<!DOCTYPE html>
<html lang="en" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="John Doe" />
  <!-- Open Graph Description 简短摘要-->
  
  <!-- 用于搜索引擎的文章摘要 -->
  
  <meta name="description" content="A hexo theme." />
  
  
  
  <title>
    
      SSRF攻防指北 
      
      
      |
    
     Blog
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- 代码块风格 -->
  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="/css/math/katex.min.css">

<link rel="stylesheet" href="/css/math/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="Blog" type="application/atom+xml">
</head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/avatar.png" alt="">
      
    </a>
    <div class="nickname"><a href="/">CyxSec</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">SSRF攻防指北</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
          2024-10-28 15:31:58
        </span>
        
              <span class="post-tags">
                <i class="iconfont icon-tags mr-10" title="Tags"></i>
                
                <span class="span--tag mr-8">
                  <a href="/tags/SSRF/" title="SSRF">
                    #SSRF
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <h1 id="序"><a class="markdownIt-Anchor" href="#序"></a> 序</h1>
<p>平时做渗透的时候遇见ssrf的次数其实不少，但是都是点到为止。打攻防的时候，也用了ssrf打了不少组合拳。</p>
<p>简单从攻防的角度，结合之前自己做的项目，做一个自我的总结和理解吧。</p>
<p><strong>因为是个人的一些项目经验，因此难免存在遗漏，欢迎各位师傅补充。</strong></p>
<h1 id="0x01-常见利用点"><a class="markdownIt-Anchor" href="#0x01-常见利用点"></a> 0x01 常见利用点</h1>
<h2 id="文件读取"><a class="markdownIt-Anchor" href="#文件读取"></a> 文件读取</h2>
<p>支持file协议，且有回显的情况下，可以读取文件。</p>
<p>Linux下的读文件，proc里面有很多有价值的，包括运行环境、命令行、端口等等信息。单jar环境下很容易下载到源码。</p>
<p>其余思路就是：</p>
<ul>
<li>历史命令</li>
<li>日志文件（框架、web）</li>
<li>php可以利用include的特性一点点下php文件。</li>
<li>java可以下载单jar或者web.xml文件，利用web.xml路由信息下载对应的class文件，然后通过import的特性下载其余的class文件。</li>
<li>java的配置文件fuzz（jdbc、aliyun等配置文件）</li>
<li>.net的web.config 结合machineKey 打反序列化。其余下载源码的方式也类似，不过.net遇见编译dll的场景更多。</li>
</ul>
<p><strong>其实问题主要在要输入跟路径，这与文件下载不太一样，有时候很难找到物理路径。</strong></p>
<p>实战中可以和洞可以结合起来利用，比如列目录漏洞。</p>
<p>常见的列目录漏洞就是<strong>FCKeditor</strong>编辑器了。（列目录还有个妙用就是列tmp目录，这样就能拿到php的sessionid了）</p>
<h2 id="redis"><a class="markdownIt-Anchor" href="#redis"></a> Redis</h2>
<p>redis在渗透中经常遇见。</p>
<p>实战中怎么知道系统有没有redis服务呢？</p>
<p><strong>可以尝试读取/etc/passwd文件，看看有无redis用户。</strong></p>
<ol>
<li>利用方式</li>
</ol>
<p>redis拿shell一般主要利用</p>
<ul>
<li>备份数据库，我们设置键值为我们想要的payload，这样就能备份到payload到我们想要的目录。</li>
</ul>
<p>这样就会存在脏数据，因此一般常见就是webshell、计划任务和ssh公钥利用方式，<strong>webshell一般特殊字符不影响解析，ssh公钥和计划任务会采取换行的方式避免脏数据，计划任务这个问题在不同的linux系统就不一样了，debain和ubuntu对计划任务格式有严格要求（文件权限也有限制），只有centos可以利用</strong></p>
<ul>
<li>主从复制，简单理解就是同步数据，这样写入不会存在脏数据，也可以写入二进制文件。</li>
</ul>
<ol start="2">
<li>redis为什么在ssrf中用的这么多呢？？</li>
</ol>
<p>其实与redis使用的通讯协议有关，每个服务都会有自己的通讯协议，了解过tcp的应该知道tcp的数据构造有多复杂，每个hex值都有自己的含义。</p>
<p>但是redis的通讯协议就比较粗糙了。</p>
<p>比如“set name 虎哥“在协议下就是如此构造的，格式很简单，语句是用CRLF分段的。</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240919165618027.png" alt="image-20240919165618027" /></p>
<h3 id="redis协议机制"><a class="markdownIt-Anchor" href="#redis协议机制"></a> Redis协议机制</h3>
<p>上面我们分析了redis的协议resp，但是我们搞过一些实战应该知道，dict协议也是能打redis的，但是dict协议本身没办法构造出完整的resp协议，为什么dict协议能被用在打redis中呢？</p>
<p>遇事不决，wireshark抓一下包分析一下。</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240923141623931.png" alt="image-20240923141623931" /></p>
<p>分析了原始的tcp数据流，我们发现请求格式没有按照resp协议去构造，但是依然正常响应了结果。</p>
<p>翻了半天redis文档没找到相关说法，去github上面看一下源码：</p>
<p><strong>其实redis做了兼容性处理，默认情况下Redis 可以解析直接通过 TCP 发送的简单的、以空格分隔的命令字符串，如 <code>SET key value</code></strong></p>
<p>具体看下图：如果数据不以*开头，将会认为是INLINE格式的数据，后面一样会进行解析，按照空格分割命令字符串</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240923142334205.png" alt="image-20240923142334205" /></p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240923142856744.png" alt="image-20240923142856744" /></p>
<p><strong>redis利用的思路一下子就被打开了，只要能完整控制一行的tcp数据，我们就可以和redis通讯</strong></p>
<p>我们发现redis确实尝试解析了我们发送的<strong>http请求</strong>的所有字段，且最后的set命令成功执行。（注意这里要有换行回车）</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240923143459606.png" alt="image-20240923143459606" /></p>
<p><strong>思路再发散一点，我们能发送CRLF，就能控制和redis做交互，这样有一些可能存在CRLF注入的鸡肋ssrf也能利用到redis了，比如weblogic</strong></p>
<h3 id="有密码情况的利用"><a class="markdownIt-Anchor" href="#有密码情况的利用"></a> 有密码情况的利用</h3>
<p>linux看passwd可以初步判断有无redis服务。然后就是读redis配置文件或者代码的配置文件获取密码了</p>
<p>有密码主要涉及到非交互模式下auth的逻辑。</p>
<p><a target="_blank" rel="noopener" href="https://redis.io/topics/pipelining%E3%80%82%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E7%BB%99%E5%87%BA%E4%BA%86%E6%96%B9%E6%A1%88%EF%BC%8Credis%E6%94%AF%E6%8C%81%E4%B8%80%E6%AC%A1%E5%8F%91%E5%87%BA%E5%A4%9A%E6%AC%A1request%EF%BC%8C%E5%9B%A0%E6%AD%A4%E9%9D%9E%E4%BA%A4%E4%BA%92%E6%A8%A1%E5%BC%8F%E4%B8%8B%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E6%AF%8F%E6%AC%A1%E8%AF%B7%E6%B1%82%E9%83%BD%E9%A2%9D%E5%A4%96%E5%B8%A6%E4%B8%80%E4%B8%8Bauth%E3%80%82">https://redis.io/topics/pipelining。官方文档给出了方案，redis支持一次发出多次request，因此非交互模式下，我们可以每次请求都额外带一下auth。</a></p>
<p>上面我们简单带过一次dict协议，dict协议无法传递换行回车来带上其他命令，因此dict协议只能执行一次命令，在非交互的情况下必须利用pipeline的方式一次发送多个请求。</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240923144213398.png" alt="image-20240923144213398" /></p>
<p>http的情况是可以的：</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240923144621754.png" alt="image-20240923144621754" /></p>
<p>因此只要可以构造两行或者多行数据，就可以用来攻击redis。</p>
<p>gopher就更不用提了。</p>
<h2 id="axis"><a class="markdownIt-Anchor" href="#axis"></a> Axis</h2>
<p>Axis的adminService存在漏洞，但是这个接口限制了仅允许localhost访问，因此通常配合ssrf打组合拳</p>
<p>想了解的可以看这篇文章：<a target="_blank" rel="noopener" href="https://paper.seebug.org/1489/">https://paper.seebug.org/1489/</a></p>
<p><strong>不做详细漏洞分析，说一些经验和打法。</strong></p>
<p>apache Axis是一种web services引擎。</p>
<ul>
<li>黑盒的时候可以看一下axis/service/、axis、service、services、axis2等目录是否存在相关web service，具体的axis版本也能看到</li>
<li>白盒的时候看路由就可以了，关键字即可。</li>
</ul>
<p>Axis是同时支持get和post请求的，相比较于post请求的参数和格式要求，使用GET的情况会更多，实战中注意系统中可能自带的特殊字符filter即可。</p>
<h3 id="实战中的axis案例"><a class="markdownIt-Anchor" href="#实战中的axis案例"></a> 实战中的Axis案例</h3>
<p>利用其他ssrf（例xxe等），配合axis打组合拳。比如利用很多的宏景hcm。</p>
<p>自己之前打某金融项目也遇见过一个有意思的情况：<strong>配置了nginx，导致adminSerive可以直接调用，不需要前置的ssrf</strong></p>
<h2 id="云服务器"><a class="markdownIt-Anchor" href="#云服务器"></a> 云服务器</h2>
<p><strong>需要回显，不同服务器厂商的接口和请求方式可能不同</strong></p>
<p>访问元数据服务，可能获取实例信息和数据</p>
<p>&lt;1&gt;亚马逊云:</p>
<p>step1. 获取通过ssrf漏洞，拿到iam角色名</p>
<p><a target="_blank" rel="noopener" href="http://169.254.169.254/latest/meta-data/iam/security-credentials">http://169.254.169.254/latest/meta-data/iam/security-credentials</a></p>
<p>step2. 通过ssrf漏洞，拿到该角色的临时凭据</p>
<p><a target="_blank" rel="noopener" href="http://169.254.169.254/latest/meta-data/iam/security-credentials/">http://169.254.169.254/latest/meta-data/iam/security-credentials/</a>&lt;role_name&gt;</p>
<p>&lt;2&gt;阿里云</p>
<p>Step1. 获取RAM角色名</p>
<p><a target="_blank" rel="noopener" href="http://100.100.100.200/latest/meta-data/ram/security-credentials/">http://100.100.100.200/latest/meta-data/ram/security-credentials/</a></p>
<p>Step2. 获取该角色的凭据</p>
<p><a target="_blank" rel="noopener" href="http://100.100.100.200/latest/meta-data/ram/security-credentials/">http://100.100.100.200/latest/meta-data/ram/security-credentials/</a><a target="_blank" rel="noopener" href="http://100.100.100.200/latest/meta-data/ram/security-credentials/"></a></p>
<p>阿里云提供这个几个api仅限于get请求</p>
<p>&lt;3&gt; 腾讯云</p>
<p>获取CAM角色的凭据:</p>
<p><a target="_blank" rel="noopener" href="http://metadata.tencentyun.com/latest/meta-data/cam/security-credentials/$%7Brole-name%7D">http://metadata.tencentyun.com/latest/meta-data/cam/security-credentials/${role-name}</a></p>
<p>腾讯云提供的api，get请求和post请求都接收</p>
<p><strong>实战看运气，看具体的角色分配</strong></p>
<h2 id="内网常见业务"><a class="markdownIt-Anchor" href="#内网常见业务"></a> 内网常见业务</h2>
<h3 id="docker-api"><a class="markdownIt-Anchor" href="#docker-api"></a> docker Api</h3>
<p>api要求post调用，因此对于ssrf的入口点限制较大。</p>
<p>因为要获取容器id等信息，因此必须要有回显。</p>
<p>实战中遇见的很少。</p>
<h3 id="gitlab"><a class="markdownIt-Anchor" href="#gitlab"></a> gitlab</h3>
<p>结合回显ssrf，通过gitlab公开的项目下载源码等。</p>
<p>gitlab/explore会存在未授权访问。</p>
<p>实战可以下载打包好的代码或配置文件。</p>
<h3 id="php-fpm"><a class="markdownIt-Anchor" href="#php-fpm"></a> PHP-FPM</h3>
<pre class="line-numbers language-none"><code class="language-none">curl7.71.1增加了限制：

https:&#x2F;&#x2F;github.com&#x2F;curl&#x2F;curl&#x2F;commit&#x2F;31e53584db5879894809fbde5445aac7553ac3e2

导致无法使用gopher构造合适的协议数据，攻击失败<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>PHP-FPM接收CGI协议内容并解析，然后执行对应的PHP文件。</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240923160619294.png" alt="image-20240923160619294" /></p>
<p>因此我们可以分析一下CGI协议，看看是否可以伪造CGI协议，让PHP-FPM可以解析我们想解析的恶意文件。</p>
<p>抓包看到cgi传递的是一系列键值对信息。</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240924111527609.png" alt="image-20240924111527609" /></p>
<p>这里直接拿网上现成的分析举例了：</p>
<p>用户访问<code>http://127.0.0.1/index.php?a=1&amp;b=2</code>，如果web目录是<code>/var/www/html</code>，那么传递的键值对将是如下：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    'GATEWAY_INTERFACE'<span class="token operator">:</span> 'FastCGI/<span class="token number">1.0</span>'<span class="token punctuation">,</span>
    'REQUEST_METHOD'<span class="token operator">:</span> 'GET'<span class="token punctuation">,</span>
    'SCRIPT_FILENAME'<span class="token operator">:</span> '/var/www/html/index.php'<span class="token punctuation">,</span>
    'SCRIPT_NAME'<span class="token operator">:</span> '/index.php'<span class="token punctuation">,</span>
    'QUERY_STRING'<span class="token operator">:</span> '?a=<span class="token number">1</span>&amp;b=<span class="token number">2</span>'<span class="token punctuation">,</span>
    'REQUEST_URI'<span class="token operator">:</span> '/index.php?a=<span class="token number">1</span>&amp;b=<span class="token number">2</span>'<span class="token punctuation">,</span>
    'DOCUMENT_ROOT'<span class="token operator">:</span> '/var/www/html'<span class="token punctuation">,</span>
    'SERVER_SOFTWARE'<span class="token operator">:</span> 'php/fcgiclient'<span class="token punctuation">,</span>
    'REMOTE_ADDR'<span class="token operator">:</span> '<span class="token number">127.0</span>.<span class="token number">0.1</span>'<span class="token punctuation">,</span>
    'REMOTE_PORT'<span class="token operator">:</span> '<span class="token number">12345</span>'<span class="token punctuation">,</span>
    'SERVER_ADDR'<span class="token operator">:</span> '<span class="token number">127.0</span>.<span class="token number">0.1</span>'<span class="token punctuation">,</span>
    'SERVER_PORT'<span class="token operator">:</span> '<span class="token number">80</span>'<span class="token punctuation">,</span>
    'SERVER_NAME'<span class="token operator">:</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span>
    'SERVER_PROTOCOL'<span class="token operator">:</span> 'HTTP/<span class="token number">1.1</span>'
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最终会执行<code>SCRIPT_FILENAME</code>变量指向的文件。</p>
<p>而fpm在高版本默认限制了文件的后缀。</p>
<p>其实著名的nginx解析漏洞就是fastcgi的pathinfo fixBug的问题，导致可以解析任意文件。而增加了这个修复之后，解析漏洞就不再存在了，因为限制了只允许解析php文件（这里p🐂的博客也说过，可以去看一下）</p>
<pre class="line-numbers language-none"><code class="language-none">; Limits the extensions of the main script FPM will allow to parse. This can
; prevent configuration mistakes on the web server side. You should only limit
; FPM to .php extensions to prevent malicious users to use other extensions to
; exectute php code.
; Note: set an empty value to allow all extensions.
; Default Value: .php
;security.limit_extensions &#x3D; .php .php3 .php4 .php5 .php7<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>到现在我们发现可以伪造协议执行系统上的任意php文件，但这样还是很鸡肋，cgi协议里面有没有其他可以被利用的配置呢？</p>
<p>这就要说回PHP了，PHP的环境变量有两项比较有意思的配置：<code>auto_prepend_file</code>和<code>auto_append_file</code>。</p>
<p><code>auto_prepend_file</code>是告诉PHP，在执行目标文件之前，先包含<code>auto_prepend_file</code>中指定的文件</p>
<p><code>auto_append_file</code>是告诉PHP，在执行完成目标文件后，包含<code>auto_append_file</code>指向的文件。</p>
<p>如果设置<code>auto_prepend_file</code>为<code>php://input</code>，那么就能直接执行post的代码了。（当然，还需要开启远程文件包含选项<code>allow_url_include</code>）</p>
<p>接下来就是利用cgi协议，设置运行的环境变量，利用<code>PHP_VALUE</code>和<code>PHP_ADMIN_VALUE</code></p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
    &#39;GATEWAY_INTERFACE&#39;: &#39;FastCGI&#x2F;1.0&#39;,
    &#39;REQUEST_METHOD&#39;: &#39;GET&#39;,
    &#39;SCRIPT_FILENAME&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php&#39;,
    &#39;SCRIPT_NAME&#39;: &#39;&#x2F;index.php&#39;,
    &#39;QUERY_STRING&#39;: &#39;?a&#x3D;1&amp;b&#x3D;2&#39;,
    &#39;REQUEST_URI&#39;: &#39;&#x2F;index.php?a&#x3D;1&amp;b&#x3D;2&#39;,
    &#39;DOCUMENT_ROOT&#39;: &#39;&#x2F;var&#x2F;www&#x2F;html&#39;,
    &#39;SERVER_SOFTWARE&#39;: &#39;php&#x2F;fcgiclient&#39;,
    &#39;REMOTE_ADDR&#39;: &#39;127.0.0.1&#39;,
    &#39;REMOTE_PORT&#39;: &#39;12345&#39;,
    &#39;SERVER_ADDR&#39;: &#39;127.0.0.1&#39;,
    &#39;SERVER_PORT&#39;: &#39;80&#39;,
    &#39;SERVER_NAME&#39;: &quot;localhost&quot;,
    &#39;SERVER_PROTOCOL&#39;: &#39;HTTP&#x2F;1.1&#39;
    &#39;PHP_VALUE&#39;: &#39;auto_prepend_file &#x3D; php:&#x2F;&#x2F;input&#39;,
    &#39;PHP_ADMIN_VALUE&#39;: &#39;allow_url_include &#x3D; On&#39;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>整个利用线路也就打通了，分析上面的流程也能发现，利用是要有前提的：</p>
<ul>
<li>需要知道服务器上一个已知的php文件路径，可以通过报错，或者linux安装php时自带的php文件。</li>
</ul>
<p><strong>因为cgi涉及到严格的格式问题，因此只能利用在可构造完整二进制数据的ssrf点，比如gopher。</strong></p>
<h3 id="其他"><a class="markdownIt-Anchor" href="#其他"></a> 其他</h3>
<p>其实上面举的常见例子都是内网中常见的未授权访问漏洞，其他未授权漏洞当然也在ssrf的利用中，比如hadoop等。</p>
<p>或者其他可以直接构造poc的web系统，比如st2、Confluence等，只要入口点可以构造出对应的数据即可。思路要打开。</p>
<h2 id="java-ssrf的ntlm-relay"><a class="markdownIt-Anchor" href="#java-ssrf的ntlm-relay"></a> java SSRF的NTLM relay</h2>
<p>java的<code>sun.net.www.protocol.http.HttpURLConnection</code>发送HTTP请求时返回为401的HTTP返回头时，会判断该页面要求使用哪种认证方式，若攻击者回复要求采用NTLM认证则会自动使用当前用户凭据进行认证。</p>
<p><strong>在 JDK 8u351 中已经修复 (针对 TrustedSites 增加了 AuthMode 字段, 默认为 <code>DISABLED</code>)，不再会默认发起认证</strong></p>
<p>这个在A-Team的文章中有实例，顺便分析一下XXE  to RCE的过程。</p>
<p>写文章的时候发现A-Team大概确实是死掉了：</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240924152017492.png" alt="image-20240924152017492" /></p>
<p>这是一篇“不一样”的真实渗透测试案例分析文章，搜索此关键字即可。</p>
<ol>
<li>入口点</li>
</ol>
<p>​	文中的漏洞点是webdav的xxe导致的ssrf（<strong>服务是system权限，出网为机器用户权限，iis和service出网也为机器用户权限</strong>）</p>
<ol start="2">
<li>
<p>无法relay回自身</p>
<p>relay是机器用户发起，因此无法relay回自身调高权限rpc接口。</p>
</li>
<li>
<p>relay到ldap</p>
</li>
</ol>
<p>​	因为是机器用户，有权限修改自身的Rbcd属性，这样修改自己的委派属性为恶意的机器用户（这里机器用户和服务用户均可，因为一般允许域用户建立10个机器用户，所以往上文章都是新建机器用户，实战中也可以选择已经拿到的机器用户和服务用户）。</p>
<ol start="4">
<li>利用rbcd特性申请 高权限票据</li>
</ol>
<p>​	rbcd可以申请任意用户到被委派的服务的票据，因此可以申请administrator用户到目标cifs服务的权限，这样就拿到了目标机器的最高权限。</p>
<h1 id="0x02-代码案例"><a class="markdownIt-Anchor" href="#0x02-代码案例"></a> 0x02 代码案例</h1>
<h2 id="php"><a class="markdownIt-Anchor" href="#php"></a> PHP</h2>
<p><strong>file_get_contents</strong></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ul>
<li>无回显（需要代码中写回显）</li>
<li>支持协议：http（GET）、file、ftp</li>
</ul>
<p><strong>fsockopen</strong></p>
<pre class="line-numbers language-PHP" data-language="PHP"><code class="language-PHP">&lt;?php
$host&#x3D;$_GET[&#39;url&#39;];
$fp &#x3D; fsockopen($host, 80, $errno, $errstr, 30);
if (!$fp) &#123;
    echo &quot;$errstr ($errno)&lt;br &#x2F;&gt;\n&quot;;
&#125; else &#123;
    $out &#x3D; &quot;GET &#x2F; HTTP&#x2F;1.1\r\n&quot;;
    $out .&#x3D; &quot;Host: $host\r\n&quot;;
    $out .&#x3D; &quot;Connection: Close\r\n\r\n&quot;;
    fwrite($fp, $out);
    while (!feof($fp)) &#123;
        echo fgets($fp, 128);
    &#125;
    fclose($fp);
&#125;
?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>无回显（需要代码中写回显）</p>
</li>
<li>
<p>自定义tcp数据流，可发送任意数据。（其实weblogic的ssrf存在crlf也是类似的原因，自己封装了socket数据）</p>
</li>
</ul>
<p><strong>curl_exec()</strong></p>
<pre class="line-numbers language-PHP" data-language="PHP"><code class="language-PHP">&lt;?php 
$url&#x3D;$_POST[&#39;url&#39;]; 
$ch&#x3D;curl_init($url);  &#x2F;&#x2F;创造一个curl资源
curl_setopt($ch, CURLOPT_HEADER, 0); &#x2F;&#x2F;设置url和相应的选项
curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); 
$result&#x3D;curl_exec($ch); &#x2F;&#x2F; 抓取url并将其传递给浏览器
curl_close($ch); &#x2F;&#x2F;关闭curl资源
echo ($result); 
?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>无回显（需要代码中写回显）</p>
</li>
<li>
<p>支持协议：dict、gopher、http、file、ftp</p>
</li>
</ul>
<h2 id="java"><a class="markdownIt-Anchor" href="#java"></a> Java</h2>
<p>java的协议支持就比较少了，以1.8举例：http，https，file，ftp，mailto，jar，netdoc。</p>
<p>对比php有灵活的gopher，java能做的事情就很少了。</p>
<p><strong>HttpURLConnection</strong></p>
<pre class="line-numbers language-JAVA" data-language="JAVA"><code class="language-JAVA">import java.net.HttpURLConnection;
import java.net.URL;

public class SSRFExample &#123;
    public void makeRequest(String userInput) throws Exception &#123;
        URL url &#x3D; new URL(userInput);
        HttpURLConnection connection &#x3D; (HttpURLConnection) url.openConnection();
        connection.setRequestMethod(&quot;GET&quot;);
        int responseCode &#x3D; connection.getResponseCode();
        &#x2F;&#x2F; 处理响应
    &#125;
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>URLConnection</strong></p>
<pre class="line-numbers language-JAVA" data-language="JAVA"><code class="language-JAVA">import java.net.URL;
import java.net.URLConnection;
import java.io.InputStream;
import java.io.BufferedReader;
import java.io.InputStreamReader;

public class SSRFExample &#123;
    public void makeRequest(String userInput) throws Exception &#123;
        URL url &#x3D; new URL(userInput);
        URLConnection connection &#x3D; url.openConnection();
        try (InputStream inputStream &#x3D; connection.getInputStream();
             BufferedReader reader &#x3D; new BufferedReader(new InputStreamReader(inputStream))) &#123;
            String line;
            while ((line &#x3D; reader.readLine()) !&#x3D; null) &#123;
                &#x2F;&#x2F; 处理每一行
                System.out.println(line);
            &#125;
        &#125;
    &#125;
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>Socket</strong></p>
<pre class="line-numbers language-JAVA" data-language="JAVA"><code class="language-JAVA">import java.io.InputStream;
import java.io.OutputStream;
import java.net.Socket;

public class SSRFExample &#123;
    public void connectToServer(String userInput) throws Exception &#123;
        String[] parts &#x3D; userInput.split(&quot;:&quot;);
        String host &#x3D; parts[0]; &#x2F;&#x2F; 主机
        int port &#x3D; Integer.parseInt(parts[1]); &#x2F;&#x2F; 端口
        
        try (Socket socket &#x3D; new Socket(host, port);
             OutputStream outputStream &#x3D; socket.getOutputStream();
             InputStream inputStream &#x3D; socket.getInputStream()) &#123;
             
            &#x2F;&#x2F; 发送请求（根据协议）
            String request &#x3D; &quot;GET &#x2F; HTTP&#x2F;1.1\r\nHost: &quot; + host + &quot;\r\n\r\n&quot;;
            outputStream.write(request.getBytes());
            outputStream.flush();
            
            &#x2F;&#x2F; 处理响应
            byte[] buffer &#x3D; new byte[1024];
            int bytesRead;
            while ((bytesRead &#x3D; inputStream.read(buffer)) !&#x3D; -1) &#123;
                System.out.write(buffer, 0, bytesRead);
            &#125;
        &#125;
    &#125;
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="dotnet"><a class="markdownIt-Anchor" href="#dotnet"></a> Dotnet</h2>
<p>.NET也是类似，支持的协议比较少，File、Http</p>
<p><strong>HttpWebRequest</strong></p>
<pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">using System;
using System.IO;
using System.Net;

public class SSRFExample
&#123;
    public void MakeRequest(string userInput)
    &#123;
        HttpWebRequest request &#x3D; (HttpWebRequest)WebRequest.Create(userInput);
        request.Method &#x3D; &quot;GET&quot;;

        using (HttpWebResponse response &#x3D; (HttpWebResponse)request.GetResponse())
        using (StreamReader reader &#x3D; new StreamReader(response.GetResponseStream()))
        &#123;
            string responseText &#x3D; reader.ReadToEnd();
            &#x2F;&#x2F; 处理响应
            Console.WriteLine(responseText);
        &#125;
    &#125;
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>HttpClient</strong></p>
<pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">using System;
using System.Net.Http;
using System.Threading.Tasks;

public class SSRFExample
&#123;
    private static readonly HttpClient client &#x3D; new HttpClient();

    public async Task MakeRequest(string userInput)
    &#123;
        HttpResponseMessage response &#x3D; await client.GetAsync(userInput);
        response.EnsureSuccessStatusCode();

        string responseBody &#x3D; await response.Content.ReadAsStringAsync();
        &#x2F;&#x2F; 处理响应
        Console.WriteLine(responseBody);
    &#125;
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>WebClient</strong></p>
<pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">using System;
using System.Net;

public class SSRFExample
&#123;
    public void MakeRequest(string userInput)
    &#123;
        using (WebClient client &#x3D; new WebClient())
        &#123;
            string response &#x3D; client.DownloadString(userInput);
            &#x2F;&#x2F; 处理响应
            Console.WriteLine(response);
        &#125;
    &#125;
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>TcpClient</strong></p>
<pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">using System;
using System.Net.Sockets;
using System.Text;

public class SSRFExample
&#123;
    public void ConnectToServer(string userInput)
    &#123;
        string[] parts &#x3D; userInput.Split(&#39;:&#39;);
        string host &#x3D; parts[0];
        int port &#x3D; int.Parse(parts[1]);

        using (TcpClient client &#x3D; new TcpClient(host, port))
        using (NetworkStream stream &#x3D; client.GetStream())
        &#123;
            byte[] request &#x3D; Encoding.ASCII.GetBytes(&quot;GET &#x2F; HTTP&#x2F;1.1\r\nHost: &quot; + host + &quot;\r\n\r\n&quot;);
            stream.Write(request, 0, request.Length);
            
            &#x2F;&#x2F; 处理响应
            byte[] buffer &#x3D; new byte[1024];
            int bytesRead &#x3D; stream.Read(buffer, 0, buffer.Length);
            Console.WriteLine(Encoding.ASCII.GetString(buffer, 0, bytesRead));
        &#125;
    &#125;
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="0x03-漏洞总结"><a class="markdownIt-Anchor" href="#0x03-漏洞总结"></a> 0x03 漏洞总结</h1>
<h2 id="实战中常见存在漏洞的组件"><a class="markdownIt-Anchor" href="#实战中常见存在漏洞的组件"></a> 实战中常见存在漏洞的组件</h2>
<ul>
<li>
<p>ueditor：可回显的ssrf</p>
</li>
<li>
<p>XXE： system的http的ssrf</p>
</li>
<li>
<p>grafana：后台回显ssrf</p>
</li>
<li>
<p>weblogic：存在crlf注入的ssrf，可以打redis</p>
</li>
</ul>
<h3 id="数据库"><a class="markdownIt-Anchor" href="#数据库"></a> 数据库</h3>
<p>部分数据库也可以发送请求，可以用在数据库未授权或者SQL注入的场景中</p>
<p><strong>MongoDB</strong></p>
<p>db.copyDatabase(’\r\nconfig get dir\r\nquit\r\n’,‘test’,‘127.0.0.1:6379’)</p>
<p><strong>Oracle</strong></p>
<p>内置的UTL_HTTP、UTL_TCP、UTL_SMTP等方法，这些也同时被用在DNS外带注入数据的场景</p>
<p><strong>PostgreSQL</strong></p>
<pre class="line-numbers language-none"><code class="language-none">SELECT dblink_send_query(
‘host&#x3D;127.0.0.1 

dbname&#x3D;quit 

user&#x3D;\&#39;\r\nconﬁg get dir\r\n\quit\r\n’ 

password&#x3D;1 port&#x3D;6379 sslmode&#x3D;disable’,

&#39;select version();’ 
);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>Mysql</strong><br />
load_file</p>
<h2 id="利用技巧"><a class="markdownIt-Anchor" href="#利用技巧"></a> 利用技巧</h2>
<p><strong>一、利用crlf</strong></p>
<p>上面已经分析过了，存在crlf的ssrf可以被用于打有密码的redis</p>
<p><strong>二、利用锚点</strong></p>
<p>业务中存在ssrf的代码通常都是 ：String url = ip + ‘/aaaaa’;</p>
<p>只有ip可控，这时我们可以利用锚点的特性，让后面的东西和参数不发送到服务端。当然也可以采取参数的方式，但个人更喜欢锚点的方式，有时候拼接的uri不知道都可能有什么东西。</p>
<p>127.0.0.1/#/aaaaa</p>
<p><strong>三、实战中的ssrf区分</strong></p>
<p>其实实战中的ssrf可以按照两种情况去分。</p>
<ul>
<li>1是是否存在回显，回显可以根据结果获取信息，没有回显只能布尔或者延时判断结果了。</li>
<li>2是是否可以构造完整的二进制数据，比如gopher就可以构造完整的数据，可以被用于在严格的协议伪造中，比如上面提到的cgi，如果不能构造，只有一个发起GET请求的ssrf点，就只能用于支持GET的漏洞利用点了。</li>
</ul>
<p><strong>四、CTF中的极限环境配合FTP模式的</strong></p>
<p>这个实战一次没见到过，但是之前刷到过，这次总结顺便放在这里了。</p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/254387#h3-2">https://www.anquanke.com/post/id/254387#h3-2</a></p>
<h1 id="0x04-漏洞常见利用实例"><a class="markdownIt-Anchor" href="#0x04-漏洞常见利用实例"></a> 0x04 漏洞常见利用实例</h1>
<h2 id="weblogic"><a class="markdownIt-Anchor" href="#weblogic"></a> weblogic</h2>
<p>weblogic的ssrf是存在crlf漏洞的，具体原因看这篇：</p>
<p><a target="_blank" rel="noopener" href="https://security.tencent.com/index.php/blog/msg/179">https://security.tencent.com/index.php/blog/msg/179</a></p>
<p>总之就是直接调用了socket发送数据</p>
<p>不过这洞本质还是构造了一个Post的http数据包，因此不能完整的构造其他的协议数据。</p>
<p>实战中就打过redis，其他的利用目前没想到，因为这个洞的post的data也是不可控的，内置了soap数据。</p>
<p>这个洞两三年前还是遇见过不少，现在遇见的很少了，客户都不用weblogic了。。。</p>
<p><code>http://localhost:7001/uddiexplorer/SearchPublicRegistries.jsp?operator=http://test.com/hello&amp;rdoSearch=name&amp;btnSubmit=Search</code></p>
<p>发送的数据包如下：（<strong>因此利用上面分析的redis特性结合crlf，可以自定义一行header，这样就完成了攻击</strong>）</p>
<pre class="line-numbers language-none"><code class="language-none">POST &#x2F;hello HTTP&#x2F;1.1 
Content-Type: text&#x2F;xml; charset&#x3D;UTF-8 
User-Agent: Java
Host: test.com
Connection: Keep-Alive 

&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot; standalone&#x3D;&quot;yes&quot;?&gt; 
&lt;env:Envelope
xmlns:soapenc&#x3D;“http:&#x2F;&#x2F;schemas.xmlsoap.org&#x2F;soap&#x2F;encoding&#x2F;&quot;xmlns:xsd&#x3D;“http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema&quot;
xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;&gt; 
&lt;env:Header&gt;&lt;&#x2F;env:Header&gt;&lt;env:Body&gt; 
    &lt;ﬁnd_business generic&#x3D;&quot;2.0&quot; xmlns&#x3D;&quot;urn:uddi-org:api_v2&quot;&gt;         
    &lt;name&gt;%&lt;&#x2F;name&gt;&lt;&#x2F;ﬁnd_business&gt; 
&lt;&#x2F;env:Body&gt;&lt;&#x2F;env:Envelope&gt;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="ueditor"><a class="markdownIt-Anchor" href="#ueditor"></a> Ueditor</h2>
<p>这是一个GET型的可回显ssrf。</p>
<p>Ueditor可真是个好东西，.net版本有个文件写入，jsp和php版本有ssrf。</p>
<p>在某些版本Ueditor进行了内网ip的patch，正则匹配，无法请求内网资源。</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240924171735874.png" alt="image-20240924171735874" /></p>
<p>使用dns重绑定岂可绕过，或者利用domain@ip的格式绕过。</p>
<h1 id="参考链接"><a class="markdownIt-Anchor" href="#参考链接"></a> 参考链接</h1>
<p><a target="_blank" rel="noopener" href="https://security.tencent.com/index.php/blog/msg/179">https://security.tencent.com/index.php/blog/msg/179</a></p>
<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/1489/">https://paper.seebug.org/1489/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/255222#h2-0">https://www.anquanke.com/post/id/255222#h2-0</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/179910.html">https://www.freebuf.com/articles/web/179910.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/292437.html">https://www.freebuf.com/articles/web/292437.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html">https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html</a></p>
<p><a target="_blank" rel="noopener" href="https://xlab.tencent.com/cn/2019/03/18/ghidra-from-xxe-to-rce/">https://xlab.tencent.com/cn/2019/03/18/ghidra-from-xxe-to-rce/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/254387#h3-2">https://www.anquanke.com/post/id/254387#h3-2</a></p>
<p><a target="_blank" rel="noopener" href="https://security.tencent.com/index.php/blog/msg/179">https://security.tencent.com/index.php/blog/msg/179</a></p>
<p><a target="_blank" rel="noopener" href="https://exp10it.io/2023/08/%E5%9F%BA%E4%BA%8E%E8%B5%84%E6%BA%90%E7%9A%84%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE-rbcd-%E5%88%A9%E7%94%A8%E6%80%BB%E7%BB%93">https://exp10it.io/2023/08/基于资源的约束委派-rbcd-利用总结</a></p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2024/07/SQL%E6%B3%A8%E5%85%A5%E8%BF%87%E6%BB%A4%E5%AD%97%E7%AC%A6%E6%B8%97%E9%80%8F%E6%8C%87%E5%8C%97/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>Prev</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
              2024-10-28 15:31:58
            </span>
            
                  <span class="post-tags">
                    <i class="iconfont icon-tags mr-10" title="Tags"></i>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/SSRF/" title="SSRF">
                        #SSRF
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2024/08/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-%E6%A1%86%E6%9E%B6%E7%BB%93%E6%9E%84%E6%A2%B3%E7%90%86%E7%AF%87/" target="_self">
                <span>Next</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">Contents</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BA%8F"><span class="toc-text"> 序</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E5%B8%B8%E8%A7%81%E5%88%A9%E7%94%A8%E7%82%B9"><span class="toc-text"> 0x01 常见利用点</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="toc-text"> 文件读取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis"><span class="toc-text"> Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#redis%E5%8D%8F%E8%AE%AE%E6%9C%BA%E5%88%B6"><span class="toc-text"> Redis协议机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%89%E5%AF%86%E7%A0%81%E6%83%85%E5%86%B5%E7%9A%84%E5%88%A9%E7%94%A8"><span class="toc-text"> 有密码情况的利用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#axis"><span class="toc-text"> Axis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E4%B8%AD%E7%9A%84axis%E6%A1%88%E4%BE%8B"><span class="toc-text"> 实战中的Axis案例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-text"> 云服务器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E5%B8%B8%E8%A7%81%E4%B8%9A%E5%8A%A1"><span class="toc-text"> 内网常见业务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#docker-api"><span class="toc-text"> docker Api</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gitlab"><span class="toc-text"> gitlab</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#php-fpm"><span class="toc-text"> PHP-FPM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-text"> 其他</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#java-ssrf%E7%9A%84ntlm-relay"><span class="toc-text"> java SSRF的NTLM relay</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-%E4%BB%A3%E7%A0%81%E6%A1%88%E4%BE%8B"><span class="toc-text"> 0x02 代码案例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#php"><span class="toc-text"> PHP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#java"><span class="toc-text"> Java</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dotnet"><span class="toc-text"> Dotnet</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93"><span class="toc-text"> 0x03 漏洞总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E4%B8%AD%E5%B8%B8%E8%A7%81%E5%AD%98%E5%9C%A8%E6%BC%8F%E6%B4%9E%E7%9A%84%E7%BB%84%E4%BB%B6"><span class="toc-text"> 实战中常见存在漏洞的组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text"> 数据库</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7"><span class="toc-text"> 利用技巧</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-%E6%BC%8F%E6%B4%9E%E5%B8%B8%E8%A7%81%E5%88%A9%E7%94%A8%E5%AE%9E%E4%BE%8B"><span class="toc-text"> 0x04 漏洞常见利用实例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#weblogic"><span class="toc-text"> weblogic</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ueditor"><span class="toc-text"> Ueditor</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-text"> 参考链接</span></a></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        







      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          
              <a title="github" target="_blank" rel="noopener" href="https://github.com/cyxsec">
                <i class="iconfont icon-github"></i>
              </a>
              
        </li>
        
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a href="https://cyxsec.github.io/">Copyright © 2024 CysSec</a>
        
    </div>
  
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="Search...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer to：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + SSRF%E6%94%BB%E9%98%B2%E6%8C%87%E5%8C%97 + '&url=' + https%3A%2F%2Fcyxsec.github.io%2F2024%2F08%2FSSRF%25E6%2594%25BB%25E9%2598%25B2%25E6%258C%2587%25E5%258C%2597%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=https://cyxsec.github.io/2024/08/SSRF%E6%94%BB%E9%98%B2%E6%8C%87%E5%8C%97/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
