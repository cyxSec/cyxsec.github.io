<!DOCTYPE html>
<html lang="en" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="John Doe" />
  <!-- Open Graph Description 简短摘要-->
  
  <!-- 用于搜索引擎的文章摘要 -->
  
  <meta name="description" content="A hexo theme." />
  
  
  
  <title>
    
      ThinkPHP非默认漏洞分析 
      
      
      |
    
     Blog
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- 代码块风格 -->
  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="/css/math/katex.min.css">

<link rel="stylesheet" href="/css/math/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="Blog" type="application/atom+xml">
</head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/avatar.png" alt="">
      
    </a>
    <div class="nickname"><a href="/">CyxSec</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">ThinkPHP非默认漏洞分析</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
          2024-09-14 16:36:11
        </span>
        
              <span class="post-tags">
                <i class="iconfont icon-tags mr-10" title="Tags"></i>
                
                <span class="span--tag mr-8">
                  <a href="/tags/ThinkPHP/" title="ThinkPHP">
                    #ThinkPHP
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <h1 id="0x00-序"><a class="markdownIt-Anchor" href="#0x00-序"></a> 0x00 序</h1>
<p>上面我们分析了TP框架存在的默认漏洞，此篇分析一下非默认环境下的漏洞，可能主要包括：</p>
<ol>
<li>某些内置函数本身存在问题，在代码审计时可结合利用</li>
<li>框架非默认情况下的漏洞，实战更多可能做权限维持</li>
</ol>
<h1 id="0x01-tp3"><a class="markdownIt-Anchor" href="#0x01-tp3"></a> 0x01 TP3</h1>
<h2 id="一-sql-注入"><a class="markdownIt-Anchor" href="#一-sql-注入"></a> 一、 SQL 注入</h2>
<h3 id="10-tp过滤策略"><a class="markdownIt-Anchor" href="#10-tp过滤策略"></a> 1.0 TP过滤策略</h3>
<p>I 方法在TP3中是获取参数的，默认会存在过滤规则</p>
<ol>
<li>callback调用defalt_filter</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816173930602.png" alt="image-20240816173930602" /></p>
<p>实体编码，防xss</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816174206494.png" alt="image-20240816174206494" /></p>
<ol start="2">
<li>callback调用think_fiter</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816174457328.png" alt="image-20240816174457328" /></p>
<p>SQL注入过滤特殊字符</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816174544180.png" alt="image-20240816174544180" /></p>
<ol start="3">
<li>SQL操作类，定义了过滤函数，特殊字符增加转义。（TP默认使用非GBK，因此也避免了字符型注入的拼接问题）</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902161421793.png" alt="image-20240902161421793" /></p>
<h3 id="11-find方法where注入️24"><a class="markdownIt-Anchor" href="#11-find方法where注入️24"></a> 1.1 find方法+where注入（❤️.2.4）</h3>
<h4 id="vuldemo"><a class="markdownIt-Anchor" href="#vuldemo"></a> VulDemo</h4>
<ul>
<li>find函数参数可控</li>
</ul>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">M</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Student'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">find</span><span class="token punctuation">(</span><span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'GET.Sno'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="影响版本"><a class="markdownIt-Anchor" href="#影响版本"></a> 影响版本</h4>
<p>version&lt;=3.2.3</p>
<h4 id="漏洞分析"><a class="markdownIt-Anchor" href="#漏洞分析"></a> 漏洞分析</h4>
<p><strong>网上很多分析文章都把这个洞叫做where注入，这样起名感觉有点误导的感觉。</strong></p>
<p><strong>漏洞发生在find参数可控时，其实就是当参数为数组时，且数组键值存在where，最后构造sql的时候，就会把这个键值拼接到where语句中，导致SQL注入。叫where注入也没什么问题，但是不是tp处理sql的那个where函数</strong></p>
<p>codeDemo：</p>
<pre class="line-numbers language-PHP" data-language="PHP"><code class="language-PHP">class IndexController extends Controller
&#123;
    public function index()
    &#123;
        $data &#x3D; M(&#39;Student&#39;)-&gt;find(I(&#39;GET.Sno&#39;));
        var_dump($data);
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>跟入find函数</li>
</ol>
<p>\Think\Model::find</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240830181613202.png" alt="image-20240830181613202" /></p>
<ol start="2">
<li>找到最终执行SQL的地方</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902163234596.png" alt="image-20240902163234596" /></p>
<ol start="3">
<li>再往里面跟</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902163408392.png" alt="image-20240902163408392" /></p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902163417366.png" alt="image-20240902163417366" /></p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902163431277.png" alt="image-20240902163431277" /></p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902163459000.png" alt="image-20240902163459000" /></p>
<p>总结一下就是会拼接where的部分到SQL语句中。</p>
<ol start="4">
<li>所以重点在option数组的where键值在哪</li>
</ol>
<p>看一下这里的赋值部分。</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902163732464.png" alt="image-20240902163732464" /></p>
<ol start="5">
<li>跟入图中的函数</li>
</ol>
<p>找到可能影响option赋值的地方（因为我们函数传入的参数是最开始的option）</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902163901971.png" alt="image-20240902163901971" /></p>
<p>分析一下这里的if条件，首先where肯定要赋值的，第二处where的值不是数组（是我们传入的sql注入payload），因此整个过程中options的where的值不会变。</p>
<p>因此整个漏洞利用过程就很清晰了，我们赋值的时候选择赋值数组，然后插入SQL注入payload即可。</p>
<p>Sno[where]=1 and 1=updatexml(1,concat(0x7e,(select user()),0x7e),1)%23</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902164834951.png" alt="image-20240902164834951" /></p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902164651970.png" alt="image-20240902164651970" /></p>
<p>整个利用完成。</p>
<p>我们正常传参Sno=1时的opions数组：</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902164736931.png" alt="image-20240902164736931" /></p>
<h4 id="漏洞修复"><a class="markdownIt-Anchor" href="#漏洞修复"></a> 漏洞修复</h4>
<p><a target="_blank" rel="noopener" href="https://github.com/top-think/thinkphp/commit/9e1db19c1e455450cfebb8b573bb51ab7a1cef04">https://github.com/top-think/thinkphp/commit/9e1db19c1e455450cfebb8b573bb51ab7a1cef04</a></p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902165021921.png" alt="image-20240902165021921" /></p>
<p>重点在圈出来的部分，之前获取options的时候是操作原始函数参数的，更新后不操作原始参数了，漏洞也就不存在了。</p>
<h3 id="12-where方法exp注入全版本"><a class="markdownIt-Anchor" href="#12-where方法exp注入全版本"></a> 1.2 where方法+exp注入（全版本）</h3>
<h4 id="vuldemo-2"><a class="markdownIt-Anchor" href="#vuldemo-2"></a> VulDemo</h4>
<ul>
<li>where参数可控</li>
<li>结合find函数</li>
<li>不使用tp自带的I函数获取参数</li>
</ul>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">&#123;</span>
       <span class="token variable">$Stu</span> <span class="token operator">=</span> <span class="token function">D</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Student'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token variable">$no</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Sno'</span> <span class="token operator">=></span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'Sno'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$Stu</span><span class="token operator">-></span><span class="token function">where</span><span class="token punctuation">(</span><span class="token variable">$no</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="影响版本-2"><a class="markdownIt-Anchor" href="#影响版本-2"></a> 影响版本</h4>
<p>未修复，但需要不使用TP的I函数获取参数</p>
<h4 id="漏洞分析-2"><a class="markdownIt-Anchor" href="#漏洞分析-2"></a> 漏洞分析</h4>
<ol>
<li>where来获取参数</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902180246363.png" alt="image-20240902180246363" /></p>
<ol start="2">
<li>漏洞触发点还是在find函数，解析where的部分。</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902180718410.png" alt="image-20240902180718410" /></p>
<ol start="3">
<li>重点在这里，当数据第一个值为exp时，where会直接拼接第数组第二个值</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902180958738.png" alt="image-20240902180958738" /></p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240902181103234.png" alt="image-20240902181103234" /></p>
<h4 id="漏洞修复-2"><a class="markdownIt-Anchor" href="#漏洞修复-2"></a> 漏洞修复</h4>
<p>使用TP自带的I函数获取参数即可（I函数会callback过滤一些关键字）</p>
<h3 id="13-where方法bind注入️25"><a class="markdownIt-Anchor" href="#13-where方法bind注入️25"></a> 1.3 where方法+bind注入（❤️.2.5）</h3>
<h4 id="vuldemo-3"><a class="markdownIt-Anchor" href="#vuldemo-3"></a> VulDemo</h4>
<ul>
<li>where参数可控</li>
<li>结合save使用</li>
</ul>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">&#123;</span>
       <span class="token variable">$Stu</span> <span class="token operator">=</span> <span class="token function">D</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Student'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token variable">$user</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'Sno'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Sno'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'Sage'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Sage'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$Stu</span><span class="token operator">-></span><span class="token function">where</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">save</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="影响版本-3"><a class="markdownIt-Anchor" href="#影响版本-3"></a> 影响版本</h4>
<p>TP&lt;=3.2.4</p>
<h4 id="漏洞分析-3"><a class="markdownIt-Anchor" href="#漏洞分析-3"></a> 漏洞分析</h4>
<p>触发方式与上面类似</p>
<ol>
<li>先看一下save方法都做了什么</li>
</ol>
<p>其实就是update更新了数据库</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240905175748013.png" alt="image-20240905175748013" /></p>
<ol start="2">
<li>跟入update方法</li>
</ol>
<p>这里的options与上面分析的相同，是我们传入的参数</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240905175854513.png" alt="image-20240905175854513" /></p>
<ol start="3">
<li>跟入这里的parseBind方法</li>
</ol>
<p>会取值赋值到bind</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240905175953825.png" alt="image-20240905175953825" /></p>
<ol start="4">
<li>看会update方法，跟入下发的parseSet方法</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240905180155824.png" alt="image-20240905180155824" /></p>
<ol start="5">
<li>跟入这里的bindParam方法</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240905180242499.png" alt="image-20240905180242499" /></p>
<ol start="6">
<li>重新处理了bind的值，增加了：</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240905180305467.png" alt="image-20240905180305467" /></p>
<ol start="7">
<li>继续往下看，看到parseWhere方法</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240905181047505.png" alt="image-20240905181047505" /></p>
<ol start="8">
<li>跟入里面的parseWhereItem方法</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240905181152601.png" alt="image-20240905181152601" /></p>
<ol start="9">
<li>当表达式bind时，会拼接key:=value</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240905181250449.png" alt="image-20240905181250449" /></p>
<ol start="10">
<li>看会update执行的execute方法</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240905181339548.png" alt="image-20240905181339548" /></p>
<ol start="11">
<li>很明显会走入图中的逻辑</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240905181429181.png" alt="image-20240905181429181" /></p>
<p>这里面有个字符串替换方法</p>
<p>就是把this—&gt;bind里面的key value对应关系，直接替换到str里面。</p>
<p>（这里的callback写的看起来很难受，实际可以直接忽略，实际上就是做了特殊字符转义，我们直接去掉看就可以）</p>
<p>整理完整个流程了。</p>
<p>我们传参数尝试一下，看看可能会发生什么情况。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">Sno<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>bind<span class="token operator">&amp;</span>Sno<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">123</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$Stu</span> <span class="token operator">=</span> <span class="token function">D</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Student'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$user</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'Sno'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Sno'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'Sage'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Sage'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$Stu</span><span class="token operator">-></span><span class="token function">where</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">save</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>传的data和options如下</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906140832485.png" alt="image-20240906140832485" /></p>
<ol start="2">
<li>跟到里面的bindParam函数，这里的name是0，val是传入的Sage参数的值</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906141822949.png" alt="image-20240906141822949" /></p>
<ol start="3">
<li>第二处解析parseWhere，当为bind时，会直接拼接</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906142149397.png" alt="image-20240906142149397" /></p>
<ol start="4">
<li>处理完的SQL如下，两个：就是上面两处处理的结果</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906142435803.png" alt="image-20240906142435803" /></p>
<ol start="5">
<li>跟到上面分析的第三处的函数的替换部分，会把其中的:0替换成0。这也就完成了整个sql</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906142740198.png" alt="image-20240906142740198" /></p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906143106502.png" alt="image-20240906143106502" /></p>
<p>我们发现后面的:123无法转换，导致SQL报错，123是我们传的Sno的第二个参数，解决方法也很简单，我们让Sno的第二个参数以0开始，这样替换的时候也会替换后面的:了。</p>
<pre class="line-numbers language-none"><code class="language-none">Sno[0]&#x3D;bind&amp;Sno[1]&#x3D;0 and updatexml(1,concat(0x7e,user(),0x7e),1)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906143402155.png" alt="image-20240906143402155" /></p>
<h4 id="漏洞修复-3"><a class="markdownIt-Anchor" href="#漏洞修复-3"></a> 漏洞修复</h4>
<p>在tp 3.2.5版本中</p>
<p><a target="_blank" rel="noopener" href="https://github.com/top-think/thinkphp/commit/7e47e34af72996497c90c20bcfa3b2e1cedd7fa4">https://github.com/top-think/thinkphp/commit/7e47e34af72996497c90c20bcfa3b2e1cedd7fa4</a></p>
<p>TP的I方法获取参数添加了过滤特殊字符“bind”</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240905103536028.png" alt="image-20240905103536028" /></p>
<h3 id="14-order方法order-by注入️24"><a class="markdownIt-Anchor" href="#14-order方法order-by注入️24"></a> 1.4 order方法+order by注入（❤️.2.4）</h3>
<h4 id="vuldemo-4"><a class="markdownIt-Anchor" href="#vuldemo-4"></a> VulDemo</h4>
<pre class="line-numbers language-none"><code class="language-none">public function index()
&#123;
    $User &#x3D; M(&quot;Users&quot;);
    $order_by &#x3D; I(&#39;Get.name&#39;);
    $q &#x3D; $User-&gt;where(&#39;id&#x3D;1&#39;)-&gt;order($order_by)-&gt;find();
    $this-&gt;getSql($User);
    var_dump($q);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="影响版本-4"><a class="markdownIt-Anchor" href="#影响版本-4"></a> 影响版本</h4>
<p>TP&lt;3.2.4</p>
<h4 id="漏洞分析-4"><a class="markdownIt-Anchor" href="#漏洞分析-4"></a> 漏洞分析</h4>
<p>tp的model类默认没有order方法，在__call的魔术方法</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906144751269.png" alt="image-20240906144751269" /></p>
<p>parseOrder会直接将字段拼接。</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906144850165.png" alt="image-20240906144850165" /></p>
<h4 id="漏洞修复-4"><a class="markdownIt-Anchor" href="#漏洞修复-4"></a> 漏洞修复</h4>
<p>3.2.4 进行了修复</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906145044418.png" alt="image-20240906145044418" /></p>
<h1 id="0x02-tp5"><a class="markdownIt-Anchor" href="#0x02-tp5"></a> 0x02 TP5</h1>
<h2 id="一-sql注入"><a class="markdownIt-Anchor" href="#一-sql注入"></a> 一、SQL注入</h2>
<h3 id="1-insert方法注入013-015-10-15"><a class="markdownIt-Anchor" href="#1-insert方法注入013-015-10-15"></a> 1. insert方法注入（0.13-0.15, 1.0-1.5)</h3>
<h4 id="vuldemo-5"><a class="markdownIt-Anchor" href="#vuldemo-5"></a> VulDemo</h4>
<ul>
<li>开启debug</li>
<li>insert参数可控</li>
</ul>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'username/a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">db</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'users'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span> <span class="token operator">=></span> <span class="token variable">$username</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string single-quoted-string">'Update success'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="影响版本-5"><a class="markdownIt-Anchor" href="#影响版本-5"></a> 影响版本</h4>
<p>5.0.13&lt;=ThinkPHP&lt;=5.0.15</p>
<p>5.1.0&lt;=ThinkPHP&lt;=5.1.5</p>
<h4 id="漏洞分析-5"><a class="markdownIt-Anchor" href="#漏洞分析-5"></a> 漏洞分析</h4>
<ol>
<li>简单的生成和执行，跟到生成的部分</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906175242056.png" alt="image-20240906175242056" /></p>
<ol start="2">
<li>获取参数然后替换，生成sql</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906175446473.png" alt="image-20240906175446473" /></p>
<ol start="3">
<li>解析这部分，当值为inc、exp、dec时候，参数会进行拼接</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906175600482.png" alt="image-20240906175600482" /></p>
<p>利用的payload：</p>
<pre class="line-numbers language-none"><code class="language-none">username[0]&#x3D;inc&amp;username[1]&#x3D;updatexml(1,concat(0x7,user(),0x7e),1)&amp;username[2]&#x3D;1 <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>这里拿mochazz师傅的图来总结了（这个图画的是真好）</strong></p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906180155561.png" alt="image-20240906180155561" /></p>
<h4 id="漏洞修复-5"><a class="markdownIt-Anchor" href="#漏洞修复-5"></a> 漏洞修复</h4>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906175933493.png" alt="image-20240906175933493" /></p>
<h3 id="2-update方法注入16-17"><a class="markdownIt-Anchor" href="#2-update方法注入16-17"></a> 2. update方法注入（1.6-1.7）</h3>
<h4 id="vuldemo-6"><a class="markdownIt-Anchor" href="#vuldemo-6"></a> VulDemo</h4>
<ul>
<li>update参数可控</li>
<li>debug开启</li>
</ul>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">&#123;</span>
       <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'username/a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">db</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'users'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span> <span class="token operator">=></span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span> <span class="token operator">=></span> <span class="token variable">$username</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> <span class="token string single-quoted-string">'Update success'</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="影响版本-6"><a class="markdownIt-Anchor" href="#影响版本-6"></a> 影响版本</h4>
<p>5.1.6&lt;=ThinkPHP&lt;=5.1.7</p>
<h4 id="漏洞分析-6"><a class="markdownIt-Anchor" href="#漏洞分析-6"></a> 漏洞分析</h4>
<ol>
<li>跟入到update方法</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906182253139.png" alt="image-20240906182253139" /></p>
<ol start="2">
<li>生成SQL语句和执行部分</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906182504804.png" alt="image-20240906182504804" /></p>
<ol start="3">
<li>跟入生成的sql部分，解析data和替换字符</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906182603859.png" alt="image-20240906182603859" /></p>
<ol start="4">
<li>解析data部分</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906182642513.png" alt="image-20240906182642513" /></p>
<ol start="5">
<li>这里有一个拼接的逻辑</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910165958837.png" alt="image-20240910165958837" /></p>
<p>从上面跟下来，data是我们传的参数，可控的参数拼接成sql如下，因此最后只要符合sql要求，且第一个参数要为上面swith的point即可。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> <span class="token identifier"><span class="token punctuation">`</span>users<span class="token punctuation">`</span></span>  <span class="token keyword">SET</span> <span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token operator">=</span> $a<span class="token punctuation">(</span><span class="token string">'$b($c)'</span><span class="token punctuation">)</span>  <span class="token keyword">WHERE</span>  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>接着我们想办法闭合即可。我们令 <strong><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>a</mi><mo>=</mo><mi>u</mi><mi>p</mi><mi>d</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>x</mi><mi>m</mi><mi>l</mi><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mi>c</mi><mi>o</mi><mi>n</mi><mi>c</mi><mi>a</mi><mi>t</mi><mo stretchy="false">(</mo><mn>0</mn><mi>x</mi><mn>7</mn><mo separator="true">,</mo><mi>u</mi><mi>s</mi><mi>e</mi><mi>r</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mn>0</mn><mi>x</mi><mn>7</mn><mi>e</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mn>1</mn><msup><mo stretchy="false">)</mo><mo>∗</mo></msup><mo>∗</mo><mi mathvariant="normal">、</mi><mo>∗</mo><mo>∗</mo></mrow><annotation encoding="application/x-tex">a = updatexml(1,concat(0x7,user(),0x7e),1)^** 、 **</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">u</span><span class="mord mathdefault">p</span><span class="mord mathdefault">d</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">e</span><span class="mord mathdefault">x</span><span class="mord mathdefault">m</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mord mathdefault">c</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mopen">(</span><span class="mord">0</span><span class="mord mathdefault">x</span><span class="mord">7</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">u</span><span class="mord mathdefault">s</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mopen">(</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mord mathdefault">x</span><span class="mord">7</span><span class="mord mathdefault">e</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.688696em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.46528em;vertical-align:0em;"></span><span class="mord cjk_fallback">、</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.46528em;vertical-align:0em;"></span><span class="mord">∗</span></span></span></span>b = 0</strong> 、 <strong>$c = 1</strong> ，即：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> <span class="token identifier"><span class="token punctuation">`</span>users<span class="token punctuation">`</span></span> <span class="token keyword">SET</span> <span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token operator">=</span> updatexml<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token number">0x7</span><span class="token punctuation">,</span><span class="token keyword">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token punctuation">(</span><span class="token string">'0(1)'</span><span class="token punctuation">)</span> <span class="token keyword">WHERE</span> <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>继续偷mochazz师傅的图：</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910170538409.png" alt="image-20240910170538409" /></p>
<h4 id="漏洞修复-6"><a class="markdownIt-Anchor" href="#漏洞修复-6"></a> 漏洞修复</h4>
<p>直接删除了相关代码</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910170448242.png" alt="image-20240910170448242" /></p>
<h3 id="3-where方法exp注入全版本"><a class="markdownIt-Anchor" href="#3-where方法exp注入全版本"></a> 3. where方法exp注入（全版本）</h3>
<h4 id="vuldemo-7"><a class="markdownIt-Anchor" href="#vuldemo-7"></a> VulDemo</h4>
<ul>
<li>Where 第2个参数为exp</li>
<li>Where第3个参数可控</li>
<li>开启debug</li>
</ul>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">&#123;</span>
       <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">db</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'users'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'exp'</span><span class="token punctuation">,</span><span class="token variable">$username</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> <span class="token string single-quoted-string">'select success'</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="影响版本-7"><a class="markdownIt-Anchor" href="#影响版本-7"></a> 影响版本</h4>
<p>全版本</p>
<h4 id="漏洞分析-7"><a class="markdownIt-Anchor" href="#漏洞分析-7"></a> 漏洞分析</h4>
<ol>
<li>where方法，parseWhereExp是解析参数的方法，不太重要。</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910172921594.png" alt="image-20240910172921594" /></p>
<ol start="2">
<li>看select方法</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910173339004.png" alt="image-20240910173339004" /></p>
<ol start="3">
<li>跟入到parseWhere方法</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910173409721.png" alt="image-20240910173409721" /></p>
<ol start="4">
<li>跟入到buildWhere方法</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910173619128.png" alt="image-20240910173619128" /></p>
<ol start="5">
<li>会执行到parseWhereItem方法</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910174002024.png" alt="image-20240910174002024" /></p>
<h4 id="漏洞修复-7"><a class="markdownIt-Anchor" href="#漏洞修复-7"></a> 漏洞修复</h4>
<p>未修复</p>
<h3 id="4where方法not-like注入010"><a class="markdownIt-Anchor" href="#4where方法not-like注入010"></a> 4.where方法not like注入（0.10）</h3>
<h4 id="vuldemo-8"><a class="markdownIt-Anchor" href="#vuldemo-8"></a> VulDemo</h4>
<ul>
<li>where参数可控</li>
<li>开启debug</li>
</ul>
<pre class="line-numbers language-PHP" data-language="PHP"><code class="language-PHP">public function index()
    &#123;
        $username &#x3D; request()-&gt;get(&#39;username&#x2F;a&#39;);
        $result &#x3D; db(&#39;users&#39;)-&gt;where([&#39;username&#39; &#x3D;&gt; $username])-&gt;select();
        var_dump($result);
    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="影响版本-8"><a class="markdownIt-Anchor" href="#影响版本-8"></a> 影响版本</h4>
<p>5.0.10</p>
<h4 id="漏洞分析-8"><a class="markdownIt-Anchor" href="#漏洞分析-8"></a> 漏洞分析</h4>
<p>漏洞分析与上面的exp相同，不过not like是自己传的，不是上面定义好的exp。</p>
<p>不过多分析了</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910180127484.png" alt="image-20240910180127484" /></p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910180238930.png" alt="image-20240910180238930" /></p>
<h4 id="漏洞修复-8"><a class="markdownIt-Anchor" href="#漏洞修复-8"></a> 漏洞修复</h4>
<p>增加了关键字过滤</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910180310523.png" alt="image-20240910180310523" /></p>
<h3 id="5-order方法注入116-122"><a class="markdownIt-Anchor" href="#5-order方法注入116-122"></a> 5. order方法注入（1.16-1.22）</h3>
<h4 id="vuldemo-9"><a class="markdownIt-Anchor" href="#vuldemo-9"></a> VulDemo</h4>
<ul>
<li>order方法参数可控</li>
<li>开启debug</li>
<li>调用find方法</li>
</ul>
<pre class="line-numbers language-PHP" data-language="PHP"><code class="language-PHP">public function index()
    &#123;
        $orderby &#x3D; request()-&gt;get(&#39;orderby&#39;);
        $result &#x3D; db(&#39;users&#39;)-&gt;where([&#39;username&#39; &#x3D;&gt; &#39;mochazz&#39;])-&gt;order($orderby)-&gt;find();
        var_dump($result);
    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="影响版本-9"><a class="markdownIt-Anchor" href="#影响版本-9"></a> 影响版本</h4>
<p>5.1.16&lt;=ThinkPHP5&lt;=5.1.22</p>
<h4 id="漏洞分析-9"><a class="markdownIt-Anchor" href="#漏洞分析-9"></a> 漏洞分析</h4>
<p>这个与上面分析的tp3一样，都是parseOrder方法的问题</p>
<p>不做详细分析</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910181002235.png" alt="image-20240910181002235" /></p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910181019096.png" alt="image-20240910181019096" /></p>
<h4 id="漏洞修复-9"><a class="markdownIt-Anchor" href="#漏洞修复-9"></a> 漏洞修复</h4>
<p>增加判断）和#</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910181040568.png" alt="image-20240910181040568" /></p>
<h3 id="6-max方法聚合查询注入00-02113-125"><a class="markdownIt-Anchor" href="#6-max方法聚合查询注入00-02113-125"></a> 6. max方法聚合查询注入（0.0-0.21，1.3-1.25）</h3>
<h4 id="vuldemo-10"><a class="markdownIt-Anchor" href="#vuldemo-10"></a> VulDemo</h4>
<ul>
<li>max方法参数可控</li>
<li>开启debug</li>
</ul>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$options</span> <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'options'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">db</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'users'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">max</span><span class="token punctuation">(</span><span class="token variable">$options</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="影响版本-10"><a class="markdownIt-Anchor" href="#影响版本-10"></a> 影响版本</h4>
<p><strong>5.0.0&lt;=ThinkPHP&lt;=5.0.21</strong> 、 <strong>5.1.3&lt;=ThinkPHP5&lt;=5.1.25</strong></p>
<h4 id="漏洞分析-10"><a class="markdownIt-Anchor" href="#漏洞分析-10"></a> 漏洞分析</h4>
<p>max方法实战中用的非常少</p>
<p>不花时间分析了</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910182130657.png" alt="image-20240910182130657" /></p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910182207168.png" alt="image-20240910182207168" /></p>
<h4 id="漏洞修复-10"><a class="markdownIt-Anchor" href="#漏洞修复-10"></a> 漏洞修复</h4>
<p>增加了正则匹配，仅允许字母和. *</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240910182252180.png" alt="image-20240910182252180" /></p>
<h1 id="0x03-tp6"><a class="markdownIt-Anchor" href="#0x03-tp6"></a> 0x03 TP6</h1>
<h2 id="1-session任意文件写入00-01"><a class="markdownIt-Anchor" href="#1-session任意文件写入00-01"></a> 1. Session任意文件写入（0.0-0.1）</h2>
<p><a target="_blank" rel="noopener" href="https://github.com/Mochazz/ThinkPHP-Vuln/blob/master/ThinkPHP6/ThinkPHP6.0%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99.md">https://github.com/Mochazz/ThinkPHP-Vuln/blob/master/ThinkPHP6/ThinkPHP6.0任意文件写.md</a></p>
<h1 id="0x04-文件包含"><a class="markdownIt-Anchor" href="#0x04-文件包含"></a> 0x04 文件包含</h1>
<h2 id="1assign参数可控导致的文件包含"><a class="markdownIt-Anchor" href="#1assign参数可控导致的文件包含"></a> 1.assign参数可控导致的文件包含</h2>
<h3 id="触发条件"><a class="markdownIt-Anchor" href="#触发条件"></a> 触发条件</h3>
<ol>
<li>存在类似assign函数参数可控的代码</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816144806251.png" alt="image-20240816144806251" /></p>
<pre class="line-numbers language-none"><code class="language-none">assign方法第一个变量可控&#x3D;&gt;变量覆盖&#x3D;&gt;任意文件包含&#x3D;&gt;RCE<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>题外话：本地搭建调试环境的时候，提示找不到模板，自己在<code>Application\Home\View\Index</code>下面新建了模板文件</p>
<h3 id="漏洞分析-11"><a class="markdownIt-Anchor" href="#漏洞分析-11"></a> 漏洞分析</h3>
<ol>
<li>assign只做了赋值操作</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816144850011.png" alt="image-20240816144850011" /></p>
<ol start="2">
<li>跟入fetch</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816144934461.png" alt="image-20240816144934461" /></p>
<ol start="3">
<li>跟入listen函数</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816145025426.png" alt="image-20240816145025426" /></p>
<ol start="4">
<li>跟入exec</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816145114321.png" alt="image-20240816145114321" /></p>
<ol start="5">
<li>跟入赋值类的run方法</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816145137086.png" alt="image-20240816145137086" /></p>
<ol start="6">
<li>函数参数是我们传的参数，跟入最后的断点处</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816145240625.png" alt="image-20240816145240625" /></p>
<ol start="7">
<li>跟入fetch后的load方法</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816145428421.png" alt="image-20240816145428421" /></p>
<ol start="8">
<li>很明显的变量覆盖+文件包含，这也是为什么我们需要传入数组变量，key值为_filename</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816145751936.png" alt="image-20240816145751936" /></p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240816145818684.png" alt="image-20240816145818684" /></p>
<p>tp的日志记录：</p>
<pre class="line-numbers language-none"><code class="language-none">未开启debug：
\Application\Runtime\Logs\Common\（一般选择&#x2F;?s&#x3D;--&gt;&lt;?&#x3D;phpinfo();?&gt;去触发）

\Application\Runtime\Logs\Home\（可以用?s&#x3D;&#x2F;home&#x2F;index&#x2F;&lt;?&#x3D;phpinfo();?&gt;去触发）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="0x05-文件写入"><a class="markdownIt-Anchor" href="#0x05-文件写入"></a> 0x05 文件写入</h1>
<h2 id="1s方法和f方法或cacheset参数可控"><a class="markdownIt-Anchor" href="#1s方法和f方法或cacheset参数可控"></a> 1.S方法和F方法或Cache::set参数可控</h2>
<h3 id="vuldemo-11"><a class="markdownIt-Anchor" href="#vuldemo-11"></a> VulDemo</h3>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">&#123;</span>
       <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'GET.name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">S</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">,</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="漏洞分析-12"><a class="markdownIt-Anchor" href="#漏洞分析-12"></a> 漏洞分析</h3>
<ol>
<li>跟到$cache的set方法</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906150903581.png" alt="image-20240906150903581" /></p>
<ol start="2">
<li>分析文件写入的部分，看两个参数的初始化位置。一个是filename方法获取，一个是序列化后的值</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906151003887.png" alt="image-20240906151003887" /></p>
<ol start="3">
<li>filename值，md5计算，拼接配置中的文件夹前缀。</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906151202004.png" alt="image-20240906151202004" /></p>
<ol start="4">
<li>写入的文件data中包含//注释符，只要在data添加%0d换行就可以了</li>
</ol>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906151545064.png" alt="" /></p>
<p>文件名为上面分析的，md5（name）的值</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906151748198.png" alt="image-20240906151748198" /></p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906151956563.png" alt="image-20240906151956563" /></p>
<h3 id="f方法"><a class="markdownIt-Anchor" href="#f方法"></a> F方法</h3>
<p>F方法很直接，直接写文件，不过多分析。</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240906153209845.png" alt="image-20240906153209845" /></p>
<h1 id="0x06-tp的日志"><a class="markdownIt-Anchor" href="#0x06-tp的日志"></a> 0x06 TP的日志</h1>
<h2 id="1-不同的日志含义"><a class="markdownIt-Anchor" href="#1-不同的日志含义"></a> 1. 不同的日志含义</h2>
<p>默认有不同的log路径</p>
<ul>
<li>Runtime\Logs\Common: 记录系统的整体运行状态</li>
</ul>
<p>​	TP3未开启debug情况下记录的信息：</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240911102033818.png" alt="image-20240911102033818" /></p>
<ul>
<li>Runtime\Logs\Home: 记录模块运行的状态</li>
</ul>
<p>​	TP3未开启debug情况下记录的信息：</p>
<p>​	会记录系统报错信息和SQL语句相关</p>
<p><img src="C:%5CUsers%5C14198%5Cblog%5Cpublic%5Ctypora-user-images%5Cimage-20240911102141866.png" alt="image-20240911102141866" /></p>
<h2 id="2-日志路径"><a class="markdownIt-Anchor" href="#2-日志路径"></a> 2. 日志路径</h2>
<h3 id="tp3"><a class="markdownIt-Anchor" href="#tp3"></a> TP3</h3>
<p><strong>路径：</strong></p>
<pre class="line-numbers language-none"><code class="language-none">Runtime&#x2F;Logs&#x2F;
Runtime&#x2F;Logs&#x2F;Admin&#x2F;
Runtime&#x2F;Logs&#x2F;Backend&#x2F;
Runtime&#x2F;Logs&#x2F;Home&#x2F;
Runtime&#x2F;Logs&#x2F;Common&#x2F;
App&#x2F;Runtime&#x2F;Logs&#x2F;
App&#x2F;Runtime&#x2F;Logs&#x2F;Home&#x2F;
Application&#x2F;Runtime&#x2F;Logs&#x2F;
Application&#x2F;Runtime&#x2F;Logs&#x2F;Admin&#x2F;
Application&#x2F;Runtime&#x2F;Logs&#x2F;Home&#x2F;
Application&#x2F;Runtime&#x2F;Logs&#x2F;App&#x2F;
Application&#x2F;Runtime&#x2F;Logs&#x2F;Ext&#x2F;
Application&#x2F;Runtime&#x2F;Logs&#x2F;Api&#x2F;
Application&#x2F;Runtime&#x2F;Logs&#x2F;Test&#x2F;
Application&#x2F;Runtime&#x2F;Logs&#x2F;Common&#x2F;
Application&#x2F;Runtime&#x2F;Logs&#x2F;Service&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>日志名字：</strong></p>
<p>年份后两位_月份_日期.log</p>
<p>24_01_23.log</p>
<h3 id="tp5"><a class="markdownIt-Anchor" href="#tp5"></a> TP5</h3>
<p><strong>路径：</strong></p>
<pre class="line-numbers language-none"><code class="language-none">runtime&#x2F;log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>日志名字，存在多个后缀：</strong></p>
<p>年份月份/日期.log</p>
<p>202409/10.log<br />
202409/10_cli.log<br />
202409/10_error.log<br />
202409/10_sql.log</p>
<h3 id="tp6"><a class="markdownIt-Anchor" href="#tp6"></a> TP6</h3>
<p><strong>路径：</strong></p>
<pre class="line-numbers language-none"><code class="language-none">runtime&#x2F;log&#x2F;
runtime&#x2F;log&#x2F;Home&#x2F;
runtime&#x2F;log&#x2F;Common&#x2F;
runtime&#x2F;log&#x2F;Admin&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>日志名字：</strong></p>
<p>年份月份/日期.log</p>
<p>202409/10.log</p>
<h1 id="参考链接"><a class="markdownIt-Anchor" href="#参考链接"></a> 参考链接</h1>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/14451?time__1311=GqAxuWqCqYq05DK5YI9l4hT907A4D#toc-22">https://xz.aliyun.com/t/14451?time__1311=GqAxuWqCqYq05DK5YI9l4hT907A4D#toc-22</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/lktop/p/13802598.html">https://www.cnblogs.com/lktop/p/13802598.html</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/9326">https://xz.aliyun.com/t/9326</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Mochazz/ThinkPHP-Vuln">https://github.com/Mochazz/ThinkPHP-Vuln</a></p>
<p><a target="_blank" rel="noopener" href="https://furina.org.cn/2024/01/25/thinkphp-log-leakage/">https://furina.org.cn/2024/01/25/thinkphp-log-leakage/</a></p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2023/05/ThinkPHP%E9%BB%98%E8%AE%A4%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>Prev</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
              2024-09-14 16:36:11
            </span>
            
                  <span class="post-tags">
                    <i class="iconfont icon-tags mr-10" title="Tags"></i>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/ThinkPHP/" title="ThinkPHP">
                        #ThinkPHP
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2023/10/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E4%B8%8B%E7%9A%84Webshell%E8%BF%9E%E6%8E%A5/" target="_self">
                <span>Next</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">Contents</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x00-%E5%BA%8F"><span class="toc-text"> 0x00 序</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-tp3"><span class="toc-text"> 0x01 TP3</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-sql-%E6%B3%A8%E5%85%A5"><span class="toc-text"> 一、 SQL 注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-tp%E8%BF%87%E6%BB%A4%E7%AD%96%E7%95%A5"><span class="toc-text"> 1.0 TP过滤策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-find%E6%96%B9%E6%B3%95where%E6%B3%A8%E5%85%A5%EF%B8%8F24"><span class="toc-text"> 1.1 find方法+where注入（❤️.2.4）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#vuldemo"><span class="toc-text"> VulDemo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC"><span class="toc-text"> 影响版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-text"> 漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="toc-text"> 漏洞修复</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-where%E6%96%B9%E6%B3%95exp%E6%B3%A8%E5%85%A5%E5%85%A8%E7%89%88%E6%9C%AC"><span class="toc-text"> 1.2 where方法+exp注入（全版本）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#vuldemo-2"><span class="toc-text"> VulDemo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC-2"><span class="toc-text"> 影响版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-2"><span class="toc-text"> 漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-2"><span class="toc-text"> 漏洞修复</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-where%E6%96%B9%E6%B3%95bind%E6%B3%A8%E5%85%A5%EF%B8%8F25"><span class="toc-text"> 1.3 where方法+bind注入（❤️.2.5）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#vuldemo-3"><span class="toc-text"> VulDemo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC-3"><span class="toc-text"> 影响版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-3"><span class="toc-text"> 漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-3"><span class="toc-text"> 漏洞修复</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-order%E6%96%B9%E6%B3%95order-by%E6%B3%A8%E5%85%A5%EF%B8%8F24"><span class="toc-text"> 1.4 order方法+order by注入（❤️.2.4）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#vuldemo-4"><span class="toc-text"> VulDemo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC-4"><span class="toc-text"> 影响版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-4"><span class="toc-text"> 漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-4"><span class="toc-text"> 漏洞修复</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-tp5"><span class="toc-text"> 0x02 TP5</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-sql%E6%B3%A8%E5%85%A5"><span class="toc-text"> 一、SQL注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-insert%E6%96%B9%E6%B3%95%E6%B3%A8%E5%85%A5013-015-10-15"><span class="toc-text"> 1. insert方法注入（0.13-0.15, 1.0-1.5)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#vuldemo-5"><span class="toc-text"> VulDemo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC-5"><span class="toc-text"> 影响版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-5"><span class="toc-text"> 漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-5"><span class="toc-text"> 漏洞修复</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-update%E6%96%B9%E6%B3%95%E6%B3%A8%E5%85%A516-17"><span class="toc-text"> 2. update方法注入（1.6-1.7）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#vuldemo-6"><span class="toc-text"> VulDemo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC-6"><span class="toc-text"> 影响版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-6"><span class="toc-text"> 漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-6"><span class="toc-text"> 漏洞修复</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-where%E6%96%B9%E6%B3%95exp%E6%B3%A8%E5%85%A5%E5%85%A8%E7%89%88%E6%9C%AC"><span class="toc-text"> 3. where方法exp注入（全版本）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#vuldemo-7"><span class="toc-text"> VulDemo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC-7"><span class="toc-text"> 影响版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-7"><span class="toc-text"> 漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-7"><span class="toc-text"> 漏洞修复</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4where%E6%96%B9%E6%B3%95not-like%E6%B3%A8%E5%85%A5010"><span class="toc-text"> 4.where方法not like注入（0.10）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#vuldemo-8"><span class="toc-text"> VulDemo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC-8"><span class="toc-text"> 影响版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-8"><span class="toc-text"> 漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-8"><span class="toc-text"> 漏洞修复</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-order%E6%96%B9%E6%B3%95%E6%B3%A8%E5%85%A5116-122"><span class="toc-text"> 5. order方法注入（1.16-1.22）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#vuldemo-9"><span class="toc-text"> VulDemo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC-9"><span class="toc-text"> 影响版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-9"><span class="toc-text"> 漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-9"><span class="toc-text"> 漏洞修复</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-max%E6%96%B9%E6%B3%95%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2%E6%B3%A8%E5%85%A500-02113-125"><span class="toc-text"> 6. max方法聚合查询注入（0.0-0.21，1.3-1.25）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#vuldemo-10"><span class="toc-text"> VulDemo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC-10"><span class="toc-text"> 影响版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-10"><span class="toc-text"> 漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-10"><span class="toc-text"> 漏洞修复</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-tp6"><span class="toc-text"> 0x03 TP6</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-session%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A500-01"><span class="toc-text"> 1. Session任意文件写入（0.0-0.1）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="toc-text"> 0x04 文件包含</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1assign%E5%8F%82%E6%95%B0%E5%8F%AF%E6%8E%A7%E5%AF%BC%E8%87%B4%E7%9A%84%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="toc-text"> 1.assign参数可控导致的文件包含</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E6%9D%A1%E4%BB%B6"><span class="toc-text"> 触发条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-11"><span class="toc-text"> 漏洞分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5"><span class="toc-text"> 0x05 文件写入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1s%E6%96%B9%E6%B3%95%E5%92%8Cf%E6%96%B9%E6%B3%95%E6%88%96cacheset%E5%8F%82%E6%95%B0%E5%8F%AF%E6%8E%A7"><span class="toc-text"> 1.S方法和F方法或Cache::set参数可控</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#vuldemo-11"><span class="toc-text"> VulDemo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-12"><span class="toc-text"> 漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#f%E6%96%B9%E6%B3%95"><span class="toc-text"> F方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-tp%E7%9A%84%E6%97%A5%E5%BF%97"><span class="toc-text"> 0x06 TP的日志</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%B8%8D%E5%90%8C%E7%9A%84%E6%97%A5%E5%BF%97%E5%90%AB%E4%B9%89"><span class="toc-text"> 1. 不同的日志含义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%97%A5%E5%BF%97%E8%B7%AF%E5%BE%84"><span class="toc-text"> 2. 日志路径</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#tp3"><span class="toc-text"> TP3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tp5"><span class="toc-text"> TP5</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tp6"><span class="toc-text"> TP6</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-text"> 参考链接</span></a></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        







      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          
              <a title="github" target="_blank" rel="noopener" href="https://github.com/cyxsec">
                <i class="iconfont icon-github"></i>
              </a>
              
        </li>
        
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a href="https://cyxsec.github.io/">Copyright © 2024 CysSec</a>
        
    </div>
  
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="Search...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer to：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + ThinkPHP%E9%9D%9E%E9%BB%98%E8%AE%A4%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90 + '&url=' + https%3A%2F%2Fcyxsec.github.io%2F2023%2F07%2FThinkPHP%25E9%259D%259E%25E9%25BB%2598%25E8%25AE%25A4%25E6%25BC%258F%25E6%25B4%259E%25E5%2588%2586%25E6%259E%2590%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=https://cyxsec.github.io/2023/07/ThinkPHP%E9%9D%9E%E9%BB%98%E8%AE%A4%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
